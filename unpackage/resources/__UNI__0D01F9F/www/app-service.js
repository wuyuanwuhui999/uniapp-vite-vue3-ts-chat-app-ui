var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i);if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((i=>t.resolve(e()).then((()=>i))),(i=>t.resolve(e()).then((()=>{throw i}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(vue){"use strict";var isVue2=!1;
/*!
    * pinia v2.0.33
    * (c) 2023 Eduardo San Martin Morote
    * @license MIT
    */let activePinia;const setActivePinia=e=>activePinia=e,piniaSymbol=Symbol();function isPlainObject(e){return e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)&&"function"!=typeof e.toJSON}var MutationType,MutationType2;function createPinia(){const e=vue.effectScope(!0),t=e.run((()=>vue.ref({})));let i=[],r=[];const s=vue.markRaw({install(e){setActivePinia(s),s._a=e,e.provide(piniaSymbol,s),e.config.globalProperties.$pinia=s,r.forEach((e=>i.push(e))),r=[]},use(e){return this._a||isVue2?i.push(e):r.push(e),this},_p:i,_a:null,_e:e,_s:new Map,state:t});return s}MutationType2=MutationType||(MutationType={}),MutationType2.direct="direct",MutationType2.patchObject="patch object",MutationType2.patchFunction="patch function";const noop$1=()=>{};function addSubscription(e,t,i,r=noop$1){e.push(t);const s=()=>{const i=e.indexOf(t);i>-1&&(e.splice(i,1),r())};return!i&&vue.getCurrentScope()&&vue.onScopeDispose(s),s}function triggerSubscriptions(e,...t){e.slice().forEach((e=>{e(...t)}))}function mergeReactiveObjects(e,t){e instanceof Map&&t instanceof Map&&t.forEach(((t,i)=>e.set(i,t))),e instanceof Set&&t instanceof Set&&t.forEach(e.add,e);for(const i in t){if(!t.hasOwnProperty(i))continue;const r=t[i],s=e[i];isPlainObject(s)&&isPlainObject(r)&&e.hasOwnProperty(i)&&!vue.isRef(r)&&!vue.isReactive(r)?e[i]=mergeReactiveObjects(s,r):e[i]=r}return e}const skipHydrateSymbol=Symbol();function shouldHydrate(e){return!isPlainObject(e)||!e.hasOwnProperty(skipHydrateSymbol)}const{assign:assign}=Object;function isComputed(e){return!(!vue.isRef(e)||!e.effect)}function createOptionsStore(e,t,i,r){const{state:s,actions:a,getters:n}=t,o=i.state.value[e];let l;return l=createSetupStore(e,(function(){o||(i.state.value[e]=s?s():{});const t=vue.toRefs(i.state.value[e]);return assign(t,a,Object.keys(n||{}).reduce(((t,r)=>(t[r]=vue.markRaw(vue.computed((()=>{setActivePinia(i);const t=i._s.get(e);return n[r].call(t,t)}))),t)),{}))}),t,i,r,!0),l}function createSetupStore(e,t,i={},r,s,a){let n;const o=assign({actions:{}},i),l={deep:!0};let c,u,d,h=vue.markRaw([]),m=vue.markRaw([]);const f=r.state.value[e];let g;function p(t){let i;c=u=!1,"function"==typeof t?(t(r.state.value[e]),i={type:MutationType.patchFunction,storeId:e,events:d}):(mergeReactiveObjects(r.state.value[e],t),i={type:MutationType.patchObject,payload:t,storeId:e,events:d});const s=g=Symbol();vue.nextTick().then((()=>{g===s&&(c=!0)})),u=!0,triggerSubscriptions(h,i,r.state.value[e])}a||f||(r.state.value[e]={}),vue.ref({});const v=a?function(){const{state:e}=i,t=e?e():{};this.$patch((e=>{assign(e,t)}))}:noop$1;function y(t,i){return function(){setActivePinia(r);const s=Array.from(arguments),a=[],n=[];let o;triggerSubscriptions(m,{args:s,name:t,store:T,after:function(e){a.push(e)},onError:function(e){n.push(e)}});try{o=i.apply(this&&this.$id===e?this:T,s)}catch(l){throw triggerSubscriptions(n,l),l}return o instanceof Promise?o.then((e=>(triggerSubscriptions(a,e),e))).catch((e=>(triggerSubscriptions(n,e),Promise.reject(e)))):(triggerSubscriptions(a,o),o)}}const E={_p:r,$id:e,$onAction:addSubscription.bind(null,m),$patch:p,$reset:v,$subscribe(t,i={}){const s=addSubscription(h,t,i.detached,(()=>a())),a=n.run((()=>vue.watch((()=>r.state.value[e]),(r=>{("sync"===i.flush?u:c)&&t({storeId:e,type:MutationType.direct,events:d},r)}),assign({},l,i))));return s},$dispose:function(){n.stop(),h=[],m=[],r._s.delete(e)}},T=vue.reactive(E);r._s.set(e,T);const S=r._e.run((()=>(n=vue.effectScope(),n.run((()=>t())))));for(const _ in S){const t=S[_];if(vue.isRef(t)&&!isComputed(t)||vue.isReactive(t))a||(f&&shouldHydrate(t)&&(vue.isRef(t)?t.value=f[_]:mergeReactiveObjects(t,f[_])),r.state.value[e][_]=t);else if("function"==typeof t){const e=y(_,t);S[_]=e,o.actions[_]=t}}return assign(T,S),assign(vue.toRaw(T),S),Object.defineProperty(T,"$state",{get:()=>r.state.value[e],set:e=>{p((t=>{assign(t,e)}))}}),r._p.forEach((e=>{assign(T,n.run((()=>e({store:T,app:r._a,pinia:r,options:o}))))})),f&&a&&i.hydrate&&i.hydrate(T.$state,f),c=!0,u=!0,T}function defineStore(e,t,i){let r,s;const a="function"==typeof t;function n(e,i){const n=vue.getCurrentInstance();(e=e||n&&vue.inject(piniaSymbol,null))&&setActivePinia(e),(e=activePinia)._s.has(r)||(a?createSetupStore(r,t,s,e):createOptionsStore(r,s,e));return e._s.get(r)}return"string"==typeof e?(r=e,s=a?i:t):(s=e,r=e.id),n.$id=r,n}const HOST="http://127.0.0.1:5001",MUSIC_SEARCH_STORAGE_KEY="MUSIC_SEARCH_STORAGE_KEY",LOOP_STORAGE_KEY="LOOP_STORAGE_KEY",MUSIC_STORAGE_KEY="MUSIC_STORAGE_KEY",MUSIC_LIST_STORAGE_KEY="MUSIC_LIST_STORAGE_KEY",MUSIC_CLASSIFY_NAME_STORAGE_KEY="MUSIC_CLASSIFY_NAME_STORAGE_KEY",MUSIC_FAVORITE_NAME_STORAGE_KEY="MUSIC_FAVORITE_NAME_STORAGE_KEY",MAX_FAVORITE_NUMBER=500,PAGE_SIZE=20;var LoopModeEnum=(e=>(e[e.ORDER=0]="ORDER",e[e.RANDOM=1]="RANDOM",e[e.REPEAT=2]="REPEAT",e))(LoopModeEnum||{}),TabEnum=(e=>(e[e.PREV=0]="PREV",e[e.NEXT=1]="NEXT",e))(TabEnum||{}),CommentEnum=(e=>(e.MUSIC_CIRCLE="MUSIC_CIRCLE",e.MUSIC="MUSIC",e.MOVIE="MOVIE",e.MOVIE_CIRCLE="MOVIE_CIRCLE",e))(CommentEnum||{}),CircleEnum=(e=>(e.MUSIC="MUSIC",e.MOVIE="MOVIE",e))(CircleEnum||{});const _HttpRequest=class{constructor(){__publicField(this,"token","")}setToken(e){this.token=e}static getInstance(){return this.instance||(this.instance=new _HttpRequest),this.instance}handerErrorStatus(e,t){let i="服务找不到";return 502!==e&&503!==e||(i="服务器开小差了~"),!t.noShowMsg&&uni.showToast({title:`${i}，错误码：${e}`,icon:"none"}),i}handerError(e,t){let i="请求异常";return/timeout/.test(e.errMsg)&&(i="请求超时"),!t.noShowMsg&&uni.showToast({title:i,icon:"none"}),i}request(e){return new Promise(((t,i)=>{const r={"content-type":"application/json",Authorization:this.token};uni.request({method:e.method,url:HOST+e.url,data:e.data,header:Object.assign(r,null==e?void 0:e.header),dataType:e.dataType?"其他":"json",success:r=>{const s=r.statusCode||-404,a=r.data;if(200==s&&"SUCCESS"===a.status)t(a);else if(401===s)!e.noShowMsg&&uni.showModal({title:"登录失效",content:"登录失效，请重新登录"}).then((e=>{e.confirm})),i({code:s,msg:"未登录",data:r.data});else{const t=this.handerErrorStatus(s,e);i({code:s,msg:t||r.errMsg,data:r.data})}},fail:t=>{let r=this.handerError(t,e);i({msg:r})}})}))}get(e,t,i){return this.request({method:"GET",url:e,data:t,...i})}post(e,t,i){return this.request({method:"POST",url:e,data:t,...i})}delete(e,t,i){return this.request({method:"DELETE",url:e,data:t,...i})}put(e,t,i){return this.request({method:"PUT",url:e,data:t,...i})}};let HttpRequest=_HttpRequest;__publicField(HttpRequest,"instance");const httpRequest=HttpRequest.getInstance(),api$1={getKeywordMusic:"/service/myMusic/getKeywordMusic",getMusicClassify:"/service/myMusic/getMusicClassify",getMusicListByClassifyId:"/service/myMusic/getMusicListByClassifyId",getMusicAuthorListByCategoryId:"/service/myMusic/getMusicAuthorListByCategoryId",getCircleListByType:"/service/circle/getCircleListByType",getMusicPlayMenu:"/service/myMusic-getway/getMusicPlayMenu",getFavoriteAuthor:"/service/myMusic-getway/getFavoriteAuthor",insertFavoriteAuthor:"/service/myMusic-getway/insertFavoriteAuthor/",deleteMyLikeMusicAuthor:"/service/myMusic-getway/deleteMyLikeMusicAuthor/",getMusicRecord:"/service/myMusic-getway/getMusicRecord",insertMusicRecord:"/service/myMusic-getway/insertMusicRecord",insertMusicLike:"/service/myMusic-getway/insertMusicLike/",deleteMusicLike:"/service/myMusic-getway/deleteMusicLike/",queryFavoriteDirectory:"/service/myMusic-getway/queryFavoriteDirectory",searchMusic:"/service/myMusic/searchMusic",getSingerCategory:"/service/myMusic/getSingerCategory",saveLike:"/service/social-getway/saveLike",deleteLike:"/service/social-getway/deleteLike",insertComment:"/service/social-getway/insertComment",getTopCommentList:"/service/social/getTopCommentList",getCommentCount:"/service/social/getCommentCount",isMusicFavorite:"/service/myMusic-getway/isMusicFavorite/",getFavoriteDirectory:"/service/myMusic-getway/getFavoriteDirectory",insertFavoriteDirectory:"/service/myMusic-getway/insertFavoriteDirectory/",insertFavoriteDirectory:"/service/myMusic-getway/insertFavoriteDirectory",insertCircle:"/service/circle-getway/insertCircle",getMusicListByFavoriteId:"/service/myMusic-getway/getMusicListByFavoriteId",getMusicAuthorCategory:"/service/myMusic/getMusicAuthorCategory",getMusicListByAuthorId:"/service/myMusic/getMusicListByAuthorId"},getKeyWordMusicService=()=>httpRequest.get(api$1.getKeywordMusic),getMusicClassifyService=()=>httpRequest.get(api$1.getMusicClassify),getMusicListByClassifyIdService=(e,t,i)=>httpRequest.get(`${api$1.getMusicListByClassifyId}?classifyId=${e}&pageNum=${t}&pageSize=${i}`),getMusicAuthorListByCategoryIdService=(e,t,i)=>httpRequest.get(`${api$1.getMusicAuthorListByCategoryId}?categoryId=${e}&pageNum=${t}&pageSize=${i}`),getCircleListByTypeService=(e,t,i)=>httpRequest.get(`${api$1.getCircleListByType}?type=${e}&pageNum=${t}&pageSize=${i}`),saveLikeService=e=>httpRequest.post(api$1.saveLike,e),deleteLikeService=(e,t)=>httpRequest.delete(`${api$1.deleteLike}?relationId=${e}&type=${t}`),getFavoriteAuthorService=(e,t)=>httpRequest.get(`${api$1.getFavoriteAuthor}?pageNum=${e}&pageSize=${t}`),getMusicRecordService=(e,t)=>httpRequest.get(`${api$1.getMusicRecord}?pageNum=${e}&pageSize=${t}`),insertMusicRecordService=e=>httpRequest.post(api$1.insertMusicRecord,e),insertMusicLikeService=e=>httpRequest.post(api$1.insertMusicLike+e),deleteMusicLikeService=e=>httpRequest.delete(api$1.deleteMusicLike+e),getTopCommentListService=(e,t,i,r)=>httpRequest.get(`${api$1.getTopCommentList}?relationId=${e}&type=${t}&pageSize=${r}&pageNum=${i}`),getCommentCountService=(e,t)=>httpRequest.get(`${api$1.getCommentCount}?relationId=${e}&type=${t}`),insertCommentService=e=>httpRequest.post(api$1.insertComment,e),isMusicFavoriteService=e=>httpRequest.get(api$1.isMusicFavorite+e),getFavoriteDirectoryService=e=>httpRequest.get(`${api$1.getFavoriteDirectory}?musicId=${e}`),insertFavoriteDirectoryService=(e,t)=>httpRequest.post(api$1.insertFavoriteDirectory+e,t),insertFavoriteDirectoryService=e=>httpRequest.post(api$1.insertFavoriteDirectory,e),searchMusicService=(e,t,i)=>httpRequest.get(`${api$1.searchMusic}?keyword=${e}&pageNum=${t}&pageSize=${i}`),saveCircleService=e=>httpRequest.post(api$1.insertCircle,e),getMusicListByFavoriteIdService=(e,t,i)=>httpRequest.get(`${api$1.getMusicListByFavoriteId}?favoriteId=${e}&pageNum=${t}&pageSize=${i}`),getMusicAuthorCategoryService=()=>httpRequest.get(api$1.getMusicAuthorCategory),insertFavoriteAuthorService=e=>httpRequest.post(`${api$1.insertFavoriteAuthor}${e}`),deleteMyLikeMusicAuthorService=e=>httpRequest.delete(`${api$1.deleteMyLikeMusicAuthor}${e}`),getMusicListByAuthorIdService=(e,t,i)=>httpRequest.get(`${api$1.getMusicListByAuthorId}?authorId=${e}&pageNum=${t}&pageSize=${i}`),useStore=defineStore("myStore",{state:()=>({userData:{},token:"",platform:"",device:"",version:"",musicItem:{},audio:uni.createInnerAudioContext(),isPlaying:!1,playMusicList:[],musicList:[],unPlayMusicList:[],classifyName:"",playIndex:-1,total:0,loop:LoopModeEnum.ORDER}),actions:{setUserData(e){this.userData=e},setDeviceInfo(e){this.platform=e.platform,this.device=e.deviceModel,this.version=e.osVersion},setToken(e){this.token=e},setMusic(e,t=!0){this.musicItem=e,this.audio.src=HOST+e.localPlayUrl,t&&(this.audio.play(),this.isPlaying=!0),this.removePlayMusic(),uni.setStorage({key:MUSIC_STORAGE_KEY,data:JSON.stringify(e)});const i={musicId:e.id,platform:this.platform,version:this.version,device:this.device};t&&insertMusicRecordService(i)},setClassifyMusic(e,t,i,r){this.musicItem=e[i],this.musicList=e,this.classifyName=r,this.playMusicList=[],this.unPlayMusicList=[...e],this.isPlaying=!0,uni.setStorage({key:MUSIC_STORAGE_KEY,data:JSON.stringify(t)}),uni.setStorage({key:MUSIC_LIST_STORAGE_KEY,data:JSON.stringify(e)}),uni.setStorage({key:MUSIC_CLASSIFY_NAME_STORAGE_KEY,data:JSON.stringify(r)}),this.audio.src=HOST+t.localPlayUrl,this.audio.play();const s={musicId:t.id,platform:this.platform,version:this.version,device:this.device};insertMusicRecordService(s)},setMusicList(e){this.musicList=e,this.unPlayMusicList=[...e],uni.setStorage({key:MUSIC_LIST_STORAGE_KEY,data:JSON.stringify(e)}),this.playIndex=this.musicList.findIndex((e=>e.id===this.musicItem.id)),this.removePlayMusic()},resetplayMusicList(){this.unPlayMusicList=[...this.musicList]},removePlayMusic(){const e=this.unPlayMusicList.findIndex((e=>e.id===this.musicItem.id));-1!==e&&this.unPlayMusicList.splice(e,1)},randomTabPrev(){let e=this.playMusicList[this.playMusicList.length-1];e?this.playMusicList.pop():e=this.musicList[this.musicList.length-1],this.setMusic(e,!0)},usePlay(e){this.isPlaying=e,this.audio[this.isPlaying?"play":"pause"]()},setMusicPlayIndex(e){this.playIndex=e,this.musicList[e]&&this.setMusic(this.musicList[e])},setLoop(e){uni.setStorage({key:LOOP_STORAGE_KEY,data:e}),this.loop=e}}}),api={getUserData:"/service/user/getUserData",getCategoryList:"/service/movie/getCategoryList",getKeyWord:"/service/movie/getKeyWord",getAllCategoryByClassify:"/service/movie/getAllCategoryByClassify",getAllCategoryListByPageName:"/service/movie/getAllCategoryListByPageName",getUserMsg:"/service/movie-getway/getUserMsg",getSearch:"/service/movie/search",login:"/service/user/login",getStar:"/service/movie/getStar",getMovieUrl:"/service/movie/getMovieUrl",getViewRecord:"/service/movie-getway/getViewRecord",saveViewRecord:"/service/movie-getway/saveViewRecord",getPlayRecord:"/service/movie-getway/getPlayRecord",savePlayRecord:"/service/movie-getway/savePlayRecord",getFavorite:"/service/movie-getway/getFavoriteList",saveFavorite:"/service/movie-getway/saveFavorite",deleteFavorite:"/service/movie-getway/deleteFavorite",getYourLikes:"/service/movie/getYourLikes",getRecommend:"/service/movie/getRecommend",isFavorite:"/service/movie-getway/isFavorite",updateUser:"/service/user-getway/updateUser",updatePassword:"/service/user-getway/updatePassword",getCommentCount:"/service/social/getCommentCount",getTopCommentList:"/service/social/getTopCommentList",getReplyCommentList:"/service/social/getReplyCommentList",insertCommentService:"/service/social-getway/insertComment",updateAvaterService:"/service/user-getway/updateAvater",register:"/service/user/register",getUserById:"/service/user/getUserById"};var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs$1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var md5Exports={},md5={get exports(){return md5Exports},set exports(e){md5Exports=e}},cryptExports={},crypt={get exports(){return cryptExports},set exports(e){cryptExports=e}},base64map,crypt$1;base64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",crypt$1={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&crypt$1.rotl(e,8)|4278255360&crypt$1.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=crypt$1.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],i=0,r=0;i<e.length;i++,r+=8)t[r>>>5]|=e[i]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],i=0;i<32*e.length;i+=8)t.push(e[i>>>5]>>>24-i%32&255);return t},bytesToHex:function(e){for(var t=[],i=0;i<e.length;i++)t.push((e[i]>>>4).toString(16)),t.push((15&e[i]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],i=0;i<e.length;i+=2)t.push(parseInt(e.substr(i,2),16));return t},bytesToBase64:function(e){for(var t=[],i=0;i<e.length;i+=3)for(var r=e[i]<<16|e[i+1]<<8|e[i+2],s=0;s<4;s++)8*i+6*s<=8*e.length?t.push(base64map.charAt(r>>>6*(3-s)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],i=0,r=0;i<e.length;r=++i%4)0!=r&&t.push((base64map.indexOf(e.charAt(i-1))&Math.pow(2,-2*r+8)-1)<<2*r|base64map.indexOf(e.charAt(i))>>>6-2*r);return t}},crypt.exports=crypt$1;var charenc={utf8:{stringToBytes:function(e){return charenc.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(charenc.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t},bytesToString:function(e){for(var t=[],i=0;i<e.length;i++)t.push(String.fromCharCode(e[i]));return t.join("")}}},charenc_1=charenc,isBuffer_1=function(e){return null!=e&&(isBuffer(e)||isSlowBuffer(e)||!!e._isBuffer)},crypt2,utf8,isBuffer2,bin,md5$1;function isBuffer(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function isSlowBuffer(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&isBuffer(e.slice(0,0))}crypt2=cryptExports,utf8=charenc_1.utf8,isBuffer2=isBuffer_1,bin=charenc_1.bin,md5$1=function(e,t){e.constructor==String?e=t&&"binary"===t.encoding?bin.stringToBytes(e):utf8.stringToBytes(e):isBuffer2(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var i=crypt2.bytesToWords(e),r=8*e.length,s=1732584193,a=-271733879,n=-1732584194,o=271733878,l=0;l<i.length;l++)i[l]=16711935&(i[l]<<8|i[l]>>>24)|4278255360&(i[l]<<24|i[l]>>>8);i[r>>>5]|=128<<r%32,i[14+(r+64>>>9<<4)]=r;var c=md5$1._ff,u=md5$1._gg,d=md5$1._hh,h=md5$1._ii;for(l=0;l<i.length;l+=16){var m=s,f=a,g=n,p=o;s=c(s,a,n,o,i[l+0],7,-680876936),o=c(o,s,a,n,i[l+1],12,-389564586),n=c(n,o,s,a,i[l+2],17,606105819),a=c(a,n,o,s,i[l+3],22,-1044525330),s=c(s,a,n,o,i[l+4],7,-176418897),o=c(o,s,a,n,i[l+5],12,1200080426),n=c(n,o,s,a,i[l+6],17,-1473231341),a=c(a,n,o,s,i[l+7],22,-45705983),s=c(s,a,n,o,i[l+8],7,1770035416),o=c(o,s,a,n,i[l+9],12,-1958414417),n=c(n,o,s,a,i[l+10],17,-42063),a=c(a,n,o,s,i[l+11],22,-1990404162),s=c(s,a,n,o,i[l+12],7,1804603682),o=c(o,s,a,n,i[l+13],12,-40341101),n=c(n,o,s,a,i[l+14],17,-1502002290),s=u(s,a=c(a,n,o,s,i[l+15],22,1236535329),n,o,i[l+1],5,-165796510),o=u(o,s,a,n,i[l+6],9,-1069501632),n=u(n,o,s,a,i[l+11],14,643717713),a=u(a,n,o,s,i[l+0],20,-373897302),s=u(s,a,n,o,i[l+5],5,-701558691),o=u(o,s,a,n,i[l+10],9,38016083),n=u(n,o,s,a,i[l+15],14,-660478335),a=u(a,n,o,s,i[l+4],20,-405537848),s=u(s,a,n,o,i[l+9],5,568446438),o=u(o,s,a,n,i[l+14],9,-1019803690),n=u(n,o,s,a,i[l+3],14,-187363961),a=u(a,n,o,s,i[l+8],20,1163531501),s=u(s,a,n,o,i[l+13],5,-1444681467),o=u(o,s,a,n,i[l+2],9,-51403784),n=u(n,o,s,a,i[l+7],14,1735328473),s=d(s,a=u(a,n,o,s,i[l+12],20,-1926607734),n,o,i[l+5],4,-378558),o=d(o,s,a,n,i[l+8],11,-2022574463),n=d(n,o,s,a,i[l+11],16,1839030562),a=d(a,n,o,s,i[l+14],23,-35309556),s=d(s,a,n,o,i[l+1],4,-1530992060),o=d(o,s,a,n,i[l+4],11,1272893353),n=d(n,o,s,a,i[l+7],16,-155497632),a=d(a,n,o,s,i[l+10],23,-1094730640),s=d(s,a,n,o,i[l+13],4,681279174),o=d(o,s,a,n,i[l+0],11,-358537222),n=d(n,o,s,a,i[l+3],16,-722521979),a=d(a,n,o,s,i[l+6],23,76029189),s=d(s,a,n,o,i[l+9],4,-640364487),o=d(o,s,a,n,i[l+12],11,-421815835),n=d(n,o,s,a,i[l+15],16,530742520),s=h(s,a=d(a,n,o,s,i[l+2],23,-995338651),n,o,i[l+0],6,-198630844),o=h(o,s,a,n,i[l+7],10,1126891415),n=h(n,o,s,a,i[l+14],15,-1416354905),a=h(a,n,o,s,i[l+5],21,-57434055),s=h(s,a,n,o,i[l+12],6,1700485571),o=h(o,s,a,n,i[l+3],10,-1894986606),n=h(n,o,s,a,i[l+10],15,-1051523),a=h(a,n,o,s,i[l+1],21,-2054922799),s=h(s,a,n,o,i[l+8],6,1873313359),o=h(o,s,a,n,i[l+15],10,-30611744),n=h(n,o,s,a,i[l+6],15,-1560198380),a=h(a,n,o,s,i[l+13],21,1309151649),s=h(s,a,n,o,i[l+4],6,-145523070),o=h(o,s,a,n,i[l+11],10,-1120210379),n=h(n,o,s,a,i[l+2],15,718787259),a=h(a,n,o,s,i[l+9],21,-343485551),s=s+m>>>0,a=a+f>>>0,n=n+g>>>0,o=o+p>>>0}return crypt2.endian([s,a,n,o])},md5$1._ff=function(e,t,i,r,s,a,n){var o=e+(t&i|~t&r)+(s>>>0)+n;return(o<<a|o>>>32-a)+t},md5$1._gg=function(e,t,i,r,s,a,n){var o=e+(t&r|i&~r)+(s>>>0)+n;return(o<<a|o>>>32-a)+t},md5$1._hh=function(e,t,i,r,s,a,n){var o=e+(t^i^r)+(s>>>0)+n;return(o<<a|o>>>32-a)+t},md5$1._ii=function(e,t,i,r,s,a,n){var o=e+(i^(t|~r))+(s>>>0)+n;return(o<<a|o>>>32-a)+t},md5$1._blocksize=16,md5$1._digestsize=16,md5.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var i=crypt2.wordsToBytes(md5$1(e,t));return t&&t.asBytes?i:t&&t.asString?bin.bytesToString(i):crypt2.bytesToHex(i)};const getKeyWordService=e=>httpRequest.get(api.getKeyWord,{classify:e}),getUserDataService=e=>(httpRequest.setToken(e),httpRequest.get(api.getUserData)),getCategoryListService=e=>httpRequest.get(api.getCategoryList,e),getAllCategoryListByPageNameService=e=>httpRequest.get(api.getAllCategoryListByPageName,{pageName:e}),getUserMsgService=()=>httpRequest.get(api.getUserMsg),getPlayRecordMovieListService=(e,t)=>httpRequest.get(`${api.getPlayRecord}?pageNum=${e}&pageSize=${t}`),getMyFavoriteMovieListService=(e,t)=>httpRequest.get(`${api.getFavorite}?pageNum=${e}&pageSize=${t}`),getMyViewsMovieListService=(e,t)=>httpRequest.get(`${api.getViewRecord}?pageNum=${e}&pageSize=${t}`),getMovieStartListService=e=>httpRequest.get(`${api.getStar}/${e}`),getRecommentListService=e=>httpRequest.get(`${api.getRecommend}?classify=${e}`),saveViewRecordService=e=>httpRequest.post(api.saveViewRecord,e),getMovieUrlService=e=>httpRequest.get(`${api.getMovieUrl}?movieId=${e}`),isFavoriteService=e=>httpRequest.get(`${api.isFavorite}?movieId=${e}`),saveFavoriteService=e=>httpRequest.post(`${api.saveFavorite}/${e}`),deleteFavoriteService=e=>httpRequest.delete(`${api.deleteFavorite}/${e}`),savePlayRecordService=e=>httpRequest.post(api.savePlayRecord,e),updateUserDataService=e=>httpRequest.put(api.updateUser,e),loginService=(e,t)=>(t=md5Exports(t),httpRequest.post(api.login,{userId:e,password:t})),registerService=e=>(e.password=md5Exports(e.password),httpRequest.put(api.register,e)),getUserByIdService=e=>httpRequest.get(`${api.getUserById}?userId=${e}`),getRecommendService=e=>httpRequest.get(`${api.getRecommend}?classify=${e}`),getSearchService=(e,t,i)=>httpRequest.get(`${api.getSearch}?keyword=${e}&pageNum=${t}&pageSize=${i}`),_sfc_main$P=vue.defineComponent({__name:"LaunchPage",setup(e){const t=useStore(),i=uni.getStorageSync("token");return uni.getSystemInfo({success:e=>{t.setDeviceInfo(e)}}),setTimeout((()=>{i?getUserDataService(i).then((e=>{t.setUserData(e.data),t.setToken(e.token),uni.setStorage({key:"token",data:e.token}),httpRequest.setToken(e.token),uni.redirectTo({url:"../pages/IndexPage"})})):uni.redirectTo({url:"../pages/MovieLoginPage"})}),1e3),(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createElementVNode("text",null,"欢迎使用")]))}}),_export_sfc=(e,t)=>{const i=e.__vccOpts||e;for(const[r,s]of t)i[r]=s;return i},MoviePagesLaunchPage=_export_sfc(_sfc_main$P,[["__scopeId","data-v-017c6526"]]),_sfc_main$O=vue.defineComponent({__name:"SwiperComponent",props:{classify:{type:String,require:!0,default:""}},setup(e){const t=e,i=vue.reactive([]);return vue.onMounted((()=>{getCategoryListService({classify:t.classify,category:"轮播"}).then((e=>{i.push(...e.data.slice(0,5))}))})),(e,t)=>(vue.openBlock(),vue.createElementBlock("swiper",{class:"swiper-wrapper","indicator-dots":"",autoplay:"true",interval:"5000",duration:"500","indicator-active-color":"#ffae00",circular:"true"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(i,(e=>(vue.openBlock(),vue.createElementBlock("swiper-item",{class:"swiper-item",key:e.id},[vue.createElementVNode("image",{mode:"aspectFill",class:"swiper-item",src:vue.unref(HOST)+e.localImg},null,8,["src"])])))),128))]))}}),SwiperComponent=_export_sfc(_sfc_main$O,[["__scopeId","data-v-2088506c"]]),_sfc_main$N=vue.defineComponent({__name:"TitleComponent",props:{title:{type:String,require:!0,default:""}},setup:e=>(t,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"title-wrapper"},[vue.createElementVNode("view",{class:"title-line"}),vue.createElementVNode("text",{class:"title-text"},vue.toDisplayString(e.title),1)]))}),TitleComponent=_export_sfc(_sfc_main$N,[["__scopeId","data-v-9549eb6e"]]),_sfc_main$M=vue.defineComponent({__name:"MovieListComponent",props:{list:{type:Array,reqiure:!0,default:[]},direction:{type:String,reqiure:!0,default:"horizontal"}},setup(e){const{list:t}=e,i=t,r=e=>{uni.navigateTo({url:`../pages/MovieDetailPage?data=${encodeURIComponent(JSON.stringify(e))}`})};return(t,s)=>(vue.openBlock(),vue.createElementBlock("view",null,["horizontal"===e.direction?(vue.openBlock(),vue.createElementBlock("scroll-view",{key:0,"scroll-x":"","show-scrollbar":"false",class:"scroll-view"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(vue.unref(i),(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"scroll-view-item",key:e.id},[vue.createElementVNode("view",{class:"movie-item-wrapper",onClick:t=>r(e)},[vue.createElementVNode("image",{class:"movie-img",src:vue.unref(HOST)+e.localImg},null,8,["src"]),vue.createElementVNode("text",{class:"movie-name"},vue.toDisplayString(e.movieName),1)],8,["onClick"])])))),128))])):(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"grid-wrapper"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(vue.unref(i),(e=>(vue.openBlock(),vue.createElementBlock("view",{key:e.id,class:"movie-item-wrapper",onClick:t=>r(e)},[vue.createElementVNode("image",{class:"movie-img",src:vue.unref(HOST)+e.localImg},null,8,["src"]),vue.createElementVNode("text",{class:"movie-name"},vue.toDisplayString(e.movieName),1)],8,["onClick"])))),128))]))]))}}),MovieListComponent=_export_sfc(_sfc_main$M,[["__scopeId","data-v-dc6c1a52"]]),_sfc_main$L=vue.defineComponent({__name:"CategoryComponent",props:{classifyItem:{type:Object,reqiure:!0,default:{}}},setup(e){const t=e,i=vue.reactive([]);return getCategoryListService(t.classifyItem).then((e=>{i.push(...e.data)})),(t,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:"module-block"},[vue.createVNode(vue.unref(TitleComponent),{title:e.classifyItem.category},null,8,["title"]),vue.createVNode(vue.unref(MovieListComponent),{direction:"horizontal",list:i},null,8,["list"])]))}}),CategoryComponent=_export_sfc(_sfc_main$L,[["__scopeId","data-v-32cf6008"]]),defaulAvater="/assets/default_avater.f4259db5.png",_sfc_main$K=vue.defineComponent({__name:"AvaterComponent",props:{size:{type:String,reqiure:!0,default:"middle"}},setup(e){const t=useStore(),i={middle:"user-avater-middle",big:"user-avater-big"},r=()=>{uni.navigateTo({url:"../pages/MovieUserPage"})};return(s,a)=>(vue.openBlock(),vue.createElementBlock("image",{onClick:r,class:vue.normalizeClass(["user-avater",i[e.size]]),src:vue.unref(t).userData.avater?vue.unref(HOST)+vue.unref(t).userData.avater:vue.unref(defaulAvater)},null,10,["src"]))}}),AvaterComponent=_export_sfc(_sfc_main$K,[["__scopeId","data-v-a732ec42"]]),_sfc_main$J=vue.defineComponent({__name:"SearchComponent",props:{classify:{type:String,reqiure:!0,default:""}},setup(e){const{classify:t}=e,i=vue.ref(""),r=()=>{uni.navigateTo({url:`../pages/MovieSearchPage?classify=${encodeURIComponent(t)}&keyword=${i.value}`})};return vue.onMounted((()=>{getKeyWordService(t).then((e=>i.value=e.data.movieName))})),(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"search-wrapper module-block"},[vue.createVNode(vue.unref(AvaterComponent),{size:"middle"}),vue.createElementVNode("view",{class:"search-input-wrapper",onClick:r},[vue.createElementVNode("text",{class:"search-input-placehold"},vue.toDisplayString(i.value),1)])]))}}),SearchComponent=_export_sfc(_sfc_main$J,[["__scopeId","data-v-593013ca"]]),_sfc_main$I=vue.defineComponent({__name:"HomeComponent",setup(e){const t=vue.reactive([]);return vue.onMounted((()=>{getAllCategoryListByPageNameService("首页").then((e=>t.push(...e.data)))})),(e,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createVNode(vue.unref(SearchComponent),{classify:"电影"}),vue.createVNode(vue.unref(SwiperComponent),{classify:"电影"}),vue.createElementVNode("view",{class:"classify-wrapper module-block"},[vue.createElementVNode("view",{class:"classify-item"},[vue.createElementVNode("image",{class:"classify-img",src:"/static/icon_hot.png"}),vue.createElementVNode("text",{class:"classify-text"},"热门")]),vue.createElementVNode("view",{class:"classify-item"},[vue.createElementVNode("image",{class:"classify-img",src:"/static/icon_play.png"}),vue.createElementVNode("text",{class:"classify-text"},"预告")]),vue.createElementVNode("view",{class:"classify-item"},[vue.createElementVNode("image",{class:"classify-img",src:"/static/icon_top.png"}),vue.createElementVNode("text",{class:"classify-text"},"最新")]),vue.createElementVNode("view",{class:"classify-item"},[vue.createElementVNode("image",{class:"classify-img",src:"/static/icon_classify.png"}),vue.createElementVNode("text",{class:"classify-text"},"分类")])]),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(t,(e=>(vue.openBlock(),vue.createBlock(vue.unref(CategoryComponent),{key:e.category,classifyItem:e},null,8,["classifyItem"])))),128))]))}}),HomeComponent=_export_sfc(_sfc_main$I,[["__scopeId","data-v-7dd57fe0"]]),_sfc_main$H=vue.defineComponent({__name:"MovieComponent",setup(e){const t=vue.reactive([]);return vue.onMounted((()=>{getAllCategoryListByPageNameService("电影").then((e=>t.push(...e.data)))})),(e,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"movie-wrapper"},[vue.createVNode(vue.unref(SearchComponent),{classify:"电影"}),vue.createVNode(vue.unref(SwiperComponent),{classify:"电影"}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(t,(e=>(vue.openBlock(),vue.createBlock(vue.unref(CategoryComponent),{key:e.category,classifyItem:e},null,8,["classifyItem"])))),128))]))}}),_sfc_main$G=vue.defineComponent({__name:"TVComponent",setup(e){const t=vue.reactive([]);return vue.onMounted((()=>{getAllCategoryListByPageNameService("电视剧").then((e=>t.push(...e.data)))})),(e,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"tv-wrapper"},[vue.createVNode(vue.unref(SearchComponent),{classify:"电视剧"}),vue.createVNode(vue.unref(SwiperComponent),{classify:"电视剧"}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(t,(e=>(vue.openBlock(),vue.createBlock(vue.unref(CategoryComponent),{key:e.category,classifyItem:e},null,8,["classifyItem"])))),128))]))}}),_sfc_main$F=vue.defineComponent({__name:"MyComponent",setup(e){const t=vue.ref(!0),i=vue.ref(!1),r=vue.ref(!1),s=vue.ref(!1),a=vue.reactive([]),n=vue.reactive([]),o=vue.reactive([]),l=useStore(),c=vue.reactive({userAge:0,favoriteCount:0,playRecordCount:0,viewRecordCount:0}),u=()=>{s.value||(t.value=!t.value,t.value&&(s.value=!0,a.splice(0,a.length),getPlayRecordMovieListService(1,20).then((e=>a.push(...e.data))).finally((()=>s.value=!1))))},d=()=>{s.value||(i.value=!i.value,i.value&&(s.value=!0,n.splice(0,n.length),getMyFavoriteMovieListService(1,20).then((e=>n.push(...e.data))).finally((()=>s.value=!1))))},h=()=>{s.value||(r.value=!r.value,r.value&&(s.value=!0,o.splice(0,o.length),getMyViewsMovieListService(1,20).then((e=>o.push(...e.data))).finally((()=>s.value=!1))))},m=()=>{uni.navigateTo({url:"../../music/pages/MusicIndexPage"})},f=()=>{uni.navigateTo({url:"../pages/MovieUserPage"})};return vue.onMounted((()=>{getUserMsgService().then((e=>Object.assign(c,e.data))),getPlayRecordMovieListService(1,20).then((e=>a.push(...e.data)))})),(e,s)=>(vue.openBlock(),vue.createElementBlock("view",{class:"my-wrapper"},[vue.createElementVNode("view",{class:"user-wrapper module-block"},[vue.createVNode(vue.unref(AvaterComponent),{size:"big"}),vue.createElementVNode("view",{class:"user-name-wrapper"},[vue.createElementVNode("text",{class:"user-name"},vue.toDisplayString(vue.unref(l).userData.username),1),vue.createElementVNode("text",{class:"user-sign"},vue.toDisplayString(vue.unref(l).userData.sign),1)]),vue.createElementVNode("image",{onClick:f,class:"icon-edit",src:"/static/icon_edit.png"})]),vue.createElementVNode("view",{class:"user-msg-wrapper module-block"},[vue.createElementVNode("view",{class:"user-msg-item"},[vue.createElementVNode("text",{class:"user-msg-count"},vue.toDisplayString(c.userAge),1),vue.createElementVNode("text",{class:"user-msg-title"},"使用天数")]),vue.createElementVNode("view",{class:"user-msg-item"},[vue.createElementVNode("text",{class:"user-msg-count"},vue.toDisplayString(c.favoriteCount),1),vue.createElementVNode("text",{class:"user-msg-title"},"收藏")]),vue.createElementVNode("view",{class:"user-msg-item"},[vue.createElementVNode("text",{class:"user-msg-count"},vue.toDisplayString(c.playRecordCount),1),vue.createElementVNode("text",{class:"user-msg-title"},"观看记录")]),vue.createElementVNode("view",{class:"user-msg-item"},[vue.createElementVNode("text",{class:"user-msg-count"},vue.toDisplayString(c.viewRecordCount),1),vue.createElementVNode("text",{class:"user-msg-title"},"浏览记录")])]),vue.createElementVNode("view",{class:"play-record-view module-block"},[vue.createElementVNode("view",{class:"title-wrapper",onClick:u},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_play_record.png"}),vue.createElementVNode("text",{class:"title-text"},"观看记录"),vue.createElementVNode("image",{class:vue.normalizeClass(["icon-arrow",{"icon-arrow-rotate":t.value}]),src:"/static/icon_arrow.png"},null,2)]),a.length>0&&t.value?(vue.openBlock(),vue.createBlock(vue.unref(MovieListComponent),{key:0,direction:"horizontal",list:a,class:vue.normalizeClass({"scroll-view-margin":a.length>0})},null,8,["list","class"])):vue.createCommentVNode("",!0)]),vue.createElementVNode("view",{class:"module-block"},[vue.createElementVNode("view",{class:"title-wrapper",onClick:d},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_collection.png"}),vue.createElementVNode("text",{class:"title-text"},"我的收藏"),vue.createElementVNode("image",{class:vue.normalizeClass(["icon-arrow",{"icon-arrow-rotate":i.value}]),src:"/static/icon_arrow.png"},null,2)]),n.length>0&&i.value?(vue.openBlock(),vue.createBlock(vue.unref(MovieListComponent),{key:0,direction:"horizontal",list:n,class:vue.normalizeClass({"scroll-view-margin":n.length>0})},null,8,["list","class"])):vue.createCommentVNode("",!0)]),vue.createElementVNode("view",{class:"module-block"},[vue.createElementVNode("view",{class:"title-wrapper",onClick:h},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_record.png"}),vue.createElementVNode("text",{class:"title-text"},"我浏览过的电影"),vue.createElementVNode("image",{class:vue.normalizeClass(["icon-arrow",{"icon-arrow-rotate":r.value}]),src:"/static/icon_arrow.png"},null,2)]),o.length>0&&r.value?(vue.openBlock(),vue.createBlock(vue.unref(MovieListComponent),{key:0,direction:"horizontal",list:o,class:vue.normalizeClass({"scroll-view-margin":n.length>0})},null,8,["list","class"])):vue.createCommentVNode("",!0)]),vue.createElementVNode("view",{class:"module-block"},[vue.createElementVNode("view",{class:"title-wrapper title-wrapper-pading",onClick:m},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_music.png"}),vue.createElementVNode("text",{class:"title-text"},"音乐"),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"title-wrapper title-wrapper-pading"},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_music_circle.png"}),vue.createElementVNode("text",{class:"title-text"},"电影圈"),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"title-wrapper title-wrapper-pading"},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_app.png"}),vue.createElementVNode("text",{class:"title-text"},"小程序"),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})])])]))}}),MyComponent=_export_sfc(_sfc_main$F,[["__scopeId","data-v-2491fe42"]]),_sfc_main$E=vue.defineComponent({__name:"IndexPage",setup(e){const t=vue.ref(0),i=vue.reactive([!0,!1,!1,!1]),r=e=>{t.value=e,!i[e]&&i.splice(e,1,!0)};return(e,s)=>(vue.openBlock(),vue.createElementBlock("view",{class:"index-wrapper"},[vue.createElementVNode("view",{class:"page-container"},[vue.createVNode(HomeComponent,{style:vue.normalizeStyle({display:0===t.value?"block":"none"})},null,8,["style"]),i[1]?(vue.openBlock(),vue.createBlock(_sfc_main$H,{key:0,style:vue.normalizeStyle({display:1===t.value?"block":"none"})},null,8,["style"])):vue.createCommentVNode("",!0),i[2]?(vue.openBlock(),vue.createBlock(_sfc_main$G,{key:1,style:vue.normalizeStyle({display:2===t.value?"block":"none"})},null,8,["style"])):vue.createCommentVNode("",!0),i[3]?(vue.openBlock(),vue.createBlock(MyComponent,{key:2,style:vue.normalizeStyle({display:3===t.value?"block":"none"})},null,8,["style"])):vue.createCommentVNode("",!0)]),vue.createElementVNode("view",{class:"tab-bar"},[vue.createElementVNode("view",{class:"tab-item",onClick:s[0]||(s[0]=e=>r(0))},[0===t.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_home_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_home.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":0===t.value}])},"首页",2)]),vue.createElementVNode("view",{class:"tab-item",onClick:s[1]||(s[1]=e=>r(1))},[1===t.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_movie_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_movie.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":1===t.value}])},"电影",2)]),vue.createElementVNode("view",{class:"tab-item",onClick:s[2]||(s[2]=e=>r(2))},[2===t.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_tv_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_tv.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":2===t.value}])},"电视剧",2)]),vue.createElementVNode("view",{class:"tab-item",onClick:s[3]||(s[3]=e=>r(3)),"data-index":"3"},[3===t.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_user_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_user.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":3===t.value}])},"我的",2)])])]))}}),MoviePagesIndexPage=_export_sfc(_sfc_main$E,[["__scopeId","data-v-01b9c016"]]);
/*!
    * vue-router v4.2.5
    * (c) 2023 Eduardo San Martin Morote
    * @license MIT
    */
var NavigationType,NavigationType2,NavigationDirection,NavigationDirection2,NavigationFailureType,NavigationFailureType2;NavigationType2=NavigationType||(NavigationType={}),NavigationType2.pop="pop",NavigationType2.push="push",NavigationDirection2=NavigationDirection||(NavigationDirection={}),NavigationDirection2.back="back",NavigationDirection2.forward="forward",NavigationDirection2.unknown="",NavigationFailureType2=NavigationFailureType||(NavigationFailureType={}),NavigationFailureType2[NavigationFailureType2.aborted=4]="aborted",NavigationFailureType2[NavigationFailureType2.cancelled=8]="cancelled",NavigationFailureType2[NavigationFailureType2.duplicated=16]="duplicated";const routeLocationKey=Symbol("");function useRoute(){return vue.inject(routeLocationKey)}const _sfc_main$D={name:"UniRate",props:{isFill:{type:[Boolean,String],default:!0},color:{type:String,default:"#ececec"},activeColor:{type:String,default:"#ffca3e"},disabledColor:{type:String,default:"#c0c0c0"},size:{type:[Number,String],default:24},value:{type:[Number,String],default:0},modelValue:{type:[Number,String],default:0},max:{type:[Number,String],default:5},margin:{type:[Number,String],default:0},disabled:{type:[Boolean,String],default:!1},readonly:{type:[Boolean,String],default:!1},allowHalf:{type:[Boolean,String],default:!1},touchable:{type:[Boolean,String],default:!0}},data:()=>({valueSync:"",userMouseFristMove:!0,userRated:!1,userLastRate:1}),watch:{value(e){this.valueSync=Number(e)},modelValue(e){this.valueSync=Number(e)}},computed:{stars(){const e=this.valueSync?this.valueSync:0,t=[],i=Math.floor(e),r=Math.ceil(e);for(let s=0;s<this.max;s++)i>s?t.push({activeWitch:"100%"}):r-1===s?t.push({activeWitch:100*(e-i)+"%"}):t.push({activeWitch:"0"});return t},marginNumber(){return Number(this.margin)}},created(){this.valueSync=Number(this.value||this.modelValue),this._rateBoxLeft=0,this._oldValue=null},mounted(){setTimeout((()=>{this._getSize()}),100)},methods:{touchstart(e){if(this.readonly||this.disabled)return;const{clientX:t,screenX:i}=e.changedTouches[0];this._getRateCount(t||i)},touchmove(e){if(this.readonly||this.disabled||!this.touchable)return;const{clientX:t,screenX:i}=e.changedTouches[0];this._getRateCount(t||i)},mousedown(e){},mousemove(e){},mouseleave(e){},_getRateCount(e){const t=this;this._getSize((function(){const i=Number(t.size);if(isNaN(i))return new Error("size 属性只能设置为数字");const r=e-t._rateBoxLeft;let s=parseInt(r/(i+t.marginNumber));s=s<0?0:s,s=s>t.max?t.max:s;const a=parseInt(r-(i+t.marginNumber)*s);let n=0;(t._oldValue!==s||t.PC)&&(t._oldValue=s,n=t.allowHalf?a>i/2?s+1:s+.5:s+1,n=Math.max(.5,Math.min(n,t.max)),t.valueSync=n,t._onChange())}))},_onChange(){this.$emit("input",this.valueSync),this.$emit("update:modelValue",this.valueSync),this.$emit("change",{value:this.valueSync})},_getSize(e){uni.createSelectorQuery().in(this).select(".uni-rate").boundingClientRect().exec((t=>{t&&(this._rateBoxLeft=t[0].left,e&&e())}))}}};function _sfc_render$7(e,t,i,r,s,a){const n=vue.resolveComponent("uni-icons");return vue.openBlock(),vue.createElementBlock("view",null,[vue.createElementVNode("view",{ref:"uni-rate",class:"uni-rate"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.stars,((e,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:vue.normalizeClass(["uni-rate__icon",{"uni-cursor-not-allowed":i.disabled}]),style:vue.normalizeStyle({"margin-right":a.marginNumber+"px"}),key:r,onTouchstart:t[0]||(t[0]=vue.withModifiers(((...e)=>a.touchstart&&a.touchstart(...e)),["stop"])),onTouchmove:t[1]||(t[1]=vue.withModifiers(((...e)=>a.touchmove&&a.touchmove(...e)),["stop"])),onMousedown:t[2]||(t[2]=vue.withModifiers(((...e)=>a.mousedown&&a.mousedown(...e)),["stop"])),onMousemove:t[3]||(t[3]=vue.withModifiers(((...e)=>a.mousemove&&a.mousemove(...e)),["stop"])),onMouseleave:t[4]||(t[4]=(...e)=>a.mouseleave&&a.mouseleave(...e))},[vue.createVNode(n,{color:i.color,size:i.size,type:i.isFill?"star-filled":"star"},null,8,["color","size","type"]),vue.createElementVNode("view",{style:vue.normalizeStyle({width:e.activeWitch}),class:"uni-rate__icon-on"},[vue.createVNode(n,{color:i.disabled?i.disabledColor:i.activeColor,size:i.size,type:"star-filled"},null,8,["color","size"])],4)],38)))),128))],512)])}const uniRate=_export_sfc(_sfc_main$D,[["render",_sfc_render$7],["__scopeId","data-v-e457d973"]]),_sfc_main$C=vue.defineComponent({__name:"ScoreComponent",props:{score:{type:[Number,String],reqiure:!0,default:0}},setup:e=>(t,i)=>e.score?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"score-wrapper"},[vue.createVNode(uniRate,{touchable:!1,value:e.score/2},null,8,["value"]),vue.createElementVNode("text",{class:"score-text"},vue.toDisplayString(e.score),1)])):vue.createCommentVNode("",!0)}),ScoreComponent=_export_sfc(_sfc_main$C,[["__scopeId","data-v-ba9c7544"]]),_sfc_main$B=vue.defineComponent({__name:"MovieDetailPage",setup(e){const t=vue.reactive({}),i=vue.reactive([]),r=vue.reactive([]),s=()=>{uni.navigateTo({url:`../pages/MoviePlayPage?data=${encodeURIComponent(JSON.stringify(t))}`})};return vue.onMounted((()=>{const e=useRoute(),s=decodeURIComponent(e.query.data);Object.assign(t,JSON.parse(s)),t.id=16575,getMovieStartListService(t.id).then((e=>i.push(...e.data))),getRecommentListService(t.classify).then((e=>r.push(...e.data))),saveViewRecordService(t)})),(e,a)=>{var n;return t.id?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"page-wrapper"},[vue.createElementVNode("scroll-view",{"scroll-y":""},[vue.createElementVNode("view",{class:"module-block module-block-row"},[vue.createElementVNode("view",{class:"movie-img-wrapper",onClick:s,style:vue.normalizeStyle({backgroundImage:"url("+vue.unref(HOST)+t.localImg+")"})},[vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_detail_play.png"})],4),vue.createElementVNode("view",{class:"movie-name-wrapper"},[vue.createElementVNode("text",{class:"movie-name"},vue.toDisplayString(t.movieName),1),vue.createElementVNode("text",{class:"movie-description"},vue.toDisplayString(null==(n=t.description)?void 0:n.replace(/\n\s/g,"")),1),vue.createElementVNode("text",{class:"movie-description"},vue.toDisplayString(t.star),1),vue.createElementVNode("text",{class:"movie-description"},vue.toDisplayString(t.type),1),vue.createVNode(ScoreComponent,{score:t.score},null,8,["score"])])]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(TitleComponent,{title:"剧情"}),vue.createElementVNode("text",{class:"plot"},vue.toDisplayString(t.plot),1)]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(TitleComponent,{title:"演员"}),i.length>0?(vue.openBlock(),vue.createElementBlock("scroll-view",{key:0,"scroll-x":"","show-scrollbar":"false",class:"scroll-view"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(i,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"scroll-view-item",key:e.id},[vue.createElementVNode("view",{class:"movie-item-wrapper"},[vue.createElementVNode("image",{class:"movie-img",src:vue.unref(HOST)+e.localImg},null,8,["src"]),vue.createElementVNode("text",{class:"movie-name"},vue.toDisplayString(e.starName),1)])])))),128))])):vue.createCommentVNode("",!0)]),vue.createElementVNode("view",{class:"module-block module-block-last"},[vue.createVNode(TitleComponent,{title:"推荐"}),vue.createVNode(MovieListComponent,{direction:"horizontal",list:r},null,8,["list"])])])])):vue.createCommentVNode("",!0)}}}),MoviePagesMovieDetailPage=_export_sfc(_sfc_main$B,[["__scopeId","data-v-7c6134c8"]]);var muiPlayer_minExports={},muiPlayer_min={get exports(){return muiPlayer_minExports},set exports(e){muiPlayer_minExports=e}};
/*!
  * Mui Player Javascript Library v1.8.1 @Professional edition
  * Date：2023-01-28
  * Released under GPL-3.0 license
  * https://muiplayer.js.org/
  */
(function(module,exports){function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0;return{s:t=function(){},n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,n=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){n=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(n)throw s}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(i="Object"===i&&e.constructor?e.constructor.name:i)||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var e2,t2;e2=window,t2=function(){var MuiPlayer=function MuiPlayer(config){var _this=this;_this._global_={};var webpagePlugin="",mobilePlugin="",hls=null,flv=null,option=config||{},plugins=option.plugins||[];this._event_={};var con="string"==typeof option.container?document.querySelector(option.container):option.container,$CONSTANT,$habit,$node,$global,element,$el,variable,$data,$method;con&&($CONSTANT={unitLengthReg:/^(auto|inherit|initial|\d+(\.\d+)?(\%|px|cm|mm|em|rem|vw|vh|)?)$/i,encodeKey:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"},$habit={themeColor:"#1e98d4"},$node={video:'\x3c!-- HTML5 Video --\x3e<div class="video-wrapper"><video width="100%" height="100%"></video></div>',mplayerPoster:'<div class="mplayer-poster" id="mplayer-poster"></div>',mplayerCover:'\x3c!-- 媒体播放遮罩层 --\x3e<div class="mplayer-cover" id="mplayer-cover"></div>',mplayerLoading:'\x3c!-- Mplayer加载Loading --\x3e<div class="mplayer-loading"id="mplayer-loading"control><svg viewBox="25 25 50 50"class="mplayer-loading__circular"><circle cx="50"cy="50"r="20"fill="none"></circle></svg></div>',mplayerError:'\x3c!-- 视频加载错误显示 --\x3e<div class="mplayer-error"id="mplayer-error"control><div class="errop-tip">视频加载失败，点击刷新</div><svg t="1575125481608"class="icon"viewBox="0 0 1024 1024"version="1.1"xmlns="http://www.w3.org/2000/svg"p-id="5893"width="28"height="28"><path d="M513.34 831.74C337.03 831.74 193.6 688.31 193.6 512c0-71.09 23.31-138.85 65.53-194.03v51.61c0 17.67 14.33 32 32 32s32-14.33 32-32V239.45c0-5.87-1.59-11.36-4.34-16.09-0.06-0.1-0.11-0.2-0.17-0.3-0.16-0.28-0.34-0.55-0.51-0.82-0.13-0.2-0.26-0.41-0.39-0.61-0.08-0.13-0.17-0.25-0.26-0.37a35.5 35.5 0 0 0-1.58-2.13c-6.81-8.35-16.96-12.35-26.95-11.69h-130c-17.67 0-32 14.33-32 32s14.33 32 32 32h55.35C159.8 339 129.6 423.35 129.6 512c0 51.79 10.15 102.05 30.17 149.38 19.33 45.7 46.99 86.74 82.23 121.97 35.23 35.23 76.27 62.9 121.97 82.23 47.33 20.02 97.59 30.17 149.38 30.17 17.67 0 32-14.33 32-32s-14.34-32.01-32.01-32.01zM855.38 762.3h-51.23c19.81-23 36.93-48.3 50.75-75.22 27.6-53.74 42.18-114.28 42.18-175.08 0-51.79-10.15-102.05-30.17-149.38-19.33-45.7-46.99-86.73-82.23-121.97-35.23-35.23-76.27-62.9-121.97-82.23-47.33-20.02-97.59-30.17-149.38-30.17-17.67 0-32 14.33-32 32s14.33 32 32 32c176.31 0 319.74 143.44 319.74 319.74 0 78.31-27.68 151.61-77.6 209.05l0.24-56.04c0.08-17.67-14.19-32.06-31.86-32.14h-0.14c-17.61 0-31.92 14.24-32 31.86l-0.55 129.43a31.988 31.988 0 0 0 9.32 22.71 31.68 31.68 0 0 0 5.33 4.3c0.02 0.01 0.04 0.02 0.06 0.04 0.48 0.31 0.97 0.61 1.47 0.89l0.15 0.09c0.5 0.28 1 0.54 1.51 0.8 0.03 0.01 0.05 0.03 0.08 0.04 1.64 0.8 3.34 1.46 5.1 1.98 0.01 0 0.02 0.01 0.03 0.01 0.55 0.16 1.1 0.3 1.66 0.43 0.07 0.02 0.15 0.03 0.22 0.05 0.5 0.11 1 0.21 1.5 0.3 0.1 0.02 0.2 0.04 0.3 0.05 0.48 0.08 0.96 0.15 1.44 0.21 0.11 0.01 0.23 0.03 0.34 0.04 0.48 0.05 0.95 0.09 1.43 0.12l0.34 0.03c0.53 0.03 1.07 0.04 1.61 0.05h132.31c17.67 0 32-14.33 32-32s-14.31-31.99-31.98-31.99z"p-id="5894"fill="#ffffff"></path></svg></div>',mplayerHeader:'\x3c!-- Mplayer 顶部导航 --\x3e<div class="mplayer-header"id="mplayer-header"><div class="title-groupt"id="title-groupt"><button class="player-btn header-control back-button keyboard-input"id="back-button"control><svg id="back-icon-svg"t="1573891955387"viewBox="0 0 1024 1024"version="1.1"xmlns="http://www.w3.org/2000/svg"p-id="4550"width="18"height="18"><path d="M305.519192 557.640404c-11.636364 0-23.40202-4.39596-32.323232-13.317172-17.842424-17.842424-17.842424-46.674747 0-64.517171L683.830303 69.30101c17.842424-17.842424 46.674747-17.842424 64.517172 0 17.842424 17.842424 17.842424 46.674747 0 64.517172L337.713131 544.323232c-8.921212 8.921212-20.557576 13.317172-32.193939 13.317172z m0 0"fill="#ffffff"p-id="4551"></path><path d="M715.894949 968.145455c-11.636364 0-23.40202-4.39596-32.323232-13.317172L273.19596 544.323232c-17.842424-17.842424-17.842424-46.674747 0-64.517171 17.842424-17.842424 46.674747-17.842424 64.517171 0l410.505051 410.50505c17.842424 17.842424 17.842424 46.674747 0 64.517172-8.921212 8.921212-20.557576 13.317172-32.323233 13.317172z m0 0"fill="#ffffff"p-id="4552"></path></svg><div class="title-name"id="title-name"></div></button></div><div class="buttom-group"id="buttom-group"></div></div>',mplayerFooter:'\x3c!-- Mplayer 底部操作控件 --\x3e<div class="mplayer-footer"id="mplayer-footer"><div class="progress"id="progress"><div class="left-part"id="left-part"><button class="player-btn keyboard-input play-switch footer-control"id="play-switch"control>\x3c!--play button--\x3e<div class="_play"><svg t="1574051894346"viewBox="0 0 1024 1024"version="1.1"xmlns="http://www.w3.org/2000/svg"p-id="1212"><path d="M324.085 95.787l500.422 300.664c82.373 50.453 79.284 136.946-1.030 186.37v0l-506.6 304.784c-41.187 23.683-87.522 37.068-131.798 9.267-36.037-22.653-46.335-58.691-46.335-97.819v-616.774c0-39.127 13.386-75.166 48.395-97.819 45.305-27.801 94.731-14.416 136.946 11.327v0z"p-id="1213"fill="#ffffff"></path></svg></div>\x3c!--pause button--\x3e<div class="_pause"style="display: none;"><svg t="1574051952939"viewBox="0 0 1024 1024"version="1.1"xmlns="http://www.w3.org/2000/svg"p-id="1434"><path d="M248.26311111 515.072c0-110.592-0.22755555-221.184 0.11377778-331.776 0.11377778-35.84 18.20444445-60.87111111 49.26577778-70.99733333 27.53422222-8.87466667 56.88888889 0.34133333 75.32088888 23.77955555 10.58133333 13.42577778 15.13244445 28.89955555 15.01866667 45.96622223-0.11377778 223.11822222 0.11377778 446.23644445-0.22755555 669.35466666-0.11377778 42.55288889-31.06133333 73.27288889-70.54222222 72.81777778-39.25333333-0.45511111-68.72177778-31.51644445-68.94933334-74.52444444-0.34133333-111.50222222 0-223.11822222 0-334.62044445zM638.52088889 516.66488889V193.64977778c0-52.45155555 27.42044445-85.21955555 70.54222222-84.65066667 42.43911111 0.56888889 69.17688889 32.42666667 69.17688889 83.05777778 0.11377778 218.22577778 0.11377778 436.56533333 0 654.79111111 0 38.34311111-17.29422222 63.60177778-49.152 73.95555555-27.648 8.98844445-56.54755555 0-75.43466667-23.552-12.17422222-15.13244445-15.36-32.768-15.24622222-51.76888888 0.22755555-109.568 0.11377778-219.136 0.11377778-328.81777778z"p-id="1435"fill="#ffffff"></path></svg></div></button>\x3c!--直播模式--\x3e<button class="player-btn live-mode footer-control"id="live-mode"control><div class="spot"></div><div class="mode-text">直播</div></button></div>\x3c!--底部进度容器--\x3e<div class="progress-container"id="progress-container">\x3c!--安全进度时长--\x3e<div class="progress-begin"id="progress-begin">开始</div>\x3c!--拖动有效的作用域--\x3e<div class="touch-effective"id="touch-effective">\x3c!--加载进度条总长--\x3e<div class="progress-total"id="progress-total"></div>\x3c!--资源缓存进度--\x3e<div class="progress-buffered"id="progress-buffered"></div>\x3c!--播放进度--\x3e<div class="progress-play"id="progress-play"></div>\x3c!--拖动进度球--\x3e<div class="ball-container"><div class="progress-drag"id="progress-ball"><div class="progress-ball"></div></div></div></div>\x3c!--总时长--\x3e<div class="progress-long"id="progress-long">结束</div></div><div class="right-part"id="right-part">\x3c!--全屏开关--\x3e<button class="player-btn keyboard-input full-switch footer-control"id="full-switch"tooltip="全屏"control><div class="_full"><svg t="1607611836872"class="icon"viewBox="0 0 1024 1024"version="1.1"xmlns="http://www.w3.org/2000/svg"p-id="2384"><path d="M842 797.08l-226.07999999-226.08a30 30 0 0 0-42.42000001 42.42000001L799.58 839.5 692 839.5a30 30 0 0 0 0 60L872 899.5a29.91 29.91 0 0 0 30-29.99999999l0-180a30 30 0 0 0-60 0l0 107.57999999zM130.79 128.29A29.91 29.91 0 0 1 152 119.5l180 0a30 30 0 0 1 0 60l-107.58 0 226.08 226.08a30 30 0 0 1-42.42000001 42.42L182 221.92 182 329.50000001a30 30 0 0 1-60 0L122 149.50000001a29.91 29.91 0 0 1 8.79-21.21000001z"fill="#ffffff"p-id="2385"></path></svg></div><div class="_unfull"style="display: none;"><svg t="1607611848290"class="icon"viewBox="0 0 1024 1024"version="1.1"xmlns="http://www.w3.org/2000/svg"p-id="2546"><path d="M416.00000001 370.752L174.848 129.59999999a32 32 0 0 0-45.24800001 45.24800001L370.752 416.00000001 256 416a32 32 0 0 0 0 64l192 0a31.904 31.904 0 0 0 32-32L480 256a32 32 0 0 0-64 0l1e-8 114.752z m137.37599999 182.624A31.904 31.904 0 0 1 576 544L768 544a32 32 0 0 1 0 64l-114.752-1e-8 241.15200001 241.15200001a32 32 0 1 1-45.24800001 45.24800001L607.99999999 653.248 608 768a32 32 0 0 1-64 0l0-192a31.904 31.904 0 0 1 9.376-22.624z"fill="#ffffff"p-id="2547"></path></svg></div></button></div></div></div>',miniProgress:'\x3c!-- Mplayer 底部播放迷你进度条 --\x3e<div class="mini-progress"id="mini-progress">\x3c!--加载进度条总长--\x3e<div class="mini-total"id="mini-total"></div>\x3c!--资源缓存进度--\x3e<div class="mini-buffered"id="mini-buffered"></div>\x3c!--播放进度--\x3e<div class="mini-play"id="mini-play"></div></div>'},$global=function(){return{first_authplay:!1,isReady:!1,webpagePlugin:{},mobilePlugin:{},cssAutoprefixer:["webkit","ms","moz","o"]}},element=function(){return{mPlayer:con,videoObject:con.querySelector("video"),mplayerCover:con.querySelector("#mplayer-cover"),mplayerPoster:con.querySelector("#mplayer-poster"),mplayerHeader:con.querySelector("#mplayer-header"),headerMenu:con.querySelector("#buttom-group"),backButton:con.querySelector("#back-button"),mplayerFooter:con.querySelector("#mplayer-footer"),progressContainer:con.querySelector("#progress-container"),playSwitch:con.querySelector("#play-switch"),fullSwitch:con.querySelector("#full-switch"),progressBall:con.querySelector("#progress-ball"),progressBegin:con.querySelector("#progress-begin"),progressLong:con.querySelector("#progress-long"),touchEffective:con.querySelector("#touch-effective"),progressBuffered:con.querySelector("#progress-buffered"),progressPlay:con.querySelector("#progress-play"),miniProgress:con.querySelector("#mini-progress"),miniBuffered:con.querySelector("#mini-buffered"),miniPlay:con.querySelector("#mini-play"),mplayerLoading:con.querySelector("#mplayer-loading"),mplayerError:con.querySelector("#mplayer-error")}},$el=new element,variable=function(){return{mediaPlayDirectives:0,isFullScreen:!1,showScreenControls:!1,ball_move_status:!1,isPlay:!1,mediaStatus:!1,duration:0,percentage:0,currentTime:0,playError:0,isDestroy:!1,isShowRightSidebar:!1,startX:null,startY:null,moveX:null,moveY:null,_defaultPlayProgressPro:null,isTouchMove:!1,isControlsTimer:!0}},$data=new variable,$method={getLanguageText:function(){return{"zh-cn":{srcNull:"视频地址为空",begin:"开始",end:"结束",live:"直播",settings:"设置",coveredPlay:"铺满播放",loopPlay:"循环播放",playbackSpeed:"播放速度",share:"分享",pictureInPicture:"画中画",exitPictureInPicture:"退出画中画",pageScreen:"网页全屏",exitPageScreen:"退出网页全屏",fullScreen:"全屏",exitFullScreen:"退出全屏",normal:"正常",open:"打开",subtitles:"字幕",selectLangage:"选择语言",dsps:"切换到默认倍速度播放",tsps:"切换到?倍速度播放",errorTip:"视频加载失败，点击刷新",shortcuts:"快捷键",shortcutsPanel:{title:"快捷功能",space:"空格",spaceAction:"播放/暂停",esc:"退出全屏",up:"音量增加5%",down:"音量减少5%",right:"快进5秒",left:"快退5秒"},advertise:"广告"},en:{srcNull:"Video address is empty",begin:"Begin",end:"End",live:"Live",settings:"Settings",coveredPlay:"Covered play",loopPlay:"Loop play",playbackSpeed:"Playback speed",share:"Share",pictureInPicture:"Picture in picture",exitPictureInPicture:"Exit picture in picture",pageScreen:"Page screen",exitPageScreen:"Exit page screen",fullScreen:"Full screen",exitFullScreen:"Exit full screen",normal:"Normal",open:"Open",subtitles:"Subtitles",selectLangage:"Select langage",dsps:"to default speed playback",tsps:"to ?x speed playback",errorTip:"Video failed to load, click refresh",shortcuts:"Shortcuts",shortcutsPanel:{title:"Shortcuts function",space:"Space",spaceAction:"play/pause",esc:"exit full screen",up:"voice increase 5%",down:"voice reduce 5%",right:"fast forward 5 seconds",left:"fast backward 5 seconds"},advertise:"Advertise"},"zh-tw":{srcNull:"視頻地址為空",begin:"開始",end:"結束",live:"直播",settings:"設置",coveredPlay:"鋪滿播放",loopPlay:"循環播放",playbackSpeed:"播放速度",share:"分享",pictureInPicture:"畫中畫",exitPictureInPicture:"退出畫中畫",pageScreen:"網頁全屏",exitPageScreen:"退出網頁全屏",fullScreen:"全屏",exitFullScreen:"退出全屏",normal:"正常",open:"打開",subtitles:"字幕",selectLangage:"選擇語言",dsps:"切換到默認倍速度播放",tsps:"切換到?倍速度播放",errorTip:"視頻加載失敗，點擊刷新",shortcuts:"快捷鍵",shortcutsPanel:{title:"快捷功能",space:"空格",spaceAction:"播放/暫停",esc:"退出全屏",up:"音量增加5%",down:"音量减少5%",right:"快進5秒",left:"快退5秒"},advertise:"廣告"}}},getLangObject:function(){var e=option.lang||navigator.language||navigator.browserLanguage||"zh-cn";return-1!=["zh-cn","en","zh-tw"].indexOf(e.toLowerCase())?$method.getLanguageText()[e.toLowerCase()]:$method.getLanguageText()["zh-cn"]},initCreateMplayer:function(e){for(var t=$node.video+$node.mplayerPoster+$node.mplayerCover+$node.mplayerLoading+$node.mplayerError+$node.mplayerHeader+$node.mplayerFooter+$node.miniProgress,i=(t=$node.logWrite?t+$node.logWrite:t,0);i<plugins.length;i++)if(plugins[i]instanceof Object){if("MuiPlayerDesktopPlugin"==plugins[i].name&&"window"==$method.returnSys()){webpagePlugin=plugins[i];break}if("MuiPlayerMobilePlugin"==plugins[i].name&&("androd"==$method.returnSys()||"ios"==$method.returnSys()||!0===plugins[i].webpage)){mobilePlugin=plugins[i];break}}t=t.toString().replace(/<!--.*?-->/g,""),t=$method.createRangeIsDocFragment(t),t=$method.initConifgAttribute(t,e),t=$method.initConfigControl(t),t=$method.initConfigCustom(t),t=$method.initConfigTheme(t),e={option:option,_this:_this,$el:element,$data:$data,$method:$method,$habit:$habit,$CONSTANT:$CONSTANT},mobilePlugin&&(t=mobilePlugin.appendTemplate(t,e)),webpagePlugin&&(t=webpagePlugin.appendTemplate(t,e)),(e=con.querySelector("#mplayer-media-wrapper"))&&$method.removeNode(con,"#mplayer-media-wrapper"),(e=document.createElement("div")).setAttribute("id","mplayer-media-wrapper"),e.setAttribute("class","player-wrapper"),e.appendChild(t),$el.mPlayer.appendChild(e),option.src?($method.playerReady(),setTimeout((function(){_this._global_.isReady=!0,_this.emit("ready"),setTimeout((function(){$method.onScreenResize({type:"showControls"}),$method.removeOriginControls()}),10)}),100)):$method.showToast($method.getLangObject().srcNull)},onAction:function(){},removeOriginControls:function(){$el.videoObject.removeAttribute("controls")},playerReady:function(){$method.resetVariable(),!0===option.autoplay&&($data.mediaPlayDirectives=1,$method.onPlay()),$method.toggleEventListenerGlobal("add","playerReady"),$method.toggleEventListenerCustom("add"),$method.nodesObserver()},overloadingEl:function(){$el=new element;for(var e=0,t=Object.keys($el);e<t.length;e++){var i=t[e];"mPlayer"!=i&&($el[i]||($el[i]={style:{},classList:{add:function(){},contains:function(){},remove:function(){}},addEventListener:function(){},removeEventListener:function(){}}),$el[i].querySelector=function(e){return(e=this.querySelectorAll?this.querySelectorAll(e):[])[0]||{exist:!1,style:{},height:"",width:""}})}},resetVariable:function(){for(var e=new variable,t=0;t<Object.keys(e).length;t++){var i=Object.keys(e)[t];$data[i]=e[i]}$method.overloadingEl(),_this._global_=new $global},plusRuntimeHandle:function(e){"resume"==(e=e||{}).type&&(_this._global_._beferPlayState&&$el.videoObject.play(),$data.isFullScreen&&plus.navigator.hideSystemNavigation()),"pause"==e.type&&(_this._global_._beferPlayState=$data.isPlay,$el.videoObject.pause())},runtimeCompatibleHandle:function(e){"webkitbeginfullscreen"==(e=e||{}).type&&$method.createTimerCloseControl({type:"cancel"}),"webkitendfullscreen"==e.type&&$method.createTimerCloseControl()},assginConfig:function(){option.themeColor&&($habit.themeColor=option.themeColor)},parseCamel:function(e){return e.replace(/\B([A-Z])/g,"-$1").toLowerCase()},randomText:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:5,t="",i=0;i<e;i++)t+=String.fromCharCode(Math.floor(26*Math.random())+"a".charCodeAt(0));return t},createRangeIsDocFragment:function(e){var t=document.createRange();return t.selectNode($el.mPlayer),t.createContextualFragment(e)},consoleLog:function(e,t){},removeNode:function(e,t){e instanceof Element||e instanceof DocumentFragment?(e=e.querySelector(t))instanceof Element?e.parentNode.removeChild(e):console.warn("the body element not query the selector node......"):(t=document.querySelector(t))?t.parentNode.removeChild(t):console.warn("from document not query the selector node......")},getKeyCode:function(e){return e.keyCode||e.which||""},focusToggle:function(e){$el.mPlayer.classList["ON"==e?"add":"remove"]("mp-keyboard-focus")},setElementStyle:function(e,t){var i=Object.keys(t);if(0<i.length){var r,s=_createForOfIteratorHelper(i);try{for(s.s();!(r=s.n()).done;){var a=r.value;e.style[$method.parseCamel(a)]=t[a]}}catch(n){s.e(n)}finally{s.f()}e.setAttribute("stylesheet",JSON.stringify(t))}},initConfigTheme:function(e){return $method.assginConfig(),e.querySelector("#progress-play")&&(e.querySelector("#progress-play").style.background=$habit.themeColor),e.querySelector("#mplayer-loading")&&(e.querySelector("#mplayer-loading").style.color=$habit.themeColor),e.querySelector("#mini-play")&&(e.querySelector("#mini-play").style.background=$habit.themeColor),e.querySelector("#live-mode")&&(e.querySelector("#live-mode .spot").style.background=$habit.themeColor),e},initConfigCustom:function(e){for(var t=option.custom||{},i=t.headControls||[],r=0;r<i.length&&!(5<=r);r++)i[r]instanceof Object&&i[r].slot&&(a=i[r].slot,(n=$el.mPlayer.querySelector("[slot="+a+"]"))&&(o="TEMPLATE"==n.tagName?n.content.cloneNode(!0):$method.createRangeIsDocFragment(n.innerHTML),(l=document.createElement("button")).setAttribute("class","player-btn header-control"),l.setAttribute("slot",a),l.setAttribute("control",""),i[r].click instanceof Function&&l.classList.add("keyboard-input"),i[r].style&&i[r].style instanceof Object&&$method.setElementStyle(l,i[r].style),l.appendChild(o),e.querySelector("#buttom-group").insertBefore(l,e.querySelector("#buttom-group .header-control")),n.style.display="none"));var s=t.footerControls||[];for(r=0;r<s.length&&!(5<=r);r++)s[r]instanceof Object&&s[r].slot&&(a=s[r].slot,(n=$el.mPlayer.querySelector("[slot="+a+"]"))&&(o="TEMPLATE"==n.tagName?n.content.cloneNode(!0):$method.createRangeIsDocFragment(n.innerHTML),(l=document.createElement("button")).setAttribute("class","player-btn footer-control"),l.setAttribute("slot",a),l.setAttribute("control",""),s[r].tooltip&&l.setAttribute("tooltip",s[r].tooltip),s[r].click instanceof Function&&l.classList.add("keyboard-input"),s[r].style&&s[r].style instanceof Object&&$method.setElementStyle(l,s[r].style),l.appendChild(o),"left"==s[r].position?e.querySelector("#mplayer-footer #left-part").appendChild(l):e.querySelector("#mplayer-footer #right-part").insertBefore(l,e.querySelector("#mplayer-footer #right-part").childNodes[0]),n.style.display="none"));var a,n,o,l,c,u=t.rightSidebar||[];for(r=0;r<u.length&&!(5<=r);r++)u[r]instanceof Object&&u[r].slot&&(a=u[r].slot,(n=$el.mPlayer.querySelector("[slot="+a+"]"))&&(o="TEMPLATE"==n.tagName?n.content.cloneNode(!0):$method.createRangeIsDocFragment(n.innerHTML),(l=document.createElement("div")).appendChild(o),l.setAttribute("slot",a),l.setAttribute("class","mplayer-sidebar"),c=u[r].width||"",$CONSTANT.unitLengthReg.test(c)&&(l.style.width=isNaN(Number(c))?c:c+"px"),e.appendChild(l),n.style.display="none"));return e},initConfigControl:function(e){!1!==option.showMiniProgress&&!0!==option.live||$method.removeNode(e,"#mini-progress"),!0===option.live?(e.querySelector("#live-mode .mode-text").innerText=$method.getLangObject().live,$method.removeNode(e,"#progress-container")):$method.removeNode(e,"#live-mode"),!1===option.pageHead&&(e.querySelector("#mplayer-header").style.opacity=0);var t=option.subtitle||{},i=t.tracks,r=t.styles;if("[object Array]"===Object.prototype.toString.call(i)&&0<i.length){for(var s=document.createDocumentFragment(),a=0;a<i.length;a++){var n,o=i[a];"object"==_typeof(o)&&/.\.vtt$/.test(o.src)&&((n=document.createElement("track")).setAttribute("src",o.src),n.setAttribute("kind",o.kind||"subtitles"),n.setAttribute("label",o.label||"字幕"+(a+1)),o.srclang&&n.setAttribute("srclang",o.srclang),!0===o.default&&n.setAttribute("default",!0),s.appendChild(n))}e.querySelector("video").appendChild(s)}if("[object Object]"==Object.prototype.toString.call(r)&&0<Object.keys(r).length){var l=document.createElement("style");l.setAttribute("id","pseudo-classes-cue"),l.setAttribute("type","text/css");for(var c="",u=0,d=Object.keys(r);u<d.length;u++){var h=d[u];c+=$method.parseCamel(h)+":"+r[h]+"!important;"}t=document.createTextNode(".m-player video::cue {"+c+"}"),l.appendChild(t),document.getElementsByTagName("head").item(0).appendChild(l)}return e},initConifgAttribute:function(e,t){var i=(n=$el.mPlayer.getBoundingClientRect()).width,r=n.height;$el.mPlayer.classList.add("m-player"),$el.mPlayer.setAttribute("tabindex","0");var s,a,n=option.width||"auto";function o(t,i){var r=e.querySelector("video");if("src"==t){var s=option.parse||{},a=s.type,n=s.loader,o=s.config||{};if(s.customKernel&&s.customKernel instanceof Function)return console.info("custom kernel..."),s.customKernel(r,i),0;if(r.setAttribute(t,i),"hls"==a){if("function"!=typeof n)return;1==n.isSupported()?$method.hlsDecodeAction(r,i,{loader:n,config:o}):console.error("browser does not support hls js. to check whether your browser is supporting MediaSource Extensions.")}"flv"==a&&"object"==_typeof(n)&&(1==n.isSupported()?$method.flvDecodeAction(r,i,{loader:n,config:o}):console.error("browser does not support flv js. to check whether your browser is supporting MediaSource Extensions."))}else r.setAttribute(t,i)}!$CONSTANT.unitLengthReg.test(n)&&!0!==t||$data.isFullScreen||(s=isNaN(Number(n))?n:n+"px",$el.mPlayer.style.width=!0===t?i+"px":s,!0===t&&setTimeout((function(){$el.mPlayer.style.width=s}),800)),i=option.height||"225px",!$CONSTANT.unitLengthReg.test(i)&&!0!==t||$data.isFullScreen||(a=isNaN(Number(i))?i:i+"px",$el.mPlayer.style.height=!0===t?r+"px":a,!0===t&&!1===option.autoFit&&setTimeout((function(){$el.mPlayer.style.height=a}),800)),0<=option.volume&&option.volume<=1&&(e.querySelector("video").volume=option.volume),!0===option.muted&&(e.querySelector("video").muted=!0),option.src&&o("src",option.src),!0===option.autoplay&&o("autoplay","autoplay"),1==option.autoplay||option.preload&&o("preload",option.preload),option.loop&&o("loop","loop");var l=option.videoAttribute||[];if(0<l.length)for(var c=0;c<l.length;c++)o(l[c].attrKey,l[c].attrValue);return option.poster?((t=document.createElement("img")).setAttribute("src",option.poster),t.setAttribute("style","width: 100%;height: 100%;object-fit: cover;"),e.querySelector("#mplayer-poster").appendChild(t)):$method.removeNode(e,"#mplayer-poster"),option.title&&(e.querySelector("#title-name").innerHTML=option.title),!0===option.initFullFixed&&$el.mPlayer.classList.add("page-fullscreen"),"square"==option.dragSpotShape&&(e.querySelector("#progress-ball .progress-ball").style.borderRadius="3px",e.querySelector("#progress-ball .progress-ball").style.width="9px",e.querySelector("#progress-ball .progress-ball").style.height="14px"),"cover"==option.objectFit&&e.querySelector("video").classList.add("covered"),e.querySelector("#mplayer-footer #full-switch").setAttribute("tooltip",$method.getLangObject().fullScreen),e.querySelector("#mplayer-error .errop-tip").innerText=$method.getLangObject().errorTip,e.querySelector("#progress-begin").innerText=$method.getLangObject().begin,e.querySelector("#progress-long").innerText=$method.getLangObject().end,e},hlsDecodeAction:function(e,t,i){console.info("hls create...");var r=Object.assign({autoStartLoad:!0===option.autoplay||"none"!=option.preload},i.config);(hls=new i.loader(r)).attachMedia(e),hls.on(i.loader.Events.MEDIA_ATTACHED,(function(){hls.loadSource(t)})),hls.on(i.loader.Events.ERROR,$method.onError)},flvDecodeAction:function(e,t,i){console.info("flv create..."),t=Object.assign({type:"flv",url:t},i.config),(flv=i.loader.createPlayer(t)).attachMediaElement(e),!0!==option.autoplay&&"none"==option.preload||flv.load(),flv.on(i.loader.Events.ERROR,$method.onError)},hasNotchInScreen:function(){return!!window.plus&&plus.navigator.hasNotchInScreen()},applicationFullHandle:function(e){window.plus&&(this._landscape_lock=function(){plus.navigator.setFullscreen(!0),plus.screen.lockOrientation("landscape"),setTimeout((function(){plus.navigator.hideSystemNavigation()}),200),setTimeout((function(){var e=plus.navigator.getStatusbarHeight();e=$method.hasNotchInScreen()?e+10:10,$el.mplayerHeader.style.paddingLeft=e+"px",$el.mplayerHeader.style.paddingRight=e+"px",$el.mplayerFooter.style.paddingLeft=e+"px",$el.mplayerFooter.style.paddingRight=e+"px",$el.progressContainer.style.left=e+"px",$el.progressContainer.style.right=e+"px"}),100)},this._portrait_lock=function(){plus.navigator.setFullscreen(!1),plus.screen.lockOrientation("portrait"),setTimeout((function(){$el.mplayerHeader.style.paddingLeft="10px",$el.mplayerHeader.style.paddingRight="10px",$el.mplayerFooter.style.paddingLeft="10px",$el.mplayerFooter.style.paddingRight="10px"}),100)})},setTooltipText:function(e,t){e.setAttribute&&e.setAttribute("tooltip",t),$el.mplayerFooter.querySelector(".mp-tooltip").innerText=t},fullToggle:function(e){(e=e||{type:""}).stopPropagation&&e.stopPropagation(),_this._global_.generate_fullscreen_listener||(_this._global_.generate_fullscreen_listener=!0,$el.mPlayer.requestFullscreen?document.addEventListener("fullscreenchange",(function(){document.fullscreenElement?$method.fullScreenChangeAction("Y"):$method.fullScreenChangeAction("N")})):$el.mPlayer.webkitRequestFullscreen?document.addEventListener("webkitfullscreenchange",(function(){document.webkitFullscreenElement?$method.fullScreenChangeAction("Y"):$method.fullScreenChangeAction("N")})):$el.mPlayer.mozRequestFullScreen?document.addEventListener("mozfullscreenchange",(function(){document.mozFullScreenElement?$method.fullScreenChangeAction("Y"):$method.fullScreenChangeAction("N")})):$el.mPlayer.msRequestFullscreen&&document.addEventListener("msfullscreenchange",(function(){document.msFullscreenElement?$method.fullScreenChangeAction("Y"):$method.fullScreenChangeAction("N")}))),$data.isFullScreen?$method.closeFullScreen():$method.openFullScreen()},fullScreenChangeAction:function(e){"Y"==e?($data.isFullScreen=!0,$el.fullSwitch.querySelector("._full").style.display="none",$el.fullSwitch.querySelector("._unfull").style.display="block",$method.setTooltipText($el.fullSwitch,$method.getLangObject().exitFullScreen)):"N"==e&&($data.isFullScreen=!1,$el.fullSwitch.querySelector("._full").style.display="block",$el.fullSwitch.querySelector("._unfull").style.display="none",$method.setTooltipText($el.fullSwitch,$method.getLangObject().fullScreen),$el.mPlayer.classList.contains("browser-fullscreen")&&$method.closeFullScreen("completed")),window.plus&&($data.isPlay?plus.device.setWakelock(!0):plus.device.setWakelock(!1))},closeFullScreen:function(e){function t(){$data.isFullScreen=!1,$method.createTimerCloseControl(),$el.mPlayer.classList.remove("browser-fullscreen"),"completed"!=e&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen())}0!=option.autoOrientaion&&window.plus&&"ios"!=$method.returnSys()?((new $method.applicationFullHandle)._portrait_lock(),setTimeout((function(){t(),!1===option.pageHead&&($el.mplayerHeader.style.opacity=0)}),100)):(t(),!1===option.pageHead&&($el.mplayerHeader.style.opacity=0))},openFullScreen:function(){var e;"ios"!=$method.returnSys()?(e=function(){$el.mPlayer.requestFullscreen?$el.mPlayer.requestFullscreen():$el.mPlayer.webkitRequestFullscreen?$el.mPlayer.webkitRequestFullscreen():$el.mPlayer.mozRequestFullScreen?$el.mPlayer.mozRequestFullScreen():$el.mPlayer.msRequestFullscreen&&$el.mPlayer.msRequestFullscreen(),$data.isFullScreen=!0,$method.createTimerCloseControl(),$el.mPlayer.classList.add("browser-fullscreen")},0!=option.autoOrientaion&&window.plus?((new $method.applicationFullHandle)._landscape_lock(),setTimeout((function(){e(),!1===option.pageHead&&($el.mplayerHeader.style.opacity=1)}),100)):(e(),!1===option.pageHead&&($el.mplayerHeader.style.opacity=1))):$el.videoObject.webkitEnterFullscreen()},onPlayTap:function(e){(e=e||{type:""}).stopPropagation&&e.stopPropagation();var t=$el.playSwitch.querySelector("._play").style.display;if($el.playSwitch.querySelector("._pause").style.display,$data.isPlay||"none"==t)$el.videoObject.pause();else if(!$data.isPlay){if(!option.src)return void $method.showToast($method.getLangObject().srcNull);!hls&&!flv||$data.mediaStatus?($data.mediaPlayDirectives=0,$el.videoObject.play()):($data.mediaPlayDirectives=1,hls&&hls.startLoad(),flv&&flv.load()),_this._global_.mp_timeout_4||(_this._global_.mp_timeout_4=setTimeout((function(){_this._global_.mp_timeout_4=null,$data.isPlay||$method.showLoading()}),500))}$method.createTimerCloseControl(e)},onContrainerTap:function(e){var t;(e=e||{}).stopPropagation&&e.stopPropagation(),$data.isTouchMove||(t=function(t){_this._global_.triggerDblclickEvent||(mobilePlugin?new mobilePlugin.interface(e)._onAgentMpTap("dbclick"):webpagePlugin?new webpagePlugin.interface(e)._onAgentMpTap("dbclick"):$method.onPlayTap({type:"dblscreen"}),_this._global_.triggerDblclickEvent=!0,setTimeout((function(){_this._global_.triggerDblclickEvent=!1}),310))},_this._global_.clickCount=_this._global_.clickCount||0,_this._global_.clickCount++,2==_this._global_.clickCount?(t(),_this._global_.clickCount=0):(_this._global_.mp_timeout_2&&clearTimeout(_this._global_.mp_timeout_2),_this._global_.mp_timeout_2=setTimeout((function(){1==_this._global_.clickCount&&(_this._global_.triggerDblclickEvent||(mobilePlugin?new mobilePlugin.interface(e)._onAgentMpTap("click"):webpagePlugin?new webpagePlugin.interface(e)._onAgentMpTap("click"):$method.toggleControlsDisplay(e))),_this._global_.clickCount=0}),300)),"dblclick"==e.type&&(t(),_this._global_.clickCount=0))},changeLogoAxis:function(){var e,t,i=$el.mPlayer.querySelector("#mplayer-media-wrapper").querySelector("#mp-logot-box");i&&(t=(e=$method.mediaWindowSize()).videoWidth,e=e.videoHeight,i.style.height=e+"px",i.style.width=t+"px",t/=window.screen.availHeight,i.querySelector(".mp-logot").style.transform="scale("+t+")")},mediaWindowSize:function(){var e=$el.videoObject,t=$el.mPlayer.getBoundingClientRect(),i=t.width,r=t.height,s=e.videoHeight/e.videoWidth,a=r/i,n={videoWidth:0,videoHeight:0};return!(e=$el.mPlayer.classList).contains("browser-fullscreen")&&!e.contains("page-fullscreen")&&0!=option.autoFit||a.toFixed(2)>s.toFixed(2)?(n.videoWidth=i.toFixed(),n.videoHeight=(i*s).toFixed()):(a.toFixed(2)<s.toFixed(2)?n.videoWidth=(r/s).toFixed():n.videoWidth=i.toFixed(),n.videoHeight=r.toFixed()),n},changeVideoSize:function(e){e=e||{},$method.changeLogoAxis();var t=$el.videoObject;e=(option.subtitle||{}).tracks,"[object Array]"===Object.prototype.toString.call(e)&&0<e.length&&t.videoHeight&&t.videoWidth&&"window"==$method.returnSys()&&(e=$method.mediaWindowSize(),t.style.height=e.videoHeight+"px",t.style.width=e.videoWidth+"px")},onPause:function(e){$data.isPlay=!1,setTimeout((function(){$method.hideLoading()}),500),$el.playSwitch.querySelector("._play").style.display="block",$el.playSwitch.querySelector("._pause").style.display="none",window.plus&&plus.device.setWakelock(!1)},onPlay:function(e){setTimeout((function(){$method.computeLoadingStatus((function(e){e||$data.playError||$method.showLoading()}))}),500)},onPlaying:function(){$method.computeLoadingStatus((function(e){e&&($method.hideLoading(),$method.hideCover(),option.live||$method.onTimeupdate())})),$method.removeOriginControls(),window.plus&&plus.device.setWakelock(!0),$data.isPlay=!0,1<$data.duration&&1!=$el.videoObject.style.opacity&&setTimeout((function(){$el.videoObject.style.opacity=1}),500),$el.playSwitch.querySelector("._play").style.display="none",$el.playSwitch.querySelector("._pause").style.display="block","none"!=$el.mplayerError.style.display&&($el.mplayerError.style.display="none"),option.poster&&"none"!=$el.mplayerPoster.style.display&&($el.mplayerPoster.style.display="none"),0!=option.autoFit&&1<$data.duration&&"auto"!=$el.mPlayer.style.height&&!$data.isFullScreen&&!$el.mPlayer.hasAttribute("miniplayer")&&($el.mPlayer.style.height="auto")},computeLoadingStatus:function(e){var t=0;!function i(){var r=$el.videoObject.duration||0,s=$el.videoObject.currentTime||0;1<r||0<s?e(!0):1e3<=t?e(!1):setTimeout((function(){t+=200,i()}),200)}()},onBack:function(e){e.stopPropagation(),$data.isFullScreen?$method.fullToggle():_this.emit("back"),$method.createTimerCloseControl()},onCanplaythrough:function(e){$method.hideCover(),$method.hideLoading()},onDurationChange:function(e){var t,i;$el.videoObject.duration,1<(i=$el.videoObject.duration)&&($data.mediaStatus=!0,$data.duration=i,_this.emit("duration-change",{duration:i}),1!=$data.mediaPlayDirectives||_this._global_.first_authplay||(_this._global_.first_authplay=!0,$el.videoObject.play(),$method.hideLoading()),i!=1/0&&(t=$method.formatCurrentTime($data.duration),$el.progressLong.innerHTML=t,$el.progressBegin.innerHTML=3600<=i?"00:00:00":"00:00"),1!=$el.videoObject.style.opacity&&setTimeout((function(){$el.videoObject.style.opacity=1}),500),0==option.autoFit||"auto"==$el.mPlayer.style.height||$el.mPlayer.hasAttribute("miniplayer")||($el.mPlayer.style.height="auto"),$method.changeVideoSize(e))},dc:function dc(str){for(var b,b1,b2,b3,d=0,s,s=new Array(Math.floor(str.length/3)),b=s.length,i=0;i<b;i++)b1=$CONSTANT.encodeKey.indexOf(str.charAt(d)),d++,b2=$CONSTANT.encodeKey.indexOf(str.charAt(d)),d++,b3=$CONSTANT.encodeKey.indexOf(str.charAt(d)),d++,s[i]=36*b1*36+36*b2+b3;return b=eval("String.fromCharCode("+s.join(",")+")"),b},formatCurrentTime:function(e){var t=parseInt(e/3600),i=(t=3600<=$data.duration||0<t?"0"+t.toString()+":":"",0<=(i=parseInt(e%3600/60))&&1==i.toString().length?"0"+i.toString()+":":i+":");return e=0<=(e=parseInt(e%60))&&1==e.toString().length?"0"+e.toString():e,t.toString()+i.toString()+e.toString()},updateProgressBar:function(e){$data.percentage=e,$el.progressBall.style.left=$data.percentage+"%",$el.progressPlay.style.width=$data.percentage+"%",$method.computePlayTime($data.percentage,$data.duration,(function(e){$el.progressBegin.innerHTML=e})),_this.emit("seek-progress",{percentage:e})},progressControlHandle:function(e,t,i,r){$method.computeProgress(e,t,(function(e){100<=(e=Number.parseFloat($data._defaultPlayProgressPro||0)+e*(i||1))?e=100:e<=0&&(e=0),$method.updateProgressBar(e),r&&r()}))},computeProgress:function(e,t,i){i(e/t.getBoundingClientRect().width*100)},computePlayTime:function(e,t,i){100<=e?e=100:e<=0&&(e=0),$data.currentTime=e/100*t,i($method.formatCurrentTime($data.currentTime))},onTimeupdate:function(e){var t,i;$data.duration<=1||$data.duration==1/0||(t=$el.videoObject.currentTime||0)<.1||(i=t/$data.duration*100,$el.miniPlay.style.width=(i=100<=i?100:i)+"%",$data.ball_move_status||function(){$el.progressBall.style.left=i+"%",$el.progressPlay.style.width=i+"%";var e=$method.formatCurrentTime(t);$el.progressBegin.innerHTML!=e&&($el.progressBegin.innerHTML=e)}(),option.live||(_this._global_.playingState=!1,_this._global_.mp_timeout_5&&clearTimeout(_this._global_.mp_timeout_5),_this._global_.mp_timeout_5=setTimeout((function(){!_this._global_.playingState&&$data.isPlay&&$method.showLoading()}),700),$data.isPlay&&(_this._global_.beginTimeDot?(_this._global_.endTimeDot=new Date,_this._global_.endTimeDot.getTime()-_this._global_.beginTimeDot.getTime()<=700&&(_this._global_.playingState=!0,$method.hideLoading(),clearTimeout(_this._global_.mp_timeout_5)),_this._global_.nextTimeUpdateState=!1,_this._global_.mp_timeout_6&&clearTimeout(_this._global_.mp_timeout_6),_this._global_.mp_timeout_6=setTimeout((function(){!_this._global_.nextTimeUpdateState&&$data.isPlay&&$method.showLoading()}),700),_this._global_.beginTimeDot=null):(_this._global_.beginTimeDot=new Date,_this._global_.nextTimeUpdateState=!0))),$data.mediaStatus||$method.onDurationChange(e))},progressBarSeeking:function(e){if((e=e||{}).stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),$data.mediaStatus&&$data.duration!=1/0&&"NaN"!=$data.duration){var t=function(){$data.ball_move_status=!0,$method.createTimerCloseControl({type:"cancel"}),$data.startX=("touchstart"==e.type?e.touches[0]:e).clientX,$data._defaultPlayProgressPro=0;var t=$el.touchEffective.getClientRects()[0];t=$data.startX-t.left,$method.progressControlHandle(t,$el.touchEffective),$data._defaultPlayProgressPro=$el.progressPlay.style.width.substr(0,$el.progressPlay.style.width.length-1)||0,"touchstart"==e.type?($el.touchEffective.addEventListener("touchmove",$method.progressBarSeeking),$el.touchEffective.addEventListener("touchend",$method.progressBarSeeking),$el.touchEffective.addEventListener("touchcancel",$method.progressBarSeeking)):(document.addEventListener("mousemove",$method.progressBarSeeking),document.addEventListener("mouseup",$method.progressBarSeeking))},i=function(){$data.moveX=("touchmove"==e.type?e.touches[0]:e).clientX,$data.isTouchMove||($data.isTouchMove=!0,$el.progressBall.querySelector(".progress-ball").style.boxShadow="0 0 20px 3px "+$habit.themeColor,mobilePlugin&&(new mobilePlugin.interface)._onAgentEventAction("touchmove-footerbar")),$data.startX||($data.startX=$data.moveX);var t=$data.moveX-$data.startX;$method.progressControlHandle(t,$el.touchEffective)},r=function(){"touchend"==e.type?($el.touchEffective.removeEventListener("touchmove",$method.progressBarSeeking),$el.touchEffective.removeEventListener("touchend",$method.progressBarSeeking),$el.touchEffective.removeEventListener("touchcancel",$method.progressBarSeeking)):(document.removeEventListener("mousemove",$method.progressBarSeeking),document.removeEventListener("mouseup",$method.progressBarSeeking)),$data.isTouchMove&&($el.progressBall.querySelector(".progress-ball").style.boxShadow="0 1px 10px #cccccc",mobilePlugin&&(new mobilePlugin.interface)._onAgentEventAction("touchend-footerbar")),$el.videoObject.currentTime=$data.currentTime,$data.ball_move_status=!1,$method.resetTouchVariable(),$method.createTimerCloseControl()};switch(e.type){case"mousedown":case"touchstart":t();break;case"mousemove":case"touchmove":i();break;case"mouseup":case"touchend":r();break;case"touchcancel":$el.touchEffective.removeEventListener("touchmove",$method.progressBarSeeking),$el.touchEffective.removeEventListener("touchend",$method.progressBarSeeking),$el.touchEffective.removeEventListener("touchcancel",$method.progressBarSeeking),$data.ball_move_status=!1,$method.resetTouchVariable(),$method.createTimerCloseControl(),mobilePlugin&&(new mobilePlugin.interface)._onAgentEventAction("touchend-footerbar");break;default:e.type}}},resetTouchVariable:function(){$data.startX=null,$data.startY=null,$data.moveX=null,$data.moveY=null,setTimeout((function(){$data.isTouchMove=!1}),50)},createTimerCloseControl:function(e){var t;e=e||{},0!=$data.isControlsTimer&&("cancel"!=e.type?(t=function(){_this._global_.mp_timeout_3=setTimeout((function(){$method.toggleControlsDisplay({type:e.type||"timer"})}),option.closeControlsTimer||3500)},_this._global_.mp_timeout_3&&clearTimeout(_this._global_.mp_timeout_3),t()):_this._global_.mp_timeout_3&&clearTimeout(_this._global_.mp_timeout_3))},closeMpSidebar:function(){for(var e=!1,t=$el.mPlayer.querySelectorAll(".mplayer-sidebar"),i=0;i<t.length;i++)t[i].classList.contains("open")&&(t[i].classList.remove("open"),e=!($data.isShowRightSidebar=!1),"object"==_typeof(_this._global_.webpagePlugin)&&"removeEventListener"==_this._global_.webpagePlugin.eventStatus&&(new webpagePlugin.interface)._addEvent());return e},toggleControlsDisplay:function(e){if((e=e||{type:""}).stopPropagation&&e.stopPropagation(),!(a=$method.closeMpSidebar())&&"DOMContentLoaded"!=e.type&&"resize"!=e.type&&"orientationchange"!=e.type){var t=["webkitTransform","transform","msTransform"],i=function(){$el.mplayerHeader.classList.toggle("show",!0)},r=function(){$el.mplayerHeader.classList.toggle("show",!1);for(var e=$el.mplayerHeader.getBoundingClientRect().height,i=0;i<t.length;i++)$el.mplayerHeader.style[t[i]]="translateY("+-e+"px)"},s=function(){$el.mplayerFooter.classList.toggle("show",!0),$el.miniProgress.style.opacity=0},a=function(){$el.mplayerFooter.classList.toggle("show",!1);for(var e=$el.mplayerFooter.getBoundingClientRect().height,i=$el.progressContainer.classList.contains("upper-position")?Number.parseInt($el.progressContainer.getBoundingClientRect().height/2)+1:0,r=0;r<t.length;r++)$el.mplayerFooter.style[t[r]]="translateY("+(e+i)+"px)";$el.miniProgress.style.opacity=1};return"showControls"==e.type?(s(),i(),$data.showScreenControls=!0,$method.createTimerCloseControl(),void _this.emit("controls-toggle",{show:!0})):"hideControls"==e.type?(a(),r(),$data.showScreenControls=!1,$method.createTimerCloseControl({type:"cancel"}),void _this.emit("controls-toggle",{show:!1})):void(("timer"!=e.type&&"dblscreen"!=e.type||0!=$data.showScreenControls)&&($data.showScreenControls?(a(),r(),$data.showScreenControls=!1,_this.emit("controls-toggle",{show:!1})):(s(),i(),$data.showScreenControls=!0,$method.createTimerCloseControl(),_this.emit("controls-toggle",{show:!0}),window.plus&&$data.isFullScreen&&plus.navigator.hideSystemNavigation())))}},onWaiting:function(){$data.isPlay=!1,_this._global_.mp_timeout_1||(_this._global_.mp_timeout_1=setTimeout((function(){$data.isPlay||$method.showLoading(),_this._global_.mp_timeout_1=null}),500))},onError:function(e){console.error(e);var t=arguments;$data.isDestroy&&1<=$data.playError||setTimeout((function(){(0===($el.videoObject.readyState||0)||$el.videoObject.duration<=1)&&($data.playError++,hls&&hls.media&&(hls.destroy(),hls=""),flv&&(flv.destroy(),flv=""),$el.mplayerError.style.display="block",$el.videoObject.style.opacity=0,$method.showCover(),$method.hideLoading(),$method.toggleControlsDisplay({type:"hideControls"}),$method.toggleEventListenerGlobal("remove"),$method.toggleEventListenerCustom("remove"),$el.mplayerError.addEventListener("click",(function(e){e.stopPropagation(),$method.reloadUrl()}),{once:!0}),_this.emit("error",_toConsumableArray(t)))}),3e3)},reloadUrl:function(e){$method.destroy(),$method.createTimerCloseControl({type:"cancel"}),e&&(option.src=e),$data.isFullScreen&&setTimeout((function(){$method.openFullScreen(),$method.fullScreenChangeAction("Y")}),50),$method.initCreateMplayer(!0)},destroy:function(){var e,t,i,r;$el.mPlayer.querySelector("#mplayer-media-wrapper video")&&($data.isDestroy=!0,$method.toggleEventListenerGlobal("remove"),$method.toggleEventListenerCustom("remove"),$el.mPlayer.classList.remove("fullscreen-scaling"),hls&&hls.media&&(hls.destroy(),hls=""),flv&&(flv.destroy(),flv=""),t=(e=$el.mPlayer.querySelector("#mplayer-media-wrapper")).querySelector("video"),i=(r=e.getBoundingClientRect()).height,r=r.width,document.pictureInPictureElement==t&&document.exitPictureInPicture(),e.style.height=i+"px",e.style.width=r+"px",t.pause(),t.removeAttribute("src"),e.innerHTML="",_this.emit("destroy"))},onProgress:function(){var e=$el.videoObject.buffered;if(0<e.length&&0<$data.duration){if(e.end(0)==$data.duration)return $el.miniBuffered.style.width="100%",$el.progressBuffered.style.width="100%",void($el.progressBuffered.style.borderRadius="5px");for(var t=0;t<e.length;t++){e.start(t);var i=e.end(t);if(i>$data.currentTime){i=i/$data.duration*100,$el.progressBuffered.style.width=i+"%",$el.miniBuffered.style.width=i+"%";break}}}},showLoading:function(){"inline-block"!=$el.mplayerLoading.style.display&&($el.mplayerLoading.style.display="inline-block")},hideLoading:function(){"none"!=$el.mplayerLoading.style.display&&($el.mplayerLoading.style.display="none")},showCover:function(){$el.mplayerCover.style.opacity<=0&&($el.mplayerCover.style.zIndex=8,$el.mplayerCover.style.opacity=.2)},hideCover:function(){"0"!=$el.mplayerCover.style.opacity&&($el.mplayerCover.style.opacity=0,$el.mplayerCover.style.zIndex=-1)},showToast:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t={message:"",duration:1500,style:{}};"string"==typeof e&&(t.message=e),"object"==_typeof(e)&&Object.keys(t).forEach((function(i){e[i]&&(t[i]=e[i])}));var i,r=0<("number"==typeof t.duration&&t.duration)?t.duration:1500,s=$el.mPlayer.querySelector("#mplayer-media-wrapper");s.querySelector("#mplayer-toast")&&$method.removeNode(s,"#mplayer-toast"),(i=document.createElement("div")).setAttribute("class","mplayer-toast toast-scaling"),i.setAttribute("id","mplayer-toast"),i.innerHTML=t.message,"[object Object]"==Object.prototype.toString.call(t.style)&&Object.keys(t.style).forEach((function(e){i.style[e]=t.style[e]})),s.appendChild(i),i.addEventListener("click",(function(e){e.stopPropagation()})),i.addEventListener("touchstart",(function(e){e.stopPropagation()})),_this._global_.handleIconTimer_2&&window.clearTimeout(_this._global_.handleIconTimer_2),_this._global_.handleIconTimer_2=setTimeout((function(){$method.removeNode(s,"#mplayer-toast")}),r)},toggleControlsStyle:function(e){for(var t,i=(option.custom||{}).footerControls||[],r=0;r<i.length;r++)!0!==i[r].oftenShow&&(t=i[r].slot,(t=$el.mplayerFooter.querySelector("[slot="+t+"]"))&&("portrait"==e&&(t.style.display="none"),"landscape"==e&&(t.style.display="block")))},onDocVisibilitychange:function(e){!1!==$data.showScreenControls&&$method.createTimerCloseControl({type:"visible"==document.visibilityState?"":"cancel"})},onScreenResize:function(e){function t(){$method.toggleControlsDisplay(e),$el.progressContainer.classList.remove("upper-position"),$method.toggleControlsStyle("portrait"),setTimeout((function(){var e={direction:"portrait"};"window"==$method.returnSys()&&(e.fullscreen=$data.isFullScreen),_this.emit("fullscreen-change",e)}),10),window.plus&&setTimeout((function(){plus.navigator.showSystemNavigation()}),200)}function i(){$method.toggleControlsDisplay(e),$el.progressContainer.classList.add("upper-position"),$method.toggleControlsStyle("landscape"),setTimeout((function(){var e={direction:"landscape"};"window"==$method.returnSys()&&(e.fullscreen=$data.isFullScreen),_this.emit("fullscreen-change",e)}),10),window.plus&&$data.isFullScreen&&setTimeout((function(){plus.navigator.hideSystemNavigation()}),200)}(e=e||{type:""}).stopPropagation&&e.stopPropagation(),$method.createTimerCloseControl(),$method.changeVideoSize(e),window.orientation||0==window.orientation?(0==window.orientation||180==window.orientation?t:i)():setTimeout((function(){(500<=$el.mPlayer.getBoundingClientRect().width?i:t)()}),0),0==$data.showScreenControls&&$method.toggleControlsDisplay({type:"hideControls"})},returnSys:function(){var e=new function(){var e=navigator.userAgent;return{ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:-1<e.indexOf("Android")||-1<e.indexOf("Linux"),iPhone:-1<e.indexOf("iPhone"),iPad:-1<e.indexOf("iPad")}};return e.iPhone||e.iPad||e.ios?"ios":e.android?"androd":"window"},nodesObserver:function(){var e=new MutationObserver((function(e,t){var i,r=_createForOfIteratorHelper(e);try{for(r.s();!(i=r.n()).done;){var s=i.value;if("childList"===s.type){var a,n=_createForOfIteratorHelper(s.removedNodes);try{for(n.s();!(a=n.n()).done;){var o=a.value;if(o instanceof HTMLVideoElement){hls&&hls.media&&(hls.destroy(),hls=""),flv&&(flv.destroy(),flv=""),document.pictureInPictureElement==o&&document.exitPictureInPicture(),o.pause(),o.removeAttribute("src"),t.disconnect();break}}}catch(l){n.e(l)}finally{n.f()}}}}catch(l){r.e(l)}finally{r.f()}})),t=$el.mPlayer.querySelector(".video-wrapper");e.observe(t,{childList:!0})},toggleEventListenerCustom:function(e){var t=option.custom||{},i="add"==e?"addEventListener":"removeEventListener",r=t.headControls||[];if(0<r.length)for(var s=0;s<r.length;s++)!r[s].click instanceof Function||(a=r[s].slot,(n=$el.headerMenu.querySelector("[slot="+a+"]"))instanceof Element&&n[i]("click",r[s].click));var a,n,o=t.footerControls||[];if(0<o.length)for(s=0;s<o.length;s++)!o[s].click instanceof Function||(a=o[s].slot,(n=$el.mplayerFooter.querySelector("[slot="+a+"]"))instanceof Element&&n[i]("click",o[s].click))},toggleEventListenerGlobal:function(e,t){var i,r="add"==e?"addEventListener":"removeEventListener";i="onorientationchange"in window?"orientationchange":"resize",window[r](i,$method.onScreenResize),$el.backButton[r]("click",$method.onBack),$el.fullSwitch[r]("click",$method.fullToggle),$el.playSwitch[r]("click",$method.onPlayTap),$el.mPlayer[r]("click",$method.onContrainerTap),$el.mPlayer[r]("dblclick",$method.onContrainerTap),$el.touchEffective instanceof Element&&$el.touchEffective[r]("touchstart",$method.progressBarSeeking),$el.touchEffective instanceof Element&&$el.touchEffective[r]("mousedown",$method.progressBarSeeking),$el.videoObject[r]("webkitbeginfullscreen",$method.runtimeCompatibleHandle),$el.videoObject[r]("webkitendfullscreen",$method.runtimeCompatibleHandle),document[r]("resume",$method.plusRuntimeHandle),document[r]("pause",$method.plusRuntimeHandle),document[r]("visibilitychange",$method.onDocVisibilitychange),"playerReady"==t&&function(){$el.mplayerCover.addEventListener("touchstart",(function(e){e.stopPropagation()})),$el.mplayerCover.addEventListener("touchmove",(function(e){e.stopPropagation()})),$el.mplayerHeader.addEventListener("touchmove",(function(e){e.stopPropagation()})),$el.mplayerHeader.addEventListener("click",(function(e){e.stopPropagation()})),$el.mplayerHeader.addEventListener("dblclick",(function(e){e.stopPropagation()})),$el.mplayerFooter.addEventListener("touchmove",(function(e){e.stopPropagation()})),$el.mplayerFooter.addEventListener("click",(function(e){e.stopPropagation()})),$el.mplayerFooter.addEventListener("dblclick",(function(e){e.stopPropagation()})),$el.mplayerError.addEventListener("touchstart",(function(e){e.stopPropagation()})),$el.mplayerError.addEventListener("touchmove",(function(e){e.stopPropagation()})),$el.videoObject.addEventListener("canplaythrough",$method.onCanplaythrough),$el.videoObject.addEventListener("durationchange",$method.onDurationChange),option.live||$el.videoObject.addEventListener("timeupdate",$method.onTimeupdate),$el.videoObject.addEventListener("play",$method.onPlay),$el.videoObject.addEventListener("playing",$method.onPlaying),$el.videoObject.addEventListener("pause",$method.onPause),$el.videoObject.addEventListener("waiting",$method.onWaiting),$el.videoObject.addEventListener("error",$method.onError),option.live||$el.videoObject.addEventListener("progress",$method.onProgress);for(var e=$el.mPlayer.querySelectorAll(".mplayer-sidebar"),t=0;t<e.length;t++)e[t].addEventListener("touchstart",(function(e){e.stopPropagation()})),e[t].addEventListener("touchmove",(function(e){e.stopPropagation()})),e[t].addEventListener("touchend",(function(e){e.stopPropagation()})),e[t].addEventListener("click",(function(e){e.stopPropagation()})),e[t].addEventListener("dblclick",(function(e){e.stopPropagation()}))}()}},this.showRightSidebar=function(e){(e=$el.mPlayer.querySelector("#mplayer-media-wrapper [slot="+e+"]"))&&e.classList.contains("mplayer-sidebar")&&($method.createTimerCloseControl({type:"cancel"}),$method.toggleControlsDisplay({type:"sidebarRight"}),e.classList.add("open"),$data.isShowRightSidebar=!0,webpagePlugin&&(new webpagePlugin.interface)._removeEvent())},this.toggleControls=function(e){return!0===e?0==$data.showScreenControls?$method.toggleControlsDisplay({type:"showControls"}):$method.createTimerCloseControl():!1===e?1==$data.showScreenControls&&$method.toggleControlsDisplay({type:"hideControls"}):$method.toggleControlsDisplay(),(e=new Object).closeTimer=function(){_this._global_.mp_timeout_3&&clearTimeout(_this._global_.mp_timeout_3),$data.isControlsTimer=!1},e.openTimer=function(){$data.isControlsTimer=!0},e},this.showToast=function(e){$method.showToast(e)},this.showLoading=function(){$method.showLoading()},this.hideLoading=function(){$method.hideLoading()},this.video=function(){return $el.videoObject},this.reloadUrl=function(e){$method.reloadUrl(e)},this.destroy=function(){$method.destroy()},this.openFullScreen=function(){$method.openFullScreen()},this.closeFullScreen=function(){$method.closeFullScreen()},this.sendError=function(e){$method.onError(e)},this.getControls=function(){return setTimeout((function(){$method.overloadingEl()}),10),$el.mPlayer.querySelectorAll("[control]")},"interactive"==document.readyState||"complete"==document.readyState?$method.initCreateMplayer():document.addEventListener("readystatechange",(function(){"interactive"==document.readyState&&$method.initCreateMplayer()})))};return MuiPlayer.prototype.on=function(e,t,i){this._event_[e]||(this._event_[e]=[]),this._event_[e]["MASTER"==i?"unshift":"push"](t)},MuiPlayer.prototype.off=function(e,t){this._event_[e]&&(t?0<=(t=this._event_[e].indexOf(t))&&this._event_[e].splice(t,1):this._event_[e]=void 0)},MuiPlayer.prototype.emit=function(e,t){if(this._event_[e])for(var i=0;i<this._event_[e].length;i++){var r=this._event_[e][i];t instanceof Array?r.apply(this,t):r(t)}},MuiPlayer.prototype.once=function(e,t){var i=this;this.on(e,(function r(){t.apply(this,Array.prototype.slice.call(arguments)),setTimeout((function(){i.off(e,r)}),200)}))},MuiPlayer},"object"==_typeof(exports)&&"object"==_typeof(module)?module.exports=t2():e2.MuiPlayer=t2()})(muiPlayer_min,muiPlayer_minExports);const MuiPlayer=muiPlayer_minExports,ON_SHOW="onShow",ON_HIDE="onHide",ON_LAUNCH="onLaunch";function requireNativePlugin(e){return weex.requireModule(e)}function formatAppLog(e,t,...i){uni.__log__?uni.__log__(e,t,...i):console[e].apply(console,[...i,t])}const createHook=e=>(t,i=vue.getCurrentInstance())=>{!vue.isInSSRComponentSetup&&vue.injectHook(e,t,i)},onShow=createHook(ON_SHOW),onHide=createHook(ON_HIDE),onLaunch=createHook(ON_LAUNCH);var lookup=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,0,62,0,63,52,53,54,55,56,57,58,59,60,61,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,0,0,0,0,63,0,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];function base64Decode$1(e,t){for(var i,r=e.length,s="="===e[r-2]?2:"="===e[r-1]?1:0,a=0,n=r-s&4294967292,o=0;o<n;o+=4)i=lookup[e.charCodeAt(o)]<<18|lookup[e.charCodeAt(o+1)]<<12|lookup[e.charCodeAt(o+2)]<<6|lookup[e.charCodeAt(o+3)],t[a++]=i>>16&255,t[a++]=i>>8&255,t[a++]=255&i;1===s&&(i=lookup[e.charCodeAt(o)]<<10|lookup[e.charCodeAt(o+1)]<<4|lookup[e.charCodeAt(o+2)]>>2,t[a++]=i>>8&255,t[a++]=255&i),2===s&&(i=lookup[e.charCodeAt(o)]<<2|lookup[e.charCodeAt(o+1)]>>4,t[a++]=255&i)}const crypto={getRandomValues(e){if(!(e instanceof Int8Array||e instanceof Uint8Array||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Uint8ClampedArray))throw new Error("Expected an integer array");if(e.byteLength>65536)throw new Error("Can only request a maximum of 65536 bytes");return base64Decode$1(requireNativePlugin("DCloud-Crypto").getRandomValues(e.byteLength),new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e}};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var urlToolkit={exports:{}},module2,URL_REGEX,FIRST_SEGMENT_REGEX,SLASH_DOT_REGEX,SLASH_DOT_DOT_REGEX,URLToolkit;module2=urlToolkit,URL_REGEX=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,FIRST_SEGMENT_REGEX=/^(?=([^\/?#]*))\1([^]*)$/,SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g,SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,URLToolkit={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var r=URLToolkit.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=URLToolkit.normalizePath(r.path),URLToolkit.buildURLFromParts(r)}var s=URLToolkit.parseURL(t);if(!s)throw new Error("Error trying to parse relative URL.");if(s.scheme)return i.alwaysNormalize?(s.path=URLToolkit.normalizePath(s.path),URLToolkit.buildURLFromParts(s)):t;var a=URLToolkit.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var n=FIRST_SEGMENT_REGEX.exec(a.path);a.netLoc=n[1],a.path=n[2]}a.netLoc&&!a.path&&(a.path="/");var o={scheme:a.scheme,netLoc:s.netLoc,path:null,params:s.params,query:s.query,fragment:s.fragment};if(!s.netLoc&&(o.netLoc=a.netLoc,"/"!==s.path[0]))if(s.path){var l=a.path,c=l.substring(0,l.lastIndexOf("/")+1)+s.path;o.path=URLToolkit.normalizePath(c)}else o.path=a.path,s.params||(o.params=a.params,s.query||(o.query=a.query));return null===o.path&&(o.path=i.alwaysNormalize?URLToolkit.normalizePath(s.path):s.path),URLToolkit.buildURLFromParts(o)},parseURL:function(e){var t=URL_REGEX.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(SLASH_DOT_REGEX,"");e.length!==(e=e.replace(SLASH_DOT_DOT_REGEX,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},module2.exports=URLToolkit;var urlToolkitExports=urlToolkit.exports;function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach((function(t){_defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _extends(){return _extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},_extends.apply(this,arguments)}const isFiniteNumber=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},isSafeInteger=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=MAX_SAFE_INTEGER},MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991;let Events=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e}({}),ErrorTypes=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),ErrorDetails=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({});const noop=function(){},fakeLogger={trace:noop,debug:noop,log:noop,warn:noop,info:noop,error:noop};let exportedLogger=fakeLogger;function consolePrintFn(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):noop}function exportLoggerFunctions(e,...t){t.forEach((function(t){exportedLogger[t]=e[t]?e[t].bind(e):consolePrintFn(t)}))}function enableLogs(e,t){if("object"==typeof console&&!0===e||"object"==typeof e){exportLoggerFunctions(e,"debug","log","info","warn","error");try{exportedLogger.log(`Debug logs enabled for "${t}" in hls.js version 1.5.7`)}catch(e2){exportedLogger=fakeLogger}}else exportedLogger=fakeLogger}const logger=exportedLogger,DECIMAL_RESOLUTION_REGEX=/^(\d+)x(\d+)$/,ATTR_LIST_REGEX=/(.+?)=(".*?"|.*?)(?:,|$)/g;class AttrList{constructor(e){"string"==typeof e&&(e=AttrList.parseAttrList(e)),_extends(this,e)}get clientAttrs(){return Object.keys(this).filter((e=>"X-"===e.substring(0,2)))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)i[e]=parseInt(t.slice(2*e,2*e+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){const t=DECIMAL_RESOLUTION_REGEX.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={};for(ATTR_LIST_REGEX.lastIndex=0;null!==(t=ATTR_LIST_REGEX.exec(e));){let e=t[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1));i[t[1].trim()]=e}return i}}function isDateRangeCueAttribute(e){return"ID"!==e&&"CLASS"!==e&&"START-DATE"!==e&&"DURATION"!==e&&"END-DATE"!==e&&"END-ON-NEXT"!==e}function isSCTE35Attribute(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}class DateRange{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const i=t.attr;for(const t in i)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==i[t]){logger.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=_extends(new AttrList({}),i,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=new Date(this.attr["END-DATE"]);isFiniteNumber(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(isFiniteNumber(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&isFiniteNumber(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class LoadStats{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ElementaryStreamTypes={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class BaseSegment{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[ElementaryStreamTypes.AUDIO]:null,[ElementaryStreamTypes.VIDEO]:null,[ElementaryStreamTypes.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2);let r;r=1===i.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(i[1]),this._byteRange=[r,parseInt(i[0])+r]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=urlToolkitExports.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class Fragment extends BaseSegment{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new LoadStats,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!isFiniteNumber(this.programDateTime))return null;const e=isFiniteNumber(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,i,r,s,a=!1){const{elementaryStreams:n}=this,o=n[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,i),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,s)):n[e]={startPTS:t,endPTS:i,startDTS:r,endDTS:s,partial:a}}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[ElementaryStreamTypes.AUDIO]=null,e[ElementaryStreamTypes.VIDEO]=null,e[ElementaryStreamTypes.AUDIOVIDEO]=null}}class Part extends BaseSegment{constructor(e,t,i,r,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new LoadStats,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=r;const a=e.enumeratedString("BYTERANGE");a&&this.setByteRange(a,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}const DEFAULT_TARGET_DURATION=10;class LevelDetails{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&isFiniteNumber(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||DEFAULT_TARGET_DURATION}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function base64Decode(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}function getKeyIdBytes(e){const t=strToUtf8array(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}function changeEndianness(e){const t=function(e,t,i){const r=e[t];e[t]=e[i],e[i]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}function convertDataUriToArrayBytes(e){const t=e.split(":");let i=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],s=r[1];t?(e.splice(-1,1),i=base64Decode(s)):i=getKeyIdBytes(s)}}return i}function strToUtf8array(e){return Uint8Array.from(unescape(encodeURIComponent(e)),(e=>e.charCodeAt(0)))}const optionalSelf="undefined"!=typeof self?self:void 0;var KeySystems={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},KeySystemFormats={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function keySystemFormatToKeySystemDomain(e){switch(e){case KeySystemFormats.FAIRPLAY:return KeySystems.FAIRPLAY;case KeySystemFormats.PLAYREADY:return KeySystems.PLAYREADY;case KeySystemFormats.WIDEVINE:return KeySystems.WIDEVINE;case KeySystemFormats.CLEARKEY:return KeySystems.CLEARKEY}}var KeySystemIds={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function keySystemIdToKeySystemDomain(e){if(e===KeySystemIds.WIDEVINE)return KeySystems.WIDEVINE}function keySystemDomainToKeySystemFormat(e){switch(e){case KeySystems.FAIRPLAY:return KeySystemFormats.FAIRPLAY;case KeySystems.PLAYREADY:return KeySystemFormats.PLAYREADY;case KeySystems.WIDEVINE:return KeySystemFormats.WIDEVINE;case KeySystems.CLEARKEY:return KeySystemFormats.CLEARKEY}}function getKeySystemsForConfig(e){const{drmSystems:t,widevineLicenseUrl:i}=e,r=t?[KeySystems.FAIRPLAY,KeySystems.WIDEVINE,KeySystems.PLAYREADY,KeySystems.CLEARKEY].filter((e=>!!t[e])):[];return!r[KeySystems.WIDEVINE]&&i&&r.push(KeySystems.WIDEVINE),r}const requestMediaKeySystemAccess=null!=optionalSelf&&null!=(_optionalSelf$navigat=optionalSelf.navigator)&&_optionalSelf$navigat.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var _optionalSelf$navigat;function getSupportedMediaKeySystemConfigurations(e,t,i,r){let s;switch(e){case KeySystems.FAIRPLAY:s=["cenc","sinf"];break;case KeySystems.WIDEVINE:case KeySystems.PLAYREADY:s=["cenc"];break;case KeySystems.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return createMediaKeySystemConfigurations(s,t,i,r)}function createMediaKeySystemConfigurations(e,t,i,r){return[{initDataTypes:e,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:t.map((e=>({contentType:`audio/mp4; codecs="${e}"`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}))),videoCapabilities:i.map((e=>({contentType:`video/mp4; codecs="${e}"`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null})))}]}function sliceUint8(e,t,i){return Uint8Array.prototype.slice?e.slice(t,i):new Uint8Array(Array.prototype.slice.call(e,t,i))}const isHeader$2=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,isFooter=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,getID3Data=(e,t)=>{const i=t;let r=0;for(;isHeader$2(e,t);){r+=10;r+=readSize(e,t+6),isFooter(e,t+10)&&(r+=10),t+=r}if(r>0)return e.subarray(i,i+r)},readSize=(e,t)=>{let i=0;return i=(127&e[t])<<21,i|=(127&e[t+1])<<14,i|=(127&e[t+2])<<7,i|=127&e[t+3],i},canParse$2=(e,t)=>isHeader$2(e,t)&&readSize(e,t+6)+10<=e.length-t,getTimeStamp=e=>{const t=getID3Frames(e);for(let i=0;i<t.length;i++){const e=t[i];if(isTimeStampFrame(e))return readTimeStamp(e)}},isTimeStampFrame=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,getFrameData=e=>{const t=String.fromCharCode(e[0],e[1],e[2],e[3]),i=readSize(e,4);return{type:t,size:i,data:e.subarray(10,10+i)}},getID3Frames=e=>{let t=0;const i=[];for(;isHeader$2(e,t);){const r=readSize(e,t+6);t+=10;const s=t+r;for(;t+8<s;){const r=getFrameData(e.subarray(t)),s=decodeFrame(r);s&&i.push(s),t+=r.size+10}isFooter(e,t)&&(t+=10)}return i},decodeFrame=e=>"PRIV"===e.type?decodePrivFrame(e):"W"===e.type[0]?decodeURLFrame(e):decodeTextFrame(e),decodePrivFrame=e=>{if(e.size<2)return;const t=utf8ArrayToStr(e.data,!0),i=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:i.buffer}},decodeTextFrame=e=>{if(e.size<2)return;if("TXXX"===e.type){let t=1;const i=utf8ArrayToStr(e.data.subarray(t),!0);t+=i.length+1;const r=utf8ArrayToStr(e.data.subarray(t));return{key:e.type,info:i,data:r}}const t=utf8ArrayToStr(e.data.subarray(1));return{key:e.type,data:t}},decodeURLFrame=e=>{if("WXXX"===e.type){if(e.size<2)return;let t=1;const i=utf8ArrayToStr(e.data.subarray(t),!0);t+=i.length+1;const r=utf8ArrayToStr(e.data.subarray(t));return{key:e.type,info:i,data:r}}const t=utf8ArrayToStr(e.data);return{key:e.type,data:t}},readTimeStamp=e=>{if(8===e.data.byteLength){const t=new Uint8Array(e.data),i=1&t[3];let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,i&&(r+=47721858.84),Math.round(r)}},utf8ArrayToStr=(e,t=!1)=>{const i=getTextDecoder();if(i){const r=i.decode(e);if(t){const e=r.indexOf("\0");return-1!==e?r.substring(0,e):r}return r.replace(/\0/g,"")}const r=e.length;let s,a,n,o="",l=0;for(;l<r;){if(s=e[l++],0===s&&t)return o;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:a=e[l++],o+=String.fromCharCode((31&s)<<6|63&a);break;case 14:a=e[l++],n=e[l++],o+=String.fromCharCode((15&s)<<12|(63&a)<<6|(63&n)<<0)}}return o};let decoder;function getTextDecoder(){if(!navigator.userAgent.includes("PlayStation 4"))return decoder||void 0===self.TextDecoder||(decoder=new self.TextDecoder("utf-8")),decoder}const Hex={hexDump:function(e){let t="";for(let i=0;i<e.length;i++){let r=e[i].toString(16);r.length<2&&(r="0"+r),t+=r}return t}},UINT32_MAX$1=Math.pow(2,32)-1,push=[].push,RemuxerTrackIdConfig={video:1,audio:2,id3:3,text:4};function bin2str(e){return String.fromCharCode.apply(null,e)}function readUint16(e,t){const i=e[t]<<8|e[t+1];return i<0?65536+i:i}function readUint32(e,t){const i=readSint32(e,t);return i<0?4294967296+i:i}function readUint64(e,t){let i=readUint32(e,t);return i*=Math.pow(2,32),i+=readUint32(e,t+4),i}function readSint32(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i}function hasMoofData(e){const t=e.byteLength;for(let i=0;i<t;){const r=readUint32(e,i);if(r>8&&109===e[i+4]&&111===e[i+5]&&111===e[i+6]&&102===e[i+7])return!0;i=r>1?i+r:t}return!1}function findBox(e,t){const i=[];if(!t.length)return i;const r=e.byteLength;for(let s=0;s<r;){const a=readUint32(e,s),n=a>1?s+a:r;if(bin2str(e.subarray(s+4,s+8))===t[0])if(1===t.length)i.push(e.subarray(s+8,n));else{const r=findBox(e.subarray(s+8,n),t.slice(1));r.length&&push.apply(i,r)}s=n}return i}function parseSegmentIndex(e){const t=[],i=e[0];let r=8;const s=readUint32(e,r);r+=4;let a=0,n=0;0===i?(a=readUint32(e,r),n=readUint32(e,r+4),r+=8):(a=readUint64(e,r),n=readUint64(e,r+8),r+=16),r+=2;let o=e.length+n;const l=readUint16(e,r);r+=2;for(let c=0;c<l;c++){let i=r;const a=readUint32(e,i);i+=4;const n=2147483647&a;if(1===(2147483648&a)>>>31)return logger.warn("SIDX has hierarchical references (not supported)"),null;const l=readUint32(e,i);i+=4,t.push({referenceSize:n,subsegmentDuration:l,info:{duration:l/s,start:o,end:o+n-1}}),o+=n,i+=4,r=i}return{earliestPresentationTime:a,timescale:s,version:i,referencesCount:l,references:t}}function parseInitSegment(e){const t=[],i=findBox(e,["moov","trak"]);for(let r=0;r<i.length;r++){const e=i[r],s=findBox(e,["tkhd"])[0];if(s){let i=s[0];const r=readUint32(s,0===i?12:20),a=findBox(e,["mdia","mdhd"])[0];if(a){i=a[0];const s=readUint32(a,0===i?12:20),n=findBox(e,["mdia","hdlr"])[0];if(n){const i=bin2str(n.subarray(8,12)),a={soun:ElementaryStreamTypes.AUDIO,vide:ElementaryStreamTypes.VIDEO}[i];if(a){const i=parseStsd(findBox(e,["mdia","minf","stbl","stsd"])[0]);t[r]={timescale:s,type:a},t[a]=_objectSpread2({timescale:s,id:r},i)}}}}}return findBox(e,["moov","mvex","trex"]).forEach((e=>{const i=readUint32(e,4),r=t[i];r&&(r.default={duration:readUint32(e,12),flags:readUint32(e,20)})})),t}function parseStsd(e){const t=e.subarray(8),i=t.subarray(86),r=bin2str(t.subarray(4,8));let s=r;const a="enca"===r||"encv"===r;if(a){const e=findBox(t,[r])[0];findBox(e.subarray("enca"===r?28:78),["sinf"]).forEach((e=>{const t=findBox(e,["schm"])[0];if(t){const i=bin2str(t.subarray(4,8));if("cbcs"===i||"cenc"===i){const t=findBox(e,["frma"])[0];t&&(s=bin2str(t))}}}))}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const e=findBox(i,["avcC"])[0];s+="."+toHex(e[1])+toHex(e[2])+toHex(e[3]);break}case"mp4a":{const e=findBox(t,[r])[0],i=findBox(e.subarray(28),["esds"])[0];if(i&&i.length>12){let e=4;if(3!==i[e++])break;e=skipBERInteger(i,e),e+=2;const t=i[e++];if(128&t&&(e+=2),64&t&&(e+=i[e++]),4!==i[e++])break;e=skipBERInteger(i,e);const r=i[e++];if(64!==r)break;if(s+="."+toHex(r),e+=12,5!==i[e++])break;e=skipBERInteger(i,e);const a=i[e++];let n=(248&a)>>3;31===n&&(n+=1+((7&a)<<3)+((224&i[e])>>5)),s+="."+n}break}case"hvc1":case"hev1":{const e=findBox(i,["hvcC"])[0],t=e[1],r=["","A","B","C"][t>>6],a=31&t,n=readUint32(e,2),o=(32&t)>>5?"H":"L",l=e[12],c=e.subarray(6,12);s+="."+r+a,s+="."+n.toString(16).toUpperCase(),s+="."+o+l;let u="";for(let i=c.length;i--;){const e=c[i];if(e||u){u="."+e.toString(16).toUpperCase()+u}}s+=u;break}case"dvh1":case"dvhe":{const e=findBox(i,["dvcC"])[0],t=e[2]>>1&127,r=e[2]<<5&32|e[3]>>3&31;s+="."+addLeadingZero(t)+"."+addLeadingZero(r);break}case"vp09":{const e=findBox(i,["vpcC"])[0],t=e[4],r=e[5],a=e[6]>>4&15;s+="."+addLeadingZero(t)+"."+addLeadingZero(r)+"."+addLeadingZero(a);break}case"av01":{const e=findBox(i,["av1C"])[0],t=e[1]>>>5,r=31&e[1],a=e[2]>>>7?"H":"M",n=(64&e[2])>>6,o=(32&e[2])>>5,l=2===t&&n?o?12:10:n?10:8,c=(16&e[2])>>4,u=(8&e[2])>>3,d=(4&e[2])>>2,h=3&e[2],m=1,f=1,g=1,p=0;s+="."+t+"."+addLeadingZero(r)+a+"."+addLeadingZero(l)+"."+c+"."+u+d+h+"."+addLeadingZero(m)+"."+addLeadingZero(f)+"."+addLeadingZero(g)+"."+p;break}}return{codec:s,encrypted:a}}function skipBERInteger(e,t){const i=t+5;for(;128&e[t++]&&t<i;);return t}function toHex(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function addLeadingZero(e){return(e<10?"0":"")+e}function patchEncyptionData(e,t){if(!e||!t)return e;const i=t.keyId;if(i&&t.isCommonEncryption){findBox(e,["moov","trak"]).forEach((e=>{const t=findBox(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=findBox(t,["enca"]);const s=r.length>0;s||(r=findBox(t,["encv"])),r.forEach((e=>{findBox(s?e.subarray(28):e.subarray(78),["sinf"]).forEach((e=>{const t=parseSinf(e);if(t){const e=t.subarray(8,24);e.some((e=>0!==e))||(logger.log(`[eme] Patching keyId in 'enc${s?"a":"v"}>sinf>>tenc' box: ${Hex.hexDump(e)} -> ${Hex.hexDump(i)}`),t.set(i,8))}}))}))}))}return e}function parseSinf(e){const t=findBox(e,["schm"])[0];if(t){const i=bin2str(t.subarray(4,8));if("cbcs"===i||"cenc"===i)return findBox(e,["schi","tenc"])[0]}return logger.error("[eme] missing 'schm' box"),null}function getStartDTS(e,t){return findBox(t,["moof","traf"]).reduce(((t,i)=>{const r=findBox(i,["tfdt"])[0],s=r[0],a=findBox(i,["tfhd"]).reduce(((t,i)=>{const a=readUint32(i,4),n=e[a];if(n){let e=readUint32(r,4);if(1===s){if(e===UINT32_MAX$1)return logger.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;e*=UINT32_MAX$1+1,e+=readUint32(r,8)}const i=e/(n.timescale||9e4);if(isFiniteNumber(i)&&(null===t||i<t))return i}return t}),null);return null!==a&&isFiniteNumber(a)&&(null===t||a<t)?a:t}),null)}function getDuration(e,t){let i=0,r=0,s=0;const a=findBox(e,["moof","traf"]);for(let n=0;n<a.length;n++){const e=a[n],o=findBox(e,["tfhd"])[0],l=t[readUint32(o,4)];if(!l)continue;const c=l.default,u=readUint32(o,0)|(null==c?void 0:c.flags);let d=null==c?void 0:c.duration;8&u&&(d=readUint32(o,2&u?12:8));const h=l.timescale||9e4,m=findBox(e,["trun"]);for(let t=0;t<m.length;t++){if(i=computeRawDurationFromSamples(m[t]),!i&&d){i=d*readUint32(m[t],4)}l.type===ElementaryStreamTypes.VIDEO?r+=i/h:l.type===ElementaryStreamTypes.AUDIO&&(s+=i/h)}}if(0===r&&0===s){let t=1/0,i=0,r=0;const s=findBox(e,["sidx"]);for(let e=0;e<s.length;e++){const a=parseSegmentIndex(s[e]);if(null!=a&&a.references){t=Math.min(t,a.earliestPresentationTime/a.timescale);const e=a.references.reduce(((e,t)=>e+t.info.duration||0),0);i=Math.max(i,e+a.earliestPresentationTime/a.timescale),r=i-t}}if(r&&isFiniteNumber(r))return r}return r||s}function computeRawDurationFromSamples(e){const t=readUint32(e,0);let i=8;1&t&&(i+=4),4&t&&(i+=4);let r=0;const s=readUint32(e,4);for(let a=0;a<s;a++){if(256&t){r+=readUint32(e,i),i+=4}512&t&&(i+=4),1024&t&&(i+=4),2048&t&&(i+=4)}return r}function offsetStartDTS(e,t,i){findBox(t,["moof","traf"]).forEach((t=>{findBox(t,["tfhd"]).forEach((r=>{const s=readUint32(r,4),a=e[s];if(!a)return;const n=a.timescale||9e4;findBox(t,["tfdt"]).forEach((e=>{const t=e[0],r=i*n;if(r){let i=readUint32(e,4);if(0===t)i-=r,i=Math.max(i,0),writeUint32(e,4,i);else{i*=Math.pow(2,32),i+=readUint32(e,8),i-=r,i=Math.max(i,0);const t=Math.floor(i/(UINT32_MAX$1+1)),s=Math.floor(i%(UINT32_MAX$1+1));writeUint32(e,4,t),writeUint32(e,8,s)}}}))}))}))}function segmentValidRange(e){const t={valid:null,remainder:null},i=findBox(e,["moof"]);if(i.length<2)return t.remainder=e,t;const r=i[i.length-1];return t.valid=sliceUint8(e,0,r.byteOffset-8),t.remainder=sliceUint8(e,r.byteOffset-8),t}function appendUint8Array(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function parseSamples(e,t){const i=[],r=t.samples,s=t.timescale,a=t.id;let n=!1;return findBox(r,["moof"]).map((o=>{const l=o.byteOffset-8;findBox(o,["traf"]).map((o=>{const c=findBox(o,["tfdt"]).map((e=>{const t=e[0];let i=readUint32(e,4);return 1===t&&(i*=Math.pow(2,32),i+=readUint32(e,8)),i/s}))[0];return void 0!==c&&(e=c),findBox(o,["tfhd"]).map((c=>{const u=readUint32(c,4),d=16777215&readUint32(c,0);let h=0;const m=0!=(16&d);let f=0;const g=0!=(32&d);let p=8;u===a&&(0!=(1&d)&&(p+=8),0!=(2&d)&&(p+=4),0!=(8&d)&&(h=readUint32(c,p),p+=4),m&&(f=readUint32(c,p),p+=4),g&&(p+=4),"video"===t.type&&(n=isHEVC(t.codec)),findBox(o,["trun"]).map((a=>{const o=a[0],c=16777215&readUint32(a,0),u=0!=(1&c);let d=0;const m=0!=(4&c),g=0!=(256&c);let p=0;const v=0!=(512&c);let y=0;const E=0!=(1024&c),T=0!=(2048&c);let S=0;const _=readUint32(a,4);let k=8;u&&(d=readUint32(a,k),k+=4),m&&(k+=4);let b=d+l;for(let l=0;l<_;l++){if(g?(p=readUint32(a,k),k+=4):p=h,v?(y=readUint32(a,k),k+=4):y=f,E&&(k+=4),T&&(S=0===o?readUint32(a,k):readSint32(a,k),k+=4),t.type===ElementaryStreamTypes.VIDEO){let t=0;for(;t<y;){const a=readUint32(r,b);if(b+=4,isSEIMessage(n,r[b])){parseSEIMessageFromNALu(r.subarray(b,b+a),n?2:1,e+S/s,i)}b+=a,t+=a+4}}e+=p/s}})))}))}))})),i}function isHEVC(e){if(!e)return!1;const t=e.indexOf("."),i=t<0?e:e.substring(0,t);return"hvc1"===i||"hev1"===i||"dvh1"===i||"dvhe"===i}function isSEIMessage(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6===(31&t)}function parseSEIMessageFromNALu(e,t,i,r){const s=discardEPB(e);let a=0;a+=t;let n=0,o=0,l=0;for(;a<s.length;){n=0;do{if(a>=s.length)break;l=s[a++],n+=l}while(255===l);o=0;do{if(a>=s.length)break;l=s[a++],o+=l}while(255===l);const e=s.length-a;let t=a;if(o<e)a+=o;else if(o>e){logger.error(`Malformed SEI payload. ${o} is too small, only ${e} bytes left to parse.`);break}if(4===n){if(181===s[t++]){const e=readUint16(s,t);if(t+=2,49===e){const e=readUint32(s,t);if(t+=4,1195456820===e){const e=s[t++];if(3===e){const a=s[t++],o=64&a,l=o?2+3*(31&a):0,c=new Uint8Array(l);if(o){c[0]=a;for(let e=1;e<l;e++)c[e]=s[t++]}r.push({type:e,payloadType:n,pts:i,bytes:c})}}}}}else if(5===n&&o>16){const e=[];for(let i=0;i<16;i++){const r=s[t++].toString(16);e.push(1==r.length?"0"+r:r),3!==i&&5!==i&&7!==i&&9!==i||e.push("-")}const a=o-16,l=new Uint8Array(a);for(let i=0;i<a;i++)l[i]=s[t++];r.push({payloadType:n,pts:i,uuid:e.join(""),userData:utf8ArrayToStr(l),userDataBytes:l})}}}function discardEPB(e){const t=e.byteLength,i=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return e;const s=t-i.length,a=new Uint8Array(s);let n=0;for(r=0;r<s;n++,r++)n===i[0]&&(n++,i.shift()),a[r]=e[n];return a}function parseEmsg(e){const t=e[0];let i="",r="",s=0,a=0,n=0,o=0,l=0,c=0;if(0===t){for(;"\0"!==bin2str(e.subarray(c,c+1));)i+=bin2str(e.subarray(c,c+1)),c+=1;for(i+=bin2str(e.subarray(c,c+1)),c+=1;"\0"!==bin2str(e.subarray(c,c+1));)r+=bin2str(e.subarray(c,c+1)),c+=1;r+=bin2str(e.subarray(c,c+1)),c+=1,s=readUint32(e,12),a=readUint32(e,16),o=readUint32(e,20),l=readUint32(e,24),c=28}else if(1===t){c+=4,s=readUint32(e,c),c+=4;const t=readUint32(e,c);c+=4;const a=readUint32(e,c);for(c+=4,n=2**32*t+a,isSafeInteger(n)||(n=Number.MAX_SAFE_INTEGER,logger.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=readUint32(e,c),c+=4,l=readUint32(e,c),c+=4;"\0"!==bin2str(e.subarray(c,c+1));)i+=bin2str(e.subarray(c,c+1)),c+=1;for(i+=bin2str(e.subarray(c,c+1)),c+=1;"\0"!==bin2str(e.subarray(c,c+1));)r+=bin2str(e.subarray(c,c+1)),c+=1;r+=bin2str(e.subarray(c,c+1)),c+=1}return{schemeIdUri:i,value:r,timeScale:s,presentationTime:n,presentationTimeDelta:a,eventDuration:o,id:l,payload:e.subarray(c,e.byteLength)}}function mp4Box(e,...t){const i=t.length;let r=8,s=i;for(;s--;)r+=t[s].byteLength;const a=new Uint8Array(r);for(a[0]=r>>24&255,a[1]=r>>16&255,a[2]=r>>8&255,a[3]=255&r,a.set(e,4),s=0,r=8;s<i;s++)a.set(t[s],r),r+=t[s].byteLength;return a}function mp4pssh(e,t,i){if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,s,a;if(t){r=1,s=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");s.set(i,16*e)}}else r=0,s=new Uint8Array;r>0?(a=new Uint8Array(4),t.length>0&&new DataView(a.buffer).setUint32(0,t.length,!1)):a=new Uint8Array;const n=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(n.buffer).setUint32(0,i.byteLength,!1),mp4Box([112,115,115,104],new Uint8Array([r,0,0,0]),e,a,s,n,i||new Uint8Array)}function parsePssh(e){if(!(e instanceof ArrayBuffer)||e.byteLength<32)return null;const t={version:0,systemId:"",kids:null,data:null},i=new DataView(e),r=i.getUint32(0);if(e.byteLength!==r&&r>44)return null;if(1886614376!==i.getUint32(4))return null;if(t.version=i.getUint32(8)>>>24,t.version>1)return null;t.systemId=Hex.hexDump(new Uint8Array(e,12,16));const s=i.getUint32(28);if(0===t.version){if(r-32<s)return null;t.data=new Uint8Array(e,32,s)}else if(1===t.version){t.kids=[];for(let i=0;i<s;i++)t.kids.push(new Uint8Array(e,32+16*i,16))}return t}let keyUriToKeyIdMap={};class LevelKey{static clearKeyUriToKeyIdMap(){keyUriToKeyIdMap={}}constructor(e,t,i,r=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=r,this.iv=s,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&"AES-128"!==e}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case KeySystemFormats.FAIRPLAY:case KeySystemFormats.WIDEVINE:case KeySystemFormats.PLAYREADY:case KeySystemFormats.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof e&&("AES-128"!==this.method||this.iv||logger.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=createInitializationVector(e);return new LevelKey(this.method,this.uri,"identity",this.keyFormatVersions,t)}const t=convertDataUriToArrayBytes(this.uri);if(t)switch(this.keyFormat){case KeySystemFormats.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case KeySystemFormats.PLAYREADY:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=mp4pssh(e,null,t);const i=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),r=String.fromCharCode.apply(null,Array.from(i)),s=r.substring(r.indexOf("<"),r.length),a=(new DOMParser).parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(a){const e=a.childNodes[0]?a.childNodes[0].nodeValue:a.getAttribute("VALUE");if(e){const t=base64Decode(e).subarray(0,16);changeEndianness(t),this.keyId=t}}break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=keyUriToKeyIdMap[this.uri];if(!e){const t=Object.keys(keyUriToKeyIdMap).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);new DataView(e.buffer,12,4).setUint32(0,t),keyUriToKeyIdMap[this.uri]=e}this.keyId=e}return this}}function createInitializationVector(e){const t=new Uint8Array(16);for(let i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}const VARIABLE_REPLACEMENT_REGEX=/\{\$([a-zA-Z0-9-_]+)\}/g;function hasVariableReferences(e){return VARIABLE_REPLACEMENT_REGEX.test(e)}function substituteVariablesInAttributes(e,t,i){if(null!==e.variableList||e.hasVariableRefs)for(let r=i.length;r--;){const s=i[r],a=t[s];a&&(t[s]=substituteVariables(e,a))}}function substituteVariables(e,t){if(null!==e.variableList||e.hasVariableRefs){const i=e.variableList;return t.replace(VARIABLE_REPLACEMENT_REGEX,(t=>{const r=t.substring(2,t.length-1),s=null==i?void 0:i[r];return void 0===s?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),t):s}))}return t}function addVariableDefinition(e,t,i){let r,s,a=e.variableList;if(a||(e.variableList=a={}),"QUERYPARAM"in t){r=t.QUERYPARAM;try{const e=new self.URL(i).searchParams;if(!e.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${i}"`);s=e.get(r)}catch(n){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${n.message}`))}}else r=t.NAME,s=t.VALUE;r in a?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):a[r]=s||""}function importVariableDefinition(e,t,i){const r=t.IMPORT;if(i&&r in i){let t=e.variableList;t||(e.variableList=t={}),t[r]=i[r]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}function getMediaSource(e=!0){if("undefined"==typeof self)return;return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const sampleEntryCodesISO={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function isCodecType(e,t){const i=sampleEntryCodesISO[t];return!!i&&!!i[e.slice(0,4)]}function areCodecsMediaSourceSupported(e,t,i=!0){return!e.split(",").some((e=>!isCodecMediaSourceSupported(e,t,i)))}function isCodecMediaSourceSupported(e,t,i=!0){var r;const s=getMediaSource(i);return null!=(r=null==s?void 0:s.isTypeSupported(mimeTypeForCodec(e,t)))&&r}function mimeTypeForCodec(e,t){return`${t}/mp4;codecs="${e}"`}function videoCodecPreferenceValue(e){if(e){const t=e.substring(0,4);return sampleEntryCodesISO.video[t]}return 2}function codecsSetSelectionPreferenceValue(e){return e.split(",").reduce(((e,t)=>{const i=sampleEntryCodesISO.video[t];return i?(2*i+e)/(e?3:2):(sampleEntryCodesISO.audio[t]+e)/(e?2:1)}),0)}const CODEC_COMPATIBLE_NAMES={};function getCodecCompatibleNameLower(e,t=!0){if(CODEC_COMPATIBLE_NAMES[e])return CODEC_COMPATIBLE_NAMES[e];const i={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[e];for(let r=0;r<i.length;r++)if(isCodecMediaSourceSupported(i[r],"audio",t))return CODEC_COMPATIBLE_NAMES[e]=i[r],i[r];return e}const AUDIO_CODEC_REGEXP=/flac|opus/i;function getCodecCompatibleName(e,t=!0){return e.replace(AUDIO_CODEC_REGEXP,(e=>getCodecCompatibleNameLower(e.toLowerCase(),t)))}function pickMostCompleteCodecName(e,t){return e&&"mp4a"!==e?e:t}function convertAVC1ToAVCOTI(e){const t=e.split(".");if(t.length>2){let e=t.shift()+".";return e+=parseInt(t.shift()).toString(16),e+=("000"+parseInt(t.shift()).toString(16)).slice(-4),e}return e}const MASTER_PLAYLIST_REGEX=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,MASTER_PLAYLIST_MEDIA_REGEX=/#EXT-X-MEDIA:(.*)/g,IS_MEDIA_PLAYLIST=/^#EXT(?:INF|-X-TARGETDURATION):/m,LEVEL_PLAYLIST_REGEX_FAST=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),LEVEL_PLAYLIST_REGEX_SLOW=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class M3U8Parser{static findGroup(e,t){for(let i=0;i<e.length;i++){const r=e[i];if(r.id===t)return r}}static resolve(e,t){return urlToolkitExports.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return IS_MEDIA_PLAYLIST.test(e)}static parseMasterPlaylist(e,t){const i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:hasVariableReferences(e)},r=[];let s;for(MASTER_PLAYLIST_REGEX.lastIndex=0;null!=(s=MASTER_PLAYLIST_REGEX.exec(e));)if(s[1]){var a;const e=new AttrList(s[1]);substituteVariablesInAttributes(i,e,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const n=substituteVariables(i,s[2]),o={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:M3U8Parser.resolve(n,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),setCodecs(e.CODECS,o),null!=(a=o.unknownCodecs)&&a.length||r.push(o),i.levels.push(o)}else if(s[3]){const e=s[3],r=s[4];switch(e){case"SESSION-DATA":{const e=new AttrList(r);substituteVariablesInAttributes(i,e,["DATA-ID","LANGUAGE","VALUE","URI"]);const t=e["DATA-ID"];t&&(null===i.sessionData&&(i.sessionData={}),i.sessionData[t]=e);break}case"SESSION-KEY":{const e=parseKey(r,t,i);e.encrypted&&e.isSupported()?(null===i.sessionKeys&&(i.sessionKeys=[]),i.sessionKeys.push(e)):logger.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":{const e=new AttrList(r);substituteVariablesInAttributes(i,e,["NAME","VALUE","QUERYPARAM"]),addVariableDefinition(i,e,t)}break;case"CONTENT-STEERING":{const e=new AttrList(r);substituteVariablesInAttributes(i,e,["SERVER-URI","PATHWAY-ID"]),i.contentSteering={uri:M3U8Parser.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":i.startTimeOffset=parseStartTimeOffset(r)}}const n=r.length>0&&r.length<i.levels.length;return i.levels=n?r:i.levels,0===i.levels.length&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(e,t,i){let r;const s={},a=i.levels,n={AUDIO:a.map((e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec}))),SUBTITLES:a.map((e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec}))),"CLOSED-CAPTIONS":[]};let o=0;for(MASTER_PLAYLIST_MEDIA_REGEX.lastIndex=0;null!==(r=MASTER_PLAYLIST_MEDIA_REGEX.exec(e));){const e=new AttrList(r[1]),a=e.TYPE;if(a){const r=n[a],l=s[a]||[];s[a]=l,substituteVariablesInAttributes(i,e,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const c=e.LANGUAGE,u=e["ASSOC-LANGUAGE"],d=e.CHANNELS,h=e.CHARACTERISTICS,m=e["INSTREAM-ID"],f={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",name:e.NAME||c||"",type:a,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:c,url:e.URI?M3U8Parser.resolve(e.URI,t):""};if(u&&(f.assocLang=u),d&&(f.channels=d),h&&(f.characteristics=h),m&&(f.instreamId=m),null!=r&&r.length){const e=M3U8Parser.findGroup(r,f.groupId)||r[0];assignCodec(f,e,"audioCodec"),assignCodec(f,e,"textCodec")}l.push(f)}}return s}static parseLevelPlaylist(e,t,i,r,s,a){const n=new LevelDetails(t),o=n.fragments;let l,c,u,d=null,h=0,m=0,f=0,g=0,p=null,v=new Fragment(r,t),y=-1,E=!1,T=null;for(LEVEL_PLAYLIST_REGEX_FAST.lastIndex=0,n.m3u8=e,n.hasVariableRefs=hasVariableReferences(e);null!==(l=LEVEL_PLAYLIST_REGEX_FAST.exec(e));){E&&(E=!1,v=new Fragment(r,t),v.start=f,v.sn=h,v.cc=g,v.level=i,d&&(v.initSegment=d,v.rawProgramDateTime=d.rawProgramDateTime,d.rawProgramDateTime=null,T&&(v.setByteRange(T),T=null)));const e=l[1];if(e){v.duration=parseFloat(e);const t=(" "+l[2]).slice(1);v.title=t||null,v.tagList.push(t?["INF",e,t]:["INF",e])}else if(l[3]){if(isFiniteNumber(v.duration)){v.start=f,u&&setFragLevelKeys(v,u,n),v.sn=h,v.level=i,v.cc=g,o.push(v);const e=(" "+l[3]).slice(1);v.relurl=substituteVariables(n,e),assignProgramDateTime(v,p),p=v,f+=v.duration,h++,m=0,E=!0}}else if(l[4]){const e=(" "+l[4]).slice(1);p?v.setByteRange(e,p):v.setByteRange(e)}else if(l[5])v.rawProgramDateTime=(" "+l[5]).slice(1),v.tagList.push(["PROGRAM-DATE-TIME",v.rawProgramDateTime]),-1===y&&(y=o.length);else{if(l=l[0].match(LEVEL_PLAYLIST_REGEX_SLOW),!l){logger.warn("No matches on slow regex match for level playlist!");continue}for(c=1;c<l.length&&void 0===l[c];c++);const e=(" "+l[c]).slice(1),s=(" "+l[c+1]).slice(1),f=l[c+2]?(" "+l[c+2]).slice(1):"";switch(e){case"PLAYLIST-TYPE":n.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":h=n.startSN=parseInt(s);break;case"SKIP":{const e=new AttrList(s);substituteVariablesInAttributes(n,e,["RECENTLY-REMOVED-DATERANGES"]);const t=e.decimalInteger("SKIPPED-SEGMENTS");if(isFiniteNumber(t)){n.skippedSegments=t;for(let e=t;e--;)o.unshift(null);h+=t}const i=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");i&&(n.recentlyRemovedDateranges=i.split("\t"));break}case"TARGETDURATION":n.targetduration=Math.max(parseInt(s),1);break;case"VERSION":n.version=parseInt(s);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":n.live=!1;break;case"#":(s||f)&&v.tagList.push(f?[s,f]:[s]);break;case"DISCONTINUITY":g++,v.tagList.push(["DIS"]);break;case"GAP":v.gap=!0,v.tagList.push([e]);break;case"BITRATE":v.tagList.push([e,s]);break;case"DATERANGE":{const e=new AttrList(s);substituteVariablesInAttributes(n,e,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),substituteVariablesInAttributes(n,e,e.clientAttrs);const t=new DateRange(e,n.dateRanges[e.ID]);t.isValid||n.skippedSegments?n.dateRanges[t.id]=t:logger.warn(`Ignoring invalid DATERANGE tag: "${s}"`),v.tagList.push(["EXT-X-DATERANGE",s]);break}case"DEFINE":{const e=new AttrList(s);substituteVariablesInAttributes(n,e,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in e?importVariableDefinition(n,e,a):addVariableDefinition(n,e,t)}break;case"DISCONTINUITY-SEQUENCE":g=parseInt(s);break;case"KEY":{const e=parseKey(s,t,n);if(e.isSupported()){if("NONE"===e.method){u=void 0;break}u||(u={}),u[e.keyFormat]&&(u=_extends({},u)),u[e.keyFormat]=e}else logger.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${s}"`);break}case"START":n.startTimeOffset=parseStartTimeOffset(s);break;case"MAP":{const e=new AttrList(s);if(substituteVariablesInAttributes(n,e,["BYTERANGE","URI"]),v.duration){const s=new Fragment(r,t);setInitSegment(s,e,i,u),d=s,v.initSegment=d,d.rawProgramDateTime&&!v.rawProgramDateTime&&(v.rawProgramDateTime=d.rawProgramDateTime)}else{const t=v.byteRangeEndOffset;if(t){const e=v.byteRangeStartOffset;T=`${t-e}@${e}`}else T=null;setInitSegment(v,e,i,u),d=v,E=!0}break}case"SERVER-CONTROL":{const e=new AttrList(s);n.canBlockReload=e.bool("CAN-BLOCK-RELOAD"),n.canSkipUntil=e.optionalFloat("CAN-SKIP-UNTIL",0),n.canSkipDateRanges=n.canSkipUntil>0&&e.bool("CAN-SKIP-DATERANGES"),n.partHoldBack=e.optionalFloat("PART-HOLD-BACK",0),n.holdBack=e.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const e=new AttrList(s);n.partTarget=e.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=n.partList;e||(e=n.partList=[]);const i=m>0?e[e.length-1]:void 0,r=m++,a=new AttrList(s);substituteVariablesInAttributes(n,a,["BYTERANGE","URI"]);const o=new Part(a,v,t,r,i);e.push(o),v.duration+=o.duration;break}case"PRELOAD-HINT":{const e=new AttrList(s);substituteVariablesInAttributes(n,e,["URI"]),n.preloadHint=e;break}case"RENDITION-REPORT":{const e=new AttrList(s);substituteVariablesInAttributes(n,e,["URI"]),n.renditionReports=n.renditionReports||[],n.renditionReports.push(e);break}default:logger.warn(`line parsed but not handled: ${l}`)}}}p&&!p.relurl?(o.pop(),f-=p.duration,n.partList&&(n.fragmentHint=p)):n.partList&&(assignProgramDateTime(v,p),v.cc=g,n.fragmentHint=v,u&&setFragLevelKeys(v,u,n));const S=o.length,_=o[0],k=o[S-1];if(f+=n.skippedSegments*n.targetduration,f>0&&S&&k){n.averagetargetduration=f/S;const e=k.sn;n.endSN="initSegment"!==e?e:0,n.live||(k.endList=!0),_&&(n.startCC=_.cc)}else n.endSN=0,n.startCC=0;return n.fragmentHint&&(f+=n.fragmentHint.duration),n.totalduration=f,n.endCC=g,y>0&&backfillProgramDateTimes(o,y),n}}function parseKey(e,t,i){var r,s;const a=new AttrList(e);substituteVariablesInAttributes(i,a,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const n=null!=(r=a.METHOD)?r:"",o=a.URI,l=a.hexadecimalInteger("IV"),c=a.KEYFORMATVERSIONS,u=null!=(s=a.KEYFORMAT)?s:"identity";o&&a.IV&&!l&&logger.error(`Invalid IV: ${a.IV}`);const d=o?M3U8Parser.resolve(o,t):"",h=(c||"1").split("/").map(Number).filter(Number.isFinite);return new LevelKey(n,d,u,h,l)}function parseStartTimeOffset(e){const t=new AttrList(e).decimalFloatingPoint("TIME-OFFSET");return isFiniteNumber(t)?t:null}function setCodecs(e,t){let i=(e||"").split(/[ ,]+/).filter((e=>e));["video","audio","text"].forEach((e=>{const r=i.filter((t=>isCodecType(t,e)));r.length&&(t[`${e}Codec`]=r.join(","),i=i.filter((e=>-1===r.indexOf(e))))})),t.unknownCodecs=i}function assignCodec(e,t,i){const r=t[i];r&&(e[i]=r)}function backfillProgramDateTimes(e,t){let i=e[t];for(let r=t;r--;){const t=e[r];if(!t)return;t.programDateTime=i.programDateTime-1e3*t.duration,i=t}}function assignProgramDateTime(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),isFiniteNumber(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function setInitSegment(e,t,i,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=i,e.sn="initSegment",r&&(e.levelkeys=r),e.initSegment=null}function setFragLevelKeys(e,t,i){e.levelkeys=t;const{encryptedFragments:r}=i;r.length&&r[r.length-1].levelkeys===t||!Object.keys(t).some((e=>t[e].isCommonEncryption))||r.push(e)}var PlaylistContextType={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},PlaylistLevelType={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function mapContextToLevelType(e){const{type:t}=e;switch(t){case PlaylistContextType.AUDIO_TRACK:return PlaylistLevelType.AUDIO;case PlaylistContextType.SUBTITLE_TRACK:return PlaylistLevelType.SUBTITLE;default:return PlaylistLevelType.MAIN}}function getResponseUrl(e,t){let i=e.url;return void 0!==i&&0!==i.indexOf("data:")||(i=t.url),i}class PlaylistLoader{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,r=t.loader,s=new(i||r)(t);return this.loaders[e.type]=s,s}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:PlaylistContextType.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:r,pathwayId:s,url:a,deliveryDirectives:n}=t;this.load({id:i,level:r,pathwayId:s,responseType:"text",type:PlaylistContextType.LEVEL,url:a,deliveryDirectives:n})}onAudioTrackLoading(e,t){const{id:i,groupId:r,url:s,deliveryDirectives:a}=t;this.load({id:i,groupId:r,level:null,responseType:"text",type:PlaylistContextType.AUDIO_TRACK,url:s,deliveryDirectives:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:r,url:s,deliveryDirectives:a}=t;this.load({id:i,groupId:r,level:null,responseType:"text",type:PlaylistContextType.SUBTITLE_TRACK,url:s,deliveryDirectives:a})}load(e){var t;const i=this.hls.config;let r,s=this.getInternalLoader(e);if(s){const t=s.context;if(t&&t.url===e.url&&t.level===e.level)return void logger.trace("[playlist-loader]: playlist request ongoing");logger.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}if(r=e.type===PlaylistContextType.MANIFEST?i.manifestLoadPolicy.default:_extends({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),isFiniteNumber(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if(e.type===PlaylistContextType.LEVEL&&null!==e.level?t=this.hls.levels[e.level].details:e.type===PlaylistContextType.AUDIO_TRACK&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===PlaylistContextType.SUBTITLE_TRACK&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,i=t.targetduration;if(e&&i){const t=1e3*Math.max(3*e,.8*i);r=_extends({},r,{maxTimeToFirstByteMs:Math.min(t,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,r.maxTimeToFirstByteMs)})}}}const a=r.errorRetry||r.timeoutRetry||{},n={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},o={onSuccess:(e,t,i,r)=>{const s=this.getInternalLoader(i);this.resetInternalLoader(i.type);const a=e.data;0===a.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),M3U8Parser.isMediaPlaylist(a)?this.handleTrackOrLevelPlaylist(e,t,i,r||null,s):this.handleMasterPlaylist(e,t,i,r)):this.handleManifestParsingError(e,i,new Error("no EXTM3U delimiter"),r||null,t)},onError:(e,t,i,r)=>{this.handleNetworkError(t,i,!1,e,r)},onTimeout:(e,t,i)=>{this.handleNetworkError(t,i,!0,void 0,e)}};s.load(e,n,o)}handleMasterPlaylist(e,t,i,r){const s=this.hls,a=e.data,n=getResponseUrl(e,i),o=M3U8Parser.parseMasterPlaylist(a,n);if(o.playlistParsingError)return void this.handleManifestParsingError(e,i,o.playlistParsingError,r,t);const{contentSteering:l,levels:c,sessionData:u,sessionKeys:d,startTimeOffset:h,variableList:m}=o;this.variableList=m;const{AUDIO:f=[],SUBTITLES:g,"CLOSED-CAPTIONS":p}=M3U8Parser.parseMasterPlaylistMedia(a,n,o);if(f.length){f.some((e=>!e.url))||!c[0].audioCodec||c[0].attrs.AUDIO||(logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),f.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new AttrList({}),bitrate:0,url:""}))}s.trigger(Events.MANIFEST_LOADED,{levels:c,audioTracks:f,subtitles:g,captions:p,contentSteering:l,url:n,stats:t,networkDetails:r,sessionData:u,sessionKeys:d,startTimeOffset:h,variableList:m})}handleTrackOrLevelPlaylist(e,t,i,r,s){const a=this.hls,{id:n,level:o,type:l}=i,c=getResponseUrl(e,i),u=isFiniteNumber(o)?o:isFiniteNumber(n)?n:0,d=mapContextToLevelType(i),h=M3U8Parser.parseLevelPlaylist(e.data,c,u,d,0,this.variableList);if(l===PlaylistContextType.MANIFEST){const e={attrs:new AttrList({}),bitrate:0,details:h,name:"",url:c};a.trigger(Events.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:c,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=h,this.handlePlaylistLoaded(h,e,t,i,r,s)}handleManifestParsingError(e,t,i,r,s){this.hls.trigger(Events.ERROR,{type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.MANIFEST_PARSING_ERROR,fatal:t.type===PlaylistContextType.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:r,stats:s})}handleNetworkError(e,t,i=!1,r,s){let a=`A network ${i?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${e.type}`;e.type===PlaylistContextType.LEVEL?a+=`: ${e.level} id: ${e.id}`:e.type!==PlaylistContextType.AUDIO_TRACK&&e.type!==PlaylistContextType.SUBTITLE_TRACK||(a+=` id: ${e.id} group-id: "${e.groupId}"`);const n=new Error(a);logger.warn(`[playlist-loader]: ${a}`);let o=ErrorDetails.UNKNOWN,l=!1;const c=this.getInternalLoader(e);switch(e.type){case PlaylistContextType.MANIFEST:o=i?ErrorDetails.MANIFEST_LOAD_TIMEOUT:ErrorDetails.MANIFEST_LOAD_ERROR,l=!0;break;case PlaylistContextType.LEVEL:o=i?ErrorDetails.LEVEL_LOAD_TIMEOUT:ErrorDetails.LEVEL_LOAD_ERROR,l=!1;break;case PlaylistContextType.AUDIO_TRACK:o=i?ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:ErrorDetails.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case PlaylistContextType.SUBTITLE_TRACK:o=i?ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:ErrorDetails.SUBTITLE_LOAD_ERROR,l=!1}c&&this.resetInternalLoader(e.type);const u={type:ErrorTypes.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:c,context:e,error:n,networkDetails:t,stats:s};if(r){const i=(null==t?void 0:t.url)||e.url;u.response=_objectSpread2({url:i,data:void 0},r)}this.hls.trigger(Events.ERROR,u)}handlePlaylistLoaded(e,t,i,r,s,a){const n=this.hls,{type:o,level:l,id:c,groupId:u,deliveryDirectives:d}=r,h=getResponseUrl(t,r),m=mapContextToLevelType(r),f="number"==typeof r.level&&m===PlaylistLevelType.MAIN?l:void 0;if(!e.fragments.length){const e=new Error("No Segments found in Playlist");return void n.trigger(Events.ERROR,{type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:h,error:e,reason:e.message,response:t,context:r,level:f,parent:m,networkDetails:s,stats:i})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const g=e.playlistParsingError;if(g)n.trigger(Events.ERROR,{type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.LEVEL_PARSING_ERROR,fatal:!1,url:h,error:g,reason:g.message,response:t,context:r,level:f,parent:m,networkDetails:s,stats:i});else switch(e.live&&a&&(a.getCacheAge&&(e.ageHeader=a.getCacheAge()||0),a.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),o){case PlaylistContextType.MANIFEST:case PlaylistContextType.LEVEL:n.trigger(Events.LEVEL_LOADED,{details:e,level:f||0,id:c||0,stats:i,networkDetails:s,deliveryDirectives:d});break;case PlaylistContextType.AUDIO_TRACK:n.trigger(Events.AUDIO_TRACK_LOADED,{details:e,id:c||0,groupId:u||"",stats:i,networkDetails:s,deliveryDirectives:d});break;case PlaylistContextType.SUBTITLE_TRACK:n.trigger(Events.SUBTITLE_TRACK_LOADED,{details:e,id:c||0,groupId:u||"",stats:i,networkDetails:s,deliveryDirectives:d})}}}function sendAddTrackEvent(e,t){let i;try{i=new Event("addtrack")}catch(r){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}function addCueToTrack(e,t){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(r){logger.debug(`[texttrack-utils]: ${r}`);try{const i=new self.TextTrackCue(t.startTime,t.endTime,t.text);i.id=t.id,e.addCue(i)}catch(s){logger.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}"disabled"===i&&(e.mode=i)}function clearCurrentCues(e){const t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(let i=e.cues.length;i--;)e.removeCue(e.cues[i]);"disabled"===t&&(e.mode=t)}function removeCuesInRange(e,t,i,r){const s=e.mode;if("disabled"===s&&(e.mode="hidden"),e.cues&&e.cues.length>0){const s=getCuesInRange(e.cues,t,i);for(let t=0;t<s.length;t++)r&&!r(s[t])||e.removeCue(s[t])}"disabled"===s&&(e.mode=s)}function getFirstCueIndexAfterTime(e,t){if(t<e[0].startTime)return 0;const i=e.length-1;if(t>e[i].endTime)return-1;let r=0,s=i;for(;r<=s;){const a=Math.floor((s+r)/2);if(t<e[a].startTime)s=a-1;else{if(!(t>e[a].startTime&&r<i))return a;r=a+1}}return e[r].startTime-t<t-e[s].startTime?r:s}function getCuesInRange(e,t,i){const r=[],s=getFirstCueIndexAfterTime(e,t);if(s>-1)for(let a=s,n=e.length;a<n;a++){const s=e[a];if(s.startTime>=t&&s.endTime<=i)r.push(s);else if(s.startTime>i)return r}return r}function filterSubtitleTracks(e){const t=[];for(let i=0;i<e.length;i++){const r=e[i];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||t.push(e[i])}return t}var MetadataSchema={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const MIN_CUE_DURATION=.25;function getCueClass(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function createCueWithDataFields(e,t,i,r,s){let a=new e(t,i,"");try{a.value=r,s&&(a.type=s)}catch(e2){a=new e(t,i,JSON.stringify(s?_objectSpread2({type:s},r):r))}return a}const MAX_CUE_ENDTIME=(()=>{const e=getCueClass();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e2){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function dateRangeDateToTimelineSeconds(e,t){return e.getTime()/1e3-t}function hexToArrayBuffer(e){return Uint8Array.from(e.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class ID3TrackController{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(clearCurrentCues(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if("metadata"===i.kind&&"id3"===i.label)return sendAddTrackEvent(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:r}}}=this;if(!i&&!r)return;const{samples:s}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const a=getCueClass();if(a)for(let n=0;n<s.length;n++){const e=s[n].type;if(e===MetadataSchema.emsg&&!i||!r)continue;const t=getID3Frames(s[n].data);if(t){const i=s[n].pts;let r=i+s[n].duration;r>MAX_CUE_ENDTIME&&(r=MAX_CUE_ENDTIME);r-i<=0&&(r=i+MIN_CUE_DURATION);for(let s=0;s<t.length;s++){const n=t[s];if(!isTimeStampFrame(n)){this.updateId3CueEnds(i,e);const t=createCueWithDataFields(a,i,r,n,e);t&&this.id3Track.addCue(t)}}}}}updateId3CueEnds(e,t){var i;const r=null==(i=this.id3Track)?void 0:i.cues;if(r)for(let s=r.length;s--;){const i=r[s];i.type===t&&i.startTime<e&&i.endTime===MAX_CUE_ENDTIME&&(i.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:r}){const{id3Track:s,hls:a}=this;if(!a)return;const{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:o}}=a;if(s&&(n||o)){let e;e="audio"===r?e=>e.type===MetadataSchema.audioId3&&o:"video"===r?e=>e.type===MetadataSchema.emsg&&n:e=>e.type===MetadataSchema.audioId3&&o||e.type===MetadataSchema.emsg&&n,removeCuesInRange(s,t,i,e)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:r}=this,{dateRanges:s}=t,a=Object.keys(s);if(r){const e=Object.keys(i).filter((e=>!a.includes(e)));for(let t=e.length;t--;){const s=e[t];Object.keys(i[s].cues).forEach((e=>{r.removeCue(i[s].cues[e])})),delete i[s]}}const n=t.fragments[t.fragments.length-1];if(0===a.length||!isFiniteNumber(null==n?void 0:n.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=n.programDateTime/1e3-n.start,l=getCueClass();for(let c=0;c<a.length;c++){const e=a[c],t=s[e],r=dateRangeDateToTimelineSeconds(t.startDate,o),n=i[e],u=(null==n?void 0:n.cues)||{};let d=(null==n?void 0:n.durationKnown)||!1,h=MAX_CUE_ENDTIME;const m=t.endDate;if(m)h=dateRangeDateToTimelineSeconds(m,o),d=!0;else if(t.endOnNext&&!d){const e=a.reduce(((e,i)=>{if(i!==t.id){const r=s[i];if(r.class===t.class&&r.startDate>t.startDate&&(!e||t.startDate<e.startDate))return r}return e}),null);e&&(h=dateRangeDateToTimelineSeconds(e.startDate,o),d=!0)}const f=Object.keys(t.attr);for(let i=0;i<f.length;i++){const s=f[i];if(!isDateRangeCueAttribute(s))continue;const a=u[s];if(a)d&&!n.durationKnown&&(a.endTime=h);else if(l){let i=t.attr[s];isSCTE35Attribute(s)&&(i=hexToArrayBuffer(i));const a=createCueWithDataFields(l,r,h,{key:s,data:i},MetadataSchema.dateRange);a&&(a.id=e,this.id3Track.addCue(a),u[s]=a)}}i[e]={cues:u,dateRange:t,durationKnown:d}}}}class LatencyController{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(null===e)return null;const{holdBack:t,partHoldBack:i,targetduration:r}=e,{liveSyncDuration:s,liveSyncDurationCount:a,lowLatencyMode:n}=this.config,o=this.hls.userConfig;let l=n&&i||t;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==s?s:a*r);const c=r;return l+Math.min(1*this.stallCount,c)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(null===e||null===t||null===i)return null;const r=i.edge,s=e-t-this.edgeStalled,a=r-i.totalduration,n=r-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(a,s),n)}get drift(){const{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(Events.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(Events.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var i;t.details===ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(i=this.levelDetails)&&i.live&&logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(null===i)return;this._latency=i;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:s}=this.config;if(!r||1===s||!t.live)return;const a=this.targetLatency;if(null===a)return;const n=i-a;if(n<Math.min(this.maxLatency,a+t.targetduration)&&n>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,s)),i=Math.round(2/(1+Math.exp(-.75*n-this.edgeStalled))*20)/20;e.playbackRate=Math.min(t,Math.max(1,i))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}const HdcpLevels=["NONE","TYPE-0","TYPE-1",null];function isHdcpLevel(e){return HdcpLevels.indexOf(e)>-1}const VideoRangeValues=["SDR","PQ","HLG"];function isVideoRange(e){return!!e&&VideoRangeValues.indexOf(e)>-1}var HlsSkip={No:"",Yes:"YES",v2:"v2"};function getSkipValue(e,t){const{canSkipUntil:i,canSkipDateRanges:r,endSN:s}=e;return i&&(void 0!==t?t-s:0)<i?r?HlsSkip.v2:HlsSkip.Yes:HlsSkip.No}class HlsUrlParameters{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Level{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter((e=>!!e)).map((e=>e.substring(0,4))).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return hasGroup(this._audioGroups,e)}hasSubtitleGroup(e){return hasGroup(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}}function hasGroup(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function updateFromToPTS(e,t){const i=t.startPTS;if(isFiniteNumber(i)){let r,s=0;t.sn>e.sn?(s=i-e.start,r=e):(s=e.start-i,r=t),r.duration!==s&&(r.duration=s)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function updateFragPTSDTS(e,t,i,r,s,a){r-i<=0&&(logger.warn("Fragment should have a positive duration",t),r=i+t.duration,a=s+t.duration);let n=i,o=r;const l=t.startPTS,c=t.endPTS;if(isFiniteNumber(l)){const e=Math.abs(l-i);isFiniteNumber(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,n=Math.max(i,l),i=Math.min(i,l),s=Math.min(s,t.startDTS),o=Math.min(r,c),r=Math.max(r,c),a=Math.max(a,t.endDTS)}const u=i-t.start;0!==t.start&&(t.start=i),t.duration=r-t.start,t.startPTS=i,t.maxStartPTS=n,t.startDTS=s,t.endPTS=r,t.minEndPTS=o,t.endDTS=a;const d=t.sn;if(!e||d<e.startSN||d>e.endSN)return 0;let h;const m=d-e.startSN,f=e.fragments;for(f[m]=t,h=m;h>0;h--)updateFromToPTS(f[h],f[h-1]);for(h=m;h<f.length-1;h++)updateFromToPTS(f[h],f[h+1]);return e.fragmentHint&&updateFromToPTS(f[f.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,u}function mergeDetails(e,t){let i=null;const r=e.fragments;for(let l=r.length-1;l>=0;l--){const e=r[l].initSegment;if(e){i=e;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;let s,a=0;if(mapFragmentIntersection(e,t,((e,r)=>{e.relurl&&(a=e.cc-r.cc),isFiniteNumber(e.startPTS)&&isFiniteNumber(e.endPTS)&&(r.start=r.startPTS=e.startPTS,r.startDTS=e.startDTS,r.maxStartPTS=e.maxStartPTS,r.endPTS=e.endPTS,r.endDTS=e.endDTS,r.minEndPTS=e.minEndPTS,r.duration=e.endPTS-e.startPTS,r.duration&&(s=r),t.PTSKnown=t.alignedSliding=!0),r.elementaryStreams=e.elementaryStreams,r.loader=e.loader,r.stats=e.stats,e.initSegment&&(r.initSegment=e.initSegment,i=e.initSegment)})),i){(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach((e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=i)?void 0:t.relurl)||(e.initSegment=i)}))}if(t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some((e=>!e)),t.deltaUpdateFailed){logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=mergeDateRanges(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));const n=t.fragments;if(a){logger.warn("discontinuity sliding from playlist, take drift into account");for(let e=0;e<n.length;e++)n[e].cc+=a}t.skippedSegments&&(t.startCC=t.fragments[0].cc),mapPartIntersection(e.partList,t.partList,((e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),s?updateFragPTSDTS(t,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):adjustSliding(e,t),n.length&&(t.totalduration=t.edge-n[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const o=t.advancedDateTime;if(t.advanced&&o){const e=t.edge;t.driftStart||(t.driftStartTime=o,t.driftStart=e),t.driftEndTime=o,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function mergeDateRanges(e,t,i){const r=_extends({},e);return i&&i.forEach((e=>{delete r[e]})),Object.keys(t).forEach((e=>{const i=new DateRange(t[e].attr,r[e]);i.isValid?r[e]=i:logger.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[e].attr)}"`)})),r}function mapPartIntersection(e,t,i){if(e&&t){let r=0;for(let s=0,a=e.length;s<=a;s++){const a=e[s],n=t[s+r];a&&n&&a.index===n.index&&a.fragment.sn===n.fragment.sn?i(a,n):r--}}}function mapFragmentIntersection(e,t,i){const r=t.skippedSegments,s=Math.max(e.startSN,t.startSN)-t.startSN,a=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,n=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let c=s;c<=a;c++){const e=l[n+c];let s=o[c];r&&!s&&c<r&&(s=t.fragments[c]=e),e&&s&&i(e,s)}}function adjustSliding(e,t){const i=t.startSN+t.skippedSegments-e.startSN,r=e.fragments;i<0||i>=r.length||addSliding(t,r[i].start)}function addSliding(e,t){if(t){const i=e.fragments;for(let r=e.skippedSegments;r<i.length;r++)i[r].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function computeReloadInterval(e,t=1/0){let i=1e3*e.targetduration;if(e.updated){const r=e.fragments,s=4;if(r.length&&i*s>t){const e=1e3*r[r.length-1].duration;e<i&&(i=e)}}else i/=2;return Math.round(i)}function getFragmentWithSN(e,t,i){if(null==e||!e.details)return null;const r=e.details;let s=r.fragments[t-r.startSN];return s||(s=r.fragmentHint,s&&s.sn===t?s:t<r.startSN&&i&&i.sn===t?i:null)}function getPartWith(e,t,i){var r;return null!=e&&e.details?findPart(null==(r=e.details)?void 0:r.partList,t,i):null}function findPart(e,t,i){if(e)for(let r=e.length;r--;){const s=e[r];if(s.index===i&&s.fragment.sn===t)return s}return null}function reassignFragmentLevelIndexes(e){e.forEach(((e,t)=>{const{details:i}=e;null!=i&&i.fragments&&i.fragments.forEach((e=>{e.level=t}))}))}function isTimeoutError(e){switch(e.details){case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_TIMEOUT:case ErrorDetails.LEVEL_LOAD_TIMEOUT:case ErrorDetails.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function getRetryConfig(e,t){const i=isTimeoutError(t);return e.default[(i?"timeout":"error")+"Retry"]}function getRetryDelay(e,t){const i="linear"===e.backoff?1:Math.pow(2,t);return Math.min(i*e.retryDelayMs,e.maxRetryDelayMs)}function getLoaderConfigWithoutReties(e){return _objectSpread2(_objectSpread2({},e),{errorRetry:null,timeoutRetry:null})}function shouldRetry(e,t,i,r){if(!e)return!1;const s=null==r?void 0:r.code,a=t<e.maxNumRetry&&(retryForHttpStatus(s)||!!i);return e.shouldRetry?e.shouldRetry(e,t,i,r,a):a}function retryForHttpStatus(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}const BinarySearch={search:function(e,t){let i=0,r=e.length-1,s=null,a=null;for(;i<=r;){s=(i+r)/2|0,a=e[s];const n=t(a);if(n>0)i=s+1;else{if(!(n<0))return a;r=s-1}}return null}};function findFragmentByPDT(e,t,i){if(null===t||!Array.isArray(e)||!e.length||!isFiniteNumber(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;i=i||0;for(let r=0;r<e.length;++r){const s=e[r];if(pdtWithinToleranceTest(t,i,s))return s}return null}function findFragmentByPTS(e,t,i=0,r=0){let s=null;if(e){s=t[e.sn-t[0].sn+1]||null;const r=e.endDTS-i;r>0&&r<15e-7&&(i+=15e-7)}else 0===i&&0===t[0].start&&(s=t[0]);if(s&&(!e||e.level===s.level)&&0===fragmentWithinToleranceTest(i,r,s))return s;const a=BinarySearch.search(t,fragmentWithinToleranceTest.bind(null,i,r));return!a||a===e&&s?s:a}function fragmentWithinToleranceTest(e=0,t=0,i){if(i.start<=e&&i.start+i.duration>e)return 0;const r=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-r<=e?1:i.start-r>e&&i.start?-1:0}function pdtWithinToleranceTest(e,t,i){const r=1e3*Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-r>e}function findFragWithCC(e,t){return BinarySearch.search(e,(e=>e.cc<t?1:e.cc>t?-1:0))}var NetworkErrorAction={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},ErrorActionFlags={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class ErrorController{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=logger.log.bind(logger,"[info]:"),this.warn=logger.warn.bind(logger,"[warning]:"),this.error=logger.error.bind(logger,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(Events.ERROR,this.onError,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Events.ERROR,this.onError,this),e.off(Events.ERROR,this.onErrorOut,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===PlaylistLevelType.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i,r;if(t.fatal)return;const s=this.hls,a=t.context;switch(t.details){case ErrorDetails.FRAG_LOAD_ERROR:case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_ERROR:case ErrorDetails.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case ErrorDetails.FRAG_PARSING_ERROR:if(null!=(i=t.frag)&&i.gap)return void(t.errorAction={action:NetworkErrorAction.DoNothing,flags:ErrorActionFlags.None});case ErrorDetails.FRAG_GAP:case ErrorDetails.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=NetworkErrorAction.SendAlternateToPenaltyBox);case ErrorDetails.LEVEL_EMPTY_ERROR:case ErrorDetails.LEVEL_PARSING_ERROR:{var n,o;const e=t.parent===PlaylistLevelType.MAIN?t.level:s.loadLevel;t.details===ErrorDetails.LEVEL_EMPTY_ERROR&&null!=(n=t.context)&&null!=(o=n.levelDetails)&&o.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case ErrorDetails.LEVEL_LOAD_ERROR:case ErrorDetails.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==a?void 0:a.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,a.level)));case ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case ErrorDetails.SUBTITLE_LOAD_ERROR:case ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:if(a){const e=s.levels[s.loadLevel];if(e&&(a.type===PlaylistContextType.AUDIO_TRACK&&e.hasAudioGroup(a.groupId)||a.type===PlaylistContextType.SUBTITLE_TRACK&&e.hasSubtitleGroup(a.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=NetworkErrorAction.SendAlternateToPenaltyBox,void(t.errorAction.flags=ErrorActionFlags.MoveAllAlternatesMatchingHost)}return;case ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=s.levels[s.loadLevel],i=null==e?void 0:e.attrs["HDCP-LEVEL"];i?t.errorAction={action:NetworkErrorAction.SendAlternateToPenaltyBox,flags:ErrorActionFlags.MoveAllAlternatesMatchingHDCP,hdcpLevel:i}:this.keySystemError(t)}return;case ErrorDetails.BUFFER_ADD_CODEC_ERROR:case ErrorDetails.REMUX_ALLOC_ERROR:case ErrorDetails.BUFFER_APPEND_ERROR:return void(t.errorAction=this.getLevelSwitchAction(t,null!=(r=t.level)?r:s.loadLevel));case ErrorDetails.INTERNAL_EXCEPTION:case ErrorDetails.BUFFER_APPENDING_ERROR:case ErrorDetails.BUFFER_FULL_ERROR:case ErrorDetails.LEVEL_SWITCH_ERROR:case ErrorDetails.BUFFER_STALLED_ERROR:case ErrorDetails.BUFFER_SEEK_OVER_HOLE:case ErrorDetails.BUFFER_NUDGE_ON_STALL:return void(t.errorAction={action:NetworkErrorAction.DoNothing,flags:ErrorActionFlags.None})}t.type===ErrorTypes.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=getRetryConfig(this.hls.config.playlistLoadPolicy,e),r=this.playlistError++;if(shouldRetry(i,r,isTimeoutError(e),e.response))return{action:NetworkErrorAction.RetryRequest,flags:ErrorActionFlags.None,retryConfig:i,retryCount:r};const s=this.getLevelSwitchAction(e,t);return i&&(s.retryConfig=i,s.retryCount=r),s}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),r=t.levels[i],{fragLoadPolicy:s,keyLoadPolicy:a}=t.config,n=getRetryConfig(e.details.startsWith("key")?a:s,e),o=t.levels.reduce(((e,t)=>e+t.fragmentError),0);if(r){e.details!==ErrorDetails.FRAG_GAP&&r.fragmentError++;if(shouldRetry(n,o,isTimeoutError(e),e.response))return{action:NetworkErrorAction.RetryRequest,flags:ErrorActionFlags.None,retryConfig:n,retryCount:o}}const l=this.getLevelSwitchAction(e,i);return n&&(l.retryConfig=n,l.retryCount=o),l}getLevelSwitchAction(e,t){const i=this.hls;null==t&&(t=i.loadLevel);const r=this.hls.levels[t];if(r){var s,a;const t=e.details;r.loadError++,t===ErrorDetails.BUFFER_APPEND_ERROR&&r.fragmentError++;let l=-1;const{levels:c,loadLevel:u,minAutoLevel:d,maxAutoLevel:h}=i;i.autoLevelEnabled||(i.loadLevel=-1);const m=null==(s=e.frag)?void 0:s.type,f=(m===PlaylistLevelType.AUDIO&&t===ErrorDetails.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===ErrorDetails.BUFFER_ADD_CODEC_ERROR||t===ErrorDetails.BUFFER_APPEND_ERROR))&&c.some((({audioCodec:e})=>r.audioCodec!==e)),g="video"===e.sourceBufferName&&(t===ErrorDetails.BUFFER_ADD_CODEC_ERROR||t===ErrorDetails.BUFFER_APPEND_ERROR)&&c.some((({codecSet:e,audioCodec:t})=>r.codecSet!==e&&r.audioCodec===t)),{type:p,groupId:v}=null!=(a=e.context)?a:{};for(let i=c.length;i--;){const s=(i+u)%c.length;if(s!==u&&s>=d&&s<=h&&0===c[s].loadError){var n,o;const i=c[s];if(t===ErrorDetails.FRAG_GAP&&e.frag){const t=c[s].details;if(t){const i=findFragmentByPTS(e.frag,t.fragments,e.frag.start);if(null!=i&&i.gap)continue}}else{if(p===PlaylistContextType.AUDIO_TRACK&&i.hasAudioGroup(v)||p===PlaylistContextType.SUBTITLE_TRACK&&i.hasSubtitleGroup(v))continue;if(m===PlaylistLevelType.AUDIO&&null!=(n=r.audioGroups)&&n.some((e=>i.hasAudioGroup(e)))||m===PlaylistLevelType.SUBTITLE&&null!=(o=r.subtitleGroups)&&o.some((e=>i.hasSubtitleGroup(e)))||f&&r.audioCodec===i.audioCodec||!f&&r.audioCodec!==i.audioCodec||g&&r.codecSet===i.codecSet)continue}l=s;break}}if(l>-1&&i.loadLevel!==l)return e.levelRetry=!0,this.playlistError=0,{action:NetworkErrorAction.SendAlternateToPenaltyBox,flags:ErrorActionFlags.None,nextAutoLevel:l}}return{action:NetworkErrorAction.SendAlternateToPenaltyBox,flags:ErrorActionFlags.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch(null==(i=t.errorAction)?void 0:i.action){case NetworkErrorAction.DoNothing:break;case NetworkErrorAction.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===ErrorDetails.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:r,hdcpLevel:s,nextAutoLevel:a}=i;switch(r){case ErrorActionFlags.None:this.switchLevel(e,a);break;case ErrorActionFlags.MoveAllAlternatesMatchingHDCP:s&&(t.maxHdcpLevel=HdcpLevels[HdcpLevels.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}i.resolved||this.switchLevel(e,a)}switchLevel(e,t){void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class BasePlaylistController{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=logger.log.bind(logger,`${t}:`),this.warn=logger.warn.bind(logger,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const i=null==t?void 0:t.renditionReports;if(i){let s=-1;for(let a=0;a<i.length;a++){const n=i[a];let o;try{o=new self.URL(n.URI,t.url).href}catch(r){logger.warn(`Could not construct new URL for Rendition Report: ${r}`),o=n.URI||""}if(o===e){s=a;break}o===e.substring(0,o.length)&&(s=a)}if(-1!==s){const e=i[s],r=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let a=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);a>=0&&e>t.partTarget&&(a+=1)}return new HlsUrlParameters(r,a>=0?a:void 0,HlsSkip.No)}}}loadPlaylist(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,i){const{details:r,stats:s}=t,a=self.performance.now(),n=s.loading.first?Math.max(0,a-s.loading.first):0;if(r.advancedDateTime=Date.now()-n,r.live||null!=i&&i.live){if(r.reloaded(i),i&&this.log(`live playlist ${e} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED"}`),i&&r.fragments.length>0&&mergeDetails(i,r),!this.canLoad||!r.live)return;let n,o,l;if(r.canBlockReload&&r.endSN&&r.advanced){const e=this.hls.config.lowLatencyMode,s=r.lastPartSn,a=r.endSN,c=r.lastPartIndex,u=s===a;-1!==c?(o=u?a+1:s,l=u?e?0:c:c+1):o=a+1;const d=r.age,h=d+r.ageHeader;let m=Math.min(h-r.partTarget,1.5*r.targetduration);if(m>0){if(i&&m>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${m} with playlist age: ${r.age}`),m=0;else{const e=Math.floor(m/r.targetduration);if(o+=e,void 0!==l){l+=Math.round(m%r.targetduration/r.partTarget)}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${d.toFixed(2)}s goal: ${m} skip sn ${e} to part ${l}`)}r.tuneInGoal=m}if(n=this.getDeliveryDirectives(r,t.deliveryDirectives,o,l),e||!u)return void this.loadPlaylist(n)}else(r.canBlockReload||r.canSkipUntil)&&(n=this.getDeliveryDirectives(r,t.deliveryDirectives,o,l));const c=this.hls.mainForwardBufferInfo,u=c?c.end-c.len:0,d=computeReloadInterval(r,1e3*(r.edge-u));r.updated&&a>this.requestScheduled+d&&(this.requestScheduled=s.loading.start),void 0!==o&&r.canBlockReload?this.requestScheduled=s.loading.first+d-(1e3*r.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+d<a?this.requestScheduled=a:this.requestScheduled-a<=0&&(this.requestScheduled+=d);let h=this.requestScheduled-a;h=Math.max(0,h),this.log(`reload live playlist ${e} in ${Math.round(h)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(n)),h)}else this.clearTimer()}getDeliveryDirectives(e,t,i,r){let s=getSkipValue(e,i);return null!=t&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,r=t.part,s=HlsSkip.No),new HlsUrlParameters(i,r,s)}checkRetry(e){const t=e.details,i=isTimeoutError(e),r=e.errorAction,{action:s,retryCount:a=0,retryConfig:n}=r||{},o=!!r&&!!n&&(s===NetworkErrorAction.RetryRequest||!r.resolved&&s===NetworkErrorAction.SendAlternateToPenaltyBox);if(o){var l;if(this.requestScheduled=-1,a>=n.maxNumRetry)return!1;if(i&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${n.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=getRetryDelay(n,a);this.timer=self.setTimeout((()=>this.loadPlaylist()),e),this.warn(`Retrying playlist loading ${a+1}/${n.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,r.resolved=!0}return o}}class EWMA{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class EwmaBandWidthEstimator{constructor(e,t,i,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new EWMA(e),this.fast_=new EWMA(t),this.defaultTTFB_=r,this.ttfb_=new EWMA(e)}update(e,t){const{slow_:i,fast_:r,ttfb_:s}=this;i.halfLife!==e&&(this.slow_=new EWMA(e,i.getEstimate(),i.getTotalWeight())),r.halfLife!==t&&(this.fast_=new EWMA(t,r.getEstimate(),r.getTotalWeight())),s.halfLife!==e&&(this.ttfb_=new EWMA(e,s.getEstimate(),s.getTotalWeight()))}sample(e,t){const i=(e=Math.max(e,this.minDelayMs_))/1e3,r=8*t/i;this.fast_.sample(i,r),this.slow_.sample(i,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const SUPPORTED_INFO_DEFAULT={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},SUPPORTED_INFO_CACHE={};function requiresMediaCapabilitiesDecodingInfo(e,t,i,r,s,a){const n=e.audioCodec?e.audioGroups:null,o=null==a?void 0:a.audioCodec,l=null==a?void 0:a.channels,c=l?parseInt(l):o?1/0:2;let u=null;if(null!=n&&n.length)try{u=1===n.length&&n[0]?t.groups[n[0]].channels:n.reduce(((e,i)=>{if(i){const r=t.groups[i];if(!r)throw new Error(`Audio track group ${i} not found`);Object.keys(r.channels).forEach((t=>{e[t]=(e[t]||0)+r.channels[t]}))}return e}),{2:0})}catch(d){return!0}return void 0!==e.videoCodec&&(e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(r,30)||"SDR"!==e.videoRange&&e.videoRange!==i||e.bitrate>Math.max(s,8e6))||!!u&&isFiniteNumber(c)&&Object.keys(u).some((e=>parseInt(e)>c))}function getMediaDecodingInfoPromise(e,t,i){const r=e.videoCodec,s=e.audioCodec;if(!r||!s||!i)return Promise.resolve(SUPPORTED_INFO_DEFAULT);const a={width:e.width,height:e.height,bitrate:Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)),framerate:e.frameRate||30},n=e.videoRange;"SDR"!==n&&(a.transferFunction=n.toLowerCase());const o=r.split(",").map((e=>({type:"media-source",video:_objectSpread2(_objectSpread2({},a),{},{contentType:mimeTypeForCodec(e,"video")})})));return s&&e.audioGroups&&e.audioGroups.forEach((e=>{var i;e&&(null==(i=t.groups[e])||i.tracks.forEach((t=>{if(t.groupId===e){const e=t.channels||"",i=parseFloat(e);isFiniteNumber(i)&&i>2&&o.push.apply(o,s.split(",").map((e=>({type:"media-source",audio:{contentType:mimeTypeForCodec(e,"audio"),channels:""+i}}))))}})))})),Promise.all(o.map((e=>{const t=getMediaDecodingInfoKey(e);return SUPPORTED_INFO_CACHE[t]||(SUPPORTED_INFO_CACHE[t]=i.decodingInfo(e))}))).then((e=>({supported:!e.some((e=>!e.supported)),configurations:o,decodingInfoResults:e}))).catch((e=>({supported:!1,configurations:o,decodingInfoResults:[],error:e})))}function getMediaDecodingInfoKey(e){const{audio:t,video:i}=e,r=i||t;if(r){const e=r.contentType.split('"')[1];if(i)return`r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${e}_${Math.ceil(i.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${e}`}return""}function isHdrSupported(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}function getVideoSelectionOptions(e,t){let i=!1,r=[];return e&&(i="SDR"!==e,r=[e]),t&&(r=t.allowedVideoRanges||VideoRangeValues.slice(0),i=void 0!==t.preferHDR?t.preferHDR:isHdrSupported(),r=i?r.filter((e=>"SDR"!==e)):["SDR"]),{preferHDR:i,allowedVideoRanges:r}}function getStartCodecTier(e,t,i,r,s){const a=Object.keys(e),n=null==r?void 0:r.channels,o=null==r?void 0:r.audioCodec,l=n&&2===parseInt(n);let c=!0,u=!1,d=1/0,h=1/0,m=1/0,f=0,g=[];const{preferHDR:p,allowedVideoRanges:v}=getVideoSelectionOptions(t,s);for(let T=a.length;T--;){const t=e[a[T]];c=t.channels[2]>0,d=Math.min(d,t.minHeight),h=Math.min(h,t.minFramerate),m=Math.min(m,t.minBitrate);const i=v.filter((e=>t.videoRanges[e]>0));i.length>0&&(u=!0,g=i)}d=isFiniteNumber(d)?d:0,h=isFiniteNumber(h)?h:0;const y=Math.max(1080,d),E=Math.max(30,h);m=isFiniteNumber(m)?m:i,i=Math.max(m,i),u||(t=void 0,g=[]);return{codecSet:a.reduce(((t,r)=>{const s=e[r];if(r===t)return t;if(s.minBitrate>i)return logStartCodecCandidateIgnored(r,`min bitrate of ${s.minBitrate} > current estimate of ${i}`),t;if(!s.hasDefaultAudio)return logStartCodecCandidateIgnored(r,"no renditions with default or auto-select sound found"),t;if(o&&r.indexOf(o.substring(0,4))%5!=0)return logStartCodecCandidateIgnored(r,`audio codec preference "${o}" not found`),t;if(n&&!l){if(!s.channels[n])return logStartCodecCandidateIgnored(r,`no renditions with ${n} channel sound found (channels options: ${Object.keys(s.channels)})`),t}else if((!o||l)&&c&&0===s.channels[2])return logStartCodecCandidateIgnored(r,"no renditions with stereo sound found"),t;return s.minHeight>y?(logStartCodecCandidateIgnored(r,`min resolution of ${s.minHeight} > maximum of ${y}`),t):s.minFramerate>E?(logStartCodecCandidateIgnored(r,`min framerate of ${s.minFramerate} > maximum of ${E}`),t):g.some((e=>s.videoRanges[e]>0))?s.maxScore<f?(logStartCodecCandidateIgnored(r,`max score of ${s.maxScore} < selected max of ${f}`),t):t&&(codecsSetSelectionPreferenceValue(r)>=codecsSetSelectionPreferenceValue(t)||s.fragmentError>e[t].fragmentError)?t:(f=s.maxScore,r):(logStartCodecCandidateIgnored(r,`no variants with VIDEO-RANGE of ${JSON.stringify(g)} found`),t)}),void 0),videoRanges:g,preferHDR:p,minFramerate:h,minBitrate:m}}function logStartCodecCandidateIgnored(e,t){logger.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function getAudioTracksByGroup(e){return e.reduce(((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const r=t.channels||"2";return i.channels[r]=(i.channels[r]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e}),{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function getCodecTiers(e,t,i,r){return e.slice(i,r+1).reduce(((e,i)=>{if(!i.codecSet)return e;const r=i.audioGroups;let s=e[i.codecSet];s||(e[i.codecSet]=s={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!r,fragmentError:0}),s.minBitrate=Math.min(s.minBitrate,i.bitrate);const a=Math.min(i.height,i.width);return s.minHeight=Math.min(s.minHeight,a),s.minFramerate=Math.min(s.minFramerate,i.frameRate),s.maxScore=Math.max(s.maxScore,i.score),s.fragmentError+=i.fragmentError,s.videoRanges[i.videoRange]=(s.videoRanges[i.videoRange]||0)+1,r&&r.forEach((e=>{if(!e)return;const i=t.groups[e];s.hasDefaultAudio=s.hasDefaultAudio||t.hasDefaultAudio?i.hasDefault:i.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(i.channels).forEach((e=>{s.channels[e]=(s.channels[e]||0)+i.channels[e]}))})),e}),{})}function findMatchingOption(e,t,i){if("attrs"in e){const i=t.indexOf(e);if(-1!==i)return i}for(let r=0;r<t.length;r++){if(matchesOption(e,t[r],i))return r}return-1}function matchesOption(e,t,i){const{groupId:r,name:s,lang:a,assocLang:n,characteristics:o,default:l}=e,c=e.forced;return(void 0===r||t.groupId===r)&&(void 0===s||t.name===s)&&(void 0===a||t.lang===a)&&(void 0===a||t.assocLang===n)&&(void 0===l||t.default===l)&&(void 0===c||t.forced===c)&&(void 0===o||characteristicsMatch(o,t.characteristics))&&(void 0===i||i(e,t))}function characteristicsMatch(e,t=""){const i=e.split(","),r=t.split(",");return i.length===r.length&&!i.some((e=>-1===r.indexOf(e)))}function audioMatchPredicate(e,t){const{audioCodec:i,channels:r}=e;return!(void 0!==i&&(t.audioCodec||"").substring(0,4)!==i.substring(0,4)||void 0!==r&&r!==(t.channels||"2"))}function findClosestLevelWithAudioGroup(e,t,i,r,s){const a=t[r],n=t.reduce(((e,t,i)=>{const r=t.uri;return(e[r]||(e[r]=[])).push(i),e}),{})[a.uri];n.length>1&&(r=Math.max.apply(Math,n));const o=a.videoRange,l=a.frameRate,c=a.codecSet.substring(0,4),u=searchDownAndUpList(t,r,(t=>{if(t.videoRange!==o||t.frameRate!==l||t.codecSet.substring(0,4)!==c)return!1;const r=t.audioGroups,a=i.filter((e=>!r||-1!==r.indexOf(e.groupId)));return findMatchingOption(e,a,s)>-1}));return u>-1?u:searchDownAndUpList(t,r,(t=>{const r=t.audioGroups,a=i.filter((e=>!r||-1!==r.indexOf(e.groupId)));return findMatchingOption(e,a,s)>-1}))}function searchDownAndUpList(e,t,i){for(let r=t;r;r--)if(i(e[r]))return r;for(let r=t+1;r<e.length;r++)if(i(e[r]))return r;return-1}class AbrController{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:t,hls:i}=this,{autoLevelEnabled:r,media:s}=i;if(!e||!s)return;const a=performance.now(),n=t?t.stats:e.stats,o=t?t.duration:e.duration,l=a-n.loading.start,c=i.minAutoLevel;if(n.aborted||n.loaded&&n.loaded===n.total||e.level<=c)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!r||s.paused||!s.playbackRate||!s.readyState)return;const u=i.mainForwardBufferInfo;if(null===u)return;const d=this.bwEstimator.getEstimateTTFB(),h=Math.abs(s.playbackRate);if(l<=Math.max(d,o/(2*h)*1e3))return;const m=u.len/h,f=n.loading.first?n.loading.first-n.loading.start:-1,g=n.loaded&&f>-1,p=this.getBwEstimate(),v=i.levels,y=v[e.level],E=n.total||Math.max(n.loaded,Math.round(o*y.averageBitrate/8));let T=g?l-f:l;T<1&&g&&(T=Math.min(l,8*n.loaded/p));const S=g?1e3*n.loaded/T:0,_=S?(E-n.loaded)/S:8*E/p+d/1e3;if(_<=m)return;const k=S?8*S:p;let b,C=Number.POSITIVE_INFINITY;for(b=e.level-1;b>c;b--){const e=v[b].maxBitrate;if(C=this.getTimeToLoadFrag(d/1e3,k,o*e,!v[b].details),C<m)break}if(C>=_)return;if(C>10*o)return;i.nextLoadLevel=i.nextAutoLevel=b,g?this.bwEstimator.sample(l-Math.min(d,f),n.loaded):this.bwEstimator.sampleTTFB(l);const L=v[b].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>L&&this.resetEstimator(L),this.clearTimer(),logger.warn(`[abr] Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly;\n      Time to underbuffer: ${m.toFixed(3)} s\n      Estimated load time for current fragment: ${_.toFixed(3)} s\n      Estimated load time for down switch fragment: ${C.toFixed(3)} s\n      TTFB estimate: ${0|f} ms\n      Current BW estimate: ${isFiniteNumber(p)?0|p:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${b} @ ${0|L} bps`),i.trigger(Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:n})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(logger.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new EwmaBandWidthEstimator(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.FRAG_LOADING,this.onFragLoading,this),e.on(Events.FRAG_LOADED,this.onFragLoaded,this),e.on(Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Events.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(Events.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.FRAG_LOADING,this.onFragLoading,this),e.off(Events.FRAG_LOADED,this.onFragLoaded,this),e.off(Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Events.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(Events.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){var r;if(!i.bitrateTest)this.fragCurrent=i,this.partCurrent=null!=(r=t.part)?r:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case ErrorDetails.BUFFER_ADD_CODEC_ERROR:case ErrorDetails.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case ErrorDetails.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:i,partCurrent:r}=this;if(e&&i&&e.sn===i.sn&&e.level===i.level){const t=performance.now(),i=r?r.stats:e.stats,s=t-i.loading.start,a=i.loading.first?i.loading.first-i.loading.start:-1;if(i.loaded&&a>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(s-Math.min(e,a),i.loaded)}else this.bwEstimator.sampleTTFB(s)}break}}}getTimeToLoadFrag(e,t,i,r){return e+i/t+(r?this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const i=this.hls.config,{loading:r}=t.stats,s=r.end-r.start;isFiniteNumber(s)&&(this.lastLevelLoadSec=s/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:i}){const r=i?i.stats:t.stats;if(t.type===PlaylistLevelType.MAIN&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=i?i.duration:t.duration,s=this.hls.levels[t.level],a=(s.loaded?s.loaded.bytes:0)+r.loaded,n=(s.loaded?s.loaded.duration:0)+e;s.loaded={bytes:a,duration:n},s.realBitrate=Math.round(8*a/n)}if(t.bitrateTest){const e={stats:r,frag:t,part:i,id:t.type};this.onFragBuffered(Events.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:r}=t,s=null!=r&&r.stats.loaded?r.stats:i.stats;if(s.aborted)return;if(this.ignoreFragment(i))return;const a=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==PlaylistLevelType.MAIN||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,t,e,0,r,1,1);if(s>-1)return s;const a=this.hls.firstLevel,n=Math.min(Math.max(a,t),e);return logger.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${n}`),n}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&i&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const r=t&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,r)&&t[e].loadError<=t[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:r,config:s,minAutoLevel:a}=i,n=t?t.duration:e?e.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let c=s.abrBandWidthFactor,u=s.abrBandWidthUpFactor;if(l){const e=this.findBestLevel(o,a,r,l,0,c,u);if(e>=0)return e}let d=n?Math.min(n,s.maxStarvationDelay):s.maxStarvationDelay;if(!l){const e=this.bitrateTestDelay;if(e){d=(n?Math.min(n,s.maxLoadingDelay):s.maxLoadingDelay)-e,logger.info(`[abr] bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),c=u=1}}const h=this.findBestLevel(o,a,r,l,d,c,u);if(logger.info(`[abr] ${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${h}`),h>-1)return h;const m=i.levels[a],f=i.levels[i.loadLevel];return(null==m?void 0:m.bitrate)<(null==f?void 0:f.bitrate)?a:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,r=e.mainForwardBufferInfo;return(r?r.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,r,s,a,n){var o;const l=r+s,c=this.lastLoadedFragLevel,u=-1===c?this.hls.firstLevel:c,{fragCurrent:d,partCurrent:h}=this,{levels:m,allAudioTracks:f,loadLevel:g,config:p}=this.hls;if(1===m.length)return 0;const v=m[u],y=!(null==v||null==(o=v.details)||!o.live),E=-1===g||-1===c;let T,S="SDR",_=(null==v?void 0:v.frameRate)||0;const{audioPreference:k,videoPreference:b}=p,C=this.audioTracksByGroup||(this.audioTracksByGroup=getAudioTracksByGroup(f));if(E){if(-1!==this.firstSelection)return this.firstSelection;const r=getStartCodecTier(this.codecTiers||(this.codecTiers=getCodecTiers(m,C,t,i)),S,e,k,b),{codecSet:s,videoRanges:a,minFramerate:n,minBitrate:o,preferHDR:l}=r;T=s,S=l?a[a.length-1]:a[0],_=n,e=Math.max(e,o),logger.log(`[abr] picked start tier ${JSON.stringify(r)}`)}else T=null==v?void 0:v.codecSet,S=null==v?void 0:v.videoRange;const L=h?h.duration:d?d.duration:0,A=this.bwEstimator.getEstimateTTFB()/1e3,w=[];for(let R=i;R>=t;R--){var D;const t=m[R],o=R>u;if(!t)continue;if(p.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const i=navigator.mediaCapabilities;"function"==typeof(null==i?void 0:i.decodingInfo)&&requiresMediaCapabilitiesDecodingInfo(t,C,S,_,e,k)?(t.supportedPromise=getMediaDecodingInfoPromise(t,C,i),t.supportedPromise.then((e=>{if(!this.hls)return;t.supportedResult=e;const i=this.hls.levels,r=i.indexOf(t);e.error?logger.warn(`[abr] MediaCapabilities decodingInfo error: "${e.error}" for level ${r} ${JSON.stringify(e)}`):e.supported||(logger.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${r} ${JSON.stringify(e)}`),r>-1&&i.length>1&&(logger.log(`[abr] Removing unsupported level ${r}`),this.hls.removeLevel(r)))}))):t.supportedResult=SUPPORTED_INFO_DEFAULT}if(T&&t.codecSet!==T||S&&t.videoRange!==S||o&&_>t.frameRate||!o&&_>0&&_<t.frameRate||t.supportedResult&&(null==(D=t.supportedResult.decodingInfoResults)||!D[0].smooth)){w.push(R);continue}const d=t.details,f=(h?null==d?void 0:d.partTarget:null==d?void 0:d.averagetargetduration)||L;let b;b=o?n*e:a*e;const I=L&&r>=2*L&&0===s?m[R].averageBitrate:m[R].maxBitrate,P=this.getTimeToLoadFrag(A,b,I*f,void 0===d);if(b>=I&&(R===c||0===t.loadError&&0===t.fragmentError)&&(P<=A||!isFiniteNumber(P)||y&&!this.bitrateTestDelay||P<l)){const e=this.forcedAutoLevel;return R===g||-1!==e&&e===g||(w.length&&logger.trace(`[abr] Skipped level(s) ${w.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${m[w[0]].codecs}" ${m[w[0]].videoRange}; not compatible with "${v.codecs}" ${S}`),logger.info(`[abr] switch candidate:${u}->${R} adjustedbw(${Math.round(b)})-bitrate=${Math.round(b-I)} ttfb:${A.toFixed(1)} avgDuration:${f.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${P.toFixed(1)} firstSelection:${E} codecSet:${T} videoRange:${S} hls.loadLevel:${g}`)),E&&(this.firstSelection=R),R}}return-1}set nextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls,r=Math.min(Math.max(e,i),t);this._nextAutoLevel!==r&&(this.nextAutoLevelKey="",this._nextAutoLevel=r)}}class TaskLoop{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var FragmentState={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class FragmentTracker{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Events.BUFFER_APPENDED,this.onBufferAppended,this),e.on(Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Events.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(Events.BUFFER_APPENDED,this.onBufferAppended,this),e.off(Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Events.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let r=i.length;r--;){const t=i[r];if(!t)break;const s=t.end;if(t.start<=e&&null!==s&&e<=s)return t}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,r=Object.keys(i);for(let s=r.length;s--;){const a=i[r[s]];if((null==a?void 0:a.body.type)===t&&a.buffered){const t=a.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,i,r){this.timeRanges&&(this.timeRanges[e]=t);const s=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach((r=>{const a=this.fragments[r];if(!a)return;if(s>=a.body.sn)return;if(!a.buffered&&!a.loaded)return void(a.body.type===i&&this.removeFragment(a.body));const n=a.range[e];n&&n.time.some((e=>{const i=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return i&&this.removeFragment(a.body),i}))}))}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:r}=e;if(!t||"initSegment"===i.sn)return;const s=getFragmentKey(i),a=this.fragments[s];if(!a||a.buffered&&i.gap)return;const n=!i.relurl;if(Object.keys(t).forEach((e=>{const s=i.elementaryStreams[e];if(!s)return;const o=t[e],l=n||!0===s.partial;a.range[e]=this.getBufferedTimes(i,r,l,o)})),a.loaded=null,Object.keys(a.range).length){a.buffered=!0;(a.body.endList=i.endList||a.body.endList)&&(this.endListFragments[a.body.type]=a),isPartial(a)||this.removeParts(i.sn-1,i.type)}else this.removeFragment(a.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter((t=>t.fragment.sn>=e)))}fragBuffered(e,t){const i=getFragmentKey(e);let r=this.fragments[i];!r&&t&&(r=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(e,t,i,r){const s={time:[],partial:i},a=e.start,n=e.end,o=e.minEndPTS||n,l=e.maxStartPTS||a;for(let c=0;c<r.length;c++){const e=r.start(c)-this.bufferPadding,t=r.end(c)+this.bufferPadding;if(l>=e&&o<=t){s.time.push({startPTS:Math.max(a,r.start(c)),endPTS:Math.min(n,r.end(c))});break}if(a<t&&n>e){const e=Math.max(a,r.start(c)),t=Math.min(n,r.end(c));t>e&&(s.partial=!0,s.time.push({startPTS:e,endPTS:t}))}else if(n<=e)break}return s}getPartialFragment(e){let t,i,r,s=null,a=0;const{bufferPadding:n,fragments:o}=this;return Object.keys(o).forEach((l=>{const c=o[l];c&&isPartial(c)&&(i=c.body.start-n,r=c.body.end+n,e>=i&&e<=r&&(t=Math.min(e-i,r-e),a<=t&&(s=c.body,a=t)))})),s}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||isPartial(t))}getState(e){const t=getFragmentKey(e),i=this.fragments[t];return i?i.buffered?isPartial(i)?FragmentState.PARTIAL:FragmentState.OK:FragmentState.APPENDING:FragmentState.NOT_LOADED}isTimeBuffered(e,t,i){let r,s;for(let a=0;a<i.length;a++){if(r=i.start(a)-this.bufferPadding,s=i.end(a)+this.bufferPadding,e>=r&&t<=s)return!0;if(t<=r)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:r}=t;if("initSegment"===i.sn||i.bitrateTest)return;const s=r?null:t,a=getFragmentKey(i);this.fragments[a]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:r,timeRanges:s}=t;if("initSegment"===i.sn)return;const a=i.type;if(r){let e=this.activePartLists[a];e||(this.activePartLists[a]=e=[]),e.push(r)}this.timeRanges=s,Object.keys(s).forEach((e=>{const t=s[e];this.detectEvictedFragments(e,t,a,r)}))}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=getFragmentKey(e);return!!this.fragments[t]}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,i,r,s){r&&!this.hasGaps||Object.keys(this.fragments).forEach((a=>{const n=this.fragments[a];if(!n)return;const o=n.body;o.type!==i||r&&!o.gap||o.start<t&&o.end>e&&(n.buffered||s)&&this.removeFragment(o)}))}removeFragment(e){const t=getFragmentKey(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const t=e.sn;this.activePartLists[e.type]=i.filter((e=>e.fragment.sn!==t))}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function isPartial(e){var t,i,r;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(i=e.range.audio)?void 0:i.partial)||(null==(r=e.range.audiovideo)?void 0:r.partial))}function getFragmentKey(e){return`${e.type}_${e.level}_${e.sn}`}const noopBuffered={length:0,start:()=>0,end:()=>0};class BufferHelper{static isBuffered(e,t){try{if(e){const i=BufferHelper.getBuffered(e);for(let e=0;e<i.length;e++)if(t>=i.start(e)&&t<=i.end(e))return!0}}catch(i){}return!1}static bufferInfo(e,t,i){try{if(e){const r=BufferHelper.getBuffered(e),s=[];let a;for(a=0;a<r.length;a++)s.push({start:r.start(a),end:r.end(a)});return this.bufferedInfo(s,t,i)}}catch(r){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort((function(e,t){const i=e.start-t.start;return i||t.end-e.end}));let r=[];if(i)for(let l=0;l<e.length;l++){const t=r.length;if(t){const s=r[t-1].end;e[l].start-s<i?e[l].end>s&&(r[t-1].end=e[l].end):r.push(e[l])}else r.push(e[l])}else r=e;let s,a=0,n=t,o=t;for(let l=0;l<r.length;l++){const e=r[l].start,c=r[l].end;if(t+i>=e&&t<c)n=e,o=c,a=o-t;else if(t+i<e){s=e;break}}return{len:a,start:n||0,end:o||0,nextStart:s}}static getBuffered(e){try{return e.buffered}catch(e2){return logger.log("failed to get media.buffered",e2),noopBuffered}}}class ChunkMetadata{constructor(e,t,i,r=0,s=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=getNewPerformanceTiming(),this.buffering={audio:getNewPerformanceTiming(),video:getNewPerformanceTiming(),audiovideo:getNewPerformanceTiming()},this.level=e,this.sn=t,this.id=i,this.size=r,this.part=s,this.partial=a}}function getNewPerformanceTiming(){return{start:0,executeStart:0,executeEnd:0,end:0}}function findFirstFragWithCC(e,t){for(let r=0,s=e.length;r<s;r++){var i;if((null==(i=e[r])?void 0:i.cc)===t)return e[r]}return null}function shouldAlignOnDiscontinuities(e,t,i){return!(!t||!(i.endCC>i.startCC||e&&e.cc<i.startCC))}function findDiscontinuousReferenceFrag(e,t){const i=e.fragments,r=t.fragments;if(!r.length||!i.length)return void logger.log("No fragments to align");const s=findFirstFragWithCC(i,r[0].cc);if(s&&(!s||s.startPTS))return s;logger.log("No frag in previous level to align on")}function adjustFragmentStart(e,t){if(e){const i=e.start+t;e.start=e.startPTS=i,e.endPTS=i+e.duration}}function adjustSlidingStart(e,t){const i=t.fragments;for(let r=0,s=i.length;r<s;r++)adjustFragmentStart(i[r],e);t.fragmentHint&&adjustFragmentStart(t.fragmentHint,e),t.alignedSliding=!0}function alignStream(e,t,i){t&&(alignDiscontinuities(e,i,t),!i.alignedSliding&&t&&alignMediaPlaylistByPDT(i,t),i.alignedSliding||!t||i.skippedSegments||adjustSliding(t,i))}function alignDiscontinuities(e,t,i){if(shouldAlignOnDiscontinuities(e,i,t)){const e=findDiscontinuousReferenceFrag(i,t);e&&isFiniteNumber(e.start)&&(logger.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),adjustSlidingStart(e.start,t))}}function alignMediaPlaylistByPDT(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const i=e.fragments,r=t.fragments;if(!i.length||!r.length)return;let s,a;const n=Math.min(t.endCC,e.endCC);t.startCC<n&&e.startCC<n&&(s=findFirstFragWithCC(r,n),a=findFirstFragWithCC(i,n)),s&&a||(s=r[Math.floor(r.length/2)],a=findFirstFragWithCC(i,s.cc)||i[Math.floor(i.length/2)]);const o=s.programDateTime,l=a.programDateTime;if(!o||!l)return;adjustSlidingStart((l-o)/1e3-(a.start-s.start),e)}const MIN_CHUNK_SIZE=Math.pow(2,17);class FragmentLoader{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(i?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,s=r.fLoader,a=r.loader;return new Promise(((n,o)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some((e=>"GAP"===e[0])))return void o(createGapLoadError(e));e.gap=!1}const l=this.loader=e.loader=s?new s(r):new a(r),c=createLoaderContext(e),u=getLoaderConfigWithoutReties(r.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:MIN_CHUNK_SIZE};e.stats=l.stats,l.load(c,d,{onSuccess:(t,i,r,s)=>{this.resetLoader(e,l);let a=t.data;r.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(a.slice(0,16)),a=a.slice(16)),n({frag:e,part:null,payload:a,networkDetails:s})},onError:(t,r,s,a)=>{this.resetLoader(e,l),o(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:_objectSpread2({url:i,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:s,stats:a}))},onAbort:(t,i,r)=>{this.resetLoader(e,l),o(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:r,stats:t}))},onTimeout:(t,i,r)=>{this.resetLoader(e,l),o(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:r,stats:t}))},onProgress:(i,r,s,a)=>{t&&t({frag:e,part:null,payload:s,networkDetails:a})}})}))}loadPart(e,t,i){this.abort();const r=this.config,s=r.fLoader,a=r.loader;return new Promise(((n,o)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void o(createGapLoadError(e,t));const l=this.loader=e.loader=s?new s(r):new a(r),c=createLoaderContext(e,t),u=getLoaderConfigWithoutReties(r.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:MIN_CHUNK_SIZE};t.stats=l.stats,l.load(c,d,{onSuccess:(r,s,a,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const c={frag:e,part:t,payload:r.data,networkDetails:o};i(c),n(c)},onError:(i,r,s,a)=>{this.resetLoader(e,l),o(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:_objectSpread2({url:c.url,data:void 0},i),error:new Error(`HTTP Error ${i.code} ${i.text}`),networkDetails:s,stats:a}))},onAbort:(i,r,s)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:s,stats:i}))},onTimeout:(i,r,s)=>{this.resetLoader(e,l),o(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:s,stats:i}))}})}))}updateStatsFromPart(e,t){const i=e.stats,r=t.stats,s=r.total;if(i.loaded+=r.loaded,s){const r=Math.round(e.duration/t.duration),a=Math.min(Math.round(i.loaded/s),r),n=(r-a)*Math.round(i.loaded/a);i.total=i.loaded+n}else i.total=Math.max(i.loaded,i.total);const a=i.loading,n=r.loading;a.start?a.first+=n.first-n.start:(a.start=n.start,a.first=n.first),a.end=n.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function createLoaderContext(e,t=null){const i=t||e,r={frag:e,part:t,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},s=i.byteRangeStartOffset,a=i.byteRangeEndOffset;if(isFiniteNumber(s)&&isFiniteNumber(a)){var n;let t=s,i=a;if("initSegment"===e.sn&&"AES-128"===(null==(n=e.decryptdata)?void 0:n.method)){const e=a-s;e%16&&(i=a+(16-e%16)),0!==s&&(r.resetIV=!0,t=s-16)}r.rangeStart=t,r.rangeEnd=i}return r}function createGapLoadError(e,t){const i=new Error(`GAP ${e.gap?"tag":"attribute"} found`),r={type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_GAP,fatal:!1,frag:e,error:i,networkDetails:null};return t&&(r.part=t),(t||e).stats.aborted=!0,new LoadError(r)}class LoadError extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class AESCrypto{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class FastAESKey{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function removePadding(e){const t=e.byteLength,i=t&&new DataView(e.buffer).getUint8(t-1);return i?sliceUint8(e,0,t-i):e}class AESDecryptor{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let r=0;r<4;r++)i[r]=t.getUint32(4*r);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,r=i[0],s=i[1],a=i[2],n=i[3],o=this.invSubMix,l=o[0],c=o[1],u=o[2],d=o[3],h=new Uint32Array(256);let m=0,f=0,g=0;for(g=0;g<256;g++)h[g]=g<128?g<<1:g<<1^283;for(g=0;g<256;g++){let i=f^f<<1^f<<2^f<<3^f<<4;i=i>>>8^255&i^99,e[m]=i,t[i]=m;const o=h[m],g=h[o],p=h[g];let v=257*h[i]^16843008*i;r[m]=v<<24|v>>>8,s[m]=v<<16|v>>>16,a[m]=v<<8|v>>>24,n[m]=v,v=16843009*p^65537*g^257*o^16843008*m,l[i]=v<<24|v>>>8,c[i]=v<<16|v>>>16,u[i]=v<<8|v>>>24,d[i]=v,m?(m=o^h[h[h[p^o]]],f^=h[h[f]]):m=f=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,r=0;for(;r<t.length&&i;)i=t[r]===this.key[r],r++;if(i)return;this.key=t;const s=this.keySize=t.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);const a=this.ksRows=4*(s+6+1);let n,o;const l=this.keySchedule=new Uint32Array(a),c=this.invKeySchedule=new Uint32Array(a),u=this.sBox,d=this.rcon,h=this.invSubMix,m=h[0],f=h[1],g=h[2],p=h[3];let v,y;for(n=0;n<a;n++)n<s?v=l[n]=t[n]:(y=v,n%s==0?(y=y<<8|y>>>24,y=u[y>>>24]<<24|u[y>>>16&255]<<16|u[y>>>8&255]<<8|u[255&y],y^=d[n/s|0]<<24):s>6&&n%s==4&&(y=u[y>>>24]<<24|u[y>>>16&255]<<16|u[y>>>8&255]<<8|u[255&y]),l[n]=v=(l[n-s]^y)>>>0);for(o=0;o<a;o++)n=a-o,y=3&o?l[n]:l[n-4],c[o]=o<4||n<=4?y:m[u[y>>>24]]^f[u[y>>>16&255]]^g[u[y>>>8&255]]^p[u[255&y]],c[o]=c[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const r=this.keySize+6,s=this.invKeySchedule,a=this.invSBox,n=this.invSubMix,o=n[0],l=n[1],c=n[2],u=n[3],d=this.uint8ArrayToUint32Array_(i);let h=d[0],m=d[1],f=d[2],g=d[3];const p=new Int32Array(e),v=new Int32Array(p.length);let y,E,T,S,_,k,b,C,L,A,w,D,R,I;const P=this.networkToHostOrderSwap;for(;t<p.length;){for(L=P(p[t]),A=P(p[t+1]),w=P(p[t+2]),D=P(p[t+3]),_=L^s[0],k=D^s[1],b=w^s[2],C=A^s[3],R=4,I=1;I<r;I++)y=o[_>>>24]^l[k>>16&255]^c[b>>8&255]^u[255&C]^s[R],E=o[k>>>24]^l[b>>16&255]^c[C>>8&255]^u[255&_]^s[R+1],T=o[b>>>24]^l[C>>16&255]^c[_>>8&255]^u[255&k]^s[R+2],S=o[C>>>24]^l[_>>16&255]^c[k>>8&255]^u[255&b]^s[R+3],_=y,k=E,b=T,C=S,R+=4;y=a[_>>>24]<<24^a[k>>16&255]<<16^a[b>>8&255]<<8^a[255&C]^s[R],E=a[k>>>24]<<24^a[b>>16&255]<<16^a[C>>8&255]<<8^a[255&_]^s[R+1],T=a[b>>>24]<<24^a[C>>16&255]<<16^a[_>>8&255]<<8^a[255&k]^s[R+2],S=a[C>>>24]<<24^a[_>>16&255]<<16^a[k>>8&255]<<8^a[255&b]^s[R+3],v[t]=P(y^h),v[t+1]=P(S^m),v[t+2]=P(T^f),v[t+3]=P(E^g),h=L,m=A,f=w,g=D,t+=4}return v.buffer}}const CHUNK_SIZE=16;class Decrypter{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e2){}null===this.subtle&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?removePadding(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i){return this.useSoftware?new Promise(((r,s)=>{this.softwareDecrypt(new Uint8Array(e),t,i);const a=this.flush();a?r(a.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(e),t,i)}softwareDecrypt(e,t,i){const{currentIV:r,currentResult:s,remainderData:a}=this;this.logOnce("JS AES decrypt"),a&&(e=appendUint8Array(a,e),this.remainderData=null);const n=this.getValidChunk(e);if(!n.length)return null;r&&(i=r);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new AESDecryptor),o.expandKey(t);const l=s;return this.currentResult=o.decrypt(n.buffer,0,i),this.currentIV=sliceUint8(n,-16).buffer,l||null}webCryptoDecrypt(e,t,i){const r=this.subtle;return this.key===t&&this.fastAesKey||(this.key=t,this.fastAesKey=new FastAESKey(r,t)),this.fastAesKey.expandKey().then((t=>{if(!r)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new AESCrypto(r,new Uint8Array(i)).decrypt(e.buffer,t)})).catch((r=>(logger.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i))))}onWebCryptoError(e,t,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i);const r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%CHUNK_SIZE;return i!==e.length&&(t=sliceUint8(e,0,i),this.remainderData=sliceUint8(e,i)),t}logOnce(e){this.logEnabled&&(logger.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const TimeRanges={toString:function(e){let t="";const i=e.length;for(let r=0;r<i;r++)t+=`[${e.start(r).toFixed(3)}-${e.end(r).toFixed(3)}]`;return t}},State={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class BaseStreamController extends TaskLoop{constructor(e,t,i,r,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=State.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=r,this.log=logger.log.bind(logger,`${r}:`),this.warn=logger.warn.bind(logger,`${r}:`),this.hls=e,this.fragmentLoader=new FragmentLoader(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Decrypter(e.config),e.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=State.STOPPED}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const i=t.partList;if(null!=i&&i.length){const e=i[i.length-1];return BufferHelper.isBuffered(this.media,e.start+e.duration/2)}const r=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const r=this.config;this.levels&&r.autoStartLoad&&this.state===State.STOPPED&&this.startLoad(r.startPosition)}onMediaDetaching(){const e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:r,state:s}=this,a=i?i.currentTime:0,n=BufferHelper.bufferInfo(r||i,a,e.maxBufferHole);if(this.log(`media seeking to ${isFiniteNumber(a)?a.toFixed(3):a}, state: ${s}`),this.state===State.ENDED)this.resetLoadingState();else if(t){const i=e.maxFragLookUpTolerance,r=t.start-i,s=t.start+t.duration+i;if(!n.len||s<n.start||r>n.end){const e=a>s;(a<r||e)&&(e&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),this.lastCurrentTime=a),this.loadedmetadata||n.len||(this.nextLoadPosition=this.startPosition=a),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=State.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){this._doFragLoad(e,t,i,(t=>{if(this.fragContextChanged(e))return this.warn(`Fragment ${e.sn}${t.part?" p: "+t.part.index:""} of level ${e.level} was dropped during download.`),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)})).then((t=>{if(!t)return;const i=this.state;this.fragContextChanged(e)?(i===State.FRAG_LOADING||!this.fragCurrent&&i===State.PARSING)&&(this.fragmentTracker.removeFragment(e),this.state=State.IDLE):("payload"in t&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(Events.FRAG_LOADED,t)),this._handleFragmentLoadComplete(t))})).catch((t=>{this.state!==State.STOPPED&&this.state!==State.ERROR&&(this.warn(t),this.resetFragmentLoading(e))}))}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===FragmentState.APPENDING){const t=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,t),s=Math.max(e.duration,r?r.len:this.config.maxBufferLength);this.reduceMaxBufferLength(s)&&i.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===FragmentState.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const r={startOffset:e,endOffset:t,type:i};this.hls.trigger(Events.BUFFER_FLUSHING,r)}_loadInitSegment(e,t){this._doFragLoad(e,t).then((t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t})).then((t=>{const{hls:i}=this,{payload:r}=t,s=e.decryptdata;if(r&&r.byteLength>0&&null!=s&&s.key&&s.iv&&"AES-128"===s.method){const a=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),s.key.buffer,s.iv.buffer).catch((t=>{throw i.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t})).then((r=>{const s=self.performance.now();return i.trigger(Events.FRAG_DECRYPTED,{frag:e,payload:r,stats:{tstart:a,tdecrypt:s}}),t.payload=r,this.completeInitSegmentLoad(t)}))}return this.completeInitSegmentLoad(t)})).catch((t=>{this.state!==State.STOPPED&&this.state!==State.ERROR&&(this.warn(t),this.resetFragmentLoading(e))}))}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state=State.IDLE,e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var i,r,s,a;const n=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===PlaylistLevelType.MAIN?"level":"track"} ${e.level} (frag:[${(null!=(i=e.startPTS)?i:NaN).toFixed(3)}-${(null!=(r=e.endPTS)?r:NaN).toFixed(3)}] > buffer:${n?TimeRanges.toString(BufferHelper.getBuffered(n)):"(detached)"})`),"initSegment"!==e.sn){var o;if(e.type!==PlaylistLevelType.SUBTITLE){const t=e.elementaryStreams;if(!Object.keys(t).some((e=>!!t[e])))return void(this.state=State.IDLE)}const t=null==(o=this.levels)?void 0:o[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=State.IDLE,n&&(!this.loadedmetadata&&e.type==PlaylistLevelType.MAIN&&n.buffered.length&&(null==(s=this.fragCurrent)?void 0:s.sn)===(null==(a=this.fragPrevious)?void 0:a.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:r,partsLoaded:s}=e,a=!s||0===s.length||s.some((e=>!e)),n=new ChunkMetadata(i.level,i.sn,i.stats.chunkCount+1,0,r?r.index:-1,!a);t.flush(n)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,r){var s;const a=null==t?void 0:t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let n=null;if(!e.encrypted||null!=(s=e.decryptdata)&&s.key?!e.encrypted&&a.encryptedFragments.length&&this.keyLoader.loadClear(e,a.encryptedFragments):(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level}`),this.state=State.KEY_LOADING,this.fragCurrent=e,n=this.keyLoader.load(e).then((e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(Events.KEY_LOADED,e),this.state===State.KEY_LOADING&&(this.state=State.IDLE),e})),this.hls.trigger(Events.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(n=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),i=Math.max(e.start,i||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){const s=a.partList;if(s&&r){i>e.end&&a.fragmentHint&&(e=a.fragmentHint);const o=this.getNextPart(s,e,i);if(o>-1){const l=s[o];let c;return this.log(`Loading part sn: ${e.sn} p: ${l.index} cc: ${e.cc} of playlist [${a.startSN}-${a.endSN}] parts [0-${o}-${s.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=State.FRAG_LOADING,c=n?n.then((i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(e,l,t,r))).catch((e=>this.handleFragLoadError(e))):this.doFragPartsLoad(e,l,t,r).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(Events.FRAG_LOADING,{frag:e,part:l,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):c}if(!e.url||this.loadedEndOfParts(s,i))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${a?"of ["+a.startSN+"-"+a.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),isFiniteNumber(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=State.FRAG_LOADING;const o=this.config.progressive;let l;return l=o&&n?n.then((t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,r))).catch((e=>this.handleFragLoadError(e))):Promise.all([this.fragmentLoader.load(e,o?r:void 0),n]).then((([e])=>(!o&&e&&r&&r(e),e))).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(Events.FRAG_LOADING,{frag:e,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):l}doFragPartsLoad(e,t,i,r){return new Promise(((s,a)=>{var n;const o=[],l=null==(n=i.details)?void 0:n.partList,c=t=>{this.fragmentLoader.loadPart(e,t,r).then((r=>{o[t.index]=r;const a=r.part;this.hls.trigger(Events.FRAG_LOADED,r);const n=getPartWith(i,e.sn,t.index+1)||findPart(l,e.sn,t.index+1);if(!n)return s({frag:e,part:a,partsLoaded:o});c(n)})).catch(a)};c(t)}))}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(Events.ERROR,t)}else this.hls.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==State.PARSING)return void(this.fragCurrent||this.state===State.STOPPED||this.state===State.ERROR||(this.state=State.IDLE));const{frag:i,part:r,level:s}=t,a=self.performance.now();i.stats.parsing.end=a,r&&(r.stats.parsing.end=a),this.updateLevelTiming(i,r,s,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:r,sn:s,part:a}=e;if(null==t||!t[r])return this.warn(`Levels object was unset while buffering fragment ${s} of level ${r}. The current chunk will not be buffered.`),null;const n=t[r],o=a>-1?getPartWith(n,s,a):null,l=o?o.fragment:getFragmentWithSN(n,s,i);return l?(i&&i!==l&&(l.stats=i.stats),{frag:l,part:o,level:n}):null}bufferFragmentData(e,t,i,r,s){var a;if(!e||this.state!==State.PARSING)return;const{data1:n,data2:o}=e;let l=n;if(n&&o&&(l=appendUint8Array(n,o)),null==(a=l)||!a.length)return;const c={type:e.type,frag:t,part:i,chunkMeta:r,parent:t.type,data:l};if(this.hls.trigger(Events.BUFFER_APPENDING,c),e.dropped&&e.independent&&!i){if(s)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!BufferHelper.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const i=t.currentTime,r=BufferHelper.bufferInfo(t,i,0),s=e.duration,a=Math.min(2*this.config.maxFragLookUpTolerance,.25*s),n=Math.max(Math.min(e.start-a,r.end-a),i+a);e.start-n>a&&this.flushMainBuffer(n,e.start)}getFwdBufferInfo(e,t){const i=this.getLoadPosition();return isFiniteNumber(i)?this.getFwdBufferInfoAtPos(e,i,t):null}getFwdBufferInfoAtPos(e,t,i){const{config:{maxBufferHole:r}}=this,s=BufferHelper.bufferInfo(e,t,r);if(0===s.len&&void 0!==s.nextStart){const a=this.fragmentTracker.getBufferedFrag(t,i);if(a&&s.nextStart<a.end)return BufferHelper.bufferInfo(e,t,Math.max(s.nextStart,r))}return s}getMaxBufferLength(e){const{config:t}=this;let i;return i=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,i=e||t.maxBufferLength;return t.maxMaxBufferLength>=i&&(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0)}getAppendedFrag(e,t=PlaylistLevelType.MAIN){const i=this.fragmentTracker.getAppendedFrag(e,PlaylistLevelType.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,r=i.length;if(!r)return null;const{config:s}=this,a=i[0].start;let n;if(t.live){const o=s.initialLiveManifestSize;if(r<o)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${o})`),null;(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<a)&&(n=this.getInitialLiveFragment(t,i),this.startPosition=this.nextLoadPosition=n?this.hls.liveSyncPosition||n.start:e)}else e<=a&&(n=i[0]);if(!n){const i=s.lowLatencyMode?t.partEnd:t.fragmentEnd;n=this.getFragmentAtPosition(e,i,t)}return this.mapToInitFragWhenRequired(n)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===FragmentState.OK||i===FragmentState.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,r,s){const a=e.gap,n=this.getNextFragment(this.nextLoadPosition,t);if(null===n)return n;if(e=n,a&&e&&!e.gap&&i.nextStart){const t=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,r);if(null!==t&&i.len+t.len>=s)return this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,i){let r=-1,s=!1,a=!0;for(let n=0,o=e.length;n<o;n++){const o=e[n];if(a=a&&!o.independent,r>-1&&i<o.start)break;const l=o.loaded;l?r=-1:(s||o.independent||a)&&o.fragment===t&&(r=n),s=l}return r}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let r=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),r=findFragmentByPDT(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const s=i.sn+1;if(s>=e.startSN&&s<=e.endSN){const a=t[s-e.startSN];i.cc===a.cc&&(r=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=findFragWithCC(t,i.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(r=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r}getFragmentAtPosition(e,t,i){const{config:r}=this;let{fragPrevious:s}=this,{fragments:a,endSN:n}=i;const{fragmentHint:o}=i,l=r.maxFragLookUpTolerance,c=i.partList,u=!!(r.lowLatencyMode&&null!=c&&c.length&&o);let d;if(u&&o&&!this.bitrateTest&&(a=a.concat(o),n=o.sn),e<t){d=findFragmentByPTS(s,a,e,e>t-l?0:l)}else d=a[a.length-1];if(d){const e=d.sn-i.startSN,t=this.fragmentTracker.getState(d);if((t===FragmentState.OK||t===FragmentState.PARTIAL&&d.gap)&&(s=d),s&&d.sn===s.sn&&(!u||c[0].fragment.sn>d.sn)){if(s&&d.level===s.level){const t=a[e+1];d=d.sn<n&&this.fragmentTracker.getState(t)!==FragmentState.OK?t:null}}}return d}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const r=this.hls.liveSyncPosition,s=i.currentTime,a=e.fragments[0].start,n=e.edge,o=s>=a-t.maxFragLookUpTolerance&&s<=n;if(null!==r&&i.duration>r&&(s<r||!o)){const a=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!o&&i.readyState<4||s<n-a)&&(this.loadedmetadata||(this.nextLoadPosition=r),i.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${n}, reset currentTime to : ${r.toFixed(3)}`),i.currentTime=r))}}alignPlaylists(e,t,i){const r=e.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;const s=e.fragments[0].start,a=!t,n=e.alignedSliding&&isFiniteNumber(s);if(a||!n&&!s){const{fragPrevious:s}=this;alignStream(s,i,e);const a=e.fragments[0].start;return this.log(`Live playlist sliding: ${a.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${s?s.sn:"na"} fragments: ${r}`),a}return s}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),-1===i||-1===this.lastCurrentTime){const r=null!==this.startTimeOffset,s=r?this.startTimeOffset:e.startTimeOffset;null!==s&&isFiniteNumber(s)?(i=t+s,s<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${s} found in ${r?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===State.FRAG_LOADING_WAITING_RETRY)||(this.state=State.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;var r;if(this.fragContextChanged(i))return void this.warn(`Frag load error must match current frag to retry ${i.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const s=t.details===ErrorDetails.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);const a=t.errorAction,{action:n,retryCount:o=0,retryConfig:l}=a||{};if(a&&n===NetworkErrorAction.RetryRequest&&l){this.resetStartWhenNotLoaded(this.levelLastLoaded);const r=getRetryDelay(l,o);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${o+1}/${l.maxNumRetry} in ${r}ms`),a.resolved=!0,this.retryDate=self.performance.now()+r,this.state=State.FRAG_LOADING_WAITING_RETRY}else if(l&&a){if(this.resetFragmentErrors(e),!(o<l.maxNumRetry))return void logger.warn(`${t.details} reached or exceeded max retry (${o})`);s||n===NetworkErrorAction.RemoveAlternatePermanently||(a.resolved=!0)}else(null==a?void 0:a.action)===NetworkErrorAction.SendAlternateToPenaltyBox?this.state=State.WAITING_LEVEL:this.state=State.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===State.PARSING||this.state===State.PARSED){const t=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,t),r=i&&i.len>.5;r&&this.reduceMaxBufferLength(i.len);const s=!r;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${t} buffer`),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==State.STOPPED&&(this.state=State.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const r=BufferHelper.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,i),this.state===State.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=State.IDLE}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,r){var s;const a=i.details;if(!a)return void this.warn("level.details undefined");if(!Object.keys(e.elementaryStreams).reduce(((t,s)=>{const n=e.elementaryStreams[s];if(n){const o=n.endPTS-n.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${s} duration reliably (${o})`),t||!1;const l=r?0:updateFragPTSDTS(a,e,n.startPTS,n.endPTS,n.startDTS,n.endDTS);return this.hls.trigger(Events.LEVEL_PTS_UPDATED,{details:a,level:i,drift:l,type:s,frag:e,start:n.startPTS,end:n.endPTS}),!0}return t}),!1)&&null===(null==(s=this.transmuxer)?void 0:s.error)){const t=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(0===i.fragmentError&&(i.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(t.message),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=State.PARSED,this.hls.trigger(Events.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}class ChunkCache{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;return e.length?(i=1===e.length?e[0]:concatUint8Arrays(e,t),this.reset(),i):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function concatUint8Arrays(e,t){const i=new Uint8Array(t);let r=0;for(let s=0;s<e.length;s++){const t=e[s];i.set(t,r),r+=t.length}return i}function hasUMDWorker(){return"function"==typeof __HLS_WORKER_BUNDLE__}function injectWorker(){const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e);return{worker:new self.Worker(t),objectURL:t}}function loadWorker(e){const t=new self.URL(e,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}function dummyTrack(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class BaseAudioDemuxer{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=appendUint8Array(this.cachedData,e),this.cachedData=null);let i,r=getID3Data(e,0),s=r?r.length:0;const a=this._audioTrack,n=this._id3Track,o=r?getTimeStamp(r):void 0,l=e.length;for((null===this.basePTS||0===this.frameIndex&&isFiniteNumber(o))&&(this.basePTS=initPTSFn(o,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&n.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(e,s)){const t=this.appendFrame(a,e,s);t?(this.frameIndex++,this.lastPTS=t.sample.pts,s+=t.length,i=s):s=l}else canParse$2(e,s)?(r=getID3Data(e,s),n.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),s+=r.length,i=s):s++;if(s===l&&i!==l){const t=sliceUint8(e,i);this.cachedData?this.cachedData=appendUint8Array(this.cachedData,t):this.cachedData=t}}return{audioTrack:a,videoTrack:dummyTrack(),id3Track:n,textTrack:dummyTrack()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:dummyTrack(),id3Track:this._id3Track,textTrack:dummyTrack()}}destroy(){}}const initPTSFn=(e,t,i)=>{if(isFiniteNumber(e))return 90*e;return 9e4*t+(i?9e4*i.baseTime/i.timescale:0)};function getAudioConfig(e,t,i,r){let s,a,n,o;const l=navigator.userAgent.toLowerCase(),c=r,u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=1+((192&t[i+2])>>>6);const d=(60&t[i+2])>>>2;if(!(d>u.length-1))return n=(1&t[i+2])<<2,n|=(192&t[i+3])>>>6,logger.log(`manifest codec:${r}, ADTS type:${s}, samplingIndex:${d}`),/firefox/i.test(l)?d>=6?(s=5,o=new Array(4),a=d-3):(s=2,o=new Array(2),a=d):-1!==l.indexOf("android")?(s=2,o=new Array(2),a=d):(s=5,o=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&d>=6?a=d-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(d>=6&&1===n||/vivaldi/i.test(l))||!r&&1===n)&&(s=2,o=new Array(2)),a=d)),o[0]=s<<3,o[0]|=(14&d)>>1,o[1]|=(1&d)<<7,o[1]|=n<<3,5===s&&(o[1]|=(14&a)>>1,o[2]=(1&a)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:u[d],channelCount:n,codec:"mp4a.40."+s,manifestCodec:c};{const t=new Error(`invalid ADTS sampling index:${d}`);e.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}}function isHeaderPattern$1(e,t){return 255===e[t]&&240==(246&e[t+1])}function getHeaderLength(e,t){return 1&e[t+1]?7:9}function getFullFrameLength(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function canGetFrameLength(e,t){return t+5<e.length}function isHeader$1(e,t){return t+1<e.length&&isHeaderPattern$1(e,t)}function canParse$1(e,t){return canGetFrameLength(e,t)&&isHeaderPattern$1(e,t)&&getFullFrameLength(e,t)<=e.length-t}function probe$1(e,t){if(isHeader$1(e,t)){const i=getHeaderLength(e,t);if(t+i>=e.length)return!1;const r=getFullFrameLength(e,t);if(r<=i)return!1;const s=t+r;return s===e.length||isHeader$1(e,s)}return!1}function initTrackConfig(e,t,i,r,s){if(!e.samplerate){const a=getAudioConfig(t,i,r,s);if(!a)return;e.config=a.config,e.samplerate=a.samplerate,e.channelCount=a.channelCount,e.codec=a.codec,e.manifestCodec=a.manifestCodec,logger.log(`parsed codec:${e.codec}, rate:${a.samplerate}, channels:${a.channelCount}`)}}function getFrameDuration(e){return 9216e4/e}function parseFrameHeader(e,t){const i=getHeaderLength(e,t);if(t+i<=e.length){const r=getFullFrameLength(e,t)-i;if(r>0)return{headerLength:i,frameLength:r}}}function appendFrame$2(e,t,i,r,s){const a=r+s*getFrameDuration(e.samplerate),n=parseFrameHeader(t,i);let o;if(n){const{frameLength:r,headerLength:s}=n,l=s+r,c=Math.max(0,i+l-t.length);c?(o=new Uint8Array(l-s),o.set(t.subarray(i+s,t.length),0)):o=t.subarray(i+s,i+l);const u={unit:o,pts:a};return c||e.samples.push(u),{sample:u,length:l,missing:c}}const l=t.length-i;o=new Uint8Array(l),o.set(t.subarray(i,t.length),0);return{sample:{unit:o,pts:a},length:l,missing:-1}}let chromeVersion$1=null;const BitratesMap=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot=[0,1,1,4];function appendFrame$1(e,t,i,r,s){if(i+24>t.length)return;const a=parseHeader(t,i);if(a&&i+a.frameLength<=t.length){const n=r+s*(9e4*a.samplesPerFrame/a.sampleRate),o={unit:t.subarray(i,i+a.frameLength),pts:n,dts:n};return e.config=[],e.channelCount=a.channelCount,e.samplerate=a.sampleRate,e.samples.push(o),{sample:o,length:a.frameLength,missing:0}}}function parseHeader(e,t){const i=e[t+1]>>3&3,r=e[t+1]>>1&3,s=e[t+2]>>4&15,a=e[t+2]>>2&3;if(1!==i&&0!==s&&15!==s&&3!==a){const n=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*BitratesMap[14*(3===i?3-r:3===r?3:4)+s-1],c=SamplingRateMap[3*(3===i?0:2===i?1:2)+a],u=3===o?1:2,d=SamplesCoefficients[i][r],h=BytesInSlot[r],m=8*d*h,f=Math.floor(d*l/c+n)*h;if(null===chromeVersion$1){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);chromeVersion$1=e?parseInt(e[1]):0}return!!chromeVersion$1&&chromeVersion$1<=87&&2===r&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:c,channelCount:u,frameLength:f,samplesPerFrame:m}}}function isHeaderPattern(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function isHeader(e,t){return t+1<e.length&&isHeaderPattern(e,t)}function canParse(e,t){return isHeaderPattern(e,t)&&4<=e.length-t}function probe(e,t){if(t+1<e.length&&isHeaderPattern(e,t)){const i=4,r=parseHeader(e,t);let s=i;null!=r&&r.frameLength&&(s=r.frameLength);const a=t+s;return a===e.length||isHeader(e,a)}return!1}class AACDemuxer extends BaseAudioDemuxer{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,r){super.resetInitSegment(e,t,i,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=getID3Data(e,0);let i=(null==t?void 0:t.length)||0;if(probe(e,i))return!1;for(let r=e.length;i<r;i++)if(probe$1(e,i))return logger.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return canParse$1(e,t)}appendFrame(e,t,i){initTrackConfig(e,this.observer,t,i,e.manifestCodec);const r=appendFrame$2(e,t,i,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}}const emsgSchemePattern=/\/emsg[-/]ID3/i;class MP4Demuxer{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,r){const s=this.videoTrack=dummyTrack("video",1),a=this.audioTrack=dummyTrack("audio",1),n=this.txtTrack=dummyTrack("text",1);if(this.id3Track=dummyTrack("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=parseInitSegment(e);if(o.video){const{id:e,timescale:t,codec:i}=o.video;s.id=e,s.timescale=n.timescale=t,s.codec=i}if(o.audio){const{id:e,timescale:t,codec:i}=o.audio;a.id=e,a.timescale=t,a.codec=i}n.id=RemuxerTrackIdConfig.text,s.sampleDuration=0,s.duration=a.duration=r}resetContiguity(){this.remainderData=null}static probe(e){return hasMoofData(e)}demux(e,t){this.timeOffset=t;let i=e;const r=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=appendUint8Array(this.remainderData,e));const t=segmentValidRange(i);this.remainderData=t.remainder,r.samples=t.valid||new Uint8Array}else r.samples=i;const a=this.extractID3Track(r,t);return s.samples=parseSamples(t,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(t,this.timeOffset);return i.samples=parseSamples(e,t),{videoTrack:t,audioTrack:dummyTrack(),id3Track:r,textTrack:dummyTrack()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const r=findBox(e.samples,["emsg"]);r&&r.forEach((e=>{const r=parseEmsg(e);if(emsgSchemePattern.test(r.schemeIdUri)){const e=isFiniteNumber(r.presentationTime)?r.presentationTime/r.timeScale:t+r.presentationTimeDelta/r.timeScale;let s=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;s<=.001&&(s=Number.POSITIVE_INFINITY);const a=r.payload;i.samples.push({data:a,len:a.byteLength,dts:e,pts:e,type:MetadataSchema.emsg,duration:s})}}))}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const getAudioBSID=(e,t)=>{let i=0,r=5;t+=r;const s=new Uint32Array(1),a=new Uint32Array(1),n=new Uint8Array(1);for(;r>0;){n[0]=e[t];const o=Math.min(r,8),l=8-o;a[0]=4278190080>>>24+l<<l,s[0]=(n[0]&a[0])>>l,i=i?i<<o|s[0]:s[0],t+=1,r-=o}return i};class AC3Demuxer extends BaseAudioDemuxer{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,r){super.resetInitSegment(e,t,i,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const r=appendFrame(e,t,i,this.basePTS,this.frameIndex);if(-1!==r){return{sample:e.samples[e.samples.length-1],length:r,missing:0}}}static probe(e){if(!e)return!1;const t=getID3Data(e,0);if(!t)return!1;const i=t.length;return 11===e[i]&&119===e[i+1]&&void 0!==getTimeStamp(t)&&getAudioBSID(e,i)<16}}function appendFrame(e,t,i,r,s){if(i+8>t.length)return-1;if(11!==t[i]||119!==t[i+1])return-1;const a=t[i+4]>>6;if(a>=3)return-1;const n=[48e3,44100,32e3][a],o=63&t[i+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+a];if(i+l>t.length)return-1;const c=t[i+6]>>5;let u=0;2===c?u+=2:(1&c&&1!==c&&(u+=2),4&c&&(u+=2));const d=(t[i+6]<<8|t[i+7])>>12-u&1,h=[2,1,2,3,3,4,4,5][c]+d,m=t[i+5]>>3,f=7&t[i+5],g=new Uint8Array([a<<6|m<<1|f>>2,(3&f)<<6|c<<3|d<<2|o>>4,o<<4&224]),p=r+s*(1536/n*9e4),v=t.subarray(i,i+l);return e.config=g,e.channelCount=h,e.samplerate=n,e.samples.push({unit:v,pts:p}),l}class BaseVideoParser{constructor(){this.VideoSample=null}createVideoSample(e,t,i,r){return{key:e,frame:!1,pts:t,dts:i,units:[],debug:r,length:0}}getLastNalUnit(e){var t;let i,r=this.VideoSample;if(r&&0!==r.units.length||(r=e[e.length-1]),null!=(t=r)&&t.units){const e=r.units;i=e[e.length-1]}return i}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const i=t.samples,r=i.length;if(!r)return void t.dropped++;{const t=i[r-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}e.debug.length&&logger.log(e.pts+"/"+e.dts+":"+e.debug)}}class ExpGolomb{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,r=new Uint8Array(4),s=Math.min(4,t);if(0===s)throw new Error("no bytes available");r.set(e.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,i=8,r=8;for(let s=0;s<e;s++)0!==r&&(t=this.readEG(),r=(i+t+256)%256),i=0===r?i:r}readSPS(){let e,t,i,r=0,s=0,a=0,n=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),c=this.readUEG.bind(this),u=this.readBoolean.bind(this),d=this.skipBits.bind(this),h=this.skipEG.bind(this),m=this.skipUEG.bind(this),f=this.skipScalingList.bind(this);o();const g=o();if(l(5),d(3),o(),m(),100===g||110===g||122===g||244===g||44===g||83===g||86===g||118===g||128===g){const e=c();if(3===e&&d(1),m(),m(),d(1),u())for(t=3!==e?8:12,i=0;i<t;i++)u()&&f(i<6?16:64)}m();const p=c();if(0===p)c();else if(1===p)for(d(1),h(),h(),e=c(),i=0;i<e;i++)h();m(),d(1);const v=c(),y=c(),E=l(1);0===E&&d(1),d(1),u()&&(r=c(),s=c(),a=c(),n=c());let T=[1,1];if(u()&&u()){switch(o()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[o()<<8|o(),o()<<8|o()]}}return{width:Math.ceil(16*(v+1)-2*r-2*s),height:(2-E)*(y+1)*16-(E?2:4)*(a+n),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class AvcVideoParser extends BaseVideoParser{parseAVCPES(e,t,i,r,s){const a=this.parseAVCNALu(e,i.data);let n,o=this.VideoSample,l=!1;i.data=null,o&&a.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),a.forEach((r=>{var a;switch(r.type){case 1:{let t=!1;n=!0;const s=r.data;if(l&&s.length>4){const e=new ExpGolomb(s).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var c;if(t)null!=(c=o)&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null);o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.frame=!0,o.key=t;break}case 5:n=!0,null!=(a=o)&&a.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.key=!0,o.frame=!0;break;case 6:n=!0,parseSEIMessageFromNALu(r.data,1,i.pts,t.samples);break;case 7:{var u,d;n=!0,l=!0;const t=r.data,i=new ExpGolomb(t).readSPS();if(!e.sps||e.width!==i.width||e.height!==i.height||(null==(u=e.pixelRatio)?void 0:u[0])!==i.pixelRatio[0]||(null==(d=e.pixelRatio)?void 0:d[1])!==i.pixelRatio[1]){e.width=i.width,e.height=i.height,e.pixelRatio=i.pixelRatio,e.sps=[t],e.duration=s;const r=t.subarray(1,4);let a="avc1.";for(let e=0;e<3;e++){let t=r[e].toString(16);t.length<2&&(t="0"+t),a+=t}e.codec=a}break}case 8:n=!0,e.pps=[r.data];break;case 9:n=!0,e.audFound=!0,o&&this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:n=!0;break;default:n=!1,o&&(o.debug+="unknown NAL "+r.type+" ")}if(o&&n){o.units.push(r)}})),r&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}parseAVCNALu(e,t){const i=t.byteLength;let r=e.naluState||0;const s=r,a=[];let n,o,l,c=0,u=-1,d=0;for(-1===r&&(u=0,d=31&t[0],r=0,c=1);c<i;)if(n=t[c++],r)if(1!==r)if(n)if(1===n){if(o=c-r-1,u>=0){const e={data:t.subarray(u,o),type:d};a.push(e)}else{const i=this.getLastNalUnit(e.samples);i&&(s&&c<=4-s&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-s)),o>0&&(i.data=appendUint8Array(i.data,t.subarray(0,o)),i.state=0))}c<i?(l=31&t[c],u=c,d=l,r=0):r=-1}else r=0;else r=3;else r=n?0:2;else r=n?0:1;if(u>=0&&r>=0){const e={data:t.subarray(u,i),type:d,state:r};a.push(e)}if(0===a.length){const i=this.getLastNalUnit(e.samples);i&&(i.data=appendUint8Array(i.data,t))}return e.naluState=r,a}}class SampleAesDecrypter{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Decrypter(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,i){const r=e[t].unit;if(r.length<=16)return;const s=r.subarray(16,r.length-r.length%16),a=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(a).then((s=>{const a=new Uint8Array(s);r.set(a,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)}))}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length)return void i();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,i=new Int8Array(t);let r=0;for(let s=32;s<e.length-16;s+=160,r+=16)i.set(e.subarray(s,s+16),r);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let r=0;for(let s=32;s<e.length-16;s+=160,r+=16)e.set(i.subarray(r,r+16),s);return e}decryptAvcSample(e,t,i,r,s){const a=discardEPB(s.data),n=this.getAvcEncryptedData(a);this.decryptBuffer(n.buffer).then((n=>{s.data=this.getAvcDecryptedUnit(a,n),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,r)}))}decryptAvcSamples(e,t,i,r){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length)return void r();const s=e[t].units;for(;!(i>=s.length);i++){const a=s[i];if(!(a.data.length<=48||1!==a.type&&5!==a.type||(this.decryptAvcSample(e,t,i,r,a),this.decrypter.isSync())))return}}}}const PACKET_LENGTH=188;class TSDemuxer{constructor(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.videoParser=new AvcVideoParser}static probe(e){const t=TSDemuxer.syncOffset(e);return t>0&&logger.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),-1!==t}static syncOffset(e){const t=e.length;let i=Math.min(5*PACKET_LENGTH,t-PACKET_LENGTH)+1,r=0;for(;r<i;){let s=!1,a=-1,n=0;for(let o=r;o<t;o+=PACKET_LENGTH){if(71!==e[o]||t-o!==PACKET_LENGTH&&71!==e[o+PACKET_LENGTH]){if(n)return-1;break}if(n++,-1===a&&(a=o,0!==a&&(i=Math.min(a+99*PACKET_LENGTH,e.length-PACKET_LENGTH)+1)),s||(s=0===parsePID(e,o)),s&&n>1&&(0===a&&n>2||o+PACKET_LENGTH>i))return a}r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:RemuxerTrackIdConfig[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,i,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=TSDemuxer.createTrack("video"),this._audioTrack=TSDemuxer.createTrack("audio",r),this._id3Track=TSDemuxer.createTrack("id3"),this._txtTrack=TSDemuxer.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i,this._duration=r}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,r=!1){let s;i||(this.sampleAes=null);const a=this._videoTrack,n=this._audioTrack,o=this._id3Track,l=this._txtTrack;let c=a.pid,u=a.pesData,d=n.pid,h=o.pid,m=n.pesData,f=o.pesData,g=null,p=this.pmtParsed,v=this._pmtId,y=e.length;if(this.remainderData&&(y=(e=appendUint8Array(this.remainderData,e)).length,this.remainderData=null),y<PACKET_LENGTH&&!r)return this.remainderData=e,{audioTrack:n,videoTrack:a,id3Track:o,textTrack:l};const E=Math.max(0,TSDemuxer.syncOffset(e));y-=(y-E)%PACKET_LENGTH,y<e.byteLength&&!r&&(this.remainderData=new Uint8Array(e.buffer,y,e.buffer.byteLength-y));let T=0;for(let _=E;_<y;_+=PACKET_LENGTH)if(71===e[_]){const t=!!(64&e[_+1]),r=parsePID(e,_);let y;if((48&e[_+3])>>4>1){if(y=_+5+e[_+4],y===_+PACKET_LENGTH)continue}else y=_+4;switch(r){case c:t&&(u&&(s=parsePES(u))&&this.videoParser.parseAVCPES(a,l,s,!1,this._duration),u={data:[],size:0}),u&&(u.data.push(e.subarray(y,_+PACKET_LENGTH)),u.size+=_+PACKET_LENGTH-y);break;case d:if(t){if(m&&(s=parsePES(m)))switch(n.segmentCodec){case"aac":this.parseAACPES(n,s);break;case"mp3":this.parseMPEGPES(n,s);break;case"ac3":this.parseAC3PES(n,s)}m={data:[],size:0}}m&&(m.data.push(e.subarray(y,_+PACKET_LENGTH)),m.size+=_+PACKET_LENGTH-y);break;case h:t&&(f&&(s=parsePES(f))&&this.parseID3PES(o,s),f={data:[],size:0}),f&&(f.data.push(e.subarray(y,_+PACKET_LENGTH)),f.size+=_+PACKET_LENGTH-y);break;case 0:t&&(y+=e[y]+1),v=this._pmtId=parsePAT(e,y);break;case v:{t&&(y+=e[y]+1);const r=parsePMT(e,y,this.typeSupported,i);c=r.videoPid,c>0&&(a.pid=c,a.segmentCodec=r.segmentVideoCodec),d=r.audioPid,d>0&&(n.pid=d,n.segmentCodec=r.segmentAudioCodec),h=r.id3Pid,h>0&&(o.pid=h),null===g||p||(logger.warn(`MPEG-TS PMT found at ${_} after unknown PID '${g}'. Backtracking to sync byte @${E} to parse all TS packets.`),g=null,_=E-188),p=this.pmtParsed=!0;break}case 17:case 8191:break;default:g=r}}else T++;if(T>0){const e=new Error(`Found ${T} TS packet/s that do not start with 0x47`);this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message})}a.pesData=u,n.pesData=m,o.pesData=f;const S={audioTrack:n,videoTrack:a,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(S),S}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:r,textTrack:s}=e,a=i.pesData,n=t.pesData,o=r.pesData;let l;if(a&&(l=parsePES(a))?(this.videoParser.parseAVCPES(i,s,l,!0,this._duration),i.pesData=null):i.pesData=a,n&&(l=parsePES(n))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l)}t.pesData=null}else null!=n&&n.size&&logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=n;o&&(l=parsePES(o))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(e,t,i){const r=this.demux(e,i,!0,!this.config.progressive),s=this.sampleAes=new SampleAesDecrypter(this.observer,this.config,t);return this.decrypt(r,s)}decrypt(e,t){return new Promise((i=>{const{audioTrack:r,videoTrack:s}=e;r.samples&&"aac"===r.segmentCodec?t.decryptAacSamples(r.samples,0,(()=>{s.samples?t.decryptAvcSamples(s.samples,0,0,(()=>{i(e)})):i(e)})):s.samples&&t.decryptAvcSamples(s.samples,0,0,(()=>{i(e)}))}))}destroy(){this._duration=0}parseAACPES(e,t){let i=0;const r=this.aacOverFlow;let s,a,n,o=t.data;if(r){this.aacOverFlow=null;const t=r.missing,s=r.sample.unit.byteLength;if(-1===t)o=appendUint8Array(r.sample.unit,o);else{const a=s-t;r.sample.unit.set(o.subarray(0,t),a),e.samples.push(r.sample),i=r.missing}}for(s=i,a=o.length;s<a-1&&!isHeader$1(o,s);s++);if(s!==i){let e;const t=s<a-1;e=t?`AAC PES did not start with ADTS header,offset:${s}`:"No ADTS header found in AAC PES";const i=new Error(e);if(logger.warn(`parsing error: ${e}`),this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:i,reason:e}),!t)return}if(initTrackConfig(e,this.observer,o,s,this.audioCodec),void 0!==t.pts)n=t.pts;else{if(!r)return void logger.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=getFrameDuration(e.samplerate);n=r.sample.pts+t}}let l,c=0;for(;s<a;){if(l=appendFrame$2(e,o,s,n,c),s+=l.length,l.missing){this.aacOverFlow=l;break}for(c++;s<a-1&&!isHeader$1(o,s);s++);}}parseMPEGPES(e,t){const i=t.data,r=i.length;let s=0,a=0;const n=t.pts;if(void 0!==n)for(;a<r;)if(isHeader(i,a)){const t=appendFrame$1(e,i,a,n,s);if(!t)break;a+=t.length,s++}else a++;else logger.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const i=t.data,r=t.pts;if(void 0===r)return void logger.warn("[tsdemuxer]: AC3 PES unknown PTS");const s=i.length;let a,n=0,o=0;for(;o<s&&(a=appendFrame(e,i,o,r,n++))>0;)o+=a}}parseID3PES(e,t){if(void 0===t.pts)return void logger.warn("[tsdemuxer]: ID3 PES unknown PTS");const i=_extends({},t,{type:this._videoTrack?MetadataSchema.emsg:MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function parsePID(e,t){return((31&e[t+1])<<8)+e[t+2]}function parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}function parsePMT(e,t,i,r){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<a;){const a=parsePID(e,t),n=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!r){logEncryptedSamplesFoundInUnencryptedStream("ADTS AAC");break}case 15:-1===s.audioPid&&(s.audioPid=a);break;case 21:-1===s.id3Pid&&(s.id3Pid=a);break;case 219:if(!r){logEncryptedSamplesFoundInUnencryptedStream("H.264");break}case 27:-1===s.videoPid&&(s.videoPid=a,s.segmentVideoCodec="avc");break;case 3:case 4:i.mpeg||i.mp3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="mp3"):logger.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){logEncryptedSamplesFoundInUnencryptedStream("AC-3");break}case 129:i.ac3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="ac3"):logger.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===s.audioPid&&n>0){let r=t+5,o=n;for(;o>2;){if(106===e[r])!0!==i.ac3?logger.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=a,s.segmentAudioCodec="ac3");const t=e[r+1]+2;r+=t,o-=t}}break;case 194:case 135:logger.warn("Unsupported EC-3 in M2TS found");break;case 36:logger.warn("Unsupported HEVC in M2TS found")}t+=n+5}return s}function logEncryptedSamplesFoundInUnencryptedStream(e){logger.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function parsePES(e){let t,i,r,s,a,n=0;const o=e.data;if(!e||0===e.size)return null;for(;o[0].length<19&&o.length>1;)o[0]=appendUint8Array(o[0],o[1]),o.splice(1,1);t=o[0];if(1===(t[0]<<16)+(t[1]<<8)+t[2]){if(i=(t[4]<<8)+t[5],i&&i>e.size-6)return null;const l=t[7];192&l&&(s=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&l?(a=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2,s-a>54e5&&(logger.warn(`${Math.round((s-a)/9e4)}s delta between PTS and DTS, align them`),s=a)):a=s),r=t[8];let c=r+9;if(e.size<=c)return null;e.size-=c;const u=new Uint8Array(e.size);for(let e=0,i=o.length;e<i;e++){t=o[e];let i=t.byteLength;if(c){if(c>i){c-=i;continue}t=t.subarray(c),i-=c,c=0}u.set(t,n),n+=i}return i&&(i-=r+3),{data:u,pts:s,dts:a,len:i}}return null}class MP3Demuxer extends BaseAudioDemuxer{resetInitSegment(e,t,i,r){super.resetInitSegment(e,t,i,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=getID3Data(e,0);let i=(null==t?void 0:t.length)||0;if(t&&11===e[i]&&119===e[i+1]&&void 0!==getTimeStamp(t)&&getAudioBSID(e,i)<=16)return!1;for(let r=e.length;i<r;i++)if(probe(e,i))return logger.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return canParse(e,t)}appendFrame(e,t,i){if(null!==this.basePTS)return appendFrame$1(e,t,i,this.basePTS,this.frameIndex)}}class AAC{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const UINT32_MAX=Math.pow(2,32)-1;class MP4{static init(){let e;for(e in MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},MP4.types)MP4.types.hasOwnProperty(e)&&(MP4.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:t,audio:i};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=s,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),n=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,a,o,a,n),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,r))}static box(e,...t){let i=8,r=t.length;const s=r;for(;r--;)i+=t[r].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=255&i,a.set(e,4),r=0,i=8;r<s;r++)a.set(t[r],i),i+=t[r].byteLength;return a}static hdlr(e){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[e])}static mdat(e){return MP4.box(MP4.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(UINT32_MAX+1)),r=Math.floor(t%(UINT32_MAX+1));return MP4.box(MP4.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){return MP4.box(MP4.types.mdia,MP4.mdhd(e.timescale,e.duration),MP4.hdlr(e.type),MP4.minf(e))}static mfhd(e){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(e)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(e))}static moof(e,t,i){return MP4.box(MP4.types.moof,MP4.mfhd(e),MP4.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=MP4.trak(e[t]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(MP4.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=MP4.trex(e[t]);return MP4.box.apply(null,[MP4.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(UINT32_MAX+1)),r=Math.floor(t%(UINT32_MAX+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,s)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let r,s;for(r=0;r<t.length;r++)s=t[r].flags,i[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return MP4.box(MP4.types.sdtp,i)}static stbl(e){return MP4.box(MP4.types.stbl,MP4.stsd(e),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}static avc1(e){let t,i,r,s=[],a=[];for(t=0;t<e.sps.length;t++)i=e.sps[t],r=i.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));for(t=0;t<e.pps.length;t++)i=e.pps[t],r=i.byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(i));const n=MP4.box(MP4.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|e.sps.length].concat(s).concat([e.pps.length]).concat(a))),o=e.width,l=e.height,c=e.pixelRatio[0],u=e.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,u>>24,u>>16&255,u>>8&255,255&u])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return MP4.box(MP4.types.mp4a,MP4.audioStsd(e),MP4.box(MP4.types.esds,MP4.esds(e)))}static mp3(e){return MP4.box(MP4.types[".mp3"],MP4.audioStsd(e))}static ac3(e){return MP4.box(MP4.types["ac-3"],MP4.audioStsd(e),MP4.box(MP4.types.dac3,e.config))}static stsd(e){return"audio"===e.type?"mp3"===e.segmentCodec&&"mp3"===e.codec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(e)):"ac3"===e.segmentCodec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.ac3(e)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(e)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,r=e.width,s=e.height,a=Math.floor(i/(UINT32_MAX+1)),n=Math.floor(i%(UINT32_MAX+1));return MP4.box(MP4.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,s>>8&255,255&s,0,0]))}static traf(e,t){const i=MP4.sdtp(e),r=e.id,s=Math.floor(t/(UINT32_MAX+1)),a=Math.floor(t%(UINT32_MAX+1));return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),MP4.box(MP4.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a])),MP4.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(e),MP4.mdia(e))}static trex(e){const t=e.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],r=i.length,s=12+16*r,a=new Uint8Array(s);let n,o,l,c,u,d;for(t+=8+s,a.set(["video"===e.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),n=0;n<r;n++)o=i[n],l=o.duration,c=o.size,u=o.flags,d=o.cts,a.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,c>>>24&255,c>>>16&255,c>>>8&255,255&c,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,61440&u.degradPrio,15&u.degradPrio,d>>>24&255,d>>>16&255,d>>>8&255,255&d],12+16*n);return MP4.box(MP4.types.trun,a)}static initSegment(e){MP4.types||MP4.init();const t=MP4.moov(e);return appendUint8Array(MP4.FTYP,t)}}MP4.types=void 0,MP4.HDLR_TYPES=void 0,MP4.STTS=void 0,MP4.STSC=void 0,MP4.STCO=void 0,MP4.STSZ=void 0,MP4.VMHD=void 0,MP4.SMHD=void 0,MP4.STSD=void 0,MP4.FTYP=void 0,MP4.DINF=void 0;const MPEG_TS_CLOCK_FREQ_HZ=9e4;function toTimescaleFromBase(e,t,i=1,r=!1){const s=e*t*i;return r?Math.round(s):s}function toTimescaleFromScale(e,t,i=1,r=!1){return toTimescaleFromBase(e,t,1/i,r)}function toMsFromMpegTsClock(e,t=!1){return toTimescaleFromBase(e,1e3,1/MPEG_TS_CLOCK_FREQ_HZ,t)}function toMpegTsClockFromTimescale(e,t=1){return toTimescaleFromBase(e,MPEG_TS_CLOCK_FREQ_HZ,1/t)}const MAX_SILENT_FRAME_DURATION=1e4,AAC_SAMPLES_PER_FRAME=1024,MPEG_AUDIO_SAMPLE_PER_FRAME=1152,AC3_SAMPLES_PER_FRAME=1536;let chromeVersion=null,safariWebkitVersion=null,now;class MP4Remuxer{constructor(e,t,i,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,null===chromeVersion){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);chromeVersion=e?parseInt(e[1]):0}if(null===safariWebkitVersion){const e=navigator.userAgent.match(/Safari\/(\d+)/i);safariWebkitVersion=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e.reduce(((e,i)=>{const r=i.pts-e;return r<-4294967296?(t=!0,normalizePts(e,i.pts)):r>0?e:i.pts}),e[0].pts);return t&&logger.debug("PTS rollover detected"),i}remux(e,t,i,r,s,a,n,o){let l,c,u,d,h,m,f=s,g=s;const p=e.pid>-1,v=t.pid>-1,y=t.samples.length,E=e.samples.length>0,T=n&&y>0||y>1;if((!p||E)&&(!v||T)||this.ISGenerated||n){if(this.ISGenerated){var S,_,k,b;const e=this.videoTrackConfig;!e||t.width===e.width&&t.height===e.height&&(null==(S=t.pixelRatio)?void 0:S[0])===(null==(_=e.pixelRatio)?void 0:_[0])&&(null==(k=t.pixelRatio)?void 0:k[1])===(null==(b=e.pixelRatio)?void 0:b[1])||this.resetInitSegment()}else u=this.generateIS(e,t,s,a);const i=this.isVideoContiguous;let r,n=-1;if(T&&(n=findKeyframeIndex(t.samples),!i&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,n>0){logger.warn(`[mp4-remuxer]: Dropped ${n} out of ${y} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(n),t.dropped+=n,g+=(t.samples[0].pts-e)/t.inputTimeScale,r=g}else-1===n&&(logger.warn(`[mp4-remuxer]: No keyframe found out of ${y} video samples`),m=!1);if(this.ISGenerated){if(E&&T){const i=this.getVideoStartPts(t.samples),r=(normalizePts(e.samples[0].pts,i)-i)/t.inputTimeScale;f+=Math.max(0,r),g+=Math.max(0,-r)}if(E){if(e.samplerate||(logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),u=this.generateIS(e,t,s,a)),c=this.remuxAudio(e,f,this.isAudioContiguous,a,v||T||o===PlaylistLevelType.AUDIO?g:void 0),T){const r=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),u=this.generateIS(e,t,s,a)),l=this.remuxVideo(t,g,i,r)}}else T&&(l=this.remuxVideo(t,g,i,0));l&&(l.firstKeyFrame=n,l.independent=-1!==n,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(h=flushTextTrackMetadataCueSamples(i,s,this._initPTS,this._initDTS)),r.samples.length&&(d=flushTextTrackUserdataCueSamples(r,s,this._initPTS))),{audio:c,video:l,initSegment:u,independent:m,text:d,id3:h}}generateIS(e,t,i,r){const s=e.samples,a=t.samples,n=this.typeSupported,o={},l=this._initPTS;let c,u,d,h=!l||r,m="audio/mp4";if(h&&(c=u=1/0),e.config&&s.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":n.mpeg?(m="audio/mpeg",e.codec=""):n.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}o.audio={id:"audio",container:m,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&n.mpeg?new Uint8Array(0):MP4.initSegment([e]),metadata:{channelCount:e.channelCount}},h&&(d=e.inputTimeScale,l&&d===l.timescale?h=!1:c=u=s[0].pts-Math.round(d*i))}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:MP4.initSegment([t]),metadata:{width:t.width,height:t.height}},h)if(d=t.inputTimeScale,l&&d===l.timescale)h=!1;else{const e=this.getVideoStartPts(a),t=Math.round(d*i);u=Math.min(u,normalizePts(a[0].dts,e)-t),c=Math.min(c,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,h?(this._initPTS={baseTime:c,timescale:d},this._initDTS={baseTime:u,timescale:d}):c=d=void 0,{tracks:o,initPTS:c,timescale:d}}remuxVideo(e,t,i,r){const s=e.inputTimeScale,a=e.samples,n=[],o=a.length,l=this._initPTS;let c,u,d=this.nextAvcDts,h=8,m=this.videoSampleDuration,f=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,p=!1;if(!i||null===d){const e=t*s,r=a[0].pts-normalizePts(a[0].dts,a[0].pts);chromeVersion&&null!==d&&Math.abs(e-r-d)<15e3?i=!0:d=e-r}const v=l.baseTime*s/l.timescale;for(let M=0;M<o;M++){const e=a[M];e.pts=normalizePts(e.pts-v,d),e.dts=normalizePts(e.dts-v,d),e.dts<a[M>0?M-1:M].dts&&(p=!0)}p&&a.sort((function(e,t){const i=e.dts-t.dts,r=e.pts-t.pts;return i||r})),c=a[0].dts,u=a[a.length-1].dts;const y=u-c,E=y?Math.round(y/(o-1)):m||e.inputTimeScale/30;if(i){const e=c-d,i=e>E,r=e<-1;if((i||r)&&(i?logger.warn(`AVC: ${toMsFromMpegTsClock(e,!0)} ms (${e}dts) hole between fragments detected at ${t.toFixed(3)}`):logger.warn(`AVC: ${toMsFromMpegTsClock(-e,!0)} ms (${e}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!r||d>=a[0].pts||chromeVersion)){c=d;const t=a[0].pts-e;if(i)a[0].dts=c,a[0].pts=t;else for(let i=0;i<a.length&&!(a[i].dts>t);i++)a[i].dts-=e,a[i].pts-=e;logger.log(`Video: Initial PTS/DTS adjusted: ${toMsFromMpegTsClock(t,!0)}/${toMsFromMpegTsClock(c,!0)}, delta: ${toMsFromMpegTsClock(e,!0)} ms`)}}c=Math.max(0,c);let T=0,S=0,_=c;for(let M=0;M<o;M++){const e=a[M],t=e.units,i=t.length;let r=0;for(let s=0;s<i;s++)r+=t[s].data.length;S+=r,T+=i,e.length=r,e.dts<_?(e.dts=_,_+=E/4|0||1):_=e.dts,f=Math.min(e.pts,f),g=Math.max(e.pts,g)}u=a[o-1].dts;const k=S+4*T+8;let b;try{b=new Uint8Array(k)}catch(P){return void this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MUX_ERROR,details:ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,error:P,bytes:k,reason:`fail allocating video mdat ${k}`})}const C=new DataView(b.buffer);C.setUint32(0,k),b.set(MP4.types.mdat,4);let L=!1,A=Number.POSITIVE_INFINITY,w=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,R=Number.NEGATIVE_INFINITY;for(let M=0;M<o;M++){const e=a[M],t=e.units;let i,l=0;for(let r=0,s=t.length;r<s;r++){const e=t[r],i=e.data,s=e.data.byteLength;C.setUint32(h,s),h+=4,b.set(i,h),h+=s,l+=4+s}if(M<o-1)m=a[M+1].dts-e.dts,i=a[M+1].pts-e.pts;else{const t=this.config,n=M>0?e.dts-a[M-1].dts:E;if(i=M>0?e.pts-a[M-1].pts:E,t.stretchShortVideoTrack&&null!==this.nextAudioPts){const i=Math.floor(t.maxBufferHole*s),a=(r?f+r*s:this.nextAudioPts)-e.pts;a>i?(m=a-n,m<0?m=n:L=!0,logger.log(`[mp4-remuxer]: It is approximately ${a/90} ms to the next segment; using duration ${m/90} ms for the last video frame.`)):m=n}else m=n}const c=Math.round(e.pts-e.dts);A=Math.min(A,m),D=Math.max(D,m),w=Math.min(w,i),R=Math.max(R,i),n.push(new Mp4Sample(e.key,m,l,c))}if(n.length)if(chromeVersion){if(chromeVersion<70){const e=n[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(safariWebkitVersion&&R-w<D-A&&E/D<.025&&0===n[0].cts){logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=c;for(let t=0,i=n.length;t<i;t++){const r=e+n[t].duration,s=e+n[t].cts;if(t<i-1){const e=r+n[t+1].cts;n[t].duration=e-s}else n[t].duration=t?n[t-1].duration:E;n[t].cts=0,e=r}}m=L||!m?E:m,this.nextAvcDts=d=u+m,this.videoSampleDuration=m,this.isVideoContiguous=!0;const I={data1:MP4.moof(e.sequenceNumber++,c,_extends({},e,{samples:n})),data2:b,startPTS:f/s,endPTS:(g+m)/s,startDTS:c/s,endDTS:d/s,type:"video",hasAudio:!1,hasVideo:!0,nb:n.length,dropped:e.dropped};return e.samples=[],e.dropped=0,I}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return MPEG_AUDIO_SAMPLE_PER_FRAME;case"ac3":return AC3_SAMPLES_PER_FRAME;default:return AAC_SAMPLES_PER_FRAME}}remuxAudio(e,t,i,r,s){const a=e.inputTimeScale,n=a/(e.samplerate?e.samplerate:a),o=this.getSamplesPerFrame(e),l=o*n,c=this._initPTS,u="mp3"===e.segmentCodec&&this.typeSupported.mpeg,d=[],h=void 0!==s;let m=e.samples,f=u?0:8,g=this.nextAudioPts||-1;const p=t*a,v=c.baseTime*a/c.timescale;if(this.isAudioContiguous=i=i||m.length&&g>0&&(r&&Math.abs(p-g)<9e3||Math.abs(normalizePts(m[0].pts-v,p)-g)<20*l),m.forEach((function(e){e.pts=normalizePts(e.pts-v,p)})),!i||g<0){if(m=m.filter((e=>e.pts>=0)),!m.length)return;g=0===s?0:r&&!h?Math.max(0,p):m[0].pts}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let i=0,r=g;i<m.length;i++){const s=m[i],n=s.pts,o=n-r,c=Math.abs(1e3*o/a);if(o<=-t*l&&h)0===i&&(logger.warn(`Audio frame @ ${(n/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/a)} ms.`),this.nextAudioPts=g=r=n);else if(o>=t*l&&c<MAX_SILENT_FRAME_DURATION&&h){let t=Math.round(o/l);r=n-t*l,r<0&&(t--,r+=l),0===i&&(this.nextAudioPts=g=r),logger.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(r/a).toFixed(3)}s due to ${Math.round(1e3*o/a)} ms gap.`);for(let a=0;a<t;a++){const t=Math.max(r,0);let a=AAC.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);a||(logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),a=s.unit.subarray()),m.splice(i,0,{unit:a,pts:t}),r+=l,i++}}s.pts=r,r+=l}}let y,E=null,T=null,S=0,_=m.length;for(;_--;)S+=m[_].unit.byteLength;for(let R=0,I=m.length;R<I;R++){const t=m[R],r=t.unit;let s=t.pts;if(null!==T){d[R-1].duration=Math.round((s-T)/n)}else{if(i&&"aac"===e.segmentCodec&&(s=g),E=s,!(S>0))return;S+=f;try{y=new Uint8Array(S)}catch(D){return void this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MUX_ERROR,details:ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,error:D,bytes:S,reason:`fail allocating audio mdat ${S}`})}if(!u){new DataView(y.buffer).setUint32(0,S),y.set(MP4.types.mdat,4)}}y.set(r,f);const a=r.byteLength;f+=a,d.push(new Mp4Sample(!0,o,a,0)),T=s}const k=d.length;if(!k)return;const b=d[d.length-1];this.nextAudioPts=g=T+n*b.duration;const C=u?new Uint8Array(0):MP4.moof(e.sequenceNumber++,E/n,_extends({},e,{samples:d}));e.samples=[];const L=E/a,A=g/a,w={data1:C,data2:y,startPTS:L,endPTS:A,startDTS:L,endDTS:A,type:"audio",hasAudio:!0,hasVideo:!1,nb:k};return this.isAudioContiguous=!0,w}remuxEmptyAudio(e,t,i,r){const s=e.inputTimeScale,a=s/(e.samplerate?e.samplerate:s),n=this.nextAudioPts,o=this._initDTS,l=9e4*o.baseTime/o.timescale,c=(null!==n?n:r.startDTS*s)+l,u=r.endDTS*s+l,d=a*AAC_SAMPLES_PER_FRAME,h=Math.ceil((u-c)/d),m=AAC.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(logger.warn("[mp4-remuxer]: remux empty Audio"),!m)return void logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const f=[];for(let g=0;g<h;g++){const e=c+g*d;f.push({unit:m,pts:e,dts:e})}return e.samples=f,this.remuxAudio(e,t,i,!1)}}function normalizePts(e,t){let i;if(null===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}function findKeyframeIndex(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}function flushTextTrackMetadataCueSamples(e,t,i,r){const s=e.samples.length;if(!s)return;const a=e.inputTimeScale;for(let o=0;o<s;o++){const s=e.samples[o];s.pts=normalizePts(s.pts-i.baseTime*a/i.timescale,t*a)/a,s.dts=normalizePts(s.dts-r.baseTime*a/r.timescale,t*a)/a}const n=e.samples;return e.samples=[],{samples:n}}function flushTextTrackUserdataCueSamples(e,t,i){const r=e.samples.length;if(!r)return;const s=e.inputTimeScale;for(let n=0;n<r;n++){const r=e.samples[n];r.pts=normalizePts(r.pts-i.baseTime*s/i.timescale,t*s)/s}e.samples.sort(((e,t)=>e.pts-t.pts));const a=e.samples;return e.samples=[],{samples:a}}class Mp4Sample{constructor(e,t,i,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=i,this.cts=r,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class PassThroughRemuxer{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,r){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(patchEncyptionData(e,r)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=parseInitSegment(e);r.audio&&(t=getParsedTrackCodec(r.audio,ElementaryStreamTypes.AUDIO)),r.video&&(i=getParsedTrackCodec(r.video,ElementaryStreamTypes.VIDEO));const s={};r.audio&&r.video?s.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:r.audio?s.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:r.video?s.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(e,t,i,r,s,a){var n,o;let{initPTS:l,lastEndTime:c}=this;const u={audio:void 0,video:void 0,text:r,id3:i,initSegment:void 0};isFiniteNumber(c)||(c=this.lastEndTime=s||0);const d=t.samples;if(null==d||!d.length)return u;const h={initPTS:void 0,timescale:1};let m=this.initData;if(null!=(n=m)&&n.length||(this.generateInitSegment(d),m=this.initData),null==(o=m)||!o.length)return logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),u;this.emitInitSegment&&(h.tracks=this.initTracks,this.emitInitSegment=!1);const f=getDuration(d,m),g=getStartDTS(m,d),p=null===g?s:g;(isInvalidInitPts(l,p,s,f)||h.timescale!==l.timescale&&a)&&(h.initPTS=p-s,l&&1===l.timescale&&logger.warn("Adjusting initPTS by "+(h.initPTS-l.baseTime)),this.initPTS=l={baseTime:h.initPTS,timescale:1});const v=e?p-l.baseTime/l.timescale:c,y=v+f;offsetStartDTS(m,d,l.baseTime/l.timescale),f>0?this.lastEndTime=y:(logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const E=!!m.audio,T=!!m.video;let S="";E&&(S+="audio"),T&&(S+="video");const _={data1:d,startPTS:v,startDTS:v,endPTS:y,endDTS:y,type:S,hasAudio:E,hasVideo:T,nb:1,dropped:0};return u.audio="audio"===_.type?_:void 0,u.video="audio"!==_.type?_:void 0,u.initSegment=h,u.id3=flushTextTrackMetadataCueSamples(i,s,l,l),r.samples.length&&(u.text=flushTextTrackUserdataCueSamples(r,s,l)),u}}function isInvalidInitPts(e,t,i,r){if(null===e)return!0;const s=Math.max(r,1),a=t-e.baseTime/e.timescale;return Math.abs(a-i)>s}function getParsedTrackCodec(e,t){const i=null==e?void 0:e.codec;if(i&&i.length>4)return i;if(t===ElementaryStreamTypes.AUDIO){if("ec-3"===i||"ac-3"===i||"alac"===i)return i;if("fLaC"===i||"Opus"===i){return getCodecCompatibleName(i,!1)}const e="mp4a.40.5";return logger.info(`Parsed audio codec "${i}" or audio object type not handled. Using "${e}"`),e}return logger.warn(`Unhandled video codec "${i}"`),"hvc1"===i||"hev1"===i?"hvc1.1.6.L120.90":"av01"===i?"av01.0.04M.08":"avc1.42e01e"}try{now=self.performance.now.bind(self.performance)}catch(err){logger.debug("Unable to use Performance API on this environment"),now=null==optionalSelf?void 0:optionalSelf.Date.now}const muxConfig=[{demux:MP4Demuxer,remux:PassThroughRemuxer},{demux:TSDemuxer,remux:MP4Remuxer},{demux:AACDemuxer,remux:MP4Remuxer},{demux:MP3Demuxer,remux:MP4Remuxer}];muxConfig.splice(2,0,{demux:AC3Demuxer,remux:MP4Remuxer});class Transmuxer{constructor(e,t,i,r,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=r,this.id=s}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,r){const s=i.transmuxing;s.executeStart=now();let a=new Uint8Array(e);const{currentTransmuxState:n,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:c,trackSwitch:u,accurateTimeOffset:d,timeOffset:h,initSegmentChange:m}=r||n,{audioCodec:f,videoCodec:g,defaultInitPts:p,duration:v,initSegmentData:y}=o,E=getEncryptionType(a,t);if(E&&"AES-128"===E.method){const e=this.getDecrypter();if(!e.isSync())return this.decryptionPromise=e.webCryptoDecrypt(a,E.key.buffer,E.iv.buffer).then((e=>{const t=this.push(e,null,i);return this.decryptionPromise=null,t})),this.decryptionPromise;{let t=e.softwareDecrypt(a,E.key.buffer,E.iv.buffer);if(i.part>-1&&(t=e.flush()),!t)return s.executeEnd=now(),emptyResult(i);a=new Uint8Array(t)}}const T=this.needsProbing(c,u);if(T){const e=this.configureTransmuxer(a);if(e)return logger.warn(`[transmuxer] ${e.message}`),this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),s.executeEnd=now(),emptyResult(i)}(c||u||m||T)&&this.resetInitSegment(y,f,g,v,t),(c||m||T)&&this.resetInitialTimestamp(p),l||this.resetContiguity();const S=this.transmux(a,E,h,d,i),_=this.currentTransmuxState;return _.contiguous=!0,_.discontinuity=!1,_.trackSwitch=!1,s.executeEnd=now(),S}flush(e){const t=e.transmuxing;t.executeStart=now();const{decrypter:i,currentTransmuxState:r,decryptionPromise:s}=this;if(s)return s.then((()=>this.flush(e)));const a=[],{timeOffset:n}=r;if(i){const t=i.flush();t&&a.push(this.push(t,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l)return t.executeEnd=now(),[emptyResult(e)];const c=o.flush(n);return isPromise(c)?c.then((t=>(this.flushRemux(a,t,e),a))):(this.flushRemux(a,c,e),a)}flushRemux(e,t,i){const{audioTrack:r,videoTrack:s,id3Track:a,textTrack:n}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;logger.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const c=this.remuxer.remux(r,s,a,n,l,o,!0,this.id);e.push({remuxResult:c,chunkMeta:i}),i.transmuxing.executeEnd=now()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;t&&i&&(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,r,s){const{demuxer:a,remuxer:n}=this;a&&n&&(a.resetInitSegment(e,t,i,r),n.resetInitSegment(e,t,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,r,s){let a;return a=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,i,r,s):this.transmuxUnencrypted(e,i,r,s),a}transmuxUnencrypted(e,t,i,r){const{audioTrack:s,videoTrack:a,id3Track:n,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,a,n,o,t,i,!1,this.id),chunkMeta:r}}transmuxSampleAes(e,t,i,r,s){return this.demuxer.demuxSampleAes(e,t,i).then((e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,i,r,!1,this.id),chunkMeta:s})))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:r,vendor:s}=this;let a;for(let d=0,h=muxConfig.length;d<h;d++){var n;if(null!=(n=muxConfig[d].demux)&&n.probe(e)){a=muxConfig[d];break}}if(!a)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,c=a.remux,u=a.demux;l&&l instanceof c||(this.remuxer=new c(i,t,r,s)),o&&o instanceof u||(this.demuxer=new u(i,t,r),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Decrypter(this.config)),e}}function getEncryptionType(e,t){let i=null;return e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(i=t),i}const emptyResult=e=>({remuxResult:{},chunkMeta:e});function isPromise(e){return"then"in e&&e.then instanceof Function}class TransmuxConfig{constructor(e,t,i,r,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=r,this.defaultInitPts=s||null}}class TransmuxState{constructor(e,t,i,r,s,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=r,this.timeOffset=s,this.initSegmentChange=a}}var eventemitter3={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function r(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function a(e,t,r,a,n){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,n),l=i?i+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function n(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(i=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,n=new Array(a);s<a;s++)n[s]=r[s].fn;return n},o.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,n){var o=i?i+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,n),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,m=u.length;for(c=0;c<m;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,i){return a(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return a(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,r,s){var a=i?i+e:e;if(!this._events[a])return this;if(!t)return n(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||n(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:n(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&n(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o}(eventemitter3);var eventemitter3Exports=eventemitter3.exports,EventEmitter=getDefaultExportFromCjs(eventemitter3Exports);class TransmuxerInterface{constructor(e,t,i,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const s=e.config;this.hls=e,this.id=t,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=r;const a=(e,t)=>{(t=t||{}).frag=this.frag,t.id=this.id,e===Events.ERROR&&(this.error=t.error),this.hls.trigger(e,t)};this.observer=new EventEmitter,this.observer.on(Events.FRAG_DECRYPTED,a),this.observer.on(Events.ERROR,a);const n=getMediaSource(s.preferManagedMediaSource)||{isTypeSupported:()=>!1},o={mpeg:n.isTypeSupported("audio/mpeg"),mp3:n.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:n.isTypeSupported('audio/mp4; codecs="ac-3"')},l=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){if(s.workerPath||hasUMDWorker()){try{s.workerPath?(logger.log(`loading Web Worker ${s.workerPath} for "${t}"`),this.workerContext=loadWorker(s.workerPath)):(logger.log(`injecting Web Worker for "${t}"`),this.workerContext=injectWorker()),this.onwmsg=e=>this.onWorkerMessage(e);const{worker:e}=this.workerContext;e.addEventListener("message",this.onwmsg),e.onerror=e=>{const i=new Error(`${e.message}  (${e.filename}:${e.lineno})`);s.enableWorker=!1,logger.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:i})},e.postMessage({cmd:"init",typeSupported:o,vendor:l,id:t,config:JSON.stringify(s)})}catch(err){logger.warn(`Error setting up "${t}" Web Worker, fallback to inline`,err),this.resetWorker(),this.error=null,this.transmuxer=new Transmuxer(this.observer,o,s,l,t)}return}}this.transmuxer=new Transmuxer(this.observer,o,s,l,t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,i,r,s,a,n,o,l,c){var u,d;l.transmuxing.start=self.performance.now();const{transmuxer:h}=this,m=a?a.start:s.start,f=s.decryptdata,g=this.frag,p=!(g&&s.cc===g.cc),v=!(g&&l.level===g.level),y=g?l.sn-g.sn:-1,E=this.part?l.part-this.part.index:-1,T=0===y&&l.id>1&&l.id===(null==g?void 0:g.stats.chunkCount),S=!v&&(1===y||0===y&&(1===E||T&&E<=0)),_=self.performance.now();(v||y||0===s.stats.parsing.start)&&(s.stats.parsing.start=_),!a||!E&&S||(a.stats.parsing.start=_);const k=!(g&&(null==(u=s.initSegment)?void 0:u.url)===(null==(d=g.initSegment)?void 0:d.url)),b=new TransmuxState(p,S,o,v,m,k);if(!S||p||k){logger.log(`[transmuxer-interface, ${s.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${p}\n        trackSwitch: ${v}\n        contiguous: ${S}\n        accurateTimeOffset: ${o}\n        timeOffset: ${m}\n        initSegmentChange: ${k}`);const e=new TransmuxConfig(i,r,t,n,c);this.configureTransmuxer(e)}if(this.frag=s,this.part=a,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:f,chunkMeta:l,state:b},e instanceof ArrayBuffer?[e]:[]);else if(h){const t=h.push(e,f,l,b);isPromise(t)?(h.async=!0,t.then((e=>{this.handleTransmuxComplete(e)})).catch((e=>{this.transmuxerError(e,l,"transmuxer-interface push error")}))):(h.async=!1,this.handleTransmuxComplete(t))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let i=t.flush(e);isPromise(i)||t.async?(isPromise(i)||(i=Promise.resolve(i)),i.then((t=>{this.handleFlushResult(t,e)})).catch((t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}))):this.handleFlushResult(i,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach((e=>{this.handleTransmuxComplete(e)})),this.onFlush(t)}onWorkerMessage(e){const t=e.data,i=this.hls;switch(t.event){case"init":{var r;const e=null==(r=this.workerContext)?void 0:r.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":logger[t.data.logType]&&logger[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data)}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}function subtitleOptionsIdentical(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!mediaAttributesIdentical(e[i].attrs,t[i].attrs))return!1;return!0}function mediaAttributesIdentical(e,t,i){const r=e["STABLE-RENDITION-ID"];return r&&!i?r===t["STABLE-RENDITION-ID"]:!(i||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((i=>e[i]!==t[i]))}function subtitleTrackMatchesTextTrack(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}const TICK_INTERVAL$2=100;class AudioStreamController extends BaseStreamController{constructor(e,t,i){super(e,t,i,"[audio-stream-controller]",PlaylistLevelType.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(Events.ERROR,this.onError,this),e.on(Events.BUFFER_RESET,this.onBufferReset,this),e.on(Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Events.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(Events.ERROR,this.onError,this),e.off(Events.BUFFER_RESET,this.onBufferReset,this),e.off(Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(Events.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:i,initPTS:r,timescale:s}){if("main"===i){const e=t.cc;this.initPTS[t.cc]={baseTime:r,timescale:s},this.log(`InitPTS for cc: ${e} found from main: ${r}`),this.videoTrackCC=e,this.state===State.WAITING_INIT_PTS&&this.tick()}}startLoad(e){if(!this.levels)return this.startPosition=e,void(this.state=State.STOPPED);const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(TICK_INTERVAL$2),t>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=State.IDLE):(this.loadedmetadata=!1,this.state=State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case State.IDLE:this.doTickIdle();break;case State.WAITING_TRACK:{var e;const{levels:t,trackId:i}=this,r=null==t||null==(e=t[i])?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=State.WAITING_INIT_PTS}break}case State.FRAG_LOADING_WAITING_RETRY:{var t;const e=performance.now(),i=this.retryDate;if(!i||e>=i||null!=(t=this.media)&&t.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state=State.IDLE}break}case State.WAITING_INIT_PTS:{const e=this.waitingData;if(e){const{frag:t,part:i,cache:r,complete:s}=e;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=State.FRAG_LOADING;const e={frag:t,part:i,payload:r.flush(),networkDetails:null};this._handleFragmentLoadProgress(e),s&&super._handleFragmentLoadComplete(e)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${t.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const e=this.getLoadPosition(),i=BufferHelper.bufferInfo(this.mediaBuffer,e,this.config.maxBufferHole);fragmentWithinToleranceTest(i.end,this.config.maxFragLookUpTolerance,t)<0&&(this.log(`Waiting fragment cc (${t.cc}) @ ${t.start} cancelled because another fragment at ${i.end} is needed`),this.clearWaitingFragment())}}else this.state=State.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=State.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:i,trackId:r}=this,s=e.config;if(!i&&(this.startFragRequested||!s.startFragPrefetch)||null==t||!t[r])return;const a=t[r],n=a.details;if(!n||n.live&&this.levelLastLoaded!==a||this.waitForCdnTuneIn(n))return void(this.state=State.WAITING_TRACK);const o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,ElementaryStreamTypes.AUDIO,PlaylistLevelType.AUDIO));const l=this.getFwdBufferInfo(o,PlaylistLevelType.AUDIO);if(null===l)return;const{bufferedTrack:c,switchingTrack:u}=this;if(!u&&this._streamEnded(l,n))return e.trigger(Events.BUFFER_EOS,{type:"audio"}),void(this.state=State.ENDED);const d=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,PlaylistLevelType.MAIN),h=l.len,m=this.getMaxBufferLength(null==d?void 0:d.len),f=n.fragments,g=f[0].start;let p=this.flushing?this.getLoadPosition():l.end;if(u&&i){const e=this.getLoadPosition();c&&!mediaAttributesIdentical(u.attrs,c.attrs)&&(p=e),n.PTSKnown&&e<g&&(l.end>g||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=g+.05)}if(h>=m&&!u&&p<f[f.length-1].start)return;let v=this.getNextFragment(p,n),y=!1;if(v&&this.isLoopLoading(v,p)&&(y=!!v.gap,v=this.getNextFragmentLoopLoading(v,n,l,PlaylistLevelType.MAIN,m)),!v)return void(this.bufferFlushed=!0);const E=d&&v.start>d.end+n.targetduration;if(E||(null==d||!d.len)&&l.len){const e=this.getAppendedFrag(v.start,PlaylistLevelType.MAIN);if(null===e)return;if(y||(y=!!e.gap||!!E&&0===d.len),E&&!y||y&&l.nextStart&&l.nextStart<e.end)return}this.loadFragment(v,a,p)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map((e=>new Level(e)))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),i?this.setInterval(TICK_INTERVAL$2):this.resetTransmuxer(),i?(this.switchingTrack=t,this.state=State.IDLE,this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state=State.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var i;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=t);const{levels:r}=this,{details:s,id:a}=t;if(!r)return void this.warn(`Audio tracks were reset while loading level ${a}`);this.log(`Audio track ${a} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const n=r[a];let o=0;if(s.live||null!=(i=n.details)&&i.live){this.checkLiveUpdate(s);const e=this.mainDetails;if(s.deltaUpdateFailed||!e)return;var l;if(!n.details&&s.hasProgramDateTime&&e.hasProgramDateTime)alignMediaPlaylistByPDT(s,e),o=s.fragments[0].start;else o=this.alignPlaylists(s,n.details,null==(l=this.levelLastLoaded)?void 0:l.details)}n.details=s,this.levelLastLoaded=n,this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(this.mainDetails||s,o),this.state!==State.WAITING_TRACK||this.waitForCdnTuneIn(s)||(this.state=State.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:r,payload:s}=e,{config:a,trackId:n,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const l=o[n];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const c=l.details;if(!c)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(i.start);const u=a.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new TransmuxerInterface(this.hls,PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const h=this.initPTS[i.cc],m=null==(t=i.initSegment)?void 0:t.data;if(void 0!==h){const e=!1,t=r?r.index:-1,a=-1!==t,n=new ChunkMetadata(i.level,i.sn,i.stats.chunkCount,s.byteLength,t,a);d.push(s,m,u,"",i,r,c.totalduration,e,n,h)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${c.startSN} ,${c.endSN}],track ${n}`);const{cache:e}=this.waitingData=this.waitingData||{frag:i,part:r,cache:new ChunkCache,complete:!1};e.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=State.WAITING_INIT_PTS}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:i,part:r}=t;if(i.type===PlaylistLevelType.AUDIO)if(this.fragContextChanged(i))this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==i.sn){this.fragPrevious=i;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(Events.AUDIO_TRACK_SWITCHED,_objectSpread2({},e)))}this.fragBufferedComplete(i,r)}else if(!this.loadedmetadata&&i.type===PlaylistLevelType.MAIN){const e=this.videoBuffer||this.media;if(e){BufferHelper.getBuffered(e).length&&(this.loadedmetadata=!0)}}}onError(e,t){var i;if(t.fatal)this.state=State.ERROR;else switch(t.details){case ErrorDetails.FRAG_GAP:case ErrorDetails.FRAG_PARSING_ERROR:case ErrorDetails.FRAG_DECRYPT_ERROR:case ErrorDetails.FRAG_LOAD_ERROR:case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_ERROR:case ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(PlaylistLevelType.AUDIO,t);break;case ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case ErrorDetails.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==State.WAITING_TRACK||(null==(i=t.context)?void 0:i.type)!==PlaylistContextType.AUDIO_TRACK||(this.state=State.IDLE);break;case ErrorDetails.BUFFER_APPEND_ERROR:case ErrorDetails.BUFFER_FULL_ERROR:if(!t.parent||"audio"!==t.parent)return;if(t.details===ErrorDetails.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case ErrorDetails.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){t!==ElementaryStreamTypes.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==ElementaryStreamTypes.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===State.ENDED&&(this.state=State.IDLE);const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,PlaylistLevelType.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:r}=this,{remuxResult:s,chunkMeta:a}=e,n=this.getCurrentContext(a);if(!n)return void this.resetWhenMissingContext(a);const{frag:o,part:l,level:c}=n,{details:u}=c,{audio:d,text:h,id3:m,initSegment:f}=s;if(!this.fragContextChanged(o)&&u){if(this.state=State.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),null!=f&&f.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,f.tracks,e,a),r.trigger(Events.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:i,tracks:f.tracks})}if(d){const{startPTS:e,endPTS:t,startDTS:i,endDTS:r}=d;l&&(l.elementaryStreams[ElementaryStreamTypes.AUDIO]={startPTS:e,endPTS:t,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(ElementaryStreamTypes.AUDIO,e,t,i,r),this.bufferFragmentData(d,o,l,a)}if(null!=m&&null!=(t=m.samples)&&t.length){const e=_extends({id:i,frag:o,details:u},m);r.trigger(Events.FRAG_PARSING_METADATA,e)}if(h){const e=_extends({id:i,frag:o,details:u},h);r.trigger(Events.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,i,r){if(this.state!==State.PARSING)return;t.video&&delete t.video;const s=t.audio;if(!s)return;s.id="audio";const a=e.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${a}/${s.codec}]`),a&&1===a.split(",").length&&(s.levelCodec=a),this.hls.trigger(Events.BUFFER_CODECS,t);const n=s.initSegment;if(null!=n&&n.byteLength){const e={type:"audio",frag:i,part:null,chunkMeta:r,parent:i.type,data:n};this.hls.trigger(Events.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,i){const r=this.fragmentTracker.getState(e);var s;if(this.fragCurrent=e,this.switchingTrack||r===FragmentState.NOT_LOADED||r===FragmentState.PARTIAL)if("initSegment"===e.sn)this._loadInitSegment(e,t);else if(null!=(s=t.details)&&s.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=State.WAITING_INIT_PTS;const i=this.mainDetails;i&&i.fragments[0].start!==t.details.fragments[0].start&&alignMediaPlaylistByPDT(t.details,i)}else this.startFragRequested=!0,super.loadFragment(e,t,i);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){const{media:t,bufferedTrack:i}=this,r=null==i?void 0:i.attrs,s=e.attrs;t&&r&&(r.CHANNELS!==s.CHANNELS||i.name!==e.name||i.lang!==e.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(Events.AUDIO_TRACK_SWITCHED,_objectSpread2({},e))}}class AudioTrackController extends BasePlaylistController{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(Events.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(Events.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:r,details:s}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==r)return void this.warn(`Audio track with id:${i} and group:${r} not found in active group ${null==a?void 0:a.groupId}`);const n=a.details;a.details=t.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,n)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,r=this.groupIds;let s=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some((e=>-1===(null==r?void 0:r.indexOf(e))))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter((e=>!i||-1!==i.indexOf(e.groupId)));if(e.length)this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),e.forEach(((e,t)=>{e.id=t}));else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!s&&t){const i=findMatchingOption(t,e,audioMatchPredicate);if(i>-1)s=e[i];else{const e=findMatchingOption(t,this.tracks);s=this.tracks[e]}}let r=this.findTrackId(s);-1===r&&s&&(r=this.findTrackId(null));const n={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==i?void 0:i.join(",")}`),this.hls.trigger(Events.AUDIO_TRACKS_UPDATED,n);const o=this.trackId;if(-1!==r&&-1===o)this.setAudioTrack(r);else if(e.length&&-1===o){var a;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(a=this.groupIds)?void 0:a.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}else this.shouldReloadPlaylist(s)&&this.setAudioTrack(this.trackId)}onError(e,t){!t.fatal&&t.context&&(t.context.type!==PlaylistContextType.AUDIO_TRACK||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||(this.requestScheduled=-1,this.checkRetry(t)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const r=this.currentTrack;if(r&&matchesOption(e,r,audioMatchPredicate))return r;const s=findMatchingOption(e,this.tracksInGroup,audioMatchPredicate);if(s>-1){const e=this.tracksInGroup[s];return this.setAudioTrack(s),e}if(r){let r=t.loadLevel;-1===r&&(r=t.firstAutoLevel);const s=findClosestLevelWithAudioGroup(e,t.levels,i,r,audioMatchPredicate);if(-1===s)return null;t.nextLoadLevel=s}if(e.channels||e.audioCodec){const t=findMatchingOption(e,i);if(t>-1)return i[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn(`Invalid audio track id: ${e}`);this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,r=t[e],s=r.details&&!r.details.live;if(e===this.trackId&&r===i&&s)return;if(this.log(`Switching to audio-track ${e} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=e,this.currentTrack=r,this.hls.trigger(Events.AUDIO_TRACK_SWITCHING,_objectSpread2({},r)),s)return;const a=this.switchParams(r.url,null==i?void 0:i.details);this.loadPlaylist(a)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const r=t[i];if((!this.selectDefaultTrack||r.default)&&(!e||matchesOption(e,r,audioMatchPredicate)))return i}if(e){const{name:i,lang:r,assocLang:s,characteristics:a,audioCodec:n,channels:o}=e;for(let e=0;e<t.length;e++){if(matchesOption({name:i,lang:r,assocLang:s,characteristics:a,audioCodec:n,channels:o},t[e],audioMatchPredicate))return e}for(let l=0;l<t.length;l++){const i=t[l];if(mediaAttributesIdentical(e.attrs,i.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){const i=t[l];if(mediaAttributesIdentical(e.attrs,i.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const r=t.id,s=t.groupId;let a=t.url;if(e)try{a=e.addDirectives(a)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}this.log(`loading audio-track playlist ${r} "${t.name}" lang:${t.lang} group:${s}`),this.clearTimer(),this.hls.trigger(Events.AUDIO_TRACK_LOADING,{url:a,id:r,groupId:s,deliveryDirectives:e||null})}}}const TICK_INTERVAL$1=500;class SubtitleStreamController extends BaseStreamController{constructor(e,t,i){super(e,t,i,"[subtitle-stream-controller]",PlaylistLevelType.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Events.ERROR,this.onError,this),e.on(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Events.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Events.ERROR,this.onError,this),e.off(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Events.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=State.IDLE,this.setInterval(TICK_INTERVAL$1),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:r}=t;if(this.fragPrevious=i,this.state=State.IDLE,!r)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let a;const n=i.start;for(let l=0;l<s.length;l++)if(n>=s[l].start&&n<=s[l].end){a=s[l];break}const o=i.start+i.duration;a?a.end=o:(a={start:n,end:o},s.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(e,t){const{startOffset:i,endOffset:r}=t;if(0===i&&r!==Number.POSITIVE_INFINITY){const e=r-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach((t=>{for(let i=0;i<t.length;)if(t[i].end<=e)t.shift();else{if(!(t[i].start<e))break;t[i].start=e,i++}})),this.fragmentTracker.removeFragmentsInRange(i,e,PlaylistLevelType.SUBTITLE)}}onFragBuffered(e,t){var i;this.loadedmetadata||t.frag.type!==PlaylistLevelType.MAIN||null!=(i=this.media)&&i.buffered.length&&(this.loadedmetadata=!0)}onError(e,t){const i=t.frag;(null==i?void 0:i.type)===PlaylistLevelType.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==State.STOPPED&&(this.state=State.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&subtitleOptionsIdentical(this.levels,t)?this.levels=t.map((e=>new Level(e))):(this.tracksBuffered=[],this.levels=t.map((e=>{const t=new Level(e);return this.tracksBuffered[t.id]=[],t})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,PlaylistLevelType.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,null==(i=this.levels)||!i.length||-1===this.currentTrackId)return void this.clearInterval();const r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.setInterval(TICK_INTERVAL$1)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:r,levels:s}=this,{details:a,id:n}=t;if(!s)return void this.warn(`Subtitle tracks were reset while loading level ${n}`);const o=s[r];if(n>=s.length||n!==r||!o)return;this.log(`Subtitle track ${n} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(a.live||null!=(i=o.details)&&i.live){const e=this.mainDetails;if(a.deltaUpdateFailed||!e)return;const t=e.fragments[0];var c;if(o.details)l=this.alignPlaylists(a,o.details,null==(c=this.levelLastLoaded)?void 0:c.details),0===l&&t&&(l=t.start,addSliding(a,l));else a.hasProgramDateTime&&e.hasProgramDateTime?(alignMediaPlaylistByPDT(a,e),l=a.fragments[0].start):t&&(l=t.start,addSliding(a,l))}if(o.details=a,this.levelLastLoaded=o,this.startFragRequested||!this.mainDetails&&a.live||this.setStartPosition(this.mainDetails||a,l),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===State.IDLE){findFragmentByPTS(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,r=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&null!=r&&r.key&&r.iv&&"AES-128"===r.method){const e=performance.now();this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer).catch((e=>{throw s.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e})).then((i=>{const r=performance.now();s.trigger(Events.FRAG_DECRYPTED,{frag:t,payload:i,stats:{tstart:e,tdecrypt:r}})})).catch((e=>{this.warn(`${e.name}: ${e.message}`),this.state=State.IDLE}))}}doTick(){if(this.media){if(this.state===State.IDLE){const{currentTrackId:e,levels:t}=this,i=null==t?void 0:t[e];if(!i||!t.length||!i.details)return;const{config:r}=this,s=this.getLoadPosition(),a=BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,r.maxBufferHole),{end:n,len:o}=a,l=this.getFwdBufferInfo(this.media,PlaylistLevelType.MAIN),c=i.details;if(o>this.getMaxBufferLength(null==l?void 0:l.len)+c.levelTargetDuration)return;const u=c.fragments,d=u.length,h=c.edge;let m=null;const f=this.fragPrevious;if(n<h){const e=r.maxFragLookUpTolerance,t=n>h-e?0:e;m=findFragmentByPTS(f,u,Math.max(u[0].start,n),t),!m&&f&&f.start<u[0].start&&(m=u[0])}else m=u[d-1];if(!m)return;if(m=this.mapToInitFragWhenRequired(m),"initSegment"!==m.sn){const e=u[m.sn-c.startSN-1];e&&e.cc===m.cc&&this.fragmentTracker.getState(e)===FragmentState.NOT_LOADED&&(m=e)}this.fragmentTracker.getState(m)===FragmentState.NOT_LOADED&&this.loadFragment(m,i,n)}}else this.state=State.IDLE}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,i){this.fragCurrent=e,"initSegment"===e.sn?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,i))}get mediaBufferTimeRanges(){return new BufferableInstance(this.tracksBuffered[this.currentTrackId]||[])}}class BufferableInstance{constructor(e){this.buffered=void 0;const t=(t,i,r)=>{if((i>>>=0)>r-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${r})`);return e[i][t]};this.buffered={get length(){return e.length},end:i=>t("end",i,e.length),start:i=>t("start",i,e.length)}}}class SubtitleTrackController extends BasePlaylistController{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=filterSubtitleTracks(this.media.textTracks);for(let r=0;r<t.length;r++)if("hidden"===t[r].mode)e=t[r];else if("showing"===t[r].mode){e=t[r];break}const i=this.findTrackForTextTrack(e);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(Events.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(Events.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);filterSubtitleTracks(this.media.textTracks).forEach((e=>{clearCurrentCues(e)})),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:r,details:s}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==r)return void this.warn(`Subtitle track with id:${i} and group:${r} not found in active group ${null==a?void 0:a.groupId}`);const n=a.details;a.details=t.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,n)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,r=this.groupIds;let s=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some((e=>-1===(null==r?void 0:r.indexOf(e))))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter((e=>!i||-1!==i.indexOf(e.groupId)));if(e.length)this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),e.forEach(((e,t)=>{e.id=t}));else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!s&&t){this.selectDefaultTrack=!1;const i=findMatchingOption(t,e);if(i>-1)s=e[i];else{const e=findMatchingOption(t,this.tracks);s=this.tracks[e]}}let r=this.findTrackId(s);-1===r&&s&&(r=this.findTrackId(null));const a={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==i?void 0:i.join(",")}" group-id`),this.hls.trigger(Events.SUBTITLE_TRACKS_UPDATED,a),-1!==r&&-1===this.trackId&&this.setSubtitleTrack(r)}else this.shouldReloadPlaylist(s)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let r=0;r<t.length;r++){const s=t[r];if((!i||s.default)&&(i||e)&&(!e||matchesOption(s,e)))return r}if(e){for(let i=0;i<t.length;i++){const r=t[i];if(mediaAttributesIdentical(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const r=t[i];if(mediaAttributesIdentical(e.attrs,r.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){if(subtitleTrackMatchesTextTrack(t[i],e))return i}}return-1}onError(e,t){!t.fatal&&t.context&&(t.context.type!==PlaylistContextType.SUBTITLE_TRACK||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&matchesOption(e,i))return i;const r=findMatchingOption(e,this.tracksInGroup);if(r>-1){const e=this.tracksInGroup[r];return this.setSubtitleTrack(r),e}if(i)return null;{const i=findMatchingOption(e,t);if(i>-1)return t[i]}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const r=t.id,s=t.groupId;let a=t.url;if(e)try{a=e.addDirectives(a)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}this.log(`Loading subtitle playlist for id ${r}`),this.hls.trigger(Events.SUBTITLE_TRACK_LOADING,{url:a,id:r,groupId:s,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=filterSubtitleTracks(e.textTracks),i=this.currentTrack;let r;if(i&&(r=t.filter((e=>subtitleTrackMatchesTextTrack(i,e)))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach((e=>{"disabled"!==e.mode&&e!==r&&(e.mode="disabled")})),r){const e=this.subtitleDisplay?"showing":"hidden";r.mode!==e&&(r.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!isFiniteNumber(e))return void this.warn(`Invalid subtitle track id: ${e}`);this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,r=t[e]||null;if(this.trackId=e,this.currentTrack=r,this.toggleTrackModes(),!r)return void this.hls.trigger(Events.SUBTITLE_TRACK_SWITCH,{id:e});const s=!!r.details&&!r.details.live;if(e===this.trackId&&r===i&&s)return;this.log(`Switching to subtitle-track ${e}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:""));const{id:a,groupId:n="",name:o,type:l,url:c}=r;this.hls.trigger(Events.SUBTITLE_TRACK_SWITCH,{id:a,groupId:n,name:o,type:l,url:c});const u=this.switchParams(r.url,null==i?void 0:i.details);this.loadPlaylist(u)}}class BufferOperationQueue{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t,i){const r=this.queues[t];r.push(e),1!==r.length||i||this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise((e=>{t=e})),r={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,e),i}executeNext(e){const t=this.queues[e];if(t.length){const r=t[0];try{r.execute()}catch(i){logger.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${i}`),r.onError(i);const t=this.buffers[e];null!=t&&t.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const VIDEO_CODEC_PROFILE_REPLACE=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class BufferController{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=e=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:e,mediaSource:t}=this;this.log("Media source opened"),e&&(e.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(Events.MEDIA_ATTACHED,{media:e,mediaSource:t})),t&&t.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&logger.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e;const t="[buffer-controller]";this.appendSource=e.config.preferManagedMediaSource&&"undefined"!=typeof self&&self.ManagedMediaSource,this.log=logger.log.bind(logger,t),this.warn=logger.warn.bind(logger,t),this.error=logger.error.bind(logger,t),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Events.BUFFER_RESET,this.onBufferReset,this),e.on(Events.BUFFER_APPENDING,this.onBufferAppending,this),e.on(Events.BUFFER_CODECS,this.onBufferCodecs,this),e.on(Events.BUFFER_EOS,this.onBufferEos,this),e.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(Events.FRAG_PARSED,this.onFragParsed,this),e.on(Events.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Events.BUFFER_RESET,this.onBufferReset,this),e.off(Events.BUFFER_APPENDING,this.onBufferAppending,this),e.off(Events.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Events.BUFFER_EOS,this.onBufferEos,this),e.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(Events.FRAG_PARSED,this.onFragParsed,this),e.off(Events.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new BufferOperationQueue(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media,r=getMediaSource(this.appendSource);if(i&&r){var s;const e=this.mediaSource=new r;this.log(`created media source: ${null==(s=e.constructor)?void 0:s.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming));const t=this._objectUrl=self.URL.createObjectURL(e);if(this.appendSource)try{i.removeAttribute("src");const r=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||r&&e instanceof r,removeSourceChildren(i),addSource(i,t),i.load()}catch(a){i.src=t}else i.src=t;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(this.log("media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(err){this.warn(`onMediaDetaching: ${err.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming)),e&&(e.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(e.removeAttribute("src"),this.appendSource&&removeSourceChildren(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(Events.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((e=>{this.resetBuffer(e)})),this._initSourceBuffer()}resetBuffer(e){const t=this.sourceBuffer[e];try{var i;if(t)this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,null!=(i=this.mediaSource)&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}catch(err){this.warn(`onBufferReset ${e}`,err)}}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length,r=Object.keys(t);if(r.forEach((e=>{if(i){const i=this.tracks[e];if(i&&"function"==typeof i.buffer.changeType){var r;const{id:s,codec:a,levelCodec:n,container:o,metadata:l}=t[e],c=pickMostCompleteCodecName(i.codec,i.levelCodec),u=null==c?void 0:c.replace(VIDEO_CODEC_PROFILE_REPLACE,"$1");let d=pickMostCompleteCodecName(a,n);const h=null==(r=d)?void 0:r.replace(VIDEO_CODEC_PROFILE_REPLACE,"$1");if(d&&u!==h){"audio"===e.slice(0,5)&&(d=getCodecCompatibleName(d,this.appendSource));const t=`${o};codecs=${d}`;this.appendChangeType(e,t),this.log(`switching codec ${c} to ${d}`),this.tracks[e]={buffer:i.buffer,codec:a,container:o,levelCodec:n,metadata:l,id:s}}}}else this.pendingTracks[e]=t[e]})),i)return;const s=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==s&&(this.log(`${s} bufferCodec event(s) expected ${r.join(",")}`),this.bufferCodecEventsExpected=s),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:i}=this,r={execute:()=>{const r=this.sourceBuffer[e];r&&(this.log(`changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};i.append(r,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:i,operationQueue:r,tracks:s}=this,{data:a,type:n,frag:o,part:l,chunkMeta:c}=t,u=c.buffering[n],d=self.performance.now();u.start=d;const h=o.stats.buffering,m=l?l.stats.buffering:null;0===h.start&&(h.start=d),m&&0===m.start&&(m.start=d);const f=s.audio;let g=!1;"audio"===n&&"audio/mpeg"===(null==f?void 0:f.container)&&(g=!this.lastMpegAudioChunk||1===c.id||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const p=o.start,v={execute:()=>{if(u.executeStart=self.performance.now(),g){const e=this.sourceBuffer[n];if(e){const t=p-e.timestampOffset;Math.abs(t)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${p} (delta: ${t}) sn: ${o.sn})`),e.timestampOffset=p)}}this.appendExecutor(a,n)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();u.executeEnd=u.end=e,0===h.first&&(h.first=e),m&&0===m.first&&(m.first=e);const{sourceBuffer:t}=this,i={};for(const r in t)i[r]=BufferHelper.getBuffered(t[r]);this.appendErrors[n]=0,"audio"===n||"video"===n?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(Events.BUFFER_APPENDED,{type:n,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:i})},onError:e=>{const t={type:ErrorTypes.MEDIA_ERROR,parent:o.type,details:ErrorDetails.BUFFER_APPEND_ERROR,sourceBufferName:n,frag:o,part:l,chunkMeta:c,error:e,err:e,fatal:!1};if(e.code===DOMException.QUOTA_EXCEEDED_ERR)t.details=ErrorDetails.BUFFER_FULL_ERROR;else{const e=++this.appendErrors[n];t.details=ErrorDetails.BUFFER_APPEND_ERROR,this.warn(`Failed ${e}/${i.config.appendErrorMaxRetry} times to append segment in "${n}" sourceBuffer`),e>=i.config.appendErrorMaxRetry&&(t.fatal=!0)}i.trigger(Events.ERROR,t)}};r.append(v,n,!!this.pendingTracks[n])}onBufferFlushing(e,t){const{operationQueue:i}=this,r=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(Events.BUFFER_FLUSHED,{type:e})},onError:t=>{this.warn(`Failed to remove from ${e} SourceBuffer`,t)}});t.type?i.append(r(t.type),t.type):this.getSourceBufferTypes().forEach((e=>{i.append(r(e),e)}))}onFragParsed(e,t){const{frag:i,part:r}=t,s=[],a=r?r.elementaryStreams:i.elementaryStreams;a[ElementaryStreamTypes.AUDIOVIDEO]?s.push("audiovideo"):(a[ElementaryStreamTypes.AUDIO]&&s.push("audio"),a[ElementaryStreamTypes.VIDEO]&&s.push("video"));0===s.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers((()=>{const e=self.performance.now();i.stats.buffering.end=e,r&&(r.stats.buffering.end=e);const t=r?r.stats:i.stats;this.hls.trigger(Events.FRAG_BUFFERED,{frag:i,part:r,stats:t,id:i.type})}),s)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce(((e,i)=>{const r=this.sourceBuffer[i];return!r||t.type&&t.type!==i||(r.ending=!0,r.ended||(r.ended=!0,this.log(`${i} sourceBuffer now EOS`))),e&&!(r&&!r.ended)}),!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((e=>{const t=this.sourceBuffer[e];t&&(t.ending=!1)}));const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream()):e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||null===t)return;if(!this.getSourceBufferTypes().length)return;const r=e.config,s=i.currentTime,a=t.levelTargetDuration,n=t.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(isFiniteNumber(n)&&n>0){const e=Math.max(n,a),t=Math.floor(s/a)*a-e;this.flushBackBuffer(s,a,t)}if(isFiniteNumber(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const e=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),t=Math.max(e,a),i=Math.floor(s/a)*a+t;this.flushFrontBuffer(s,a,i)}}flushBackBuffer(e,t,i){const{details:r,sourceBuffer:s}=this;this.getSourceBufferTypes().forEach((a=>{const n=s[a];if(n){const s=BufferHelper.getBuffered(n);if(s.length>0&&i>s.start(0)){if(this.hls.trigger(Events.BACK_BUFFER_REACHED,{bufferEnd:i}),null!=r&&r.live)this.hls.trigger(Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(n.ended&&s.end(s.length-1)-e<2*t)return void this.log(`Cannot flush ${a} back buffer while SourceBuffer is in ended state`);this.hls.trigger(Events.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:a})}}}))}flushFrontBuffer(e,t,i){const{sourceBuffer:r}=this;this.getSourceBufferTypes().forEach((s=>{const a=r[s];if(a){const r=BufferHelper.getBuffered(a),n=r.length;if(n<2)return;const o=r.start(n-1),l=r.end(n-1);if(i>o||e>=o&&e<=l)return;if(a.ended&&e-l<2*t)return void this.log(`Cannot flush ${s} front buffer while SourceBuffer is in ended state`);this.hls.trigger(Events.BUFFER_FLUSHING,{startOffset:o,endOffset:1/0,type:s})}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:e,hls:t,media:i,mediaSource:r}=this,s=e.fragments[0].start+e.totalduration,a=i.duration,n=isFiniteNumber(r.duration)?r.duration:0;e.live&&t.config.liveDurationInfinity?(r.duration=1/0,this.updateSeekableRange(e)):(s>n&&s>a||!isFiniteNumber(a))&&(this.log(`Updating Media Source duration to ${s.toFixed(3)}`),r.duration=s)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&null!=t&&t.setLiveSeekableRange){const r=Math.max(0,i[0].start),s=Math.max(r,r+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${r}-${s}.`),t.setLiveSeekableRange(r,s)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,r=Object.keys(i).length;if(r&&(!e||2===r||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const e=this.getSourceBufferTypes();if(e.length)this.hls.trigger(Events.BUFFER_CREATED,{tracks:this.tracks}),e.forEach((e=>{t.executeNext(e)}));else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const r in e)if(!t[r]){const s=e[r];if(!s)throw Error(`source buffer exists for track ${r}, however track does not`);let a=s.levelCodec||s.codec;a&&"audio"===r.slice(0,5)&&(a=getCodecCompatibleName(a,this.appendSource));const n=`${s.container};codecs=${a}`;this.log(`creating sourceBuffer(${n})`);try{const e=t[r]=i.addSourceBuffer(n),o=r;this.addBufferListener(o,"updatestart",this._onSBUpdateStart),this.addBufferListener(o,"updateend",this._onSBUpdateEnd),this.addBufferListener(o,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(o,"bufferedchange",((e,t)=>{const i=t.removedRanges;null!=i&&i.length&&this.hls.trigger(Events.BUFFER_FLUSHED,{type:r})})),this.tracks[r]={buffer:e,codec:a,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(err){this.error(`error while trying to add sourceBuffer: ${err.message}`),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:err,sourceBufferName:r,mimeType:n})}}}get mediaSrc(){var e;const t=(null==(e=this.media)?void 0:e.firstChild)||this.media;return null==t?void 0:t.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const{operationQueue:i}=this;i.current(e).onComplete(),i.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var i;const r=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(i=this.mediaSource)?void 0:i.readyState}`);this.error(`${r}`,t),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:r,fatal:!1});const s=this.operationQueue.current(e);s&&s.onError(r)}removeExecutor(e,t,i){const{media:r,mediaSource:s,operationQueue:a,sourceBuffer:n}=this,o=n[e];if(!r||!s||!o)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void a.shiftAndExecuteNext(e);const l=isFiniteNumber(r.duration)?r.duration:1/0,c=isFiniteNumber(s.duration)?s.duration:1/0,u=Math.max(0,t),d=Math.min(i,l,c);d>u&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${u},${d}] from the ${e} SourceBuffer`),o.remove(u,d)):a.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.sourceBuffer[t];if(i)i.ended=!1,i.appendBuffer(e);else if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);const{operationQueue:i}=this,r=t.map((e=>i.appendBlocker(e)));Promise.all(r).then((()=>{e(),t.forEach((e=>{const t=this.sourceBuffer[e];null!=t&&t.updating||i.shiftAndExecuteNext(e)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const r=this.sourceBuffer[e];if(!r)return;const s=i.bind(this,e);this.listeners[e].push({event:t,listener:s}),r.addEventListener(t,s)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach((e=>{t.removeEventListener(e.event,e.listener)}))}}function removeSourceChildren(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach((t=>{e.removeChild(t)}))}function addSource(e,t){const i=self.document.createElement("source");i.type="video/mp4",i.src=t,e.appendChild(i)}const specialCea608CharsCodes={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},getCharForByte=function(e){let t=e;return specialCea608CharsCodes.hasOwnProperty(e)&&(t=specialCea608CharsCodes[e]),String.fromCharCode(t)},NR_ROWS=15,NR_COLS=100,rowsLowCh1={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},rowsHighCh1={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rowsLowCh2={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},rowsHighCh2={25:2,26:4,29:6,30:8,31:10,27:13,28:15},backgroundColors=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class CaptionsLogger{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i="function"==typeof t?t():t;logger.log(`${this.time} [${e}] ${i}`)}}}const numArrayToHexArray=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class PenState{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const r=t[i];e.hasOwnProperty(r)&&(this[r]=e[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class StyledUnicodeChar{constructor(){this.uchar=" ",this.penState=new PenState}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Row{constructor(e){this.chars=[],this.pos=0,this.currPenState=new PenState,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<NR_COLS;t++)this.chars.push(new StyledUnicodeChar);this.logger=e}equals(e){for(let t=0;t<NR_COLS;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<NR_COLS;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<NR_COLS;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>NR_COLS&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=NR_COLS)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=getCharForByte(e);this.pos>=NR_COLS?this.logger.log(0,(()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<NR_COLS;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<NR_COLS;i++){const r=this.chars[i].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e);this.chars[this.pos].setPenState(this.currPenState)}}class CaptionScreen{constructor(e){this.rows=[],this.currRow=NR_ROWS-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<NR_ROWS;t++)this.rows.push(new Row(e));this.logger=e}reset(){for(let e=0;e<NR_ROWS;e++)this.rows[e].clear();this.currRow=NR_ROWS-1}equals(e){let t=!0;for(let i=0;i<NR_ROWS;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<NR_ROWS;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<NR_ROWS;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e);this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,(()=>"pacData = "+JSON.stringify(e)));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let t=0;t<NR_ROWS;t++)this.rows[t].clear();const e=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const r=i.rows[e].cueStartTime,s=this.logger.time;if(null!==r&&null!==s&&r<s)for(let a=0;a<this.nrRollUpRows;a++)this.rows[t-this.nrRollUpRows+a+1].copy(i.rows[e+a])}}this.currRow=t;const i=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,r=Math.max(t-1,0);i.setCursor(e.indent),e.color=i.chars[r].penState.foreground}const r={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(e){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(e))),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",r=-1;for(let s=0;s<NR_ROWS;s++){const i=this.rows[s].getTextString();i&&(r=s+1,e?t.push("Row "+r+": '"+i+"'"):t.push(i.trim()))}return t.length>0&&(i=e?"["+t.join(" | ")+"]":t.join("\n")),i}getTextAndFormat(){return this.rows}}class Cea608Channel{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new CaptionScreen(i),this.nonDisplayedMemory=new CaptionScreen(i),this.lastOutputScreen=new CaptionScreen(i),this.currRollUpRow=this.displayedMemory.rows[NR_ROWS-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[NR_ROWS-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,(()=>"MODE="+e)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>t+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=r[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Cea608Parser{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=createCmdHistory(),this.logger=void 0;const r=this.logger=new CaptionsLogger;this.channels=[null,new Cea608Channel(e,t,r),new Cea608Channel(e+1,i,r)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,r,s,a=!1;this.logger.time=e;for(let n=0;n<t.length;n+=2)if(r=127&t[n],s=127&t[n+1],0!==r||0!==s){if(this.logger.log(3,"["+numArrayToHexArray([t[n],t[n+1]])+"] -> ("+numArrayToHexArray([r,s])+")"),i=this.parseCmd(r,s),i||(i=this.parseMidrow(r,s)),i||(i=this.parsePAC(r,s)),i||(i=this.parseBackgroundAttributes(r,s)),!i&&(a=this.parseChars(r,s),a)){const e=this.currentChannel;if(e&&e>0){this.channels[e].insertChars(a)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}i||a||this.logger.log(2,"Couldn't parse cleaned data "+numArrayToHexArray([r,s])+" orig: "+numArrayToHexArray([t[n],t[n+1]]))}}parseCmd(e,t){const{cmdHistory:i}=this;if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;if(hasCmdRepeated(e,t,i))return setLastCmd(null,null,i),this.logger.log(3,"Repeated command ("+numArrayToHexArray([e,t])+") is dropped"),!0;const r=20===e||21===e||23===e?1:2,s=this.channels[r];return 20===e||21===e||28===e||29===e?32===t?s.ccRCL():33===t?s.ccBS():34===t?s.ccAOF():35===t?s.ccAON():36===t?s.ccDER():37===t?s.ccRU(2):38===t?s.ccRU(3):39===t?s.ccRU(4):40===t?s.ccFON():41===t?s.ccRDC():42===t?s.ccTR():43===t?s.ccRTD():44===t?s.ccEDM():45===t?s.ccCR():46===t?s.ccENM():47===t&&s.ccEOC():s.ccTO(t-32),setLastCmd(e,t,i),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((17===e||25===e)&&t>=32&&t<=47){if(i=17===e?1:2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[i];return!!r&&(r.ccMIDROW(t),this.logger.log(3,"MIDROW ("+numArrayToHexArray([e,t])+")"),!0)}return!1}parsePAC(e,t){let i;const r=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;if(hasCmdRepeated(e,t,r))return setLastCmd(null,null,r),!0;const s=e<=23?1:2;i=t>=64&&t<=95?1===s?rowsLowCh1[e]:rowsLowCh2[e]:1===s?rowsHighCh1[e]:rowsHighCh2[e];const a=this.channels[s];return!!a&&(a.setPAC(this.interpretPAC(i,t)),setLastCmd(e,t,r),this.currentChannel=s,!0)}interpretPAC(e,t){let i;const r={color:null,italics:!1,indent:null,underline:!1,row:e};return i=t>95?t-96:t-64,r.underline=1==(1&i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(e,t){let i,r=null,s=null;if(e>=25?(i=2,s=e-8):(i=1,s=e),s>=17&&s<=19){let e;e=17===s?t+80:18===s?t+112:t+144,this.logger.log(2,"Special char '"+getCharForByte(e)+"' in channel "+i),r=[e]}else e>=32&&e<=127&&(r=0===t?[e]:[e,t]);if(r){const i=numArrayToHexArray(r);this.logger.log(3,"Char codes =  "+i.join(",")),setLastCmd(e,t,this.cmdHistory)}return r}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;let i;const r={};16===e||24===e?(i=Math.floor((t-32)/2),r.background=backgroundColors[i],t%2==1&&(r.background=r.background+"_semi")):45===t?r.background="transparent":(r.foreground="black",47===t&&(r.underline=!0));const s=e<=23?1:2;return this.channels[s].setBkgData(r),setLastCmd(e,t,this.cmdHistory),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}this.cmdHistory=createCmdHistory()}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function setLastCmd(e,t,i){i.a=e,i.b=t}function hasCmdRepeated(e,t,i){return i.a===e&&i.b===t}function createCmdHistory(){return{a:null,b:null}}class OutputFilter{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var VTTCue=function(){if(null!=optionalSelf&&optionalSelf.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function i(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const i=t.toLowerCase();return!!~e.indexOf(i)&&i}function r(e){return i(t,e)}function s(e,...t){let i=1;for(;i<arguments.length;i++){const t=arguments[i];for(const i in t)e[i]=t[i]}return e}function a(t,a,n){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let c="",u=!1,d=t,h=a,m=n,f=null,g="",p=!0,v="auto",y="start",E=50,T="middle",S=50,_="middle";Object.defineProperty(o,"id",s({},l,{get:function(){return c},set:function(e){c=""+e}})),Object.defineProperty(o,"pauseOnExit",s({},l,{get:function(){return u},set:function(e){u=!!e}})),Object.defineProperty(o,"startTime",s({},l,{get:function(){return d},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");d=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",s({},l,{get:function(){return h},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",s({},l,{get:function(){return m},set:function(e){m=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",s({},l,{get:function(){return f},set:function(e){f=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",s({},l,{get:function(){return g},set:function(t){const r=function(t){return i(e,t)}(t);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");g=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",s({},l,{get:function(){return p},set:function(e){p=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",s({},l,{get:function(){return v},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",s({},l,{get:function(){return y},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",s({},l,{get:function(){return E},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");E=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",s({},l,{get:function(){return T},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",s({},l,{get:function(){return S},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",s({},l,{get:function(){return _},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");_=t,this.hasBeenReset=!0}})),o.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class StringDecoder{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function parseTimeStamp(e){function t(e,t,i,r){return 3600*(0|e)+60*(0|t)+(0|i)+parseFloat(r||0)}const i=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?t(i[2],i[3],0,i[4]):t(i[1],i[2],i[3],i[4]):null}class Settings{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let r=0;r<i.length;++r)if(t===i[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function parseOptions(e,t,i,r){const s=r?e.split(r):[e];for(const a in s){if("string"!=typeof s[a])continue;const e=s[a].split(i);if(2!==e.length)continue;t(e[0],e[1])}}const defaults=new VTTCue(0,0,""),center="middle"===defaults.align?"middle":"center";function parseCue(e,t,i){const r=e;function s(){const t=parseTimeStamp(e);if(null===t)throw new Error("Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function a(){e=e.replace(/^\s+/,"")}if(a(),t.startTime=s(),a(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.slice(3),a(),t.endTime=s(),a(),function(e,t){const r=new Settings;parseOptions(e,(function(e,t){let s;switch(e){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===t){r.set(e,i[s].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":s=t.split(","),r.integer(e,s[0]),r.percent(e,s[0])&&r.set("snapToLines",!1),r.alt(e,s[0],["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start",center,"end"]);break;case"position":s=t.split(","),r.percent(e,s[0]),2===s.length&&r.alt("positionAlign",s[1],["start",center,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,t);break;case"align":r.alt(e,t,["start",center,"end","left","right"])}}),/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical","");let s=r.get("line","auto");"auto"===s&&-1===defaults.line&&(s=-1),t.line=s,t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100),t.align=r.get("align",center);let a=r.get("position","auto");"auto"===a&&50===defaults.position&&(a="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=a}(e,t)}function fixLineBreaks(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class VTTParser{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new StringDecoder,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function i(){let e=t.buffer,i=0;for(e=fixLineBreaks(e);i<e.length&&"\r"!==e[i]&&"\n"!==e[i];)++i;const r=e.slice(0,i);return"\r"===e[i]&&++i,"\n"===e[i]&&++i,t.buffer=e.slice(i),r}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=i();const r=e.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let r=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(r?r=!1:e=i(),t.state){case"HEADER":/:/.test(e)?parseOptions(e,(function(e,t){}),/:/):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new VTTCue(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{parseCue(e,t.cue,t.regionList)}catch(e2){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const i=-1!==e.indexOf("--\x3e");if(!e||i&&(r=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e2){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(e2){e.onparsingerror&&e.onparsingerror(e2)}return e.onflush&&e.onflush(),this}}const LINEBREAKS=/\r\n|\n\r|\n|\r/g,startsWith$1=function(e,t,i=0){return e.slice(i,i+t.length)===t},cueString2millis=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),r=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(isFiniteNumber(t)&&isFiniteNumber(i)&&isFiniteNumber(r)&&isFiniteNumber(s)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=6e4*r,t+=36e5*s,t},hash=function(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()};function generateCueId(e,t,i){return hash(e.toString())+hash(t.toString())+hash(i)}const calculateOffset=function(e,t,i){let r=e[t],s=e[r.prevCC];if(!s||!s.new&&r.new)return e.ccOffset=e.presentationOffset=r.start,void(r.new=!1);for(;null!=(a=s)&&a.new;){var a;e.ccOffset+=r.start-s.start,r.new=!1,r=s,s=e[r.prevCC]}e.presentationOffset=i};function parseWebVTT(e,t,i,r,s,a,n){const o=new VTTParser,l=utf8ArrayToStr(new Uint8Array(e)).trim().replace(LINEBREAKS,"\n").split("\n"),c=[],u=t?toMpegTsClockFromTimescale(t.baseTime,t.timescale):0;let d,h="00:00.000",m=0,f=0,g=!0;o.oncue=function(e){const a=i[r];let n=i.ccOffset;const o=(m-u)/9e4;if(null!=a&&a.new&&(void 0!==f?n=i.ccOffset=a.start:calculateOffset(i,r,o)),o){if(!t)return void(d=new Error("Missing initPTS for VTT MPEGTS"));n=o-i.presentationOffset}const l=e.endTime-e.startTime,h=normalizePts(9e4*(e.startTime+n-f),9e4*s)/9e4;e.startTime=Math.max(h,0),e.endTime=Math.max(h+l,0);const g=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(g)),e.id||(e.id=generateCueId(e.startTime,e.endTime,g)),e.endTime>0&&c.push(e)},o.onparsingerror=function(e){d=e},o.onflush=function(){d?n(d):a(c)},l.forEach((e=>{if(g){if(startsWith$1(e,"X-TIMESTAMP-MAP=")){g=!1,e.slice(16).split(",").forEach((e=>{startsWith$1(e,"LOCAL:")?h=e.slice(6):startsWith$1(e,"MPEGTS:")&&(m=parseInt(e.slice(7)))}));try{f=cueString2millis(h)/1e3}catch(t){d=t}return}""===e&&(g=!1)}o.parse(e+"\n")})),o.flush()}const IMSC1_CODEC="stpp.ttml.im1t",HMSF_REGEX=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,TIME_UNIT_REGEX=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,textAlignToLineAlign={left:"start",center:"center",right:"end",start:"start",end:"end"};function parseIMSC1(e,t,i,r){const s=findBox(new Uint8Array(e),["mdat"]);if(0===s.length)return void r(new Error("Could not parse IMSC1 mdat"));const a=s.map((e=>utf8ArrayToStr(e))),n=toTimescaleFromScale(t.baseTime,1,t.timescale);try{a.forEach((e=>i(parseTTML(e,n))))}catch(o){r(o)}}function parseTTML(e,t){const i=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!i)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(r).reduce(((e,t)=>(e[t]=i.getAttribute(`ttp:${t}`)||r[t],e)),{}),a="preserve"!==i.getAttribute("xml:space"),n=collectionToDictionary(getElementCollection(i,"styling","style")),o=collectionToDictionary(getElementCollection(i,"layout","region")),l=getElementCollection(i,"body","[begin]");return[].map.call(l,(e=>{const i=getTextContent(e,a);if(!i||!e.hasAttribute("begin"))return null;const r=parseTtmlTime(e.getAttribute("begin"),s),l=parseTtmlTime(e.getAttribute("dur"),s);let c=parseTtmlTime(e.getAttribute("end"),s);if(null===r)throw timestampParsingError(e);if(null===c){if(null===l)throw timestampParsingError(e);c=r+l}const u=new VTTCue(r-t,c-t,i);u.id=generateCueId(u.startTime,u.endTime,u.text);const d=getTtmlStyles(o[e.getAttribute("region")],n[e.getAttribute("style")],n),{textAlign:h}=d;if(h){const e=textAlignToLineAlign[h];e&&(u.lineAlign=e),u.align=h}return _extends(u,d),u})).filter((e=>null!==e))}function getElementCollection(e,t,i){const r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(i)):[]}function collectionToDictionary(e){return e.reduce(((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e}),{})}function getTextContent(e,t){return[].slice.call(e.childNodes).reduce(((e,i,r)=>{var s;return"br"===i.nodeName&&r?e+"\n":null!=(s=i.childNodes)&&s.length?getTextContent(i,t):t?e+i.textContent.trim().replace(/\s+/g," "):e+i.textContent}),"")}function getTtmlStyles(e,t,i){const r="http://www.w3.org/ns/ttml#styling";let s=null;const a=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;return a&&i.hasOwnProperty(a)&&(s=i[a]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce(((i,a)=>{const n=getAttributeNS(t,r,a)||getAttributeNS(e,r,a)||getAttributeNS(s,r,a);return n&&(i[a]=n),i}),{})}function getAttributeNS(e,t,i){return e&&e.hasAttributeNS(t,i)?e.getAttributeNS(t,i):null}function timestampParsingError(e){return new Error(`Could not parse ttml timestamp ${e}`)}function parseTtmlTime(e,t){if(!e)return null;let i=parseTimeStamp(e);return null===i&&(HMSF_REGEX.test(e)?i=parseHoursMinutesSecondsFrames(e,t):TIME_UNIT_REGEX.test(e)&&(i=parseTimeUnits(e,t))),i}function parseHoursMinutesSecondsFrames(e,t){const i=HMSF_REGEX.exec(e),r=(0|i[4])+(0|i[5])/t.subFrameRate;return 3600*(0|i[1])+60*(0|i[2])+(0|i[3])+r/t.frameRate}function parseTimeUnits(e,t){const i=TIME_UNIT_REGEX.exec(e),r=Number(i[1]);switch(i[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/t.frameRate;case"t":return r/t.tickRate}return r}class TimelineController{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=newVTTCCs(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Events.FRAG_LOADING,this.onFragLoading,this),e.on(Events.FRAG_LOADED,this.onFragLoaded,this),e.on(Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(Events.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(Events.FRAG_LOADING,this.onFragLoading,this),e.off(Events.FRAG_LOADED,this.onFragLoaded,this),e.off(Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(Events.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new OutputFilter(this,"textTrack1"),t=new OutputFilter(this,"textTrack2"),i=new OutputFilter(this,"textTrack3"),r=new OutputFilter(this,"textTrack4");this.cea608Parser1=new Cea608Parser(1,e,t),this.cea608Parser2=new Cea608Parser(3,i,r)}}addCues(e,t,i,r,s){let a=!1;for(let n=s.length;n--;){const e=s[n],r=intersection(e[0],e[1],t,i);if(r>=0&&(e[0]=Math.min(e[0],t),e[1]=Math.max(e[1],i),a=!0,r/(i-t)>.5))return}if(a||s.push([t,i]),this.config.renderTextTracksNatively){const s=this.captionsTracks[e];this.Cues.newCue(s,t,i,r)}else{const s=this.Cues.newCue(null,t,i,r);this.hls.trigger(Events.CUES_PARSED,{type:"captions",cues:s,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:r,timescale:s}){const{unparsedVttFrags:a}=this;"main"===i&&(this.initPTS[t.cc]={baseTime:r,timescale:s}),a.length&&(this.unparsedVttFrags=[],a.forEach((e=>{this.onFragLoaded(Events.FRAG_LOADED,e)})))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let r=0;r<i.textTracks.length;r++){const s=i.textTracks[r];if(canReuseVttTextTrack(s,{name:e,lang:t,attrs:{}}))return s}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:r}=this,{label:s,languageCode:a}=t[e],n=this.getExistingTrack(s,a);if(n)i[e]=n,clearCurrentCues(i[e]),sendAddTrackEvent(i[e],r);else{const t=this.createTextTrack("captions",s,a);t&&(t[e]=!0,i[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(e,t,i){const r=this.media;if(r)return r.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach((t=>{clearCurrentCues(e[t]),delete e[t]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=newVTTCCs(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)clearCurrentCues(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],r=i.some((e=>e.textCodec===IMSC1_CODEC));if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(subtitleOptionsIdentical(this.tracks,i))return void(this.tracks=i);if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const e=this.media,t=e?filterSubtitleTracks(e.textTracks):null;if(this.tracks.forEach(((e,i)=>{let r;if(t){let i=null;for(let r=0;r<t.length;r++)if(t[r]&&canReuseVttTextTrack(t[r],e)){i=t[r],t[r]=null;break}i&&(r=i)}if(r)clearCurrentCues(r);else{const t=captionsOrSubtitlesFromCharacteristics(e);r=this.createTextTrack(t,e.name,e.lang),r&&(r.mode="disabled")}r&&this.textTracks.push(r)})),null!=t&&t.length){const e=t.filter((e=>null!==e)).map((e=>e.label));e.length&&logger.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map((e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e})));this.hls.trigger(Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach((e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const i=`textTrack${t[1]}`,r=this.captionsProperties[i];r&&(r.label=e.name,e.lang&&(r.languageCode=e.lang),r.media=e)}))}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:r,lastCc:s,lastSn:a,lastPartIndex:n}=this;if(this.enabled&&i&&r&&t.frag.type===PlaylistLevelType.MAIN){var o,l;const{cc:e,sn:c}=t.frag,u=null!=(o=null==t||null==(l=t.part)?void 0:l.index)?o:-1;c===a+1||c===a&&u===n+1||e===s||(i.reset(),r.reset()),this.lastCc=e,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:r}=t;if(i.type===PlaylistLevelType.SUBTITLE)if(r.byteLength){const e=i.decryptdata,s="stats"in t;if(null==e||!e.encrypted||s){const e=this.tracks[i.level],s=this.vttCCs;s[i.cc]||(s[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),e&&e.textCodec===IMSC1_CODEC?this._parseIMSC1(i,r):this._parseVTTs(t)}}else this.hls.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;parseIMSC1(t,this.initPTS[e.cc],(t=>{this._appendCues(t,e.level),i.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(t=>{logger.log(`Failed to parse IMSC1: ${t}`),i.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})}))}_parseVTTs(e){var t;const{frag:i,payload:r}=e,{initPTS:s,unparsedVttFrags:a}=this,n=s.length-1;if(!s[i.cc]&&-1===n)return void a.push(e);const o=this.hls;parseWebVTT(null!=(t=i.initSegment)&&t.data?appendUint8Array(i.initSegment.data,new Uint8Array(r)):r,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,(e=>{this._appendCues(e,i.level),o.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})}),(t=>{const s="Missing initPTS for VTT MPEGTS"===t.message;s?a.push(e):this._fallbackToIMSC1(i,r),logger.log(`Failed to parse VTT cue: ${t}`),s&&n>i.cc||o.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:t})}))}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||parseIMSC1(t,this.initPTS[e.cc],(()=>{i.textCodec=IMSC1_CODEC,this._parseIMSC1(e,t)}),(()=>{i.textCodec="wvtt"}))}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[t];if(!i||"disabled"===i.mode)return;e.forEach((e=>addCueToTrack(i,e)))}else{const r=this.tracks[t];if(!r)return;const s=r.default?"default":"subtitles"+t;i.trigger(Events.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===PlaylistLevelType.SUBTITLE&&this.onFragLoaded(Events.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:r}=this;if(!this.enabled||!i||!r)return;const{frag:s,samples:a}=t;if(s.type!==PlaylistLevelType.MAIN||"NONE"!==this.closedCaptionsForLevel(s))for(let n=0;n<a.length;n++){const e=a[n].bytes;if(e){const t=this.extractCea608Data(e);i.addData(a[n].pts,t[0]),r.addData(a[n].pts,t[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:r,type:s}){const{media:a}=this;if(a&&!(a.currentTime<i)){if(!s||"video"===s){const{captionsTracks:e}=this;Object.keys(e).forEach((r=>removeCuesInRange(e[r],t,i)))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==r){const{textTracks:e}=this;Object.keys(e).forEach((i=>removeCuesInRange(e[i],t,r)))}}}extractCea608Data(e){const t=[[],[]],i=31&e[0];let r=2;for(let s=0;s<i;s++){const i=e[r++],s=127&e[r++],a=127&e[r++];if(0===s&&0===a)continue;if(0!=(4&i)){const e=3&i;0!==e&&1!==e||(t[e].push(s),t[e].push(a))}}return t}}function captionsOrSubtitlesFromCharacteristics(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function canReuseVttTextTrack(e,t){return!!e&&e.kind===captionsOrSubtitlesFromCharacteristics(t)&&subtitleTrackMatchesTextTrack(t,e)}function intersection(e,t,i,r){return Math.min(t,r)-Math.max(e,i)}function newVTTCCs(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class CapLevelController{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Events.BUFFER_CODECS,this.onBufferCodecs,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Events.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&isFiniteNumber(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter(((t,i)=>this.isLevelAllowed(t)&&i<=e));return this.clientRect=null,CapLevelController.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,t.width||t.height||(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e2){}return e}isLevelAllowed(e){return!this.restrictedLevels.some((t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height))}static getMaxLevelByMediaSize(e,t,i){if(null==e||!e.length)return-1;let r=e.length-1;const s=Math.max(t,i);for(let o=0;o<e.length;o+=1){const t=e[o];if((t.width>=s||t.height>=s)&&(a=t,!(n=e[o+1])||a.width!==n.width||a.height!==n.height)){r=o;break}}var a,n;return r}}class FPSController{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const r=performance.now();if(t){if(this.lastTime){const e=r-this.lastTime,s=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,n=1e3*s/e,o=this.hls;if(o.trigger(Events.FPS_DROP,{currentDropped:s,currentDecoded:a,totalDroppedFrames:i}),n>0&&s>o.config.fpsDroppedMonitoringThreshold*a){let e=o.currentLevel;logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(Events.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}const LOGGER_PREFIX="[eme]";class EMEController{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=EMEController.CDMCleanupPromise?[EMEController.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=logger.debug.bind(logger,LOGGER_PREFIX),this.log=logger.log.bind(logger,LOGGER_PREFIX),this.warn=logger.warn.bind(logger,LOGGER_PREFIX),this.error=logger.error.bind(logger,LOGGER_PREFIX),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,r=t[e];if(r)return r.licenseUrl;if(e===KeySystems.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(e,t,i)=>!!e&&i.indexOf(e)===t,r=t.map((e=>e.audioCodec)).filter(i),s=t.map((e=>e.videoCodec)).filter(i);return r.length+s.length===0&&s.push("avc1.42e01e"),new Promise(((t,i)=>{const a=e=>{const n=e.shift();this.getMediaKeysPromise(n,r,s).then((e=>t({keySystem:n,mediaKeys:e}))).catch((t=>{e.length?a(e):i(t instanceof EMEKeyError?t:new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))}))};a(e)}))}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let e=`Configured requestMediaKeySystemAccess is not a function ${i}`;return null===requestMediaKeySystemAccess&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return i(e,t)}getMediaKeysPromise(e,t,i){const r=getSupportedMediaKeySystemConfigurations(e,t,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[e];let a=null==s?void 0:s.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(r)}`),a=this.requestMediaKeySystemAccess(e,r);const t=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch((t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)})),a.then((i=>{this.log(`Access for key-system "${i.keySystem}" obtained`);const r=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=i.createMediaKeys().then((t=>(this.log(`Media-keys created for "${e}"`),r.then((i=>i?this.setMediaKeysServerCertificate(t,e,i):t))))),t.mediaKeys.catch((t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)})),t.mediaKeys}))}return a.then((()=>s.mediaKeys))}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Hex.hexDump(e.keyId||[])}`);const r=i.createSession(),s={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),r=this.getKeyIdString(t),s="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(i,s,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return Hex.hexDump(e.keyId)}updateKeySession(e,t){var i;const r=e.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${Hex.hexDump((null==(i=e.decryptdata)?void 0:i.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),r.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise(((t,i)=>{const r=getKeySystemsForConfig(this.config),s=e.map(keySystemFormatToKeySystemDomain).filter((e=>!!e&&-1!==r.indexOf(e)));return this.getKeySystemSelectionPromise(s).then((({keySystem:e})=>{const r=keySystemDomainToKeySystemFormat(e);r?t(r):i(new Error(`Unable to find format for key-system "${e}"`))})).catch(i)}))}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),r=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(t).then((({keySystem:i,mediaKeys:s})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(i,s).then((()=>{this.throwIfDestroyed();const e=this.createMediaKeySessionContext({keySystem:i,mediaKeys:s,decryptdata:t});return this.generateRequestWithPreferredKeySession(e,"cenc",t.pssh,"playlist-key")}))))),s.catch((e=>this.handleError(e)))),s}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof EMEKeyError?this.hls.trigger(Events.ERROR,e.data):this.hls.trigger(Events.ERROR,{type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const t=keySystemFormatToKeySystemDomain(e.keyFormat),i=t?[t]:getKeySystemsForConfig(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=getKeySystemsForConfig(this.config)),0===e.length)throw new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:i}=e;if(this.debug(`"${e.type}" event: init data type: "${t}"`),null===i)return;let r,s;if("sinf"===t&&this.config.drmSystems[KeySystems.FAIRPLAY]){const e=bin2str(new Uint8Array(i));try{const t=base64Decode(JSON.parse(e).sinf),i=parseSinf(new Uint8Array(t));if(!i)return;r=i.subarray(8,24),s=KeySystems.FAIRPLAY}catch(c){return void this.warn('Failed to parse sinf "encrypted" event message initData')}}else{const e=parsePssh(i);if(null===e)return;0===e.version&&e.systemId===KeySystemIds.WIDEVINE&&e.data&&(r=e.data.subarray(8,24)),s=keySystemIdToKeySystemDomain(e.systemId)}if(!s||!r)return;const a=Hex.hexDump(r),{keyIdToKeySessionPromise:n,mediaKeySessions:o}=this;let l=n[a];for(let u=0;u<o.length;u++){const e=o[u],s=e.decryptdata;if(s.pssh||!s.keyId)continue;const c=Hex.hexDump(s.keyId);if(a===c||-1!==s.uri.replace(/-/g,"").indexOf(a)){l=n[c],delete n[c],s.pssh=new Uint8Array(i),s.keyId=r,l=n[a]=l.then((()=>this.generateRequestWithPreferredKeySession(e,t,i,"encrypted-event-key-match")));break}}l||(l=n[a]=this.getKeySystemSelectionPromise([s]).then((({keySystem:e,mediaKeys:s})=>{var n;this.throwIfDestroyed();const o=new LevelKey("ISO-23001-7",a,null!=(n=keySystemDomainToKeySystemFormat(e))?n:"");return o.pssh=new Uint8Array(i),o.keyId=r,this.attemptSetMediaKeys(e,s).then((()=>{this.throwIfDestroyed();const r=this.createMediaKeySessionContext({decryptdata:o,keySystem:e,mediaKeys:s});return this.generateRequestWithPreferredKeySession(r,t,i,"encrypted-event-no-match")}))}))),l.catch((e=>this.handleError(e)))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const r=Promise.all(i).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)}));return this.setMediaKeysQueue.push(r),r.then((()=>{this.log(`Media-keys set for "${e}"`),i.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((e=>-1===i.indexOf(e)))}))}generateRequestWithPreferredKeySession(e,t,i,r){var s,a;const n=null==(s=this.config.drmSystems)||null==(a=s[e.keySystem])?void 0:a.generateRequest;if(n)try{const r=n.call(this.hls,t,i,e);if(!r)throw new Error("Invalid response from configured generateRequest filter");t=r.initDataType,i=e.decryptdata.pssh=r.initData?new Uint8Array(r.initData):null}catch(m){var o;if(this.warn(m.message),null!=(o=this.hls)&&o.config.debug)throw m}if(null===i)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${t} length: ${i?i.byteLength:null})`);const c=new EventEmitter,u=e._onmessage=t=>{const i=e.mediaKeysSession;if(!i)return void c.emit("error",new Error("invalid state"));const{messageType:r,message:s}=t;this.log(`"${r}" message event for session "${i.sessionId}" message size: ${s.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(e,s).catch((e=>{this.handleError(e),c.emit("error",e)})):"license-release"===r?e.keySystem===KeySystems.FAIRPLAY&&(this.updateKeySession(e,strToUtf8array("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${r}"`)},d=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void c.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const i=e.keyStatus;c.emit("keyStatus",i),"expired"===i&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",u),e.mediaKeysSession.addEventListener("keystatuseschange",d);const h=new Promise(((e,t)=>{c.on("error",t),c.on("keyStatus",(i=>{i.startsWith("usable")?e():"output-restricted"===i?t(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?t(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${i}"`)):"expired"===i?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${i}"`)}))}));return e.mediaKeysSession.generateRequest(t,i).then((()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${l}`)})).catch((e=>{throw new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)})).then((()=>h)).catch((t=>{throw c.removeAllListeners(),this.removeSession(e),t})).then((()=>(c.removeAllListeners(),e)))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach(((t,i)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${Hex.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Hex.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t}))}fetchServerCertificate(e){const t=this.config,i=new(0,t.loader)(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise(((s,a)=>{const n={responseType:"arraybuffer",url:r},o=t.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,i,r)=>{s(e.data)},onError:(t,i,s,o)=>{a(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:_objectSpread2({url:n.url,data:void 0},t)},`"${e}" certificate request failed (${r}). Status: ${t.code} (${t.text})`))},onTimeout:(t,i,s)=>{a(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:{url:n.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(e,t,i)=>{a(new Error("aborted"))}};i.load(n,l,c)}))):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise(((r,s)=>{e.setServerCertificate(i).then((s=>{this.log(`setServerCertificate ${s?"success":"not supported by CDM"} (${null==i?void 0:i.byteLength}) on "${t}"`),r(e)})).catch((e=>{s(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))}))}))}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then((t=>this.updateKeySession(e,new Uint8Array(t)).catch((e=>{throw new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const r=(new DOMParser).parseFromString(i,"application/xml"),s=r.querySelectorAll("HttpHeader");if(s.length>0){let t;for(let i=0,r=s.length;i<r;i++){var a,n;t=s[i];const r=null==(a=t.querySelector("name"))?void 0:a.textContent,o=null==(n=t.querySelector("value"))?void 0:n.textContent;r&&o&&e.setRequestHeader(r,o)}}const o=r.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return strToUtf8array(atob(l))}setupLicenseXHR(e,t,i,r){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then((()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,e,t,i,r)})).catch((a=>{if(!i.decryptdata)throw a;return e.open("POST",t,!0),s.call(this.hls,e,t,i,r)})).then((i=>{e.readyState||e.open("POST",t,!0);return{xhr:e,licenseChallenge:i||r}})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise(((r,s)=>{const a=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${a}`);const n=new XMLHttpRequest;n.responseType="arraybuffer",n.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return s(new Error("invalid state"));if(4===n.readyState)if(200===n.status){this._requestLicenseFailureCount=0;let t=n.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const i=this.config.licenseResponseCallback;if(i)try{t=i.call(this.hls,n,a,e)}catch(o){this.error(o)}r(t)}else{const o=i.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||n.status>=400&&n.status<500)s(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:{url:a,data:void 0,code:n.status,text:n.statusText}},`License Request XHR failed (${a}). Status: ${n.status} (${n.statusText})`));else{const i=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${i} attempts left`),this.requestLicense(e,t).then(r,s)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=n,this.setupLicenseXHR(n,a,e,t).then((({xhr:t,licenseChallenge:i})=>{e.keySystem==KeySystems.PLAYREADY&&(i=this.unpackPlayReadyKeyMessage(t,i)),t.send(i)}))}))}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},LevelKey.clearKeyUriToKeyIdMap();const i=t.length;EMEController.CDMCleanupPromise=Promise.all(t.map((e=>this.removeSession(e))).concat(null==e?void 0:e.setMediaKeys(null).catch((e=>{this.log(`Could not clear media keys: ${e}`)})))).then((()=>{i&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)})).catch((e=>{this.log(`Could not close sessions and clear media keys: ${e}`)}))}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce(((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e)),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);return r>-1&&this.mediaKeySessions.splice(r,1),t.remove().catch((e=>{this.log(`Could not remove session: ${e}`)})).then((()=>t.close())).catch((e=>{this.log(`Could not close session: ${e}`)}))}}}EMEController.CDMCleanupPromise=void 0;class EMEKeyError extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var CmObjectType,CmObjectType2,CmStreamingFormat,CmStreamingFormat2,CmcdHeaderField,CmcdHeaderField2;CmObjectType2=CmObjectType||(CmObjectType={}),CmObjectType2.MANIFEST="m",CmObjectType2.AUDIO="a",CmObjectType2.VIDEO="v",CmObjectType2.MUXED="av",CmObjectType2.INIT="i",CmObjectType2.CAPTION="c",CmObjectType2.TIMED_TEXT="tt",CmObjectType2.KEY="k",CmObjectType2.OTHER="o",CmStreamingFormat2=CmStreamingFormat||(CmStreamingFormat={}),CmStreamingFormat2.DASH="d",CmStreamingFormat2.HLS="h",CmStreamingFormat2.SMOOTH="s",CmStreamingFormat2.OTHER="o",CmcdHeaderField2=CmcdHeaderField||(CmcdHeaderField={}),CmcdHeaderField2.OBJECT="CMCD-Object",CmcdHeaderField2.REQUEST="CMCD-Request",CmcdHeaderField2.SESSION="CMCD-Session",CmcdHeaderField2.STATUS="CMCD-Status";const CmcdHeaderMap={[CmcdHeaderField.OBJECT]:["br","d","ot","tb"],[CmcdHeaderField.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[CmcdHeaderField.SESSION]:["cid","pr","sf","sid","st","v"],[CmcdHeaderField.STATUS]:["bs","rtp"]};class SfItem{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map((e=>e instanceof SfItem?e:new SfItem(e)))),this.value=e,this.params=t}}class SfToken{constructor(e){this.description=void 0,this.description=e}}const DICT="Dict";function format(e){return Array.isArray(e)?JSON.stringify(e):e instanceof Map?"Map{}":e instanceof Set?"Set{}":"object"==typeof e?JSON.stringify(e):String(e)}function throwError(e,t,i,r){return new Error(`failed to ${e} "${format(t)}" as ${i}`,{cause:r})}const BARE_ITEM="Bare Item",BOOLEAN="Boolean",BYTES="Byte Sequence",DECIMAL="Decimal",INTEGER="Integer";function isInvalidInt(e){return e<-999999999999999||999999999999999<e}const STRING_REGEX=/[\x00-\x1f\x7f]+/,TOKEN="Token",KEY="Key";function serializeError(e,t,i){return throwError("serialize",e,t,i)}function serializeBoolean(e){if("boolean"!=typeof e)throw serializeError(e,BOOLEAN);return e?"?1":"?0"}function base64encode(e){return btoa(String.fromCharCode(...e))}function serializeByteSequence(e){if(!1===ArrayBuffer.isView(e))throw serializeError(e,BYTES);return`:${base64encode(e)}:`}function serializeInteger(e){if(isInvalidInt(e))throw serializeError(e,INTEGER);return e.toString()}function serializeDate(e){return`@${serializeInteger(e.getTime()/1e3)}`}function roundToEven(e,t){if(e<0)return-roundToEven(-e,t);const i=Math.pow(10,t);if(Math.abs(e*i%1-.5)<Number.EPSILON){const t=Math.floor(e*i);return(t%2==0?t:t+1)/i}return Math.round(e*i)/i}function serializeDecimal(e){const t=roundToEven(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw serializeError(e,DECIMAL);const i=t.toString();return i.includes(".")?i:`${i}.0`}const STRING="String";function serializeString(e){if(STRING_REGEX.test(e))throw serializeError(e,STRING);return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function symbolToStr(e){return e.description||e.toString().slice(7,-1)}function serializeToken(e){const t=symbolToStr(e);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw serializeError(t,TOKEN);return t}function serializeBareItem(e){switch(typeof e){case"number":if(!isFiniteNumber(e))throw serializeError(e,BARE_ITEM);return Number.isInteger(e)?serializeInteger(e):serializeDecimal(e);case"string":return serializeString(e);case"symbol":return serializeToken(e);case"boolean":return serializeBoolean(e);case"object":if(e instanceof Date)return serializeDate(e);if(e instanceof Uint8Array)return serializeByteSequence(e);if(e instanceof SfToken)return serializeToken(e);default:throw serializeError(e,BARE_ITEM)}}function serializeKey(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw serializeError(e,KEY);return e}function serializeParams(e){return null==e?"":Object.entries(e).map((([e,t])=>!0===t?`;${serializeKey(e)}`:`;${serializeKey(e)}=${serializeBareItem(t)}`)).join("")}function serializeItem(e){return e instanceof SfItem?`${serializeBareItem(e.value)}${serializeParams(e.params)}`:serializeBareItem(e)}function serializeInnerList(e){return`(${e.value.map(serializeItem).join(" ")})${serializeParams(e.params)}`}function serializeDict(e,t={whitespace:!0}){if("object"!=typeof e)throw serializeError(e,DICT);const i=e instanceof Map?e.entries():Object.entries(e),r=null!=t&&t.whitespace?" ":"";return Array.from(i).map((([e,t])=>{t instanceof SfItem==!1&&(t=new SfItem(t));let i=serializeKey(e);return!0===t.value?i+=serializeParams(t.params):(i+="=",Array.isArray(t.value)?i+=serializeInnerList(t):i+=serializeItem(t)),i})).join(`,${r}`)}function encodeSfDict(e,t){return serializeDict(e,t)}const isTokenField=e=>"ot"===e||"sf"===e||"st"===e,isValid=e=>"number"==typeof e?isFiniteNumber(e):null!=e&&""!==e&&!1!==e;function urlToRelativePath(e,t){const i=new URL(e),r=new URL(t);if(i.origin!==r.origin)return e;const s=i.pathname.split("/").slice(1),a=r.pathname.split("/").slice(1,-1);for(;s[0]===a[0];)s.shift(),a.shift();for(;a.length;)a.shift(),s.unshift("..");return s.join("/")}function uuid(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(t){let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)}))}}}const toRounded=e=>Math.round(e),toUrlSafe=(e,t)=>(null!=t&&t.baseUrl&&(e=urlToRelativePath(e,t.baseUrl)),encodeURIComponent(e)),toHundred=e=>100*toRounded(e/100),CmcdFormatters={br:toRounded,d:toRounded,bl:toHundred,dl:toHundred,mtp:toHundred,nor:toUrlSafe,rtp:toHundred,tb:toRounded};function processCmcd(e,t){const i={};if(null==e||"object"!=typeof e)return i;const r=Object.keys(e).sort(),s=_extends({},CmcdFormatters,null==t?void 0:t.formatters),a=null==t?void 0:t.filter;return r.forEach((r=>{if(null!=a&&a(r))return;let n=e[r];const o=s[r];o&&(n=o(n,t)),"v"===r&&1===n||"pr"==r&&1===n||isValid(n)&&(isTokenField(r)&&"string"==typeof n&&(n=new SfToken(n)),i[r]=n)})),i}function encodeCmcd(e,t={}){return e?encodeSfDict(processCmcd(e,t),_extends({whitespace:!1},t)):""}function toCmcdHeaders(e,t={}){if(!e)return{};const i=Object.entries(e),r=Object.entries(CmcdHeaderMap).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),s=i.reduce(((e,t)=>{var i;const[s,a]=t,n=(null==(i=r.find((e=>e[1].includes(s))))?void 0:i[0])||CmcdHeaderField.REQUEST;return null!=e[n]||(e[n]={}),e[n][s]=a,e}),{});return Object.entries(s).reduce(((e,[i,r])=>(e[i]=encodeCmcd(r,t),e)),{})}function appendCmcdHeaders(e,t,i){return _extends(e,toCmcdHeaders(t,i))}const CMCD_PARAM="CMCD";function toCmcdQuery(e,t={}){if(!e)return"";const i=encodeCmcd(e,t);return`${CMCD_PARAM}=${encodeURIComponent(i)}`}const REGEX=/CMCD=[^&#]+/;function appendCmcdQuery(e,t,i){const r=toCmcdQuery(t,i);if(!r)return e;if(REGEX.test(e))return e.replace(REGEX,r);const s=e.includes("?")?"&":"?";return`${e}${s}${r}`}class CMCDController{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:CmObjectType.MANIFEST,su:!this.initialized})}catch(t){logger.warn("Could not generate manifest CMCD data.",t)}},this.applyFragmentData=e=>{try{const t=e.frag,i=this.hls.levels[t.level],r=this.getObjectType(t),s={d:1e3*t.duration,ot:r};r!==CmObjectType.VIDEO&&r!==CmObjectType.AUDIO&&r!=CmObjectType.MUXED||(s.br=i.bitrate/1e3,s.tb=this.getTopBandwidth(r)/1e3,s.bl=this.getBufferLength(r)),this.apply(e,s)}catch(t){logger.warn("Could not generate segment CMCD data.",t)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;null!=i&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||uuid(),this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Events.MEDIA_DETACHED,this.onMediaDetached,this),e.on(Events.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Events.MEDIA_DETACHED,this.onMediaDetached,this),e.off(Events.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,r;this.audioBuffer=null==(i=t.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(r=t.tracks.video)?void 0:r.buffer}createData(){var e;return{v:1,sf:CmStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){_extends(t,this.createData());const i=t.ot===CmObjectType.INIT||t.ot===CmObjectType.VIDEO||t.ot===CmObjectType.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:r}=this;r&&(t=Object.keys(t).reduce(((e,i)=>(r.includes(i)&&(e[i]=t[i]),e)),{})),this.useHeaders?(e.headers||(e.headers={}),appendCmcdHeaders(e.headers,t)):e.url=appendCmcdQuery(e.url,t)}getObjectType(e){const{type:t}=e;return"subtitle"===t?CmObjectType.TIMED_TEXT:"initSegment"===e.sn?CmObjectType.INIT:"audio"===t?CmObjectType.AUDIO:"main"===t?this.hls.audioTracks.length?CmObjectType.VIDEO:CmObjectType.MUXED:void 0}getTopBandwidth(e){let t,i=0;const r=this.hls;if(e===CmObjectType.AUDIO)t=r.audioTracks;else{const e=r.maxAutoLevel,i=e>-1?e+1:r.levels.length;t=r.levels.slice(0,i)}for(const s of t)s.bitrate>i&&(i=s.bitrate);return i>0?i:NaN}getBufferLength(e){const t=this.hls.media,i=e===CmObjectType.AUDIO?this.audioBuffer:this.videoBuffer;if(!i||!t)return NaN;return 1e3*BufferHelper.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new i(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,i,r){t(e),this.loader.load(e,i,r)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new i(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,i,r){t(e),this.loader.load(e,i,r)}}}}const PATHWAY_PENALTY_DURATION_MS=3e5;class ContentSteeringController{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=logger.log.bind(logger,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Events.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Events.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter((t=>t!==e)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((null==i?void 0:i.action)===NetworkErrorAction.SendAlternateToPenaltyBox&&i.flags===ErrorActionFlags.MoveAllAlternatesMatchingHost){const e=this.levels;let r=this.pathwayPriority,s=this.pathwayId;if(t.context){const{groupId:i,pathwayId:r,type:a}=t.context;i&&e?s=this.getPathwayForGroupId(i,a,s):r&&(s=r)}s in this.penalizedPathways||(this.penalizedPathways[s]=performance.now()),!r&&e&&(r=e.reduce(((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e)),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==s),i.resolved||logger.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${s} levels: ${e?e.length:e} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length?(this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t):e}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter((t=>e===t.pathwayId))}updatePathwayPriority(e){let t;this.pathwayPriority=e;const i=this.penalizedPathways,r=performance.now();Object.keys(i).forEach((e=>{r-i[e]>PATHWAY_PENALTY_DURATION_MS&&delete i[e]}));for(let s=0;s<e.length;s++){const r=e[s];if(r in i)continue;if(r===this.pathwayId)return;const a=this.hls.nextLoadLevel,n=this.hls.levels[a];if(t=this.getLevelsForPathway(r),t.length>0){this.log(`Setting Pathway to "${r}"`),this.pathwayId=r,reassignFragmentLevelIndexes(t),this.hls.trigger(Events.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[a];n&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==n.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==n.bitrate&&this.log(`Unstable Pathways change from bitrate ${n.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const r=this.getLevelsForPathway(i).concat(this.levels||[]);for(let s=0;s<r.length;s++)if(t===PlaylistContextType.AUDIO_TRACK&&r[s].hasAudioGroup(e)||t===PlaylistContextType.SUBTITLE_TRACK&&r[s].hasSubtitleGroup(e))return r[s].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},r={};e.forEach((e=>{const{ID:s,"BASE-ID":a,"URI-REPLACEMENT":n}=e;if(t.some((e=>e.pathwayId===s)))return;const o=this.getLevelsForPathway(a).map((e=>{const t=new AttrList(e.attrs);t["PATHWAY-ID"]=s;const a=t.AUDIO&&`${t.AUDIO}_clone_${s}`,o=t.SUBTITLES&&`${t.SUBTITLES}_clone_${s}`;a&&(i[t.AUDIO]=a,t.AUDIO=a),o&&(r[t.SUBTITLES]=o,t.SUBTITLES=o);const l=performUriReplacement(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",n),c=new Level({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:l,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let i=1;i<e.audioGroups.length;i++)c.addGroupId("audio",`${e.audioGroups[i]}_clone_${s}`);if(e.subtitleGroups)for(let i=1;i<e.subtitleGroups.length;i++)c.addGroupId("text",`${e.subtitleGroups[i]}_clone_${s}`);return c}));t.push(...o),cloneRenditionGroups(this.audioTracks,i,n,s),cloneRenditionGroups(this.subtitleTracks,r,n,s)}))}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;let r;this.loader&&this.loader.destroy(),this.loader=new i(t);try{r=new self.URL(e)}catch(c){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==r.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+e)}const s={responseType:"json",url:r.href},a=t.steeringManifestLoadPolicy.default,n=a.errorRetry||a.timeoutRetry||{},o={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0},l={onSuccess:(e,t,i,s)=>{this.log(`Loaded steering manifest: "${r}"`);const a=e.data;if(1!==a.VERSION)return void this.log(`Steering VERSION ${a.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=a.TTL;const{"RELOAD-URI":n,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=a;if(n)try{this.uri=new self.URL(n,r).href}catch(c){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${n}`)}this.scheduleRefresh(this.uri||i.url),o&&this.clonePathways(o);const u={steeringManifest:a,url:r.toString()};this.hls.trigger(Events.STEERING_MANIFEST_LOADED,u),l&&this.updatePathwayPriority(l)},onError:(e,t,i,r)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let s=1e3*this.timeToLoad;if(429!==e.code)this.scheduleRefresh(this.uri||t.url,s);else{const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(s=1e3*parseFloat(t))}this.log(`Steering manifest ${t.url} rate limited`)}},onTimeout:(e,t,i)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(s,o,l)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout((()=>{var t;const i=null==(t=this.hls)?void 0:t.media;!i||i.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)}),t)}}function cloneRenditionGroups(e,t,i,r){e&&Object.keys(t).forEach((s=>{const a=e.filter((e=>e.groupId===s)).map((e=>{const a=_extends({},e);return a.details=void 0,a.attrs=new AttrList(a.attrs),a.url=a.attrs.URI=performUriReplacement(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),a.groupId=a.attrs["GROUP-ID"]=t[s],a.attrs["PATHWAY-ID"]=r,a}));e.push(...a)}))}function performUriReplacement(e,t,i,r){const{HOST:s,PARAMS:a,[i]:n}=r;let o;t&&(o=null==n?void 0:n[t],o&&(e=o));const l=new self.URL(e);return s&&!o&&(l.host=s),a&&Object.keys(a).sort().forEach((e=>{e&&l.searchParams.set(e,a[e])})),l.href}const AGE_HEADER_LINE_REGEX=/^age:\s*[\d.]+\s*$/im;class XhrLoader{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new LoadStats,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null,this.stats=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then((()=>{if(!this.stats.aborted)return s(i,t.url)})).catch((e=>(i.open("GET",t.url,!0),s(i,t.url)))).then((()=>{this.stats.aborted||this.openAndSendXhr(i,t,e)})).catch((e=>{this.callbacks.onError({code:i.status,text:e.message},t,i,r)})):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const r=t.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:a}=i.loadPolicy;if(r)for(const n in r)e.setRequestHeader(n,r[n]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&isFiniteNumber(s)?s:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const r=t.readyState,s=this.config;if(!i.aborted&&r>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const r=t.status,a="text"!==t.responseType;if(r>=200&&r<300&&(a&&t.response||null!==t.responseText)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const s=a?t.response:t.responseText,n="arraybuffer"===t.responseType?s.byteLength:s.length;if(i.loaded=i.total=n,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first),!this.callbacks)return;const o=this.callbacks.onProgress;if(o&&o(i,e,s,t),!this.callbacks)return;const l={url:t.responseURL,data:s,code:r};this.callbacks.onSuccess(l,i,e,t)}else{const a=s.loadPolicy.errorRetry;shouldRetry(a,i.retry,!1,{url:e.url,data:void 0,code:r})?this.retry(a):(logger.error(`${r} while loading ${e.url}`),this.callbacks.onError({code:r,text:t.statusText},e,t,i))}}}loadtimeout(){var e;const t=null==(e=this.config)?void 0:e.loadPolicy.timeoutRetry;if(shouldRetry(t,this.stats.retry,!0))this.retry(t);else{var i;logger.warn(`timeout while loading ${null==(i=this.context)?void 0:i.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=getRetryDelay(e,i.retry),i.retry++,logger.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&AGE_HEADER_LINE_REGEX.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}function fetchSupported(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e2){}return!1}const BYTERANGE=/(\d+)-(\d+)\/(\d+)/;class FetchLoader{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||getRequest,this.controller=new self.AbortController,this.stats=new LoadStats}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const s=getRequestParameters(e,this.controller.signal),a=i.onProgress,n="arraybuffer"===e.responseType,o=n?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,s),self.clearTimeout(this.requestTimeout),t.timeout=l&&isFiniteNumber(l)?l:c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(r,e,this.response)}),t.timeout),self.fetch(this.request).then((s=>{this.response=this.loader=s;const o=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(r,e,this.response)}),c-(o-r.loading.start)),!s.ok){const{status:e,statusText:t}=s;throw new FetchError(t||"fetch, bad network response",e,s)}return r.loading.first=o,r.total=getContentLength(s.headers)||r.total,a&&isFiniteNumber(t.highWaterMark)?this.loadProgressively(s,r,e,t.highWaterMark,a):n?s.arrayBuffer():"json"===e.responseType?s.json():s.text()})).then((s=>{const n=this.response;if(!n)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=s[o];l&&(r.loaded=r.total=l);const c={url:n.url,data:s,code:n.status};a&&!isFiniteNumber(t.highWaterMark)&&a(r,e,s,n),i.onSuccess(c,r,e,n)})).catch((t=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;const s=t&&t.code||0,a=t?t.message:null;i.onError({code:s,text:a},e,t?t.details:null,r)}))}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,r=0,s){const a=new ChunkCache,n=e.body.getReader(),o=()=>n.read().then((n=>{if(n.done)return a.dataLength&&s(t,i,a.flush(),e),Promise.resolve(new ArrayBuffer(0));const l=n.value,c=l.length;return t.loaded+=c,c<r||a.dataLength?(a.push(l),a.dataLength>=r&&s(t,i,a.flush(),e)):s(t,i,l,e),o()})).catch((()=>Promise.reject()));return o()}}function getRequestParameters(e,t){const i={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(_extends({},e.headers))};return e.rangeEnd&&i.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1)),i}function getByteRangeLength(e){const t=BYTERANGE.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}function getContentLength(e){const t=e.get("Content-Range");if(t){const e=getByteRangeLength(t);if(isFiniteNumber(e))return e}const i=e.get("Content-Length");if(i)return parseInt(i)}function getRequest(e,t){return new self.Request(e.url,t)}class FetchError extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const WHITESPACE_CHAR=/\s/,Cues={newCue(e,t,i,r){const s=[];let a,n,o,l,c;const u=self.VTTCue||self.TextTrackCue;for(let h=0;h<r.rows.length;h++)if(a=r.rows[h],o=!0,l=0,c="",!a.isEmpty()){var d;for(let e=0;e<a.chars.length;e++)WHITESPACE_CHAR.test(a.chars[e].uchar)&&o?l++:(c+=a.chars[e].uchar,o=!1);a.cueStartTime=t,t===i&&(i+=1e-4),l>=16?l--:l++;const r=fixLineBreaks(c.trim()),m=generateCueId(t,i,r);null!=e&&null!=(d=e.cues)&&d.getCueById(m)||(n=new u(t,i,r),n.id=m,n.line=h+1,n.align="left",n.position=10+Math.min(80,10*Math.floor(8*l/32)),s.push(n))}return e&&s.length&&(s.sort(((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line)),s.forEach((t=>addCueToTrack(e,t)))),s}},defaultLoadPolicy={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},hlsDefaultConfig=_objectSpread2(_objectSpread2({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:XhrLoader,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:AbrController,bufferController:BufferController,capLevelController:CapLevelController,errorController:ErrorController,fpsController:FPSController,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:defaultLoadPolicy},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},timelineConfig()),{},{subtitleStreamController:SubtitleStreamController,subtitleTrackController:SubtitleTrackController,timelineController:TimelineController,audioStreamController:AudioStreamController,audioTrackController:AudioTrackController,emeController:EMEController,cmcdController:CMCDController,contentSteeringController:ContentSteeringController});function timelineConfig(){return{cueHandler:Cues,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function mergeConfig(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=deepCpy(e),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((e=>{const s=`${"level"===e?"playlist":e}LoadPolicy`,a=void 0===t[s],n=[];r.forEach((r=>{const o=`${e}Loading${r}`,l=t[o];if(void 0!==l&&a){n.push(o);const e=i[s].default;switch(t[s]={default:e},r){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}})),n.length&&logger.warn(`hls.js config: "${n.join('", "')}" setting(s) are deprecated, use "${s}": ${JSON.stringify(t[s])}`)})),_objectSpread2(_objectSpread2({},i),t)}function deepCpy(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(deepCpy):Object.keys(e).reduce(((t,i)=>(t[i]=deepCpy(e[i]),t)),{}):e}function enableStreamingMode(e){const t=e.loader;if(t!==FetchLoader&&t!==XhrLoader)logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{fetchSupported()&&(e.loader=FetchLoader,e.progressive=!0,e.enableSoftwareAES=!0,logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}let chromeOrFirefox;class LevelController extends BasePlaylistController{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Events.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Events.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach((e=>{e.loadError=0,e.fragmentError=0})),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,r=[],s={},a={};let n=!1,o=!1,l=!1;t.levels.forEach((e=>{var t,c;const u=e.attrs;let{audioCodec:d,videoCodec:h}=e;-1!==(null==(t=d)?void 0:t.indexOf("mp4a.40.34"))&&(chromeOrFirefox||(chromeOrFirefox=/chrome|firefox/i.test(navigator.userAgent)),chromeOrFirefox&&(e.audioCodec=d=void 0)),d&&(e.audioCodec=d=getCodecCompatibleName(d,i)),0===(null==(c=h)?void 0:c.indexOf("avc1"))&&(h=e.videoCodec=convertAVC1ToAVCOTI(h));const{width:m,height:f,unknownCodecs:g}=e;if(n||(n=!(!m||!f)),o||(o=!!h),l||(l=!!d),null!=g&&g.length||d&&!areCodecsMediaSourceSupported(d,"audio",i)||h&&!areCodecsMediaSourceSupported(h,"video",i))return;const{CODECS:p,"FRAME-RATE":v,"HDCP-LEVEL":y,"PATHWAY-ID":E,RESOLUTION:T,"VIDEO-RANGE":S}=u,_=`${`${E||"."}-`}${e.bitrate}-${T}-${v}-${p}-${S}-${y}`;if(s[_])if(s[_].uri===e.url||e.attrs["PATHWAY-ID"])s[_].addGroupId("audio",u.AUDIO),s[_].addGroupId("text",u.SUBTITLES);else{const t=a[_]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const i=new Level(e);s[_]=i,r.push(i)}else{const t=new Level(e);s[_]=t,a[_]=1,r.push(t)}})),this.filterAndSortMediaOptions(r,t,n,o,l)}filterAndSortMediaOptions(e,t,i,r,s){let a=[],n=[],o=e;if((i||r)&&s&&(o=o.filter((({videoCodec:e,videoRange:t,width:i,height:r})=>(!!e||!(!i||!r))&&isVideoRange(t)))),0===o.length)return void Promise.resolve().then((()=>{if(this.hls){t.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(t.levels[0].attrs)}`);const e=new Error("no level with compatible codecs found in manifest");this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:e,reason:e.message})}}));if(t.audioTracks){const{preferManagedMediaSource:e}=this.hls.config;a=t.audioTracks.filter((t=>!t.audioCodec||areCodecsMediaSourceSupported(t.audioCodec,"audio",e))),assignTrackIdsByGroup(a)}t.subtitles&&(n=t.subtitles,assignTrackIdsByGroup(n));const l=o.slice(0);o.sort(((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return VideoRangeValues.indexOf(e.videoRange)-VideoRangeValues.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const i=videoCodecPreferenceValue(e.videoCodec),r=videoCodecPreferenceValue(t.videoCodec);if(i!==r)return r-i}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const i=codecsSetSelectionPreferenceValue(e.codecSet),r=codecsSetSelectionPreferenceValue(t.codecSet);if(i!==r)return r-i}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0}));let c=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let m=0;m<l.length;m++)if(l[m].pathwayId===o[0].pathwayId){c=l[m];break}this._levels=o;for(let m=0;m<o.length;m++)if(o[m]===c){var u;this._firstLevel=m;const e=c.bitrate,t=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${e}`),void 0===(null==(u=this.hls.userConfig)?void 0:u.abrEwmaDefaultEstimate)){const i=Math.min(e,this.hls.config.abrEwmaDefaultEstimateMax);i>t&&t===hlsDefaultConfig.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=i)}break}const d=s&&!r,h={levels:o,audioTracks:a,subtitleTracks:n,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:s,video:r,altAudio:!d&&a.some((e=>!!e.url))};this.hls.trigger(Events.MANIFEST_PARSED,h),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const i=new Error("invalid level idx"),r=e<0;if(this.hls.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.LEVEL_SWITCH_ERROR,level:e,fatal:r,error:i,reason:i.message}),r)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,r=this.currentLevel,s=r?r.attrs["PATHWAY-ID"]:void 0,a=t[e],n=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=a,i===e&&a.details&&r&&s===n)return;this.log(`Switching to level ${e} (${a.height?a.height+"p ":""}${a.videoRange?a.videoRange+" ":""}${a.codecSet?a.codecSet+" ":""}@${a.bitrate})${n?" with Pathway "+n:""} from level ${i}${s?" with Pathway "+s:""}`);const o={level:e,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(Events.LEVEL_SWITCHING,o);const l=a.details;if(!l||l.live){const e=this.switchParams(a.uri,null==r?void 0:r.details);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){!t.fatal&&t.context&&t.context.type===PlaylistContextType.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===PlaylistLevelType.MAIN){const e=t.elementaryStreams;if(!Object.keys(e).some((t=>!!e[t])))return;const i=this._levels[t.level];null!=i&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(e,t){var i;const{level:r,details:s}=t,a=this._levels[r];var n;if(!a)return this.warn(`Invalid level index ${r}`),void(null!=(n=t.deliveryDirectives)&&n.skip&&(s.deltaUpdateFailed=!0));r===this.currentLevelIndex?(0===a.fragmentError&&(a.loadError=0),this.playlistLoaded(r,t,a.details)):null!=(i=t.deliveryDirectives)&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let s=i.uri;if(e)try{s=e.addDirectives(s)}catch(r){this.warn(`Could not construct new URL with HLS Delivery Directives: ${r}`)}const a=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${void 0!==(null==e?void 0:e.msn)?" at sn "+e.msn+" part "+e.part:""} with${a?" Pathway "+a:""} ${s}`),this.clearTimer(),this.hls.trigger(Events.LEVEL_LOADING,{url:s,level:t,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const i=this._levels.filter(((t,i)=>i!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach((e=>e.level=-1))),!1)));reassignFragmentLevelIndexes(i),this._levels=i,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(Events.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(Events.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function assignTrackIdsByGroup(e){const t={};e.forEach((e=>{const i=e.groupId||"";e.id=t[i]=t[i]||0,t[i]++}))}class KeyLoader{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[i].loader;if(r){var t;if(e&&e!==(null==(t=r.context)?void 0:t.frag.type))return;r.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=ErrorDetails.KEY_LOAD_ERROR,i,r,s){return new LoadError({type:ErrorTypes.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:s,error:i,networkDetails:r})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:r}=e;for(let e=0;e<t.length;e++){const s=t[e];if(r<=s.cc&&("initSegment"===i||"initSegment"===s.sn||i<s.sn)){this.emeController.selectKeySystemFormat(s).then((e=>{s.setKeyFormat(e)}));break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then((t=>this.loadInternal(e,t))):this.loadInternal(e)}loadInternal(e,t){var i,r;t&&e.setKeyFormat(t);const s=e.decryptdata;if(!s){const i=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,ErrorDetails.KEY_LOAD_ERROR,i))}const a=s.uri;if(!a)return Promise.reject(this.createKeyLoadError(e,ErrorDetails.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${a}"`)));let n=this.keyUriToKeyInfo[a];if(null!=(i=n)&&i.decryptdata.key)return s.key=n.decryptdata.key,Promise.resolve({frag:e,keyInfo:n});var o;if(null!=(r=n)&&r.keyLoadPromise)switch(null==(o=n.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return n.keyLoadPromise.then((t=>(s.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:n})))}switch(n=this.keyUriToKeyInfo[a]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===s.keyFormat?this.loadKeyHTTP(n,e):this.loadKeyEME(n,e);case"AES-128":return this.loadKeyHTTP(n,e);default:return Promise.reject(this.createKeyLoadError(e,ErrorDetails.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(i);if(t)return(e.keyLoadPromise=t.then((t=>(e.mediaKeySessionContext=t,i)))).catch((t=>{throw e.keyLoadPromise=null,t}))}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,r=new(0,i.loader)(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise(((s,a)=>{const n={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},o=i.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,i,r)=>{const{frag:n,keyInfo:o,url:l}=i;if(!n.decryptdata||o!==this.keyUriToKeyInfo[l])return a(this.createKeyLoadError(n,ErrorDetails.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=n.decryptdata.key=new Uint8Array(e.data),n.keyLoader=null,o.loader=null,s({frag:n,keyInfo:o})},onError:(e,i,r,s)=>{this.resetLoader(i),a(this.createKeyLoadError(t,ErrorDetails.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),r,_objectSpread2({url:n.url,data:void 0},e)))},onTimeout:(e,i,r)=>{this.resetLoader(i),a(this.createKeyLoadError(t,ErrorDetails.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(e,i,r)=>{this.resetLoader(i),a(this.createKeyLoadError(t,ErrorDetails.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(n,l,c)}))}resetLoader(e){const{frag:t,keyInfo:i,url:r}=e,s=i.loader;t.keyLoader===s&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[r],s&&s.destroy()}}function getSourceBuffer(){return self.SourceBuffer||self.WebKitSourceBuffer}function isMSESupported(){if(!getMediaSource())return!1;const e=getSourceBuffer();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}function isSupported(){if(!isMSESupported())return!1;const e=getMediaSource();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((t=>e.isTypeSupported(mimeTypeForCodec(t,"video"))))||["mp4a.40.2","fLaC"].some((t=>e.isTypeSupported(mimeTypeForCodec(t,"audio")))))}function changeTypeSupported(){var e;const t=getSourceBuffer();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}const STALL_MINIMUM_DURATION_MS=250,MAX_START_GAP_JUMP=2,SKIP_BUFFER_HOLE_STEP_SECONDS=.1,SKIP_BUFFER_RANGE_START=.05;class GapController{constructor(e,t,i,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=r}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:i,media:r,stalled:s}=this;if(null===r)return;const{currentTime:a,seeking:n}=r,o=this.seeking&&!n,l=!this.seeking&&n;if(this.seeking=n,a!==e){if(this.moved=!0,n||(this.nudgeRetry=0),null!==s){if(this.stallReported){const e=self.performance.now()-s;logger.warn(`playback not stuck anymore @${a}, after ${Math.round(e)}ms`),this.stallReported=!1}this.stalled=null}return}if(l||o)return void(this.stalled=null);if(r.paused&&!n||r.ended||0===r.playbackRate||!BufferHelper.getBuffered(r).length)return void(this.nudgeRetry=0);const c=BufferHelper.bufferInfo(r,a,0),u=c.nextStart||0;if(n){const e=c.len>MAX_START_GAP_JUMP,i=!u||t&&t.start<=a||u-a>MAX_START_GAP_JUMP&&!this.fragmentTracker.getPartialFragment(a);if(e||i)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var d;if(!(c.len>0)&&!u)return;const e=Math.max(u,c.start||0)-a,t=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,i=(null==t||null==(d=t.details)?void 0:d.live)?2*t.details.targetduration:MAX_START_GAP_JUMP,s=this.fragmentTracker.getPartialFragment(a);if(e>0&&(e<=i||s))return void(r.paused||this._trySkipBufferHole(s))}const h=self.performance.now();if(null===s)return void(this.stalled=h);const m=h-s;if(!n&&m>=STALL_MINIMUM_DURATION_MS&&(this._reportStall(c),!this.media))return;const f=BufferHelper.bufferInfo(r,a,i.maxBufferHole);this._tryFixBufferStall(f,m)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:r,media:s}=this;if(null===s)return;const a=s.currentTime,n=r.getPartialFragment(a);if(n){if(this._trySkipBufferHole(n)||!this.media)return}(e.len>i.maxBufferHole||e.nextStart&&e.nextStart-a<i.maxBufferHole)&&t>1e3*i.highBufferWatchdogPeriod&&(logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:r}=this;if(!r&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(e)})`);logger.warn(r.message),t.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:i,media:r}=this;if(null===r)return 0;const s=r.currentTime,a=BufferHelper.bufferInfo(r,s,0),n=s<a.start?a.start:a.nextStart;if(n){const o=a.len<=t.maxBufferHole,l=a.len>0&&a.len<1&&r.readyState<3,c=n-s;if(c>0&&(o||l)){if(c>t.maxBufferHole){const{fragmentTracker:t}=this;let i=!1;if(0===s){const e=t.getAppendedFrag(0,PlaylistLevelType.MAIN);e&&n<e.end&&(i=!0)}if(!i){const i=e||t.getAppendedFrag(s,PlaylistLevelType.MAIN);if(i){let e=!1,r=i.end;for(;r<n;){const i=t.getPartialFragment(r);if(!i){e=!0;break}r+=i.duration}if(e)return 0}}}const a=Math.max(n+SKIP_BUFFER_RANGE_START,s+SKIP_BUFFER_HOLE_STEP_SECONDS);if(logger.warn(`skipping hole, adjusting currentTime from ${s} to ${a}`),this.moved=!0,this.stalled=null,r.currentTime=a,e&&!e.gap){const t=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${a}`);i.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:t,reason:t.message,frag:e})}return a}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i,nudgeRetry:r}=this;if(null===i)return;const s=i.currentTime;if(this.nudgeRetry++,r<e.nudgeMaxRetry){const a=s+(r+1)*e.nudgeOffset,n=new Error(`Nudging 'currentTime' from ${s} to ${a}`);logger.warn(n.message),i.currentTime=a,t.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_NUDGE_ON_STALL,error:n,fatal:!1})}else{const i=new Error(`Playhead still not moving while enough data buffered @${s} after ${e.nudgeMaxRetry} nudges`);logger.error(i.message),t.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_STALLED_ERROR,error:i,fatal:!0})}}}const TICK_INTERVAL=100;class StreamController extends BaseStreamController{constructor(e,t,i){super(e,t,i,"[stream-controller]",PlaylistLevelType.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(Events.ERROR,this.onError,this),e.on(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Events.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(Events.ERROR,this.onError,this),e.off(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Events.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(TICK_INTERVAL),this.level=-1,!this.startFragRequested){let e=i.startLevel;-1===e&&(i.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=i.firstAutoLevel),i.nextLoadLevel=e,this.level=i.loadLevel,this.loadedmetadata=!1}t>0&&-1===e&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=State.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case State.WAITING_LEVEL:{const{levels:e,level:t}=this,i=null==e?void 0:e[t],r=null==i?void 0:i.details;if(r&&(!r.live||this.levelLastLoaded===i)){if(this.waitForCdnTuneIn(r))break;this.state=State.IDLE;break}if(this.hls.nextLoadLevel!==this.level){this.state=State.IDLE;break}break}case State.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,i=null==e?void 0:e[t];this.resetStartWhenNotLoaded(i||null),this.state=State.IDLE}}}this.state===State.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:r}=this;if(null===t||!r&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const s=e.nextLoadLevel;if(null==i||!i[s])return;const a=i[s],n=this.getMainFwdBufferInfo();if(null===n)return;const o=this.getLevelDetails();if(o&&this._streamEnded(n,o)){const e={};return this.altAudio&&(e.type="video"),this.hls.trigger(Events.BUFFER_EOS,e),void(this.state=State.ENDED)}e.loadLevel!==s&&-1===e.manualLevel&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=e.nextLoadLevel=s;const l=a.details;if(!l||this.state===State.WAITING_LEVEL||l.live&&this.levelLastLoaded!==a)return this.level=s,void(this.state=State.WAITING_LEVEL);const c=n.len,u=this.getMaxBufferLength(a.maxBitrate);if(c>=u)return;this.backtrackFragment&&this.backtrackFragment.start>n.end&&(this.backtrackFragment=null);const d=this.backtrackFragment?this.backtrackFragment.start:n.end;let h=this.getNextFragment(d,l);if(this.couldBacktrack&&!this.fragPrevious&&h&&"initSegment"!==h.sn&&this.fragmentTracker.getState(h)!==FragmentState.OK){var m;const e=(null!=(m=this.backtrackFragment)?m:h).sn-l.startSN,t=l.fragments[e-1];t&&h.cc===t.cc&&(h=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&n.len&&(this.backtrackFragment=null);if(h&&this.isLoopLoading(h,d)){if(!h.gap){const e=this.audioOnly&&!this.altAudio?ElementaryStreamTypes.AUDIO:ElementaryStreamTypes.VIDEO,t=(e===ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,PlaylistLevelType.MAIN)}h=this.getNextFragmentLoopLoading(h,l,n,PlaylistLevelType.MAIN,u)}h&&(!h.initSegment||h.initSegment.data||this.bitrateTest||(h=h.initSegment),this.loadFragment(h,a,d))}loadFragment(e,t,i){const r=this.fragmentTracker.getState(e);this.fragCurrent=e,r===FragmentState.NOT_LOADED||r===FragmentState.PARTIAL?"initSegment"===e.sn?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,PlaylistLevelType.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let i;const r=this.getAppendedFrag(t.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const s=this.getLevelDetails();if(null!=s&&s.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*s.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],r=this.fragLastKbps;i=r&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*r)+1:0}else i=0;const a=this.getBufferedFrag(t.currentTime+i);if(a){const e=this.followingBufferedFrag(a);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,i=e.duration,r=Math.max(a.end,t+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,i*(this.couldBacktrack?.5:.125)),i*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case State.KEY_LOADING:case State.FRAG_LOADING:case State.FRAG_LOADING_WAITING_RETRY:case State.PARSING:case State.PARSED:this.state=State.IDLE}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new GapController(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;isFiniteNumber(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const i=this.getMainFwdBufferInfo();null!==i&&0!==i.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let i=!1,r=!1;t.levels.forEach((e=>{const t=e.audioCodec;t&&(i=i||-1!==t.indexOf("mp4a.40.2"),r=r||-1!==t.indexOf("mp4a.40.5"))})),this.audioCodecSwitch=i&&r&&!changeTypeSupported(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==State.IDLE)return;const r=i[t.level];(!r.details||r.details.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(r.details))&&(this.state=State.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:r}=this,s=t.level,a=t.details,n=a.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${n}`);const o=r[s],l=this.fragCurrent;!l||this.state!==State.FRAG_LOADING&&this.state!==State.FRAG_LOADING_WAITING_RETRY||l.level!==t.level&&l.loader&&this.abortCurrentFrag();let c=0;if(a.live||null!=(i=o.details)&&i.live){var u;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;c=this.alignPlaylists(a,o.details,null==(u=this.levelLastLoaded)?void 0:u.details)}if(o.details=a,this.levelLastLoaded=o,this.hls.trigger(Events.LEVEL_UPDATED,{details:a,level:s}),this.state===State.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=State.IDLE}this.startFragRequested?a.live&&this.synchronizeToLiveEdge(a):this.setStartPosition(a,c),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:r,payload:s}=e,{levels:a}=this;if(!a)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const n=a[i.level],o=n.details;if(!o)return this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),void this.fragmentTracker.removeFragment(i);const l=n.videoCodec,c=o.PTSKnown||!o.live,u=null==(t=i.initSegment)?void 0:t.data,d=this._getAudioCodec(n),h=this.transmuxer=this.transmuxer||new TransmuxerInterface(this.hls,PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=r?r.index:-1,f=-1!==m,g=new ChunkMetadata(i.level,i.sn,i.stats.chunkCount,s.byteLength,m,f),p=this.initPTS[i.cc];h.push(s,u,d,l,i,r,o.totalduration,c,g,p)}onAudioTrackSwitching(e,t){const i=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const e=this.hls;i&&(e.trigger(Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),e.trigger(Events.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=t.id,r=!!this.hls.audioTracks[i].url;if(r){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=r,this.tick()}onBufferCreated(e,t){const i=t.tracks;let r,s,a=!1;for(const n in i){const e=i[n];if("main"===e.id){if(s=n,r=e,"video"===n){const e=i[n];e&&(this.videoBuffer=e.buffer)}}else a=!0}a&&r?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:r}=t;if(i&&i.type!==PlaylistLevelType.MAIN)return;if(this.fragContextChanged(i))return this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===State.PARSED&&(this.state=State.IDLE));const s=r?r.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,r)}onError(e,t){var i;if(t.fatal)this.state=State.ERROR;else switch(t.details){case ErrorDetails.FRAG_GAP:case ErrorDetails.FRAG_PARSING_ERROR:case ErrorDetails.FRAG_DECRYPT_ERROR:case ErrorDetails.FRAG_LOAD_ERROR:case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_ERROR:case ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(PlaylistLevelType.MAIN,t);break;case ErrorDetails.LEVEL_LOAD_ERROR:case ErrorDetails.LEVEL_LOAD_TIMEOUT:case ErrorDetails.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==State.WAITING_LEVEL||(null==(i=t.context)?void 0:i.type)!==PlaylistContextType.LEVEL||(this.state=State.IDLE);break;case ErrorDetails.BUFFER_APPEND_ERROR:case ErrorDetails.BUFFER_FULL_ERROR:if(!t.parent||"main"!==t.parent)return;if(t.details===ErrorDetails.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case ErrorDetails.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}checkBuffer(){const{media:e,gapController:t}=this;if(e&&t&&e.readyState){if(this.loadedmetadata||!BufferHelper.getBuffered(e).length){const e=this.state!==State.IDLE?this.fragCurrent:null;t.poll(this.lastCurrentTime,e)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){const e=(t===ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(e,t,PlaylistLevelType.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking)return void this.log(`could not seek to ${i}, already seeking at ${t}`);const r=BufferHelper.getBuffered(e),s=(r.length?r.start(0):0)-i;s>0&&(s<this.config.maxBufferHole||s<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${s} to match buffer start`),i+=s,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then((i=>{const{hls:r}=this;if(!i||this.fragContextChanged(e))return;t.fragmentError=0,this.state=State.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const s=e.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),r.trigger(Events.FRAG_LOADED,i),e.bitrateTest=!1}))}_handleTransmuxComplete(e){var t;const i="main",{hls:r}=this,{remuxResult:s,chunkMeta:a}=e,n=this.getCurrentContext(a);if(!n)return void this.resetWhenMissingContext(a);const{frag:o,part:l,level:c}=n,{video:u,text:d,id3:h,initSegment:m}=s,{details:f}=c,g=this.altAudio?void 0:s.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=State.PARSING,m){if(null!=m&&m.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,m.tracks,e,a),r.trigger(Events.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:i,tracks:m.tracks})}const e=m.initPTS,t=m.timescale;isFiniteNumber(e)&&(this.initPTS[o.cc]={baseTime:e,timescale:t},r.trigger(Events.INIT_PTS_FOUND,{frag:o,id:i,initPTS:e,timescale:t}))}if(u&&f&&"initSegment"!==o.sn){const e=f.fragments[o.sn-1-f.startSN],t=o.sn===f.startSN,i=!e||o.cc>e.cc;if(!1!==s.independent){const{startPTS:e,endPTS:r,startDTS:s,endDTS:n}=u;if(l)l.elementaryStreams[u.type]={startPTS:e,endPTS:r,startDTS:s,endDTS:n};else if(u.firstKeyFrame&&u.independent&&1===a.id&&!i&&(this.couldBacktrack=!0),u.dropped&&u.independent){const s=this.getMainFwdBufferInfo(),a=(s?s.end:this.getLoadPosition())+this.config.maxBufferHole,l=u.firstKeyFramePTS?u.firstKeyFramePTS:e;if(!t&&a<l-this.config.maxBufferHole&&!i)return void this.backtrack(o);i&&(o.gap=!0),o.setElementaryStreamInfo(u.type,o.start,r,o.start,n,!0)}else t&&e>MAX_START_GAP_JUMP&&(o.gap=!0);o.setElementaryStreamInfo(u.type,e,r,s,n),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(u,o,l,a,t||i)}else{if(!t&&!i)return void this.backtrack(o);o.gap=!0}}if(g){const{startPTS:e,endPTS:t,startDTS:i,endDTS:r}=g;l&&(l.elementaryStreams[ElementaryStreamTypes.AUDIO]={startPTS:e,endPTS:t,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(ElementaryStreamTypes.AUDIO,e,t,i,r),this.bufferFragmentData(g,o,l,a)}if(f&&null!=h&&null!=(t=h.samples)&&t.length){const e={id:i,frag:o,details:f,samples:h.samples};r.trigger(Events.FRAG_PARSING_METADATA,e)}if(f&&d){const e={id:i,frag:o,details:f,samples:d.samples};r.trigger(Events.FRAG_PARSING_USERDATA,e)}}}_bufferInitSegment(e,t,i,r){if(this.state!==State.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:s,video:a,audiovideo:n}=t;if(s){let t=e.audioCodec;const i=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(t&&(t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==s.metadata.channelCount&&-1===i.indexOf("firefox")&&(t="mp4a.40.5")),t&&-1!==t.indexOf("mp4a.40.5")&&-1!==i.indexOf("android")&&"audio/mpeg"!==s.container&&(t="mp4a.40.2",this.log(`Android: force audio codec to ${t}`)),e.audioCodec&&e.audioCodec!==t&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${t}"`),s.levelCodec=t,s.id="main",this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${t||""}/${e.audioCodec||""}/${s.codec}]`)}a&&(a.levelCodec=e.videoCodec,a.id="main",this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${e.videoCodec||""}/${a.codec}]`)),n&&this.log(`Init audiovideo buffer, container:${n.container}, codecs[level/parsed]=[${e.codecs}/${n.codec}]`),this.hls.trigger(Events.BUFFER_CODECS,t),Object.keys(t).forEach((e=>{const s=t[e].initSegment;null!=s&&s.byteLength&&this.hls.trigger(Events.BUFFER_APPENDING,{type:e,data:s,frag:i,part:null,chunkMeta:r,parent:i.type})})),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,PlaylistLevelType.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=State.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const i=e.currentTime;if(BufferHelper.isBuffered(e,i)?t=this.getAppendedFrag(i):BufferHelper.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,i=t.level;e&&t.sn===e.sn&&e.level===i||(this.fragPlaying=t,this.hls.trigger(Events.FRAG_CHANGED,{frag:t}),e&&e.level===i||this.hls.trigger(Events.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,i=this.currentFrag;if(i&&isFiniteNumber(t)&&isFiniteNumber(i.programDateTime)){const e=i.programDateTime+1e3*(t-i.start);return new Date(e)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class Hls{static get version(){return"1.5.7"}static isMSESupported(){return isMSESupported()}static isSupported(){return isSupported()}static getMediaSource(){return getMediaSource()}static get Events(){return Events}static get ErrorTypes(){return ErrorTypes}static get ErrorDetails(){return ErrorDetails}static get DefaultConfig(){return Hls.defaultConfig?Hls.defaultConfig:hlsDefaultConfig}static set DefaultConfig(e){Hls.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new EventEmitter,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,enableLogs(e.debug||!1,"Hls instance");const t=this.config=mergeConfig(Hls.DefaultConfig,e);this.userConfig=e,t.progressive&&enableStreamingMode(t);const{abrController:i,bufferController:r,capLevelController:s,errorController:a,fpsController:n}=t,o=new a(this),l=this.abrController=new i(this),c=this.bufferController=new r(this),u=this.capLevelController=new s(this),d=new n(this),h=new PlaylistLoader(this),m=new ID3TrackController(this),f=t.contentSteeringController,g=f?new f(this):null,p=this.levelController=new LevelController(this,g),v=new FragmentTracker(this),y=new KeyLoader(this.config),E=this.streamController=new StreamController(this,v,y);u.setStreamController(E),d.setStreamController(E);const T=[h,p,E];g&&T.splice(1,0,g),this.networkControllers=T;const S=[l,c,u,d,m,v];this.audioTrackController=this.createController(t.audioTrackController,T);const _=t.audioStreamController;_&&T.push(new _(this,v,y)),this.subtitleTrackController=this.createController(t.subtitleTrackController,T);const k=t.subtitleStreamController;k&&T.push(new k(this,v,y)),this.createController(t.timelineController,S),y.emeController=this.emeController=this.createController(t.emeController,S),this.cmcdController=this.createController(t.cmcdController,S),this.latencyController=this.createController(LatencyController,S),this.coreComponents=S,T.push(o);const b=o.onErrorOut;"function"==typeof b&&this.on(Events.ERROR,b,o)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,r){this._emitter.off(e,t,i,r)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const t=e===Events.ERROR;this.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.INTERNAL_EXCEPTION,fatal:t,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){logger.log("destroy"),this.trigger(Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((e=>e.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((e=>e.destroy())),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){logger.log("attachMedia"),this._media=e,this.trigger(Events.MEDIA_ATTACHING,{media:e})}detachMedia(){logger.log("detachMedia"),this.trigger(Events.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,r=this.url=urlToolkitExports.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,logger.log(`loadSource:${r}`),t&&i&&(i!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(Events.MANIFEST_LOADING,{url:e})}startLoad(e=-1){logger.log(`startLoad(${e})`),this.started=!0,this.networkControllers.forEach((t=>{t.startLoad(e)}))}stopLoad(){logger.log("stopLoad"),this.started=!1,this.networkControllers.forEach((e=>{e.stopLoad()}))}resumeBuffering(){this.started&&this.networkControllers.forEach((e=>{"fragmentLoader"in e&&e.startLoad(-1)}))}pauseBuffering(){this.networkControllers.forEach((e=>{"fragmentLoader"in e&&e.stopLoad()}))}swapAudioCodec(){logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){logger.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){logger.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){isHdcpLevel(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let r=0;r<i;r++)if(e[r].maxBitrate>=t)return r;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let r;if(r=-1===t&&null!=e&&e.length?e.length-1:t,i)for(let s=r;s--;){const t=e[s].attrs["HDCP-LEVEL"];if(t&&t<=i)return s}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return null==(t=this.audioTrackController)?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return null==(t=this.subtitleTrackController)||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}Hls.defaultConfig=void 0;const _sfc_main$A=vue.defineComponent({__name:"DialogComponent",emits:["onClose"],setup(e,{emit:t}){const i=()=>{t("onClose")};return(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"dialog-wrapper"},[vue.createElementVNode("view",{class:"mask",onClick:i}),vue.createElementVNode("view",{class:"dialog-body-wrapper"},[vue.createElementVNode("view",{class:"dialog-header"},[vue.renderSlot(e.$slots,"header",{},void 0,!0),vue.createElementVNode("image",{class:"icon-close",onClick:i,src:"/static/icon_close.png"})]),vue.renderSlot(e.$slots,"content",{},void 0,!0)])]))}}),DialogComponent=_export_sfc(_sfc_main$A,[["__scopeId","data-v-f81ae447"]]),zerofull=e=>e<9?"0"+e:e,formatTime=e=>{var t=new Date(e),i=new Date;let r=Math.ceil((i.getTime()-t.getTime())/1e3);if(r<60)return"刚刚";if(r<3600)return Math.ceil(r/60)+"分前";if(r<86400)return Math.ceil(r/3600)+"小时前";if(r<2592e3)return Math.ceil(r/86400)+"天前";if(r<31104e3)return Math.ceil(r/2592e3)+"个月前";return`${zerofull(t.getFullYear())}-${zerofull(t.getMonth()+1)}-${zerofull(t.getDate())} ${zerofull(t.getHours())}:${zerofull(t.getMinutes())}:${zerofull(t.getSeconds())}`},formatSecond=(e,t=!1)=>t?`${zerofull(Math.floor(e/3600))}:${zerofull(Math.floor(e%3600/60))}:${zerofull(Math.floor(e%3600%60))}`:`${zerofull(Math.floor(e/60))}:${zerofull(Math.floor(e%60))}`,getMusicCover=e=>/http[s]?:\/\//.test(e)?e.replace("{size}","480"):HOST+e,_sfc_main$z=vue.defineComponent({__name:"CommentComponent",props:{commentList:{type:Object,reqiure:!0,default:{}},relationId:{type:Number,reqiure:!0,default:-1},isShowInput:{type:Boolean,reqiure:!0,default:!1},category:{type:String,reqiure:!0,default:""}},emits:["onSend"],setup(e,{expose:t,emit:i}){const{commentList:r,relationId:s,isShowInput:a,category:n}=e,o=vue.reactive([]),l=vue.ref(!1),c=vue.ref("评论"),u=vue.ref("");let d,h,m=0,f=!1;vue.onMounted((()=>{o.push(...r),formatAppLog("log","at music/components/CommentComponent.vue:75","myCommentList.length"+o.length),l.value=a}));const g=(e,t)=>{d=e,h=t,l.value=!0,c.value=t?`回复${t.username}`:d?`回复${d.username}`:"评论"},p=()=>{if(clearTimeout(m),!u.value||f)return;f=!0;const e={id:0,content:u.value,parentId:(null==h?void 0:h.id)||0,topId:(null==d?void 0:d.id)||0,type:n,relationId:s,createTime:"",updateTime:"",replyCount:0,userId:"",username:"",avater:"",replyUserId:"",replyUserName:"",showCommentCount:"",replyPageNum:0,replyList:[]};insertCommentService(e).then((e=>{formatAppLog("log","at music/components/CommentComponent.vue:130",e.data),u.value="",l.value=a,d?(d.replyList||(d.replyList=[]),d.replyList.push(e.data)):o.push(e.data),d=h=null,c.value="评论",i("onSend")})).finally((()=>{f=!1}))},v=()=>{a||(m&&clearInterval(m),m=setTimeout((()=>{l.value=!1}),100))},y=()=>{};return t({useShowInput:()=>{l.value=!0}}),(t,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"comment-wrapper",style:vue.normalizeStyle({height:e.isShowInput?0:"auto"})},[o.length>0?(vue.openBlock(),vue.createElementBlock("scroll-view",{key:0,class:"comment-list","scroll-y":"",onScrolltolower:y,style:vue.normalizeStyle({height:e.isShowInput?0:"auto"})},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(o,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"comment-item",key:e.id},[vue.createElementVNode("image",{class:"comment-avater",src:vue.unref(HOST)+e.avater},null,8,["src"]),vue.createElementVNode("view",{class:"comment-content-wrapper"},[vue.createElementVNode("text",{class:"comment-username"},vue.toDisplayString(e.username),1),vue.createElementVNode("text",{class:"comment-text",onClick:t=>g(e,e)},vue.toDisplayString(e.content),9,["onClick"]),vue.createElementVNode("text",{class:"comment-time"},vue.toDisplayString(vue.unref(formatTime)(e.createTime)),1),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(e.replyList,(t=>(vue.openBlock(),vue.createElementBlock("view",{class:"comment-item",key:t.id},[vue.createElementVNode("image",{class:"comment-reply-avater",src:vue.unref(HOST)+t.avater},null,8,["src"]),vue.createElementVNode("view",{class:"comment-content-wrapper"},[vue.createElementVNode("text",{class:"comment-username"},vue.toDisplayString(t.username)+"▶"+vue.toDisplayString(t.replyUserName),1),vue.createElementVNode("text",{class:"comment-text",onClick:i=>g(e,t)},vue.toDisplayString(t.content),9,["onClick"]),vue.createElementVNode("text",{class:"comment-time"},vue.toDisplayString(vue.unref(formatTime)(t.createTime)),1)])])))),128))])])))),128))],36)):(vue.openBlock(),vue.createElementBlock("text",{key:1,class:"no-data"},"暂无评论")),e.isShowInput||l.value?(vue.openBlock(),vue.createElementBlock("view",{key:2,class:"input-wrapper",style:vue.normalizeStyle({position:e.isShowInput?"relative":"fixed"})},[vue.withDirectives(vue.createElementVNode("input",{"onUpdate:modelValue":i[0]||(i[0]=e=>u.value=e),class:"input",onBlur:v,placeholder:c.value},null,40,["placeholder"]),[[vue.vModelText,u.value]]),vue.createElementVNode("text",{class:"btn-send",onClick:p},"发送")],4)):vue.createCommentVNode("",!0)],4))}}),CommentComponent=_export_sfc(_sfc_main$z,[["__scopeId","data-v-2cb9d539"]]),_sfc_main$y=vue.defineComponent({__name:"MoviePlayPage",setup(e){const t=vue.reactive({}),i=vue.ref(""),r=vue.ref(0),s=vue.ref(!1),a=vue.reactive([]),n=vue.ref(0),o=vue.reactive([]),l=vue.reactive([]),c=vue.ref(!1);let u;const d=useRoute(),h=decodeURIComponent(d.query.data);Object.assign(t,JSON.parse(h)),t.id=72667,getCommentCountService(t.id,CommentEnum.MOVIE).then((e=>{r.value=e.data})),getMovieUrlService(t.id).then((e=>{e.data.forEach(((e,t)=>{0==t&&(i.value=e.url);const r=a.findIndex((t=>t[0].playGroup===e.playGroup));-1!=r?a[r].push(e):a.push([e])}))})),getRecommentListService(t.classify).then((e=>{o.push(...e.data)})),isFavoriteService(t.id).then((e=>{s.value=e.data>0}));const m=()=>{saveFavoriteService(t.id).then((e=>{s.value=e.data>0}))},f=()=>{deleteFavoriteService(t.id).then((e=>{s.value=!(e.data>0)}))},g=()=>{getCommentCountService(t.id,CommentEnum.MUSIC).then((e=>r.value=e.data))},p=()=>{getTopCommentListService(t.id,CommentEnum.MOVIE,1,20).then((e=>{l.splice(0,l.length,...e.data),c.value=!0}))};return savePlayRecordService(t),vue.onMounted((()=>{/\.m3u8/.test(i.value)&&(u=new MuiPlayer({container:document.getElementById("player"),src:i.value.replace(/^http.+url=/,""),parse:{type:"hls",loader:Hls,config:{cors:!0}}}))})),vue.onUnmounted((()=>{null==u||u.destroy()})),(e,u)=>{var d;return vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createElementVNode("scroll-view",{"scroll-y":""},[/\.m3u8$/.test(i.value)?(vue.openBlock(),vue.createElementBlock("div",{key:0,id:"player",class:"play-webview"})):vue.createCommentVNode("",!0),vue.createElementVNode("web-view",{class:"play-webview",src:i.value},null,8,["src"]),vue.createElementVNode("view",{class:"section-wrapper"},[vue.createElementVNode("view",{class:"module-block row"},[vue.createElementVNode("image",{onClick:p,class:"icon-middle",src:"/static/icon_comment.png"}),vue.createElementVNode("text",{class:"comment-count small-margin"},vue.toDisplayString(r.value),1),s.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"icon-middle",onClick:f,src:"/static/icon_collection_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"icon-middle",onClick:m,src:"/static/icon_collection.png"})),vue.createElementVNode("image",{class:"icon-middle small-margin",src:"/static/icon_share.png"})]),vue.createElementVNode("view",{class:"module-block column"},[vue.createElementVNode("text",{class:"movieName"},vue.toDisplayString(t.movieName),1),vue.createElementVNode("text",{class:"sub-title"},vue.toDisplayString(t.star),1),t.description?(vue.openBlock(),vue.createElementBlock("text",{key:0,class:"sub-title"},vue.toDisplayString(null==(d=t.description)?void 0:d.replace(/\n|\s/g,"")),1)):vue.createCommentVNode("",!0),vue.createVNode(ScoreComponent,{score:t.score},null,8,["score"])]),vue.createElementVNode("view",{class:"module-block"},[vue.createElementVNode("scroll-view",{"scroll-x":""},[vue.createElementVNode("view",{class:"play-group-wrapper"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a,((e,t)=>(vue.openBlock(),vue.createElementBlock("text",{onClick:e=>(e=>{n.value=e})(t),class:vue.normalizeClass(["group-text",{"group-text-active":n.value===t}]),key:"playGround"+t},vue.toDisplayString(e[0].playGroup),11,["onClick"])))),128))])]),vue.createElementVNode("view",{class:"grid-wrapper"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a[n.value],((e,t)=>(vue.openBlock(),vue.createElementBlock("text",{class:vue.normalizeClass(["grid-item",{"grid-item-active":i.value===e.url}]),key:e.id},vue.toDisplayString(e.label),3)))),128))])]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(TitleComponent,{title:"推荐"}),vue.createVNode(MovieListComponent,{direction:"horizontal",list:o},null,8,["list"])])])]),c.value?(vue.openBlock(),vue.createBlock(DialogComponent,{key:0,onOnClose:u[0]||(u[0]=e=>c.value=!1)},{header:vue.withCtx((()=>[vue.createElementVNode("text",{class:"comment-header"},vue.toDisplayString(r.value)+"条评论",1)])),content:vue.withCtx((()=>[vue.createVNode(CommentComponent,{onOnSend:g,isShowInput:!0,relationId:t.id,category:vue.unref(CommentEnum).MOVIE,commentList:l},null,8,["relationId","category","commentList"])])),_:1})):vue.createCommentVNode("",!0)])}}}),_sfc_main$x={name:"uniPopup",components:{},emits:["change","maskClick"],props:{animation:{type:Boolean,default:!0},type:{type:String,default:"center"},isMaskClick:{type:Boolean,default:null},maskClick:{type:Boolean,default:null},backgroundColor:{type:String,default:"none"},safeArea:{type:Boolean,default:!0},maskBackgroundColor:{type:String,default:"rgba(0, 0, 0, 0.4)"}},watch:{type:{handler:function(e){this.config[e]&&this[this.config[e]](!0)},immediate:!0},isDesktop:{handler:function(e){this.config[e]&&this[this.config[this.type]](!0)},immediate:!0},maskClick:{handler:function(e){this.mkclick=e},immediate:!0},isMaskClick:{handler:function(e){this.mkclick=e},immediate:!0},showPopup(e){}},data:()=>({duration:300,ani:[],showPopup:!1,showTrans:!1,popupWidth:0,popupHeight:0,config:{top:"top",bottom:"bottom",center:"center",left:"left",right:"right",message:"top",dialog:"center",share:"bottom"},maskClass:{position:"fixed",bottom:0,top:0,left:0,right:0,backgroundColor:"rgba(0, 0, 0, 0.4)"},transClass:{position:"fixed",left:0,right:0},maskShow:!0,mkclick:!0,popupstyle:"top"}),computed:{isDesktop(){return this.popupWidth>=500&&this.popupHeight>=500},bg(){return""===this.backgroundColor||"none"===this.backgroundColor?"transparent":this.backgroundColor}},mounted(){(()=>{const{windowWidth:e,windowHeight:t,windowTop:i,safeArea:r,screenHeight:s,safeAreaInsets:a}=uni.getSystemInfoSync();this.popupWidth=e,this.popupHeight=t+(i||0),r&&this.safeArea?this.safeAreaInsets=a.bottom:this.safeAreaInsets=0})()},unmounted(){this.setH5Visible()},created(){null===this.isMaskClick&&null===this.maskClick?this.mkclick=!0:this.mkclick=null!==this.isMaskClick?this.isMaskClick:this.maskClick,this.animation?this.duration=300:this.duration=0,this.messageChild=null,this.clearPropagation=!1,this.maskClass.backgroundColor=this.maskBackgroundColor},methods:{setH5Visible(){},closeMask(){this.maskShow=!1},disableMask(){this.mkclick=!1},clear(e){e.stopPropagation(),this.clearPropagation=!0},open(e){if(this.showPopup)return;e&&-1!==["top","center","bottom","left","right","message","dialog","share"].indexOf(e)||(e=this.type),this.config[e]?(this[this.config[e]](),this.$emit("change",{show:!0,type:e})):console.error("缺少类型：",e)},close(e){this.showTrans=!1,this.$emit("change",{show:!1,type:this.type}),clearTimeout(this.timer),this.timer=setTimeout((()=>{this.showPopup=!1}),300)},touchstart(){this.clearPropagation=!1},onTap(){this.clearPropagation?this.clearPropagation=!1:(this.$emit("maskClick"),this.mkclick&&this.close())},top(e){this.popupstyle=this.isDesktop?"fixforpc-top":"top",this.ani=["slide-top"],this.transClass={position:"fixed",left:0,right:0,backgroundColor:this.bg},e||(this.showPopup=!0,this.showTrans=!0,this.$nextTick((()=>{this.messageChild&&"message"===this.type&&this.messageChild.timerClose()})))},bottom(e){this.popupstyle="bottom",this.ani=["slide-bottom"],this.transClass={position:"fixed",left:0,right:0,bottom:0,paddingBottom:this.safeAreaInsets+"px",backgroundColor:this.bg},e||(this.showPopup=!0,this.showTrans=!0)},center(e){this.popupstyle="center",this.ani=["zoom-out","fade"],this.transClass={position:"fixed",display:"flex",flexDirection:"column",bottom:0,left:0,right:0,top:0,justifyContent:"center",alignItems:"center"},e||(this.showPopup=!0,this.showTrans=!0)},left(e){this.popupstyle="left",this.ani=["slide-left"],this.transClass={position:"fixed",left:0,bottom:0,top:0,backgroundColor:this.bg,display:"flex",flexDirection:"column"},e||(this.showPopup=!0,this.showTrans=!0)},right(e){this.popupstyle="right",this.ani=["slide-right"],this.transClass={position:"fixed",bottom:0,right:0,top:0,backgroundColor:this.bg,display:"flex",flexDirection:"column"},e||(this.showPopup=!0,this.showTrans=!0)}}};function _sfc_render$6(e,t,i,r,s,a){const n=vue.resolveComponent("uni-transition");return s.showPopup?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:vue.normalizeClass(["uni-popup",[s.popupstyle,a.isDesktop?"fixforpc-z-index":""]])},[vue.createElementVNode("view",{onTouchstart:t[1]||(t[1]=(...e)=>a.touchstart&&a.touchstart(...e))},[s.maskShow?(vue.openBlock(),vue.createBlock(n,{key:"1",name:"mask","mode-class":"fade",styles:s.maskClass,duration:s.duration,show:s.showTrans,onClick:a.onTap},null,8,["styles","duration","show","onClick"])):vue.createCommentVNode("",!0),vue.createVNode(n,{key:"2","mode-class":s.ani,name:"content",styles:s.transClass,duration:s.duration,show:s.showTrans,onClick:a.onTap},{default:vue.withCtx((()=>[vue.createElementVNode("view",{class:vue.normalizeClass(["uni-popup__wrapper",[s.popupstyle]]),style:vue.normalizeStyle({backgroundColor:a.bg}),onClick:t[0]||(t[0]=(...e)=>a.clear&&a.clear(...e))},[vue.renderSlot(e.$slots,"default",{},void 0,!0)],6)])),_:3},8,["mode-class","styles","duration","show","onClick"])],32)],2)):vue.createCommentVNode("",!0)}const uniPopup=_export_sfc(_sfc_main$x,[["render",_sfc_render$6],["__scopeId","data-v-5d7a61ee"]]),_sfc_main$w=vue.defineComponent({__name:"OptionsDialog",props:{options:{type:Array,reqiure:!0,default:[]}},emits:["onCheck"],setup(e,{emit:t}){const i=vue.ref(null),r=()=>{var e;null==(e=i.value)||e.close()};return(s,a)=>(vue.openBlock(),vue.createBlock(uniPopup,{ref_key:"popup",ref:i,class:"popup-wrapper",type:"dialog"},{default:vue.withCtx((()=>[vue.createElementVNode("view",{class:"dialog-wrapper sex-dialog-wrapper"},[vue.createElementVNode("view",{class:"option-wrapper"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(e.options,((e,r)=>(vue.openBlock(),vue.createElementBlock("text",{class:"option-item",key:e+""+r,onClick:r=>{return s=e.value,null==(a=i.value)||a.close(),void t("onCheck",s);var s,a}},[vue.renderSlot(s.$slots,r,{},(()=>[vue.createTextVNode(vue.toDisplayString(e.text),1)]),!0)],8,["onClick"])))),128))]),vue.createElementVNode("view",{class:"option-btn",onClick:r},"取消")])])),_:3},512))}}),OptionsDialog=_export_sfc(_sfc_main$w,[["__scopeId","data-v-fc8f5182"]]),SexMap={0:"男",1:"女"},PermissionMap={0:"私密",1:"公开"},_sfc_main$v=vue.defineComponent({__name:"MovieUserPage",setup(e){const t=vue.ref(""),i=vue.ref(""),r=vue.ref(null),s=vue.ref(null),a=vue.ref(""),n=useStore(),o=(e,s)=>{var o;t.value=e,i.value=s,a.value=n.userData[s],null==(o=r.value)||o.open("top")},l=()=>{var e;null==(e=r.value)||e.close()},c=e=>{const t={...n.userData};t.sex=e,updateUserDataService(t).then((e=>{n.setUserData(t)}))},u=()=>{uni.showModal({title:"提示",content:"是否退出登录",success:e=>{e.confirm?(uni.setStorageSync("token",""),uni.reLaunch({url:"../pages/MovieLoginPage"})):e.cancel&&formatAppLog("log","at movie/pages/MovieUserPage.vue:135","用户点击取消")}})},d=()=>{const e={...n.userData};e[i.value]=a.value,updateUserDataService(e).then((t=>{var i;n.setUserData(e),null==(i=r.value)||i.close()}))},h=()=>{var e;null==(e=s.value)||e.$refs.popup.open("top")};return(e,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createElementVNode("view",{class:"module-block"},[vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("text",{class:"text"},"头像"),vue.createElementVNode("image",{class:"big-avater",src:vue.unref(n).userData.avater?vue.unref(HOST)+vue.unref(n).userData.avater:vue.unref(defaulAvater)},null,8,["src"]),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row",onClick:i[0]||(i[0]=e=>o("昵称","username"))},[vue.createElementVNode("text",{class:"text"},"昵称"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(n).userData.username),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row",onClick:h},[vue.createElementVNode("text",{class:"text"},"性别"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(SexMap)[vue.unref(n).userData.sex]||""),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row",onClick:i[1]||(i[1]=e=>o("电话","telephone"))},[vue.createElementVNode("text",{class:"text"},"电话"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(n).userData.telephone),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row",onClick:i[2]||(i[2]=e=>o("邮箱","email"))},[vue.createElementVNode("text",{class:"text"},"邮箱"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(n).userData.email),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("text",{class:"text"},"生日"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(n).userData.birthday),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row",onClick:i[3]||(i[3]=e=>o("电话","region"))},[vue.createElementVNode("text",{class:"text"},"区域"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(n).userData.region),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})]),vue.createElementVNode("view",{class:"row last-row",onClick:i[4]||(i[4]=e=>o("个性签名","sign"))},[vue.createElementVNode("text",{class:"text"},"个性签名"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(n).userData.sign),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})])]),vue.createElementVNode("button",{class:"btn-logout",onClick:u},"退出登录"),vue.createVNode(uniPopup,{ref_key:"popup1",ref:r,class:"popup-wrapper",type:"dialog"},{default:vue.withCtx((()=>[vue.createElementVNode("view",{class:"dialog-wrapper"},[vue.createElementVNode("view",{class:"dialog-box"},[vue.createElementVNode("view",{class:"dialog-header"},[vue.createElementVNode("text",null,"请输入")]),vue.createElementVNode("view",{class:"dialog-content"},[vue.createElementVNode("view",{class:"field-text"},vue.toDisplayString(t.value)+":",1),vue.withDirectives(vue.createElementVNode("input",{class:"text-input","onUpdate:modelValue":i[5]||(i[5]=e=>a.value=e)},null,512),[[vue.vModelText,a.value]])]),vue.createElementVNode("view",{class:"dialog-btn"},[vue.createElementVNode("view",{class:"btn-cancle",onClick:l},"取消"),vue.createElementVNode("view",{class:"btn-sure",onClick:d},"确定")])])])])),_:1},512),vue.createVNode(vue.unref(OptionsDialog),{ref_key:"sexOptionsDialog",ref:s,onOnCheck:c,options:[{value:0,text:"男"},{value:1,text:"女"}]},null,512)]))}}),_sfc_main$u=vue.defineComponent({__name:"MovieLoginPage",setup(e){const t=vue.ref(""),i=vue.ref("123456"),r=useStore();t.value=r.userData.userId||"吴时吴刻",uni.getStorage({key:t.value}).then((e=>{i.value=e.data||"123456"}));const s=()=>{t.value.trim()?i.value.trim()?loginService(t.value,i.value).then((e=>{uni.setStorage({key:t.value,data:i.value}),r.setUserData(e.data),r.setToken(e.token),uni.setStorage({key:"token",data:e.token}),httpRequest.setToken(e.token),uni.navigateTo({url:"../pages/IndexPage"}),uni.reLaunch({url:"../pages/IndexPage"}),uni.showToast({duration:2e3,position:"center",title:"登录成功"})})).catch((()=>{uni.showToast({duration:2e3,position:"center",title:"账号或密码错误"})})):uni.showToast({duration:2e3,position:"center",title:"密码不能为空"}):uni.showToast({duration:2e3,position:"center",title:"账号不能为空"})},a=()=>{uni.navigateTo({url:"../pages/MovieRegisterPage"})};return(e,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createElementVNode("view",{class:"module-block module-block-column"},[vue.createElementVNode("image",{src:"/static/icon_logo.png",class:"icon-logo"}),vue.createElementVNode("view",{class:"login-input-wrapper"},[vue.createElementVNode("image",{src:"/static/icon_user_active.png",class:"icon-login"}),vue.withDirectives(vue.createElementVNode("input",{"onUpdate:modelValue":r[0]||(r[0]=e=>t.value=e),class:"login-input",placeholder:"请输入账号"},null,512),[[vue.vModelText,t.value]])]),vue.createElementVNode("view",{class:"login-input-wrapper"},[vue.createElementVNode("image",{src:"/static/icon_user_active.png",class:"icon-login"}),vue.withDirectives(vue.createElementVNode("input",{type:"password","onUpdate:modelValue":r[1]||(r[1]=e=>i.value=e),class:"login-input",placeholder:"请输入密码"},null,512),[[vue.vModelText,i.value]])]),vue.createElementVNode("view",{class:"login-btn",onClick:s},"登录"),vue.createElementVNode("view",{class:"register-btn",onClick:a},"注册")])]))}}),MoviePagesMovieLoginPage=_export_sfc(_sfc_main$u,[["__scopeId","data-v-73475ea1"]]);let Calendar$1=class{constructor({selected:e,startDate:t,endDate:i,range:r}={}){this.date=this.getDateObj(new Date),this.selected=e||[],this.startDate=t,this.endDate=i,this.range=r,this.cleanMultipleStatus(),this.weeks={},this.lastHover=!1}setDate(e){const t=this.getDateObj(e);this.getWeeks(t.fullDate)}cleanMultipleStatus(){this.multipleStatus={before:"",after:"",data:[]}}setStartDate(e){this.startDate=e}setEndDate(e){this.endDate=e}getPreMonthObj(e){e=fixIosDateFormat(e);const t=(e=new Date(e)).getMonth();e.setMonth(t-1);const i=e.getMonth();return 0!==t&&i-t==0&&e.setMonth(i-1),this.getDateObj(e)}getNextMonthObj(e){e=fixIosDateFormat(e);const t=(e=new Date(e)).getMonth();e.setMonth(t+1);const i=e.getMonth();return i-t>1&&e.setMonth(i-1),this.getDateObj(e)}getDateObj(e){return e=fixIosDateFormat(e),{fullDate:getDate(e=new Date(e)),year:e.getFullYear(),month:addZero(e.getMonth()+1),date:addZero(e.getDate()),day:e.getDay()}}getPreMonthDays(e,t){const i=[];for(let r=e-1;r>=0;r--){const e=t.month-1;i.push({date:new Date(t.year,e,-r).getDate(),month:e,disable:!0})}return i}getCurrentMonthDays(e,t){const i=[],r=this.date.fullDate;for(let s=1;s<=e;s++){const e=`${t.year}-${t.month}-${addZero(s)}`,a=r===e,n=this.selected&&this.selected.find((t=>{if(this.dateEqual(e,t.date))return t}));this.startDate&&dateCompare(this.startDate,e),this.endDate&&dateCompare(e,this.endDate);let o=this.multipleStatus.data,l=-1;this.range&&o&&(l=o.findIndex((t=>this.dateEqual(t,e))));const c=-1!==l;i.push({fullDate:e,year:t.year,date:s,multiple:!!this.range&&c,beforeMultiple:this.isLogicBefore(e,this.multipleStatus.before,this.multipleStatus.after),afterMultiple:this.isLogicAfter(e,this.multipleStatus.before,this.multipleStatus.after),month:t.month,disable:this.startDate&&!dateCompare(this.startDate,e)||this.endDate&&!dateCompare(e,this.endDate),isToday:a,userChecked:!1,extraInfo:n})}return i}_getNextMonthDays(e,t){const i=[],r=t.month+1;for(let s=1;s<=e;s++)i.push({date:s,month:r,disable:!0});return i}getInfo(e){return e||(e=new Date),this.calendar.find((t=>t.fullDate===this.getDateObj(e).fullDate))}dateEqual(e,t){return e=new Date(fixIosDateFormat(e)),t=new Date(fixIosDateFormat(t)),e.valueOf()===t.valueOf()}isLogicBefore(e,t,i){let r=t;return t&&i&&(r=dateCompare(t,i)?t:i),this.dateEqual(r,e)}isLogicAfter(e,t,i){let r=i;return t&&i&&(r=dateCompare(t,i)?i:t),this.dateEqual(r,e)}geDateAll(e,t){var i=[],r=e.split("-"),s=t.split("-"),a=new Date;a.setFullYear(r[0],r[1]-1,r[2]);var n=new Date;n.setFullYear(s[0],s[1]-1,s[2]);for(var o=a.getTime()-864e5,l=n.getTime()-864e5,c=o;c<=l;)c+=864e5,i.push(this.getDateObj(new Date(parseInt(c))).fullDate);return i}setMultiple(e){if(!this.range)return;let{before:t,after:i}=this.multipleStatus;if(t&&i){if(!this.lastHover)return void(this.lastHover=!0);this.multipleStatus.before=e,this.multipleStatus.after="",this.multipleStatus.data=[],this.multipleStatus.fulldate="",this.lastHover=!1}else t?(this.multipleStatus.after=e,dateCompare(this.multipleStatus.before,this.multipleStatus.after)?this.multipleStatus.data=this.geDateAll(this.multipleStatus.before,this.multipleStatus.after):this.multipleStatus.data=this.geDateAll(this.multipleStatus.after,this.multipleStatus.before),this.lastHover=!0):(this.multipleStatus.before=e,this.lastHover=!1);this.getWeeks(e)}setHoverMultiple(e){if(!this.range||this.lastHover)return;const{before:t}=this.multipleStatus;t?(this.multipleStatus.after=e,dateCompare(this.multipleStatus.before,this.multipleStatus.after)?this.multipleStatus.data=this.geDateAll(this.multipleStatus.before,this.multipleStatus.after):this.multipleStatus.data=this.geDateAll(this.multipleStatus.after,this.multipleStatus.before)):this.multipleStatus.before=e,this.getWeeks(e)}setDefaultMultiple(e,t){this.multipleStatus.before=e,this.multipleStatus.after=t,e&&t&&(dateCompare(e,t)?(this.multipleStatus.data=this.geDateAll(e,t),this.getWeeks(t)):(this.multipleStatus.data=this.geDateAll(t,e),this.getWeeks(e)))}getWeeks(e){const{year:t,month:i}=this.getDateObj(e),r=new Date(t,i-1,1).getDay(),s=this.getPreMonthDays(r,this.getDateObj(e)),a=new Date(t,i,0).getDate(),n=42-r-a,o=[...s,...this.getCurrentMonthDays(a,this.getDateObj(e)),...this._getNextMonthDays(n,this.getDateObj(e))],l=new Array(6);for(let c=0;c<o.length;c++){const e=Math.floor(c/7);l[e]||(l[e]=new Array(7)),l[e][c%7]=o[c]}this.calendar=o,this.weeks=l}};function getDateTime(e,t){return`${getDate(e)} ${getTime(e,t)}`}function getDate(e){e=fixIosDateFormat(e);const t=(e=new Date(e)).getFullYear(),i=e.getMonth()+1,r=e.getDate();return`${t}-${addZero(i)}-${addZero(r)}`}function getTime(e,t){e=fixIosDateFormat(e);const i=(e=new Date(e)).getHours(),r=e.getMinutes(),s=e.getSeconds();return t?`${addZero(i)}:${addZero(r)}`:`${addZero(i)}:${addZero(r)}:${addZero(s)}`}function addZero(e){return e<10&&(e=`0${e}`),e}function getDefaultSecond(e){return e?"00:00":"00:00:00"}function dateCompare(e,t){return(e=new Date(fixIosDateFormat(e)))<=(t=new Date(fixIosDateFormat(t)))}function checkDate(e){return e.match(/((19|20)\d{2})(-|\/)\d{1,2}(-|\/)\d{1,2}/g)}const dateTimeReg=/^\d{4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])( [0-5]?[0-9]:[0-5]?[0-9]:[0-5]?[0-9])?$/;function fixIosDateFormat(e){return"string"==typeof e&&dateTimeReg.test(e)&&(e=e.replace(/-/g,"/")),e}const _sfc_main$t={props:{weeks:{type:Object,default:()=>({})},calendar:{type:Object,default:()=>({})},selected:{type:Array,default:()=>[]},checkHover:{type:Boolean,default:!1}},methods:{choiceDate(e){this.$emit("change",e)},handleMousemove(e){this.$emit("handleMouse",e)}}};function _sfc_render$5(e,t,i,r,s,a){return vue.openBlock(),vue.createElementBlock("view",{class:vue.normalizeClass(["uni-calendar-item__weeks-box",{"uni-calendar-item--disable":i.weeks.disable,"uni-calendar-item--before-checked-x":i.weeks.beforeMultiple,"uni-calendar-item--multiple":i.weeks.multiple,"uni-calendar-item--after-checked-x":i.weeks.afterMultiple}]),onClick:t[0]||(t[0]=e=>a.choiceDate(i.weeks)),onMouseenter:t[1]||(t[1]=e=>a.handleMousemove(i.weeks))},[vue.createElementVNode("view",{class:vue.normalizeClass(["uni-calendar-item__weeks-box-item",{"uni-calendar-item--checked":i.calendar.fullDate===i.weeks.fullDate&&(i.calendar.userChecked||!i.checkHover),"uni-calendar-item--checked-range-text":i.checkHover,"uni-calendar-item--before-checked":i.weeks.beforeMultiple,"uni-calendar-item--multiple":i.weeks.multiple,"uni-calendar-item--after-checked":i.weeks.afterMultiple,"uni-calendar-item--disable":i.weeks.disable}])},[i.selected&&i.weeks.extraInfo?(vue.openBlock(),vue.createElementBlock("text",{key:0,class:"uni-calendar-item__weeks-box-circle"})):vue.createCommentVNode("",!0),vue.createElementVNode("text",{class:"uni-calendar-item__weeks-box-text uni-calendar-item__weeks-box-text-disable uni-calendar-item--checked-text"},vue.toDisplayString(i.weeks.date),1)],2),vue.createElementVNode("view",{class:vue.normalizeClass({"uni-calendar-item--today":i.weeks.isToday})},null,2)],34)}const calendarItem=_export_sfc(_sfc_main$t,[["render",_sfc_render$5],["__scopeId","data-v-6e247954"]]),isObject=e=>null!==e&&"object"==typeof e,defaultDelimiters=["{","}"];class BaseFormatter{constructor(){this._caches=Object.create(null)}interpolate(e,t,i=defaultDelimiters){if(!t)return[e];let r=this._caches[e];return r||(r=parse(e,i),this._caches[e]=r),compile(r,t)}}const RE_TOKEN_LIST_VALUE=/^(?:\d)+/,RE_TOKEN_NAMED_VALUE=/^(?:\w)+/;function parse(e,[t,i]){const r=[];let s=0,a="";for(;s<e.length;){let n=e[s++];if(n===t){a&&r.push({type:"text",value:a}),a="";let t="";for(n=e[s++];void 0!==n&&n!==i;)t+=n,n=e[s++];const o=n===i,l=RE_TOKEN_LIST_VALUE.test(t)?"list":o&&RE_TOKEN_NAMED_VALUE.test(t)?"named":"unknown";r.push({value:t,type:l})}else a+=n}return a&&r.push({type:"text",value:a}),r}function compile(e,t){const i=[];let r=0;const s=Array.isArray(t)?"list":isObject(t)?"named":"unknown";if("unknown"===s)return i;for(;r<e.length;){const a=e[r];switch(a.type){case"text":i.push(a.value);break;case"list":i.push(t[parseInt(a.value,10)]);break;case"named":"named"===s&&i.push(t[a.value])}r++}return i}const LOCALE_ZH_HANS="zh-Hans",LOCALE_ZH_HANT="zh-Hant",LOCALE_EN="en",LOCALE_FR="fr",LOCALE_ES="es",hasOwnProperty=Object.prototype.hasOwnProperty,hasOwn=(e,t)=>hasOwnProperty.call(e,t),defaultFormatter=new BaseFormatter;function include(e,t){return!!t.find((t=>-1!==e.indexOf(t)))}function startsWith(e,t){return t.find((t=>0===e.indexOf(t)))}function normalizeLocale(e,t){if(!e)return;if(e=e.trim().replace(/_/g,"-"),t&&t[e])return e;if("chinese"===(e=e.toLowerCase()))return LOCALE_ZH_HANS;if(0===e.indexOf("zh"))return e.indexOf("-hans")>-1?LOCALE_ZH_HANS:e.indexOf("-hant")>-1||include(e,["-tw","-hk","-mo","-cht"])?LOCALE_ZH_HANT:LOCALE_ZH_HANS;let i=[LOCALE_EN,LOCALE_FR,LOCALE_ES];t&&Object.keys(t).length>0&&(i=Object.keys(t));const r=startsWith(e,i);return r||void 0}class I18n{constructor({locale:e,fallbackLocale:t,messages:i,watcher:r,formater:s}){this.locale=LOCALE_EN,this.fallbackLocale=LOCALE_EN,this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=s||defaultFormatter,this.messages=i||{},this.setLocale(e||LOCALE_EN),r&&this.watchLocale(r)}setLocale(e){const t=this.locale;this.locale=normalizeLocale(e,this.messages)||this.fallbackLocale,this.messages[this.locale]||(this.messages[this.locale]={}),this.message=this.messages[this.locale],t!==this.locale&&this.watchers.forEach((e=>{e(this.locale,t)}))}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}add(e,t,i=!0){const r=this.messages[e];r?i?Object.assign(r,t):Object.keys(t).forEach((e=>{hasOwn(r,e)||(r[e]=t[e])})):this.messages[e]=t}f(e,t,i){return this.formater.interpolate(e,t,i).join("")}t(e,t,i){let r=this.message;return"string"==typeof t?(t=normalizeLocale(t,this.messages))&&(r=this.messages[t]):i=t,hasOwn(r,e)?this.formater.interpolate(r[e],i).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function watchAppLocale(e,t){e.$watchLocale?e.$watchLocale((e=>{t.setLocale(e)})):e.$watch((()=>e.$locale),(e=>{t.setLocale(e)}))}function getDefaultLocale(){return"undefined"!=typeof uni&&uni.getLocale?uni.getLocale():"undefined"!=typeof global&&global.getLocale?global.getLocale():LOCALE_EN}function initVueI18n(e,t={},i,r){"string"!=typeof e&&([e,t]=[t,e]),"string"!=typeof e&&(e=getDefaultLocale()),"string"!=typeof i&&(i="undefined"!=typeof __uniConfig&&__uniConfig.fallbackLocale||LOCALE_EN);const s=new I18n({locale:e,fallbackLocale:i,messages:t,watcher:r});let a=(e,t)=>{if("function"!=typeof getApp)a=function(e,t){return s.t(e,t)};else{let e=!1;a=function(t,i){const r=getApp().$vm;return r&&(r.$locale,e||(e=!0,watchAppLocale(r,s))),s.t(t,i)}}return a(e,t)};return{i18n:s,f:(e,t,i)=>s.f(e,t,i),t:(e,t)=>a(e,t),add:(e,t,i=!0)=>s.add(e,t,i),watch:e=>s.watchLocale(e),getLocale:()=>s.getLocale(),setLocale:e=>s.setLocale(e)}}const en={"uni-datetime-picker.selectDate":"select date","uni-datetime-picker.selectTime":"select time","uni-datetime-picker.selectDateTime":"select date and time","uni-datetime-picker.startDate":"start date","uni-datetime-picker.endDate":"end date","uni-datetime-picker.startTime":"start time","uni-datetime-picker.endTime":"end time","uni-datetime-picker.ok":"ok","uni-datetime-picker.clear":"clear","uni-datetime-picker.cancel":"cancel","uni-datetime-picker.year":"-","uni-datetime-picker.month":"","uni-calender.MON":"MON","uni-calender.TUE":"TUE","uni-calender.WED":"WED","uni-calender.THU":"THU","uni-calender.FRI":"FRI","uni-calender.SAT":"SAT","uni-calender.SUN":"SUN","uni-calender.confirm":"confirm"},zhHans={"uni-datetime-picker.selectDate":"选择日期","uni-datetime-picker.selectTime":"选择时间","uni-datetime-picker.selectDateTime":"选择日期时间","uni-datetime-picker.startDate":"开始日期","uni-datetime-picker.endDate":"结束日期","uni-datetime-picker.startTime":"开始时间","uni-datetime-picker.endTime":"结束时间","uni-datetime-picker.ok":"确定","uni-datetime-picker.clear":"清除","uni-datetime-picker.cancel":"取消","uni-datetime-picker.year":"年","uni-datetime-picker.month":"月","uni-calender.SUN":"日","uni-calender.MON":"一","uni-calender.TUE":"二","uni-calender.WED":"三","uni-calender.THU":"四","uni-calender.FRI":"五","uni-calender.SAT":"六","uni-calender.confirm":"确认"},zhHant={"uni-datetime-picker.selectDate":"選擇日期","uni-datetime-picker.selectTime":"選擇時間","uni-datetime-picker.selectDateTime":"選擇日期時間","uni-datetime-picker.startDate":"開始日期","uni-datetime-picker.endDate":"結束日期","uni-datetime-picker.startTime":"開始时间","uni-datetime-picker.endTime":"結束时间","uni-datetime-picker.ok":"確定","uni-datetime-picker.clear":"清除","uni-datetime-picker.cancel":"取消","uni-datetime-picker.year":"年","uni-datetime-picker.month":"月","uni-calender.SUN":"日","uni-calender.MON":"一","uni-calender.TUE":"二","uni-calender.WED":"三","uni-calender.THU":"四","uni-calender.FRI":"五","uni-calender.SAT":"六","uni-calender.confirm":"確認"},i18nMessages={en:en,"zh-Hans":zhHans,"zh-Hant":zhHant},{t:t$2}=initVueI18n(i18nMessages),_sfc_main$s={name:"UniDatetimePicker",data:()=>({indicatorStyle:"height: 50px;",visible:!1,fixNvueBug:{},dateShow:!0,timeShow:!0,title:"日期和时间",time:"",year:1920,month:0,day:0,hour:0,minute:0,second:0,startYear:1920,startMonth:1,startDay:1,startHour:0,startMinute:0,startSecond:0,endYear:2120,endMonth:12,endDay:31,endHour:23,endMinute:59,endSecond:59}),props:{type:{type:String,default:"datetime"},value:{type:[String,Number],default:""},modelValue:{type:[String,Number],default:""},start:{type:[Number,String],default:""},end:{type:[Number,String],default:""},returnType:{type:String,default:"string"},disabled:{type:[Boolean,String],default:!1},border:{type:[Boolean,String],default:!0},hideSecond:{type:[Boolean,String],default:!1}},watch:{modelValue:{handler(e){e?(this.parseValue(fixIosDateFormat(e)),this.initTime(!1)):(this.time="",this.parseValue(Date.now()))},immediate:!0},type:{handler(e){"date"===e?(this.dateShow=!0,this.timeShow=!1,this.title="日期"):"time"===e?(this.dateShow=!1,this.timeShow=!0,this.title="时间"):(this.dateShow=!0,this.timeShow=!0,this.title="日期和时间")},immediate:!0},start:{handler(e){this.parseDatetimeRange(fixIosDateFormat(e),"start")},immediate:!0},end:{handler(e){this.parseDatetimeRange(fixIosDateFormat(e),"end")},immediate:!0},months(e){this.checkValue("month",this.month,e)},days(e){this.checkValue("day",this.day,e)},hours(e){this.checkValue("hour",this.hour,e)},minutes(e){this.checkValue("minute",this.minute,e)},seconds(e){this.checkValue("second",this.second,e)}},computed:{years(){return this.getCurrentRange("year")},months(){return this.getCurrentRange("month")},days(){return this.getCurrentRange("day")},hours(){return this.getCurrentRange("hour")},minutes(){return this.getCurrentRange("minute")},seconds(){return this.getCurrentRange("second")},ymd(){return[this.year-this.minYear,this.month-this.minMonth,this.day-this.minDay]},hms(){return[this.hour-this.minHour,this.minute-this.minMinute,this.second-this.minSecond]},currentDateIsStart(){return this.year===this.startYear&&this.month===this.startMonth&&this.day===this.startDay},currentDateIsEnd(){return this.year===this.endYear&&this.month===this.endMonth&&this.day===this.endDay},minYear(){return this.startYear},maxYear(){return this.endYear},minMonth(){return this.year===this.startYear?this.startMonth:1},maxMonth(){return this.year===this.endYear?this.endMonth:12},minDay(){return this.year===this.startYear&&this.month===this.startMonth?this.startDay:1},maxDay(){return this.year===this.endYear&&this.month===this.endMonth?this.endDay:this.daysInMonth(this.year,this.month)},minHour(){return"datetime"===this.type?this.currentDateIsStart?this.startHour:0:"time"===this.type?this.startHour:void 0},maxHour(){return"datetime"===this.type?this.currentDateIsEnd?this.endHour:23:"time"===this.type?this.endHour:void 0},minMinute(){return"datetime"===this.type?this.currentDateIsStart&&this.hour===this.startHour?this.startMinute:0:"time"===this.type?this.hour===this.startHour?this.startMinute:0:void 0},maxMinute(){return"datetime"===this.type?this.currentDateIsEnd&&this.hour===this.endHour?this.endMinute:59:"time"===this.type?this.hour===this.endHour?this.endMinute:59:void 0},minSecond(){return"datetime"===this.type?this.currentDateIsStart&&this.hour===this.startHour&&this.minute===this.startMinute?this.startSecond:0:"time"===this.type?this.hour===this.startHour&&this.minute===this.startMinute?this.startSecond:0:void 0},maxSecond(){return"datetime"===this.type?this.currentDateIsEnd&&this.hour===this.endHour&&this.minute===this.endMinute?this.endSecond:59:"time"===this.type?this.hour===this.endHour&&this.minute===this.endMinute?this.endSecond:59:void 0},selectTimeText:()=>t$2("uni-datetime-picker.selectTime"),okText:()=>t$2("uni-datetime-picker.ok"),clearText:()=>t$2("uni-datetime-picker.clear"),cancelText:()=>t$2("uni-datetime-picker.cancel")},mounted(){},methods:{lessThanTen:e=>e<10?"0"+e:e,parseTimeType(e){if(e){let t=e.split(":");this.hour=Number(t[0]),this.minute=Number(t[1]),this.second=Number(t[2])}},initPickerValue(e){let t=null;e?t=this.compareValueWithStartAndEnd(e,this.start,this.end):(t=Date.now(),t=this.compareValueWithStartAndEnd(t,this.start,this.end)),this.parseValue(t)},compareValueWithStartAndEnd(e,t,i){let r=null;return e=this.superTimeStamp(e),t=this.superTimeStamp(t),i=this.superTimeStamp(i),r=t&&i?e<t?new Date(t):e>i?new Date(i):new Date(e):t&&!i?t<=e?new Date(e):new Date(t):!t&&i?e<=i?new Date(e):new Date(i):new Date(e),r},superTimeStamp(e){let t="";if("time"===this.type&&e&&"string"==typeof e){const e=new Date;t=e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()+" "}return Number(e)&&(e=parseInt(e),t=0),this.createTimeStamp(t+e)},parseValue(e){if(e){if("time"===this.type&&"string"==typeof e)this.parseTimeType(e);else{let t=null;t=new Date(e),"time"!==this.type&&(this.year=t.getFullYear(),this.month=t.getMonth()+1,this.day=t.getDate()),"date"!==this.type&&(this.hour=t.getHours(),this.minute=t.getMinutes(),this.second=t.getSeconds())}this.hideSecond&&(this.second=0)}},parseDatetimeRange(e,t){if(!e)return"start"===t&&(this.startYear=1920,this.startMonth=1,this.startDay=1,this.startHour=0,this.startMinute=0,this.startSecond=0),void("end"===t&&(this.endYear=2120,this.endMonth=12,this.endDay=31,this.endHour=23,this.endMinute=59,this.endSecond=59));if("time"===this.type){const i=e.split(":");this[t+"Hour"]=Number(i[0]),this[t+"Minute"]=Number(i[1]),this[t+"Second"]=Number(i[2])}else{if(!e)return void("start"===t?this.startYear=this.year-60:this.endYear=this.year+60);Number(e)&&(e=parseInt(e));const i=/[0-9]:[0-9]/;"datetime"!==this.type||"end"!==t||"string"!=typeof e||i.test(e)||(e+=" 23:59:59");const r=new Date(e);this[t+"Year"]=r.getFullYear(),this[t+"Month"]=r.getMonth()+1,this[t+"Day"]=r.getDate(),"datetime"===this.type&&(this[t+"Hour"]=r.getHours(),this[t+"Minute"]=r.getMinutes(),this[t+"Second"]=r.getSeconds())}},getCurrentRange(e){const t=[];for(let i=this["min"+this.capitalize(e)];i<=this["max"+this.capitalize(e)];i++)t.push(i);return t},capitalize:e=>e.charAt(0).toUpperCase()+e.slice(1),checkValue(e,t,i){-1===i.indexOf(t)&&(this[e]=i[0])},daysInMonth:(e,t)=>new Date(e,t,0).getDate(),fixIosDateFormat:e=>("string"==typeof e&&(e=e.replace(/-/g,"/")),e),createTimeStamp(e){if(e)return"number"==typeof e?e:(e=e.replace(/-/g,"/"),"date"===this.type&&(e+=" 00:00:00"),Date.parse(e))},createDomSting(){const e=this.year+"-"+this.lessThanTen(this.month)+"-"+this.lessThanTen(this.day);let t=this.lessThanTen(this.hour)+":"+this.lessThanTen(this.minute);return this.hideSecond||(t=t+":"+this.lessThanTen(this.second)),"date"===this.type?e:"time"===this.type?t:e+" "+t},initTime(e=!0){this.time=this.createDomSting(),e&&("timestamp"===this.returnType&&"time"!==this.type?(this.$emit("change",this.createTimeStamp(this.time)),this.$emit("input",this.createTimeStamp(this.time)),this.$emit("update:modelValue",this.createTimeStamp(this.time))):(this.$emit("change",this.time),this.$emit("input",this.time),this.$emit("update:modelValue",this.time)))},bindDateChange(e){const t=e.detail.value;this.year=this.years[t[0]],this.month=this.months[t[1]],this.day=this.days[t[2]]},bindTimeChange(e){const t=e.detail.value;this.hour=this.hours[t[0]],this.minute=this.minutes[t[1]],this.second=this.seconds[t[2]]},initTimePicker(){if(this.disabled)return;const e=fixIosDateFormat(this.time);this.initPickerValue(e),this.visible=!this.visible},tiggerTimePicker(e){this.visible=!this.visible},clearTime(){this.time="",this.$emit("change",this.time),this.$emit("input",this.time),this.$emit("update:modelValue",this.time),this.tiggerTimePicker()},setTime(){this.initTime(),this.tiggerTimePicker()}}};function _sfc_render$4(e,t,i,r,s,a){return vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker"},[vue.createElementVNode("view",{onClick:t[0]||(t[0]=(...e)=>a.initTimePicker&&a.initTimePicker(...e))},[vue.renderSlot(e.$slots,"default",{},(()=>[vue.createElementVNode("view",{class:vue.normalizeClass(["uni-datetime-picker-timebox-pointer",{"uni-datetime-picker-disabled":i.disabled,"uni-datetime-picker-timebox":i.border}])},[vue.createElementVNode("text",{class:"uni-datetime-picker-text"},vue.toDisplayString(s.time),1),s.time?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-datetime-picker-time"},[vue.createElementVNode("text",{class:"uni-datetime-picker-text"},vue.toDisplayString(a.selectTimeText),1)]))],2)]),!0)]),s.visible?(vue.openBlock(),vue.createElementBlock("view",{key:0,id:"mask",class:"uni-datetime-picker-mask",onClick:t[1]||(t[1]=(...e)=>a.tiggerTimePicker&&a.tiggerTimePicker(...e))})):vue.createCommentVNode("",!0),s.visible?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:vue.normalizeClass(["uni-datetime-picker-popup",[s.dateShow&&s.timeShow?"":"fix-nvue-height"]]),style:vue.normalizeStyle(s.fixNvueBug)},[vue.createElementVNode("view",{class:"uni-title"},[vue.createElementVNode("text",{class:"uni-datetime-picker-text"},vue.toDisplayString(a.selectTimeText),1)]),s.dateShow?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-datetime-picker__container-box"},[vue.createElementVNode("picker-view",{class:"uni-datetime-picker-view","indicator-style":s.indicatorStyle,value:a.ymd,onChange:t[2]||(t[2]=(...e)=>a.bindDateChange&&a.bindDateChange(...e))},[vue.createElementVNode("picker-view-column",null,[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.years,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker-item",key:t},[vue.createElementVNode("text",{class:"uni-datetime-picker-item"},vue.toDisplayString(a.lessThanTen(e)),1)])))),128))]),vue.createElementVNode("picker-view-column",null,[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.months,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker-item",key:t},[vue.createElementVNode("text",{class:"uni-datetime-picker-item"},vue.toDisplayString(a.lessThanTen(e)),1)])))),128))]),vue.createElementVNode("picker-view-column",null,[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.days,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker-item",key:t},[vue.createElementVNode("text",{class:"uni-datetime-picker-item"},vue.toDisplayString(a.lessThanTen(e)),1)])))),128))])],40,["indicator-style","value"]),vue.createElementVNode("text",{class:"uni-datetime-picker-sign sign-left"},"-"),vue.createElementVNode("text",{class:"uni-datetime-picker-sign sign-right"},"-")])):vue.createCommentVNode("",!0),s.timeShow?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"uni-datetime-picker__container-box"},[vue.createElementVNode("picker-view",{class:vue.normalizeClass(["uni-datetime-picker-view",[i.hideSecond?"time-hide-second":""]]),"indicator-style":s.indicatorStyle,value:a.hms,onChange:t[3]||(t[3]=(...e)=>a.bindTimeChange&&a.bindTimeChange(...e))},[vue.createElementVNode("picker-view-column",null,[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.hours,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker-item",key:t},[vue.createElementVNode("text",{class:"uni-datetime-picker-item"},vue.toDisplayString(a.lessThanTen(e)),1)])))),128))]),vue.createElementVNode("picker-view-column",null,[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.minutes,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker-item",key:t},[vue.createElementVNode("text",{class:"uni-datetime-picker-item"},vue.toDisplayString(a.lessThanTen(e)),1)])))),128))]),i.hideSecond?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("picker-view-column",{key:0},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a.seconds,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-datetime-picker-item",key:t},[vue.createElementVNode("text",{class:"uni-datetime-picker-item"},vue.toDisplayString(a.lessThanTen(e)),1)])))),128))]))],42,["indicator-style","value"]),vue.createElementVNode("text",{class:vue.normalizeClass(["uni-datetime-picker-sign",[i.hideSecond?"sign-center":"sign-left"]])},":",2),i.hideSecond?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("text",{key:0,class:"uni-datetime-picker-sign sign-right"},":"))])):vue.createCommentVNode("",!0),vue.createElementVNode("view",{class:"uni-datetime-picker-btn"},[vue.createElementVNode("view",{onClick:t[4]||(t[4]=(...e)=>a.clearTime&&a.clearTime(...e))},[vue.createElementVNode("text",{class:"uni-datetime-picker-btn-text"},vue.toDisplayString(a.clearText),1)]),vue.createElementVNode("view",{class:"uni-datetime-picker-btn-group"},[vue.createElementVNode("view",{class:"uni-datetime-picker-cancel",onClick:t[5]||(t[5]=(...e)=>a.tiggerTimePicker&&a.tiggerTimePicker(...e))},[vue.createElementVNode("text",{class:"uni-datetime-picker-btn-text"},vue.toDisplayString(a.cancelText),1)]),vue.createElementVNode("view",{onClick:t[6]||(t[6]=(...e)=>a.setTime&&a.setTime(...e))},[vue.createElementVNode("text",{class:"uni-datetime-picker-btn-text"},vue.toDisplayString(a.okText),1)])])])],6)):vue.createCommentVNode("",!0)])}const TimePicker=_export_sfc(_sfc_main$s,[["render",_sfc_render$4],["__scopeId","data-v-934d3f40"]]),{t:t$1}=initVueI18n(i18nMessages),_sfc_main$r={components:{calendarItem:calendarItem,timePicker:TimePicker},props:{date:{type:String,default:""},defTime:{type:[String,Object],default:""},selectableTimes:{type:[Object],default:()=>({})},selected:{type:Array,default:()=>[]},startDate:{type:String,default:""},endDate:{type:String,default:""},startPlaceholder:{type:String,default:""},endPlaceholder:{type:String,default:""},range:{type:Boolean,default:!1},hasTime:{type:Boolean,default:!1},insert:{type:Boolean,default:!0},showMonth:{type:Boolean,default:!0},clearDate:{type:Boolean,default:!0},checkHover:{type:Boolean,default:!0},hideSecond:{type:[Boolean],default:!1},pleStatus:{type:Object,default:()=>({before:"",after:"",data:[],fulldate:""})},defaultValue:{type:[String,Object,Array],default:""}},data:()=>({show:!1,weeks:[],calendar:{},nowDate:{},aniMaskShow:!1,firstEnter:!0,time:"",timeRange:{startTime:"",endTime:""},tempSingleDate:"",tempRange:{before:"",after:""},isPhone:!1}),watch:{date:{immediate:!0,handler(e){this.range||(this.tempSingleDate=e,setTimeout((()=>{this.init(e)}),100))}},defTime:{immediate:!0,handler(e){this.range?(this.timeRange.startTime=e.start,this.timeRange.endTime=e.end):this.time=e}},startDate(e){this.cale&&(this.cale.setStartDate(e),this.cale.setDate(this.nowDate.fullDate),this.weeks=this.cale.weeks)},endDate(e){this.cale&&(this.cale.setEndDate(e),this.cale.setDate(this.nowDate.fullDate),this.weeks=this.cale.weeks)},selected(e){this.cale&&(this.cale.setSelectInfo(this.nowDate.fullDate,e),this.weeks=this.cale.weeks)},pleStatus:{immediate:!0,handler(e){const{before:t,after:i,fulldate:r,which:s}=e;this.tempRange.before=t,this.tempRange.after=i,setTimeout((()=>{if(r)if(this.cale.setHoverMultiple(r),t&&i){if(this.cale.lastHover=!0,this.rangeWithinMonth(i,t))return;this.setDate(t)}else this.cale.setMultiple(r),this.setDate(this.nowDate.fullDate),this.calendar.fullDate="",this.cale.lastHover=!1;else{if(!this.cale)return;this.cale.setDefaultMultiple(t,i),"left"===s&&t?(this.setDate(t),this.weeks=this.cale.weeks):i&&(this.setDate(i),this.weeks=this.cale.weeks),this.cale.lastHover=!0}}),16)}}},computed:{timepickerStartTime(){return(this.range?this.tempRange.before:this.calendar.fullDate)===this.startDate?this.selectableTimes.start:""},timepickerEndTime(){return(this.range?this.tempRange.after:this.calendar.fullDate)===this.endDate?this.selectableTimes.end:""},selectDateText:()=>t$1("uni-datetime-picker.selectDate"),startDateText(){return this.startPlaceholder||t$1("uni-datetime-picker.startDate")},endDateText(){return this.endPlaceholder||t$1("uni-datetime-picker.endDate")},okText:()=>t$1("uni-datetime-picker.ok"),yearText:()=>t$1("uni-datetime-picker.year"),monthText:()=>t$1("uni-datetime-picker.month"),MONText:()=>t$1("uni-calender.MON"),TUEText:()=>t$1("uni-calender.TUE"),WEDText:()=>t$1("uni-calender.WED"),THUText:()=>t$1("uni-calender.THU"),FRIText:()=>t$1("uni-calender.FRI"),SATText:()=>t$1("uni-calender.SAT"),SUNText:()=>t$1("uni-calender.SUN"),confirmText:()=>t$1("uni-calender.confirm")},created(){this.cale=new Calendar$1({selected:this.selected,startDate:this.startDate,endDate:this.endDate,range:this.range}),this.init(this.date)},mounted(){if("undefined"!=typeof navigator)return void(this.isPhone=-1!==navigator.userAgent.toLowerCase().indexOf("mobile"));const{windowWidth:e}=uni.getSystemInfoSync();this.isPhone=e<=500},methods:{leaveCale(){this.firstEnter=!0},handleMouse(e){if(e.disable)return;if(this.cale.lastHover)return;let{before:t,after:i}=this.cale.multipleStatus;t&&(this.calendar=e,this.cale.setHoverMultiple(this.calendar.fullDate),this.weeks=this.cale.weeks,this.firstEnter&&(this.$emit("firstEnterCale",this.cale.multipleStatus),this.firstEnter=!1))},rangeWithinMonth(e,t){const[i,r]=e.split("-"),[s,a]=t.split("-");return i===s&&r===a},maskClick(){this.close(),this.$emit("maskClose")},clearCalender(){this.range?(this.timeRange.startTime="",this.timeRange.endTime="",this.tempRange.before="",this.tempRange.after="",this.cale.multipleStatus.before="",this.cale.multipleStatus.after="",this.cale.multipleStatus.data=[],this.cale.lastHover=!1):(this.time="",this.tempSingleDate=""),this.calendar.fullDate="",this.setDate(new Date)},bindDateChange(e){const t=e.detail.value+"-1";this.setDate(t)},init(e){if(this.cale&&(this.cale.setDate(e||new Date),this.weeks=this.cale.weeks,this.nowDate=this.cale.getInfo(e),this.calendar={...this.nowDate},!e&&(this.calendar.fullDate="",this.defaultValue&&!this.range))){const e=new Date(this.defaultValue),t=getDate(e),i=e.getFullYear(),r=e.getMonth()+1,s=e.getDate(),a=e.getDay();this.calendar={fullDate:t,year:i,month:r,date:s,day:a},this.tempSingleDate=t,this.time=getTime(e,this.hideSecond)}},open(){this.clearDate&&!this.insert&&(this.cale.cleanMultipleStatus(),this.init(this.date)),this.show=!0,this.$nextTick((()=>{setTimeout((()=>{this.aniMaskShow=!0}),50)}))},close(){this.aniMaskShow=!1,this.$nextTick((()=>{setTimeout((()=>{this.show=!1,this.$emit("close")}),300)}))},confirm(){this.setEmit("confirm"),this.close()},change(){this.insert&&this.setEmit("change")},monthSwitch(){let{year:e,month:t}=this.nowDate;this.$emit("monthSwitch",{year:e,month:Number(t)})},setEmit(e){this.range||(this.calendar.fullDate||(this.calendar=this.cale.getInfo(new Date),this.tempSingleDate=this.calendar.fullDate),this.hasTime&&!this.time&&(this.time=getTime(new Date,this.hideSecond)));let{year:t,month:i,date:r,fullDate:s,extraInfo:a}=this.calendar;this.$emit(e,{range:this.cale.multipleStatus,year:t,month:i,date:r,time:this.time,timeRange:this.timeRange,fulldate:s,extraInfo:a||{}})},choiceDate(e){if(e.disable)return;this.calendar=e,this.calendar.userChecked=!0,this.cale.setMultiple(this.calendar.fullDate,!0),this.weeks=this.cale.weeks,this.tempSingleDate=this.calendar.fullDate;const t=new Date(this.cale.multipleStatus.before).getTime(),i=new Date(this.cale.multipleStatus.after).getTime();t>i&&i&&!this.isPhone?(this.tempRange.before=this.cale.multipleStatus.after,this.tempRange.after=this.cale.multipleStatus.before):(this.tempRange.before=this.cale.multipleStatus.before,this.tempRange.after=this.cale.multipleStatus.after),this.change()},changeMonth(e){let t;"pre"===e?t=this.cale.getPreMonthObj(this.nowDate.fullDate).fullDate:"next"===e&&(t=this.cale.getNextMonthObj(this.nowDate.fullDate).fullDate),this.setDate(t),this.monthSwitch()},setDate(e){this.cale.setDate(e),this.weeks=this.cale.weeks,this.nowDate=this.cale.getInfo(e)}}};function _sfc_render$3(e,t,i,r,s,a){const n=vue.resolveComponent("calendar-item"),o=vue.resolveComponent("time-picker"),l=vue.resolveComponent("uni-icons");return vue.openBlock(),vue.createElementBlock("view",{class:"uni-calendar",onMouseleave:t[9]||(t[9]=(...e)=>a.leaveCale&&a.leaveCale(...e))},[!i.insert&&s.show?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:vue.normalizeClass(["uni-calendar__mask",{"uni-calendar--mask-show":s.aniMaskShow}]),onClick:t[0]||(t[0]=(...e)=>a.maskClick&&a.maskClick(...e))},null,2)):vue.createCommentVNode("",!0),i.insert||s.show?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:vue.normalizeClass(["uni-calendar__content",{"uni-calendar--fixed":!i.insert,"uni-calendar--ani-show":s.aniMaskShow,"uni-calendar__content-mobile":s.aniMaskShow}])},[vue.createElementVNode("view",{class:vue.normalizeClass(["uni-calendar__header",{"uni-calendar__header-mobile":!i.insert}])},[vue.createElementVNode("view",{class:"uni-calendar__header-btn-box",onClick:t[1]||(t[1]=vue.withModifiers((e=>a.changeMonth("pre")),["stop"]))},[vue.createElementVNode("view",{class:"uni-calendar__header-btn uni-calendar--left"})]),vue.createElementVNode("picker",{mode:"date",value:i.date,fields:"month",onChange:t[2]||(t[2]=(...e)=>a.bindDateChange&&a.bindDateChange(...e))},[vue.createElementVNode("text",{class:"uni-calendar__header-text"},vue.toDisplayString((s.nowDate.year||"")+a.yearText+(s.nowDate.month||"")+a.monthText),1)],40,["value"]),vue.createElementVNode("view",{class:"uni-calendar__header-btn-box",onClick:t[3]||(t[3]=vue.withModifiers((e=>a.changeMonth("next")),["stop"]))},[vue.createElementVNode("view",{class:"uni-calendar__header-btn uni-calendar--right"})]),i.insert?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"dialog-close",onClick:t[4]||(t[4]=(...e)=>a.close&&a.close(...e))},[vue.createElementVNode("view",{class:"dialog-close-plus","data-id":"close"}),vue.createElementVNode("view",{class:"dialog-close-plus dialog-close-rotate","data-id":"close"})]))],2),vue.createElementVNode("view",{class:"uni-calendar__box"},[i.showMonth?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-calendar__box-bg"},[vue.createElementVNode("text",{class:"uni-calendar__box-bg-text"},vue.toDisplayString(s.nowDate.month),1)])):vue.createCommentVNode("",!0),vue.createElementVNode("view",{class:"uni-calendar__weeks",style:{"padding-bottom":"7px"}},[vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.SUNText),1)]),vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.MONText),1)]),vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.TUEText),1)]),vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.WEDText),1)]),vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.THUText),1)]),vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.FRIText),1)]),vue.createElementVNode("view",{class:"uni-calendar__weeks-day"},[vue.createElementVNode("text",{class:"uni-calendar__weeks-day-text"},vue.toDisplayString(a.SATText),1)])]),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(s.weeks,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-calendar__weeks",key:t},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(e,((e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"uni-calendar__weeks-item",key:t},[vue.createVNode(n,{class:"uni-calendar-item--hook",weeks:e,calendar:s.calendar,selected:i.selected,checkHover:i.range,onChange:a.choiceDate,onHandleMouse:a.handleMouse},null,8,["weeks","calendar","selected","checkHover","onChange","onHandleMouse"])])))),128))])))),128))]),i.insert||i.range||!i.hasTime?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-date-changed uni-calendar--fixed-top",style:{padding:"0 80px"}},[vue.createElementVNode("view",{class:"uni-date-changed--time-date"},vue.toDisplayString(s.tempSingleDate?s.tempSingleDate:a.selectDateText),1),vue.createVNode(o,{type:"time",start:a.timepickerStartTime,end:a.timepickerEndTime,modelValue:s.time,"onUpdate:modelValue":t[5]||(t[5]=e=>s.time=e),disabled:!s.tempSingleDate,border:!1,"hide-second":i.hideSecond,class:"time-picker-style"},null,8,["start","end","modelValue","disabled","hide-second"])])),!i.insert&&i.range&&i.hasTime?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"uni-date-changed uni-calendar--fixed-top"},[vue.createElementVNode("view",{class:"uni-date-changed--time-start"},[vue.createElementVNode("view",{class:"uni-date-changed--time-date"},vue.toDisplayString(s.tempRange.before?s.tempRange.before:a.startDateText),1),vue.createVNode(o,{type:"time",start:a.timepickerStartTime,modelValue:s.timeRange.startTime,"onUpdate:modelValue":t[6]||(t[6]=e=>s.timeRange.startTime=e),border:!1,"hide-second":i.hideSecond,disabled:!s.tempRange.before,class:"time-picker-style"},null,8,["start","modelValue","hide-second","disabled"])]),vue.createElementVNode("view",{style:{"line-height":"50px"}},[vue.createVNode(l,{type:"arrowthinright",color:"#999"})]),vue.createElementVNode("view",{class:"uni-date-changed--time-end"},[vue.createElementVNode("view",{class:"uni-date-changed--time-date"},vue.toDisplayString(s.tempRange.after?s.tempRange.after:a.endDateText),1),vue.createVNode(o,{type:"time",end:a.timepickerEndTime,modelValue:s.timeRange.endTime,"onUpdate:modelValue":t[7]||(t[7]=e=>s.timeRange.endTime=e),border:!1,"hide-second":i.hideSecond,disabled:!s.tempRange.after,class:"time-picker-style"},null,8,["end","modelValue","hide-second","disabled"])])])):vue.createCommentVNode("",!0),i.insert?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("view",{key:2,class:"uni-date-changed uni-date-btn--ok"},[vue.createElementVNode("view",{class:"uni-datetime-picker--btn",onClick:t[8]||(t[8]=(...e)=>a.confirm&&a.confirm(...e))},vue.toDisplayString(a.confirmText),1)]))],2)):vue.createCommentVNode("",!0)],32)}const Calendar=_export_sfc(_sfc_main$r,[["render",_sfc_render$3],["__scopeId","data-v-f58af7f1"]]),_sfc_main$q={name:"UniDatetimePicker",options:{virtualHost:!0},components:{Calendar:Calendar,TimePicker:TimePicker},data:()=>({isRange:!1,hasTime:!1,displayValue:"",inputDate:"",calendarDate:"",pickerTime:"",calendarRange:{startDate:"",startTime:"",endDate:"",endTime:""},displayRangeValue:{startDate:"",endDate:""},tempRange:{startDate:"",startTime:"",endDate:"",endTime:""},startMultipleStatus:{before:"",after:"",data:[],fulldate:""},endMultipleStatus:{before:"",after:"",data:[],fulldate:""},pickerVisible:!1,pickerPositionStyle:null,isEmitValue:!1,isPhone:!1,isFirstShow:!0,i18nT:()=>{}}),props:{type:{type:String,default:"datetime"},value:{type:[String,Number,Array,Date],default:""},modelValue:{type:[String,Number,Array,Date],default:""},start:{type:[Number,String],default:""},end:{type:[Number,String],default:""},returnType:{type:String,default:"string"},placeholder:{type:String,default:""},startPlaceholder:{type:String,default:""},endPlaceholder:{type:String,default:""},rangeSeparator:{type:String,default:"-"},border:{type:[Boolean],default:!0},disabled:{type:[Boolean],default:!1},clearIcon:{type:[Boolean],default:!0},hideSecond:{type:[Boolean],default:!1},defaultValue:{type:[String,Object,Array],default:""}},watch:{type:{immediate:!0,handler(e){this.hasTime=-1!==e.indexOf("time"),this.isRange=-1!==e.indexOf("range")}},modelValue:{immediate:!0,handler(e){this.isEmitValue?this.isEmitValue=!1:this.initPicker(e)}},start:{immediate:!0,handler(e){e&&(this.calendarRange.startDate=getDate(e),this.hasTime&&(this.calendarRange.startTime=getTime(e)))}},end:{immediate:!0,handler(e){e&&(this.calendarRange.endDate=getDate(e),this.hasTime&&(this.calendarRange.endTime=getTime(e,this.hideSecond)))}}},computed:{timepickerStartTime(){return(this.isRange?this.tempRange.startDate:this.inputDate)===this.calendarRange.startDate?this.calendarRange.startTime:""},timepickerEndTime(){return(this.isRange?this.tempRange.endDate:this.inputDate)===this.calendarRange.endDate?this.calendarRange.endTime:""},mobileCalendarTime(){const e={start:this.tempRange.startTime,end:this.tempRange.endTime};return this.isRange?e:this.pickerTime},mobSelectableTime(){return{start:this.calendarRange.startTime,end:this.calendarRange.endTime}},datePopupWidth(){return this.isRange?653:301},singlePlaceholderText(){return this.placeholder||("date"===this.type?this.selectDateText:this.selectDateTimeText)},startPlaceholderText(){return this.startPlaceholder||this.startDateText},endPlaceholderText(){return this.endPlaceholder||this.endDateText},selectDateText(){return this.i18nT("uni-datetime-picker.selectDate")},selectDateTimeText(){return this.i18nT("uni-datetime-picker.selectDateTime")},selectTimeText(){return this.i18nT("uni-datetime-picker.selectTime")},startDateText(){return this.startPlaceholder||this.i18nT("uni-datetime-picker.startDate")},startTimeText(){return this.i18nT("uni-datetime-picker.startTime")},endDateText(){return this.endPlaceholder||this.i18nT("uni-datetime-picker.endDate")},endTimeText(){return this.i18nT("uni-datetime-picker.endTime")},okText(){return this.i18nT("uni-datetime-picker.ok")},clearText(){return this.i18nT("uni-datetime-picker.clear")},showClearIcon(){return this.clearIcon&&!this.disabled&&(this.displayValue||this.displayRangeValue.startDate&&this.displayRangeValue.endDate)}},created(){this.initI18nT(),this.platform()},methods:{initI18nT(){const e=initVueI18n(i18nMessages);this.i18nT=e.t},initPicker(e){if(!e&&!this.defaultValue||Array.isArray(e)&&!e.length)this.$nextTick((()=>{this.clear(!1)}));else if(Array.isArray(e)||this.isRange){const[t,i]=e;if(!t&&!i)return;const r=getDate(t),s=getTime(t,this.hideSecond),a=getDate(i),n=getTime(i,this.hideSecond),o=r,l=a;this.displayRangeValue.startDate=this.tempRange.startDate=o,this.displayRangeValue.endDate=this.tempRange.endDate=l,this.hasTime&&(this.displayRangeValue.startDate=`${r} ${s}`,this.displayRangeValue.endDate=`${a} ${n}`,this.tempRange.startTime=s,this.tempRange.endTime=n);const c={before:r,after:a};this.startMultipleStatus=Object.assign({},this.startMultipleStatus,c,{which:"right"}),this.endMultipleStatus=Object.assign({},this.endMultipleStatus,c,{which:"left"})}else e?(this.displayValue=this.inputDate=this.calendarDate=getDate(e),this.hasTime&&(this.pickerTime=getTime(e,this.hideSecond),this.displayValue=`${this.displayValue} ${this.pickerTime}`)):this.defaultValue&&(this.inputDate=this.calendarDate=getDate(this.defaultValue),this.hasTime&&(this.pickerTime=getTime(this.defaultValue,this.hideSecond)))},updateLeftCale(e){const t=this.$refs.left;t.cale.setHoverMultiple(e.after),t.setDate(this.$refs.left.nowDate.fullDate)},updateRightCale(e){const t=this.$refs.right;t.cale.setHoverMultiple(e.after),t.setDate(this.$refs.right.nowDate.fullDate)},platform(){if("undefined"!=typeof navigator)return void(this.isPhone=-1!==navigator.userAgent.toLowerCase().indexOf("mobile"));const{windowWidth:e}=uni.getSystemInfoSync();this.isPhone=e<=500,this.windowWidth=e},show(){if(this.disabled)return;if(this.platform(),this.isPhone)return void setTimeout((()=>{this.$refs.mobile.open()}),0);this.pickerPositionStyle={top:"10px"};uni.createSelectorQuery().in(this).select(".uni-date-editor").boundingClientRect((e=>{this.windowWidth-e.left<this.datePopupWidth&&(this.pickerPositionStyle.right=0)})).exec(),setTimeout((()=>{if(this.pickerVisible=!this.pickerVisible,!this.isPhone&&this.isRange&&this.isFirstShow){this.isFirstShow=!1;const{startDate:e,endDate:t}=this.calendarRange;e&&t?this.diffDate(e,t)<30&&this.$refs.right.changeMonth("pre"):(this.$refs.right.changeMonth("next"),this.$refs.right.cale.lastHover=!1)}}),50)},close(){setTimeout((()=>{this.pickerVisible=!1,this.$emit("maskClick",this.value),this.$refs.mobile&&this.$refs.mobile.close()}),20)},setEmit(e){"timestamp"!==this.returnType&&"date"!==this.returnType||(Array.isArray(e)?(this.hasTime||(e[0]=e[0]+" 00:00:00",e[1]=e[1]+" 00:00:00"),e[0]=this.createTimestamp(e[0]),e[1]=this.createTimestamp(e[1]),"date"===this.returnType&&(e[0]=new Date(e[0]),e[1]=new Date(e[1]))):(this.hasTime||(e+=" 00:00:00"),e=this.createTimestamp(e),"date"===this.returnType&&(e=new Date(e)))),this.$emit("update:modelValue",e),this.$emit("input",e),this.$emit("change",e),this.isEmitValue=!0},createTimestamp:e=>(e=fixIosDateFormat(e),Date.parse(new Date(e))),singleChange(e){this.calendarDate=this.inputDate=e.fulldate,this.hasTime||this.confirmSingleChange()},confirmSingleChange(){if(!checkDate(this.inputDate)){const e=new Date;this.calendarDate=this.inputDate=getDate(e),this.pickerTime=getTime(e,this.hideSecond)}let e,t,i=!1;if(this.start){let r=this.start;"number"==typeof this.start&&(r=getDateTime(this.start,this.hideSecond)),[e,t]=r.split(" "),this.start&&!dateCompare(e,this.inputDate)&&(i=!0,this.inputDate=e)}let r,s,a=!1;if(this.end){let e=this.end;"number"==typeof this.end&&(e=getDateTime(this.end,this.hideSecond)),[r,s]=e.split(" "),this.end&&!dateCompare(this.inputDate,r)&&(a=!0,this.inputDate=r)}this.hasTime?(i&&(this.pickerTime=t||getDefaultSecond(this.hideSecond)),a&&(this.pickerTime=s||getDefaultSecond(this.hideSecond)),this.pickerTime||(this.pickerTime=getTime(Date.now(),this.hideSecond)),this.displayValue=`${this.inputDate} ${this.pickerTime}`):this.displayValue=this.inputDate,this.setEmit(this.displayValue),this.pickerVisible=!1},leftChange(e){const{before:t,after:i}=e.range;this.rangeChange(t,i);const r={before:e.range.before,after:e.range.after,data:e.range.data,fulldate:e.fulldate};this.startMultipleStatus=Object.assign({},this.startMultipleStatus,r)},rightChange(e){const{before:t,after:i}=e.range;this.rangeChange(t,i);const r={before:e.range.before,after:e.range.after,data:e.range.data,fulldate:e.fulldate};this.endMultipleStatus=Object.assign({},this.endMultipleStatus,r)},mobileChange(e){if(this.isRange){const{before:t,after:i}=e.range;if(!t||!i)return;if(this.handleStartAndEnd(t,i,!0),this.hasTime){const{startTime:t,endTime:i}=e.timeRange;this.tempRange.startTime=t,this.tempRange.endTime=i}this.confirmRangeChange()}else this.hasTime?this.displayValue=e.fulldate+" "+e.time:this.displayValue=e.fulldate,this.setEmit(this.displayValue);this.$refs.mobile.close()},rangeChange(e,t){e&&t&&(this.handleStartAndEnd(e,t,!0),this.hasTime||this.confirmRangeChange())},confirmRangeChange(){if(!this.tempRange.startDate||!this.tempRange.endDate)return void(this.pickerVisible=!1);let e,t;checkDate(this.tempRange.startDate)||(this.tempRange.startDate=getDate(Date.now())),checkDate(this.tempRange.endDate)||(this.tempRange.endDate=getDate(Date.now()));let i,r,s=!1,a=!1;if(this.start){let e=this.start;"number"==typeof this.start&&(e=getDateTime(this.start,this.hideSecond)),[i,r]=e.split(" "),this.start&&!dateCompare(this.start,this.tempRange.startDate)&&(s=!0,this.tempRange.startDate=i),this.start&&!dateCompare(this.start,this.tempRange.endDate)&&(a=!0,this.tempRange.endDate=i)}let n,o,l=!1,c=!1;if(this.end){let e=this.end;"number"==typeof this.end&&(e=getDateTime(this.end,this.hideSecond)),[n,o]=e.split(" "),this.end&&!dateCompare(this.tempRange.startDate,this.end)&&(l=!0,this.tempRange.startDate=n),this.end&&!dateCompare(this.tempRange.endDate,this.end)&&(c=!0,this.tempRange.endDate=n)}this.hasTime?(s?this.tempRange.startTime=r||getDefaultSecond(this.hideSecond):l&&(this.tempRange.startTime=o||getDefaultSecond(this.hideSecond)),this.tempRange.startTime||(this.tempRange.startTime=getTime(Date.now(),this.hideSecond)),a?this.tempRange.endTime=r||getDefaultSecond(this.hideSecond):c&&(this.tempRange.endTime=o||getDefaultSecond(this.hideSecond)),this.tempRange.endTime||(this.tempRange.endTime=getTime(Date.now(),this.hideSecond)),e=this.displayRangeValue.startDate=`${this.tempRange.startDate} ${this.tempRange.startTime}`,t=this.displayRangeValue.endDate=`${this.tempRange.endDate} ${this.tempRange.endTime}`):(e=this.displayRangeValue.startDate=this.tempRange.startDate,t=this.displayRangeValue.endDate=this.tempRange.endDate),dateCompare(e,t)||([e,t]=[t,e]),this.displayRangeValue.startDate=e,this.displayRangeValue.endDate=t;const u=[e,t];this.setEmit(u),this.pickerVisible=!1},handleStartAndEnd(e,t,i=!1){if(!e||!t)return;const r=i?"tempRange":"range",s=dateCompare(e,t);this[r].startDate=s?e:t,this[r].endDate=s?t:e},dateCompare:(e,t)=>(e=new Date(e.replace("-","/").replace("-","/")))<=(t=new Date(t.replace("-","/").replace("-","/"))),diffDate(e,t){e=new Date(e.replace("-","/").replace("-","/"));const i=((t=new Date(t.replace("-","/").replace("-","/")))-e)/864e5;return Math.abs(i)},clear(e=!0){this.isRange?(this.displayRangeValue.startDate="",this.displayRangeValue.endDate="",this.tempRange.startDate="",this.tempRange.startTime="",this.tempRange.endDate="",this.tempRange.endTime="",this.isPhone?this.$refs.mobile&&this.$refs.mobile.clearCalender():(this.$refs.left&&this.$refs.left.clearCalender(),this.$refs.right&&this.$refs.right.clearCalender(),this.$refs.right&&this.$refs.right.changeMonth("next")),e&&(this.$emit("change",[]),this.$emit("input",[]),this.$emit("update:modelValue",[]))):(this.displayValue="",this.inputDate="",this.pickerTime="",this.isPhone?this.$refs.mobile&&this.$refs.mobile.clearCalender():this.$refs.pcSingle&&this.$refs.pcSingle.clearCalender(),e&&(this.$emit("change",""),this.$emit("input",""),this.$emit("update:modelValue","")))}}};function _sfc_render$2(e,t,i,r,s,a){const n=vue.resolveComponent("uni-icons"),o=vue.resolveComponent("time-picker"),l=vue.resolveComponent("Calendar");return vue.openBlock(),vue.createElementBlock("view",{class:"uni-date"},[vue.createElementVNode("view",{class:"uni-date-editor",onClick:t[1]||(t[1]=(...e)=>a.show&&a.show(...e))},[vue.renderSlot(e.$slots,"default",{},(()=>[vue.createElementVNode("view",{class:vue.normalizeClass(["uni-date-editor--x",{"uni-date-editor--x__disabled":i.disabled,"uni-date-x--border":i.border}])},[s.isRange?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"uni-date-x uni-date-range"},[vue.createVNode(n,{class:"icon-calendar",type:"calendar",color:"#c0c4cc",size:"22"}),vue.createElementVNode("view",{class:"uni-date__x-input text-center"},vue.toDisplayString(s.displayRangeValue.startDate||a.startPlaceholderText),1),vue.createElementVNode("view",{class:"range-separator"},vue.toDisplayString(i.rangeSeparator),1),vue.createElementVNode("view",{class:"uni-date__x-input text-center"},vue.toDisplayString(s.displayRangeValue.endDate||a.endPlaceholderText),1)])):(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-date-x uni-date-single"},[vue.createVNode(n,{class:"icon-calendar",type:"calendar",color:"#c0c4cc",size:"22"}),vue.createElementVNode("view",{class:"uni-date__x-input"},vue.toDisplayString(s.displayValue||a.singlePlaceholderText),1)])),a.showClearIcon?(vue.openBlock(),vue.createElementBlock("view",{key:2,class:"uni-date__icon-clear",onClick:t[0]||(t[0]=vue.withModifiers(((...e)=>a.clear&&a.clear(...e)),["stop"]))},[vue.createVNode(n,{type:"clear",color:"#c0c4cc",size:"22"})])):vue.createCommentVNode("",!0)],2)]),!0)]),vue.withDirectives(vue.createElementVNode("view",{class:"uni-date-mask--pc",onClick:t[2]||(t[2]=(...e)=>a.close&&a.close(...e))},null,512),[[vue.vShow,s.pickerVisible]]),s.isPhone?vue.createCommentVNode("",!0):vue.withDirectives((vue.openBlock(),vue.createElementBlock("view",{key:0,ref:"datePicker",class:"uni-date-picker__container"},[s.isRange?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"uni-date-range--x",style:vue.normalizeStyle(s.pickerPositionStyle)},[vue.createElementVNode("view",{class:"uni-popper__arrow"}),s.hasTime?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"popup-x-header uni-date-changed"},[vue.createElementVNode("view",{class:"popup-x-header--datetime"},[vue.withDirectives(vue.createElementVNode("input",{class:"uni-date__input uni-date-range__input",type:"text","onUpdate:modelValue":t[7]||(t[7]=e=>s.tempRange.startDate=e),placeholder:a.startDateText},null,8,["placeholder"]),[[vue.vModelText,s.tempRange.startDate]]),vue.createVNode(o,{type:"time",modelValue:s.tempRange.startTime,"onUpdate:modelValue":t[9]||(t[9]=e=>s.tempRange.startTime=e),start:a.timepickerStartTime,border:!1,disabled:!s.tempRange.startDate,hideSecond:i.hideSecond},{default:vue.withCtx((()=>[vue.withDirectives(vue.createElementVNode("input",{class:"uni-date__input uni-date-range__input",type:"text","onUpdate:modelValue":t[8]||(t[8]=e=>s.tempRange.startTime=e),placeholder:a.startTimeText,disabled:!s.tempRange.startDate},null,8,["placeholder","disabled"]),[[vue.vModelText,s.tempRange.startTime]])])),_:1},8,["modelValue","start","disabled","hideSecond"])]),vue.createVNode(n,{type:"arrowthinright",color:"#999",style:{"line-height":"40px"}}),vue.createElementVNode("view",{class:"popup-x-header--datetime"},[vue.withDirectives(vue.createElementVNode("input",{class:"uni-date__input uni-date-range__input",type:"text","onUpdate:modelValue":t[10]||(t[10]=e=>s.tempRange.endDate=e),placeholder:a.endDateText},null,8,["placeholder"]),[[vue.vModelText,s.tempRange.endDate]]),vue.createVNode(o,{type:"time",modelValue:s.tempRange.endTime,"onUpdate:modelValue":t[12]||(t[12]=e=>s.tempRange.endTime=e),end:a.timepickerEndTime,border:!1,disabled:!s.tempRange.endDate,hideSecond:i.hideSecond},{default:vue.withCtx((()=>[vue.withDirectives(vue.createElementVNode("input",{class:"uni-date__input uni-date-range__input",type:"text","onUpdate:modelValue":t[11]||(t[11]=e=>s.tempRange.endTime=e),placeholder:a.endTimeText,disabled:!s.tempRange.endDate},null,8,["placeholder","disabled"]),[[vue.vModelText,s.tempRange.endTime]])])),_:1},8,["modelValue","end","disabled","hideSecond"])])])):vue.createCommentVNode("",!0),vue.createElementVNode("view",{class:"popup-x-body"},[vue.createVNode(l,{ref:"left",showMonth:!1,"start-date":s.calendarRange.startDate,"end-date":s.calendarRange.endDate,range:!0,pleStatus:s.endMultipleStatus,onChange:a.leftChange,onFirstEnterCale:a.updateRightCale,style:{padding:"0 8px"}},null,8,["start-date","end-date","pleStatus","onChange","onFirstEnterCale"]),vue.createVNode(l,{ref:"right",showMonth:!1,"start-date":s.calendarRange.startDate,"end-date":s.calendarRange.endDate,range:!0,onChange:a.rightChange,pleStatus:s.startMultipleStatus,onFirstEnterCale:a.updateLeftCale,style:{padding:"0 8px","border-left":"1px solid #F1F1F1"}},null,8,["start-date","end-date","onChange","pleStatus","onFirstEnterCale"])]),s.hasTime?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"popup-x-footer"},[vue.createElementVNode("text",{onClick:t[13]||(t[13]=(...e)=>a.clear&&a.clear(...e))},vue.toDisplayString(a.clearText),1),vue.createElementVNode("text",{class:"confirm-text",onClick:t[14]||(t[14]=(...e)=>a.confirmRangeChange&&a.confirmRangeChange(...e))},vue.toDisplayString(a.okText),1)])):vue.createCommentVNode("",!0)],4)):(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-date-single--x",style:vue.normalizeStyle(s.pickerPositionStyle)},[vue.createElementVNode("view",{class:"uni-popper__arrow"}),s.hasTime?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"uni-date-changed popup-x-header"},[vue.withDirectives(vue.createElementVNode("input",{class:"uni-date__input text-center",type:"text","onUpdate:modelValue":t[3]||(t[3]=e=>s.inputDate=e),placeholder:a.selectDateText},null,8,["placeholder"]),[[vue.vModelText,s.inputDate]]),vue.createVNode(o,{type:"time",modelValue:s.pickerTime,"onUpdate:modelValue":t[5]||(t[5]=e=>s.pickerTime=e),border:!1,disabled:!s.inputDate,start:a.timepickerStartTime,end:a.timepickerEndTime,hideSecond:i.hideSecond,style:{width:"100%"}},{default:vue.withCtx((()=>[vue.withDirectives(vue.createElementVNode("input",{class:"uni-date__input text-center",type:"text","onUpdate:modelValue":t[4]||(t[4]=e=>s.pickerTime=e),placeholder:a.selectTimeText,disabled:!s.inputDate},null,8,["placeholder","disabled"]),[[vue.vModelText,s.pickerTime]])])),_:1},8,["modelValue","disabled","start","end","hideSecond"])])):vue.createCommentVNode("",!0),vue.createVNode(l,{ref:"pcSingle",showMonth:!1,"start-date":s.calendarRange.startDate,"end-date":s.calendarRange.endDate,date:s.calendarDate,onChange:a.singleChange,"default-value":i.defaultValue,style:{padding:"0 8px"}},null,8,["start-date","end-date","date","onChange","default-value"]),s.hasTime?(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"popup-x-footer"},[vue.createElementVNode("text",{class:"confirm-text",onClick:t[6]||(t[6]=(...e)=>a.confirmSingleChange&&a.confirmSingleChange(...e))},vue.toDisplayString(a.okText),1)])):vue.createCommentVNode("",!0)],4))],512)),[[vue.vShow,s.pickerVisible]]),s.isPhone?(vue.openBlock(),vue.createBlock(l,{key:1,ref:"mobile",clearDate:!1,date:s.calendarDate,defTime:a.mobileCalendarTime,"start-date":s.calendarRange.startDate,"end-date":s.calendarRange.endDate,selectableTimes:a.mobSelectableTime,startPlaceholder:i.startPlaceholder,endPlaceholder:i.endPlaceholder,"default-value":i.defaultValue,pleStatus:s.endMultipleStatus,showMonth:!1,range:s.isRange,hasTime:s.hasTime,insert:!1,hideSecond:i.hideSecond,onConfirm:a.mobileChange,onMaskClose:a.close},null,8,["date","defTime","start-date","end-date","selectableTimes","startPlaceholder","endPlaceholder","default-value","pleStatus","range","hasTime","hideSecond","onConfirm","onMaskClose"])):vue.createCommentVNode("",!0)])}const uniDatetimePicker=_export_sfc(_sfc_main$q,[["render",_sfc_render$2],["__scopeId","data-v-cf614027"]]),_sfc_main$p=vue.defineComponent({__name:"MovieRegisterPage",setup(e){const t=useStore();let i=!1;const r=vue.ref(null),s=vue.reactive({userId:"",username:"",telephone:"",email:"",birthday:"",sex:0,password:"",sign:"",region:""}),a=vue.ref(""),n=()=>{var e;null==(e=r.value)||e.$refs.popup.open("top")},o=e=>{s.sex=e},l=()=>getUserByIdService(s.userId).then((e=>!(e.data>0)||(uni.showToast({title:"账号已存在",icon:"none"}),!1))),c=async()=>{if(s.userId)if(s.password)if(a.value)if(s.username)if(s.password!==a.value)uni.showToast({title:"确认密码错误",icon:"none"});else{if(i)return;i=!0;await l()&&await registerService({...s}).then((e=>{t.setUserData(e.data),t.setToken(e.token),uni.setStorage({key:"token",data:e.token}),httpRequest.setToken(e.token),uni.redirectTo({url:"../pages/IndexPage"}),uni.showToast({duration:2e3,position:"center",title:"注册成功"})})),i=!1}else uni.showToast({title:"请输入昵称",icon:"none"});else uni.showToast({title:"请输入确认密码",icon:"none"});else uni.showToast({title:"请输入密码",icon:"none"});else uni.showToast({title:"请输入账号",icon:"none"})};return(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createElementVNode("view",{class:"module-block module-block-column"},[vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",{class:"require"},"*"),vue.createElementVNode("text",null,"账号")]),vue.withDirectives(vue.createElementVNode("input",{onBlur:l,class:"input","onUpdate:modelValue":t[0]||(t[0]=e=>s.userId=e),placeholder:"请输入账号名称"},null,544),[[vue.vModelText,s.userId]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",{class:"require"},"*"),vue.createElementVNode("text",null,"密码")]),vue.withDirectives(vue.createElementVNode("input",{type:"password",class:"input","onUpdate:modelValue":t[1]||(t[1]=e=>s.password=e),placeholder:"请输入密码"},null,512),[[vue.vModelText,s.password]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",{class:"require"},"*"),vue.createElementVNode("text",null,"确认密码")]),vue.withDirectives(vue.createElementVNode("input",{type:"password","onUpdate:modelValue":t[2]||(t[2]=e=>a.value=e),class:"input",placeholder:"请确认密码"},null,512),[[vue.vModelText,a.value]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",{class:"require"},"*"),vue.createElementVNode("text",null,"昵称")]),vue.withDirectives(vue.createElementVNode("input",{class:"input","onUpdate:modelValue":t[3]||(t[3]=e=>s.username=e),placeholder:"请输入昵称"},null,512),[[vue.vModelText,s.username]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",null,"性别")]),vue.withDirectives(vue.createElementVNode("input",{class:"input",disabled:"",onClick:n,"onUpdate:modelValue":t[4]||(t[4]=e=>vue.unref(SexMap)[s.sex]=e),placeholder:"请选择性别"},null,512),[[vue.vModelText,vue.unref(SexMap)[s.sex]]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",null,"出生日期")]),vue.createVNode(uniDatetimePicker,{border:!1,class:"input",type:"date","clear-icon":!1,modelValue:s.birthday,"onUpdate:modelValue":t[5]||(t[5]=e=>s.birthday=e)},null,8,["modelValue"])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",null,"电话")]),vue.withDirectives(vue.createElementVNode("input",{class:"input","onUpdate:modelValue":t[6]||(t[6]=e=>s.telephone=e),placeholder:"请输入电话号码"},null,512),[[vue.vModelText,s.telephone]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",null,"邮箱")]),vue.withDirectives(vue.createElementVNode("input",{class:"input","onUpdate:modelValue":t[7]||(t[7]=e=>s.email=e),placeholder:"请输入邮箱"},null,512),[[vue.vModelText,s.email]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",null,"区域")]),vue.withDirectives(vue.createElementVNode("input",{class:"input","onUpdate:modelValue":t[8]||(t[8]=e=>s.region=e),placeholder:"请输入区域"},null,512),[[vue.vModelText,s.region]])]),vue.createElementVNode("view",{class:"row"},[vue.createElementVNode("view",{class:"title"},[vue.createElementVNode("text",null,"个性签名")]),vue.withDirectives(vue.createElementVNode("input",{class:"input","onUpdate:modelValue":t[9]||(t[9]=e=>s.sign=e),placeholder:"请输入个性签名"},null,512),[[vue.vModelText,s.sign]])])]),vue.createElementVNode("view",{class:"login-btn",onClick:c},"注册"),vue.createVNode(vue.unref(OptionsDialog),{ref_key:"sexOptionsDialog",ref:r,onOnCheck:o,options:[{value:0,text:"男"},{value:1,text:"女"}]},null,512)]))}}),MoviePagesMovieRegisterPage=_export_sfc(_sfc_main$p,[["__scopeId","data-v-ba174006"]]),_sfc_main$o=vue.defineComponent({__name:"MovieSearchPage",setup(e){const t=vue.reactive([]),i=useRoute(),r=decodeURIComponent(i.query.keyword),s=vue.reactive([]),a=vue.reactive([]),n=vue.ref(!1),o=vue.ref(!1),l=vue.ref(""),c=vue.ref(1),u=vue.ref(20);uni.getStorage({key:"historyMovieLabels"}).then((e=>{e&&t.push(...e.data.split(","))})),getRecommendService(i.query.classify).then((e=>{s.push(...e.data)}));const d=()=>{if(l.value||(l.value=r),o.value)return;n.value=o.value=!0;const e=t.findIndex((e=>e===l.value));-1!==e&&t.splice(e,1),t.unshift(l.value),uni.setStorage({key:"historyMovieLabels",data:t.join(",")}),getSearchService(l.value,c.value,u.value).then((e=>{a.splice(0,a.length,...e.data)})).finally((()=>{o.value=!1}))},h=()=>{o.value||(n.value=!1,l.value="")};return(e,i)=>(vue.openBlock(),vue.createElementBlock("scroll-view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createElementVNode("view",{class:"module-block module-block-row"},[vue.createElementVNode("view",{class:"search-input-wrapper"},[vue.withDirectives(vue.createElementVNode("input",{class:"search-input","onUpdate:modelValue":i[0]||(i[0]=e=>l.value=e),placeholder:vue.unref(r)},null,8,["placeholder"]),[[vue.vModelText,l.value]]),l.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,onClick:h,class:"icon-clear",src:"/static/icon_clear.png"})):vue.createCommentVNode("",!0)]),vue.createElementVNode("text",{class:"search-btn",onClick:d},"搜索")]),n.value?(vue.openBlock(),vue.createElementBlock(vue.Fragment,{key:0},[o.value?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"module-block module-block-last"},[vue.createVNode(MovieListComponent,{direction:"vertical",list:a},null,8,["list"])]))],64)):(vue.openBlock(),vue.createElementBlock(vue.Fragment,{key:1},[vue.createElementVNode("view",{class:"module-block",style:{"padding-right":"0"}},[vue.createVNode(TitleComponent,{title:"历史记录"}),vue.createElementVNode("view",{class:"record-list"},[t.length>0?(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,{key:0},vue.renderList(t,((e,t)=>(vue.openBlock(),vue.createElementBlock("text",{onClick:t=>(e=>{l.value=e,d()})(e),class:"record-item",key:e+t},vue.toDisplayString(e),9,["onClick"])))),128)):vue.createCommentVNode("",!0),vue.createElementVNode("text",{class:"no-data"},"暂无搜索记录")])]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(TitleComponent,{title:"推荐"}),vue.createVNode(MovieListComponent,{direction:"vertical",list:s},null,8,["list"])])],64))]))}}),MoviePagesMovieSearchPage=_export_sfc(_sfc_main$o,[["__scopeId","data-v-4bf7938f"]]),_sfc_main$n=vue.defineComponent({__name:"MusicSearchComponent",setup(e){const t=vue.ref(""),i=()=>{uni.navigateTo({url:"../pages/MusicSearchPage?keyword="+encodeURIComponent(t.value)})};return getKeyWordMusicService().then((e=>t.value=e.data.songName)),(e,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:"search-wrapper module-block"},[vue.createVNode(vue.unref(AvaterComponent),{size:"middle"}),vue.createElementVNode("view",{class:"search-input-wrapper",onClick:i},[vue.createElementVNode("text",{class:"search-input-placehold"},vue.toDisplayString(t.value),1)])]))}}),MusicSearchComponent=_export_sfc(_sfc_main$n,[["__scopeId","data-v-b7bcd89c"]]),_sfc_main$m=vue.defineComponent({__name:"MusicTitleComponent",props:{classifyItem:{type:Object,reqiure:!0,default:{}}},emits:["useMore"],setup(e,{emit:t}){const i=()=>{t("useMore")};return(t,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:"classify-title-wrapper"},[vue.createElementVNode("image",{class:"icon-classify-arrow",src:"/static/icon_down.png"}),vue.createElementVNode("text",{class:"classify-name"},vue.toDisplayString(e.classifyItem.classifyName),1),vue.renderSlot(t.$slots,"default",{},(()=>[vue.createElementVNode("text",{class:"classify-more",onClick:i},"更多")]),!0)]))}}),MusicTitleComponent=_export_sfc(_sfc_main$m,[["__scopeId","data-v-fcc1a0e8"]]),_sfc_main$l=vue.defineComponent({__name:"MusicAvaterComponent",props:{type:{type:String,default:""},avater:{type:String,default:""},name:{type:String,default:""},size:{type:String,default:"middle"}},setup:e=>(t,i)=>e.avater?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:vue.normalizeClass(["music-cover","music-cover"+e.size]),src:vue.unref(getMusicCover)(e.avater)},null,10,["src"])):"music"===e.type?(vue.openBlock(),vue.createElementBlock("image",{key:1,class:vue.normalizeClass(["music-cover","music-cover"+e.size]),src:"/static/default_cover.jpg"},null,2)):(vue.openBlock(),vue.createElementBlock("text",{key:2,class:vue.normalizeClass(["music-cover","music-cover"+e.size])},vue.toDisplayString(e.name[0]),3))}),MusicAvaterComponent=_export_sfc(_sfc_main$l,[["__scopeId","data-v-d5966a12"]]),_sfc_main$k=vue.defineComponent({__name:"MusicSingerComponent",props:{classifyItem:{type:Object,reqiure:!0,default:{}}},setup(e){const t=vue.reactive([]);getMusicAuthorListByCategoryIdService(0,1,4).then((e=>{t.push(...e.data)}));const i=()=>{uni.navigateTo({url:"../pages/MusicAuthorCategoryPage"})};return(r,s)=>(vue.openBlock(),vue.createElementBlock("view",{class:"module-block"},[vue.createVNode(MusicTitleComponent,{classifyItem:e.classifyItem,onUseMore:i},null,8,["classifyItem"]),vue.createElementVNode("view",{class:"author-list"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(t,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"author-item",key:e.id,onClick:t=>(e=>{uni.navigateTo({url:`../pages/AuthorMusicListPage?data=${encodeURIComponent(JSON.stringify(e))}`})})(e)},[vue.createVNode(MusicAvaterComponent,{type:"author",size:"big",name:e.authorName,avater:e.avatar},null,8,["name","avater"]),vue.createElementVNode("text",{class:"author-name"},vue.toDisplayString(e.authorName),1)],8,["onClick"])))),128))])]))}}),MusicSingerComponent=_export_sfc(_sfc_main$k,[["__scopeId","data-v-cbcfa805"]]),isLikeIcon="/assets/icon_like.b458a743.png",isLikeActiveIcon="/assets/icon_like_active.b5e321df.png",pauseIcon$1="/assets/icon_music_play.8894f226.png",playingIcon$1="/assets/icon_music_playing_grey.ea2c3a08.png",_sfc_main$j=vue.defineComponent({__name:"MusicClassifyListComponent",props:{musicList:{type:Array,default:[]},classifyName:{type:String,default:""}},emits:["onPlayMusic"],setup(e,{emit:t}){let i=!1;const r=useStore();return(s,a)=>(vue.openBlock(),vue.createElementBlock("view",{class:"module-block-column"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(e.musicList,((s,a)=>{var n,o;return vue.openBlock(),vue.createElementBlock("view",{class:"music-row",key:s.id,onClick:e=>((e,i)=>{t("onPlayMusic",e,i)})(s,a)},[vue.createVNode(MusicAvaterComponent,{type:"music",name:s.songName,avater:s.cover},null,8,["name","avater"]),vue.createElementVNode("text",{class:"music-name"},vue.toDisplayString(s.authorName)+" - "+vue.toDisplayString(s.songName),1),vue.createElementVNode("image",{class:"icon-small",src:(null==(n=vue.unref(r).musicItem)?void 0:n.id)==s.id&&vue.unref(r).isPlaying&&vue.unref(r).classifyName===e.classifyName?vue.unref(playingIcon$1):vue.unref(pauseIcon$1)},null,8,["src"]),vue.createElementVNode("image",{class:"icon-small",onClick:vue.withModifiers((e=>{return t=s,void(i||(i=!0,t.isLike?deleteMusicLikeService(t.id).then((e=>{e.data>0&&(t.isLike=0,uni.showToast({duration:2e3,position:"center",title:"取消点赞成功"}))})).finally((()=>i=!1)):insertMusicLikeService(t.id).then((e=>{e.data>0&&(t.isLike=1,uni.showToast({duration:2e3,position:"center",title:"点赞成功"}))})).finally((()=>i=!1))));var t}),["stop"]),src:(null==(o=vue.unref(r).musicItem)?void 0:o.isLike)?vue.unref(isLikeActiveIcon):vue.unref(isLikeIcon)},null,8,["onClick","src"]),vue.createElementVNode("image",{class:"icon-small",src:"/static/icon_music_menu.png"})],8,["onClick"])})),128))]))}}),MusicClassifyListComponent=_export_sfc(_sfc_main$j,[["__scopeId","data-v-46f3f9c6"]]),_sfc_main$i=vue.defineComponent({__name:"MusicClassifyComponent",props:{classifyItem:{type:Object,reqiure:!0,default:{}}},setup(e){const{classifyItem:t}=e,i=vue.reactive([]),r=useStore(),s=async e=>{var i;(null==(i=r.musicItem)?void 0:i.id)!==e.id&&(r.setMusic(e,!0),r.classifyName!==t.classifyName&&await getMusicListByClassifyIdService(t.id,1,MAX_FAVORITE_NUMBER).then((e=>r.setMusicList(e.data)))),uni.navigateTo({url:"../pages/MusicPlayerPage"})},a=()=>{uni.navigateTo({url:`../pages/MusicClassifyListPage?data=${encodeURIComponent(JSON.stringify(t))}`})};return getMusicListByClassifyIdService(t.id,1,3).then((e=>{i.push(...e.data)})),(t,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:"module-block"},[vue.createVNode(vue.unref(MusicTitleComponent),{onUseMore:a,classifyItem:e.classifyItem},null,8,["classifyItem"]),vue.createVNode(vue.unref(MusicClassifyListComponent),{class:"component-gap",onOnPlayMusic:s,musicList:i,classifyName:e.classifyItem.classifyName},null,8,["musicList","classifyName"])]))}}),MusicClassifyComponent=_export_sfc(_sfc_main$i,[["__scopeId","data-v-edf8162e"]]),_sfc_main$h=vue.defineComponent({__name:"MusicHomeComponent",setup(e){const t=vue.ref(3),i=vue.reactive([]),r=()=>{uni.navigateTo({url:"../pages/AuthorMusicListPage"})},s=()=>{uni.navigateTo({url:"../pages/MusicCategoryListPage"})};getMusicClassifyService().then((e=>{i.push(...e.data)}));const a=()=>{t.value<i.length&&t.value++};return(e,n)=>(vue.openBlock(),vue.createElementBlock("scroll-view",{class:"page-wrapper","scroll-y":"",onScrolltolower:a,"show-scrollbar":"false"},[vue.createElementVNode("view",null,[vue.createVNode(MusicSearchComponent),vue.createElementVNode("view",{class:"category-wrapper module-block"},[vue.createElementVNode("view",{class:"category-item",onClick:r},[vue.createElementVNode("image",{class:"category-img",src:"/static/icon_music_singer.png"}),vue.createElementVNode("text",{class:"category-name"},"歌手")]),vue.createElementVNode("view",{class:"category-item",onClick:s},[vue.createElementVNode("image",{class:"category-img",src:"/static/icon_music_classify.png"}),vue.createElementVNode("text",{class:"category-name"},"分类歌曲")]),vue.createElementVNode("view",{class:"category-item"},[vue.createElementVNode("image",{class:"category-img",src:"/static/icon_music_classics.png"}),vue.createElementVNode("text",{class:"category-name"},"经典老歌")]),vue.createElementVNode("view",{class:"category-item"},[vue.createElementVNode("image",{class:"category-img",src:"/static/icon_music_rank.png"}),vue.createElementVNode("text",{class:"category-name"},"热门榜单")])]),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(i.slice(0,t.value),((e,t)=>(vue.openBlock(),vue.createElementBlock(vue.Fragment,null,["推荐歌手"===e.classifyName?(vue.openBlock(),vue.createBlock(MusicSingerComponent,{key:"singerId"+e.id,classifyItem:e},null,8,["classifyItem"])):(vue.openBlock(),vue.createBlock(MusicClassifyComponent,{class:vue.normalizeClass(t===i.length-1?"module-block-last":""),key:"classifyId"+e.id,classifyItem:e},null,8,["class","classifyItem"]))],64)))),256)),vue.createElementVNode("view",{class:"bottom"},[vue.createElementVNode("text",null,vue.toDisplayString(t.value===i.length?"已经到底了":"正在加载更多..."),1)])])],32))}}),MusicHomeComponent=_export_sfc(_sfc_main$h,[["__scopeId","data-v-1836179a"]]),_sfc_main$g=vue.defineComponent({__name:"MusicRecommentComponent",setup(e){const t=useStore(),i=vue.ref(20);let r=!1;const s=vue.ref(1),a=vue.ref(0),n=vue.reactive([]),o=()=>{r=!0,getMusicListByClassifyIdService(1,s.value,i.value).then((e=>{0===a.value&&(a.value=e.total),n.push(...e.data)})).finally((()=>{r=!1}))},l=()=>{r||a.value>i.value*s.value&&(s.value++,o())};return o(),(e,r)=>(vue.openBlock(),vue.createElementBlock("scroll-view",{class:"page-wrapper",onScrolltolower:l,"scroll-y":"","show-scrollbar":"false"},[vue.createElementVNode("view",{class:"music-list"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(n,((e,i)=>{var r;return vue.openBlock(),vue.createElementBlock("view",{class:"music-item module-block",key:e.id},[0===i?(vue.openBlock(),vue.createElementBlock("image",{key:0,src:"/static/icon_no1.png",class:"music-rank"})):vue.createCommentVNode("",!0),1===i?(vue.openBlock(),vue.createElementBlock("image",{key:1,src:"/static/icon_no2.png",class:"music-rank"})):vue.createCommentVNode("",!0),2===i?(vue.openBlock(),vue.createElementBlock("image",{key:2,src:"/static/icon_no3.png",class:"music-rank"})):vue.createCommentVNode("",!0),i>2?(vue.openBlock(),vue.createElementBlock("text",{key:3,class:"music-rank"},vue.toDisplayString(i+1),1)):vue.createCommentVNode("",!0),vue.createVNode(MusicAvaterComponent,{type:"music",name:e.songName,avater:e.cover},null,8,["name","avater"]),vue.createElementVNode("view",{class:"music-info"},[vue.createElementVNode("text",null,vue.toDisplayString(e.songName),1),vue.createElementVNode("text",{class:"music-author"},vue.toDisplayString(e.authorName),1)]),vue.createElementVNode("image",{class:"icon-operatation",onClick:i=>(async e=>{var i;(null==(i=t.musicItem)?void 0:i.id)!==e.id&&(t.setMusic(e),"推荐歌曲"!==t.classifyName&&await getMusicListByClassifyIdService(1,1,MAX_FAVORITE_NUMBER).then((e=>t.setMusicList(e.data)))),uni.navigateTo({url:"../pages/MusicPlayerPage"})})(e),src:vue.unref(t).isPlaying&&(null==(r=vue.unref(t).musicItem)?void 0:r.id)===e.id?vue.unref(playingIcon$1):vue.unref(pauseIcon$1)},null,8,["onClick","src"]),e.isLike?(vue.openBlock(),vue.createElementBlock("image",{key:4,class:"icon-operatation",src:"/static/icon_like_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:5,class:"icon-operatation",src:"/static/icon_like.png"})),vue.createElementVNode("image",{class:"icon-operatation",src:"/static/icon_music_menu.png"})])})),128)),vue.createElementVNode("view",{class:"bottom"},[vue.createElementVNode("text",null,vue.toDisplayString(a.value>i.value*s.value?"正在加载更多...":"已经到底了"),1)])])],32))}}),MusicRecommentComponent=_export_sfc(_sfc_main$g,[["__scopeId","data-v-4efb779c"]]),_sfc_main$f=vue.defineComponent({__name:"MusicCircleComponent",setup(e){const t=vue.ref(-1),i=vue.reactive([]),r=vue.ref(1),s=vue.ref([]),a=vue.ref(0),n=useStore();let o=!1;getCircleListByTypeService(CircleEnum.MUSIC,r.value,5).then((e=>{i.push(...e.data),a.value=e.total}));const l=()=>{t.value=-1},c=()=>{5*r.value>=a.value||(r.value++,getCircleListByTypeService(CircleEnum.MUSIC,r.value,5).then((e=>{i.push(...e.data)})))},u=()=>{uni.navigateTo({url:"../pages/MusicCirClePublishPage"})};return(e,d)=>(vue.openBlock(),vue.createElementBlock("scroll-view",{class:"page-wrapper",onClick:l,"scroll-y":"",onScrolltolower:c,"show-scrollbar":"false"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(i,((e,i)=>{var r,a,l,c;return vue.openBlock(),vue.createElementBlock("view",{class:"module-block module-block-row",key:e.id},[e.useravater?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"user-avater",src:vue.unref(HOST)+e.useravater},null,8,["src"])):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"user-avater",src:"/static/default_avater.png"})),vue.createElementVNode("view",{class:"content-wrapper"},[vue.createElementVNode("text",{class:"user-name"},vue.toDisplayString(e.username),1),vue.createElementVNode("text",{class:"content"},vue.toDisplayString(e.content),1),vue.createElementVNode("view",{class:"music-wrapper"},[vue.createVNode(MusicAvaterComponent,{type:"music",name:e.musicSongName,avater:e.musicCover},null,8,["name","avater"]),vue.createElementVNode("view",{class:"music-info"},[vue.createElementVNode("text",{class:"music-name"},vue.toDisplayString(e.musicSongName)+" - "+vue.toDisplayString(e.musicAuthorName),1)]),vue.createElementVNode("image",{class:"icon-music-play",src:"/static/icon_music_play.png"})]),vue.createElementVNode("view",{class:"operate-wrapper"},[vue.createElementVNode("text",{class:"create-time"},vue.toDisplayString(vue.unref(formatTime)(e.createTime)),1),vue.createElementVNode("view",{class:"popup-wrapper"},[vue.createElementVNode("image",{class:"icon-menu",src:"/static/icon_music_menu.png",onClick:vue.withModifiers((e=>(e=>{t.value=e})(i)),["stop"])},null,8,["onClick"]),t.value===i?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"popup-menu"},[vue.createElementVNode("view",{class:"popup-menu-item",onClick:vue.withModifiers((i=>(e=>{if(o)return;o=!0;const i=e.circleLikes.findIndex((e=>e.userId===n.userData.userId));if(-1!==i)deleteLikeService(e.id,CommentEnum.MUSIC_CIRCLE).then((t=>{t.data>0&&e.circleLikes.splice(i,1)})).finally((()=>{o=!1,t.value=-1}));else{const i={type:CommentEnum.MUSIC_CIRCLE,relationId:e.id};saveLikeService(i).then((t=>{t.data&&e.circleLikes.push(t.data)})).finally((()=>{o=!1,t.value=-1}))}})(e)),["stop"])},[vue.createElementVNode("image",{class:"icon-popup-menu",src:"/static/icon_like_white.png"}),vue.createElementVNode("text",null,vue.toDisplayString((e.circleLikes||[]).find((e=>e.userId===vue.unref(n).userData.userId))?"取消赞":"赞"),1)],8,["onClick"]),vue.createElementVNode("view",{class:"popup-menu-item",onClick:e=>(e=>{s.value[e].useShowInput()})(i)},[vue.createElementVNode("image",{class:"icon-popup-menu",src:"/static/icon_comment_white.png"}),vue.createElementVNode("text",null,"评论")],8,["onClick"])])):vue.createCommentVNode("",!0)])]),(null==(r=e.circleLikes)?void 0:r.length)>0||(null==(a=e.circleComments)?void 0:a.length)>0?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"social-wrapper"},[(null==(l=e.circleLikes)?void 0:l.length)>0?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"like-wrapper"},[vue.createElementVNode("image",{class:"icon-like",src:"/static/icon_music_like.png"}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(e.circleLikes,((t,i)=>(vue.openBlock(),vue.createElementBlock(vue.Fragment,{key:t.id},[vue.createElementVNode("text",{class:"like-user"},vue.toDisplayString(t.username),1),i!==e.circleLikes.length-1?(vue.openBlock(),vue.createElementBlock("text",{key:0},"、")):vue.createCommentVNode("",!0)],64)))),128))])):vue.createCommentVNode("",!0),(null==(c=e.circleComments)?void 0:c.length)>0?(vue.openBlock(),vue.createBlock(CommentComponent,{key:1,ref_for:!0,ref_key:"commentRefs",ref:s,relationId:e.id,category:vue.unref(CommentEnum).MUSIC_CIRCLE,commentList:e.circleComments},null,8,["relationId","category","commentList"])):vue.createCommentVNode("",!0)])):vue.createCommentVNode("",!0)])])})),128)),a.value?(vue.openBlock(),vue.createElementBlock("text",{key:0,class:"bottm"},vue.toDisplayString(5*r.value>=a.value?"已经到底了":"正在加载更多"),1)):vue.createCommentVNode("",!0),vue.createElementVNode("image",{onClick:u,class:"icon-add-circle",src:"/static/icon_music_add.png"})],32))}}),MusicCircleComponent=_export_sfc(_sfc_main$f,[["__scopeId","data-v-8c7076de"]]),_sfc_main$e=vue.defineComponent({__name:"MusicMyComponent",setup(e){const t=useStore(),i=vue.reactive([]),r=vue.reactive([]),s=vue.reactive([]),a=vue.reactive([]);getFavoriteDirectoryService(0).then((e=>{i.push(...e.data)})),getFavoriteAuthorService(1,5).then((e=>{r.push(...e.data)})),getMusicRecordService(1,5).then((e=>{s.push(...e.data)}));return(e,n)=>(vue.openBlock(),vue.createElementBlock("scroll-view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createElementVNode("view",{class:"module-block module-block-row"},[vue.createVNode(AvaterComponent,{size:"middle"}),vue.createElementVNode("view",{class:"use-info"},[vue.createElementVNode("text",{class:"username"},vue.toDisplayString(vue.unref(t).userData.username),1),vue.createElementVNode("text",{class:"sign"},vue.toDisplayString(vue.unref(t).userData.sign),1)])]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(MusicTitleComponent,{classifyItem:{classifyName:"我的歌单",category:""}},{default:vue.withCtx((()=>[vue.createElementVNode("text",{class:"icon-add"},"+")])),_:1}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(i,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"singer-list",key:e.id,onClick:t=>(e=>{uni.navigateTo({url:`../pages/MusicFavoriteListPage?data=${encodeURIComponent(JSON.stringify(e))}`})})(e)},[e.cover?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"music-cover",src:vue.unref(getMusicCover)(e.cover)},null,8,["src"])):(vue.openBlock(),vue.createElementBlock("text",{key:1,class:"music-cover"},vue.toDisplayString(e.name.slice(0,1)),1)),vue.createElementVNode("view",{class:"songname-wrapper"},[vue.createElementVNode("text",null,vue.toDisplayString(e.name),1),vue.createElementVNode("text",{class:"total"},vue.toDisplayString(e.total)+"首",1)]),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_play.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_delete.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_menu.png"})],8,["onClick"])))),128))]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(MusicTitleComponent,{classifyItem:{classifyName:"我关注的歌手",category:""}}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(r,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"singer-list",key:e.id},[vue.createVNode(MusicAvaterComponent,{type:"author",name:e.authorName,avater:e.avatar},null,8,["name","avater"]),vue.createElementVNode("view",{class:"songname-wrapper"},[vue.createElementVNode("text",null,vue.toDisplayString(e.authorName),1),vue.createElementVNode("text",{class:"total"},vue.toDisplayString(e.total)+"首",1)]),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_play.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_delete.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_menu.png"})])))),128))]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(MusicTitleComponent,{classifyItem:{classifyName:"我发布的歌曲",category:""}}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a,(e=>(vue.openBlock(),vue.createElementBlock("view",{key:e.id,class:"singer-list"},[vue.createVNode(MusicAvaterComponent,{type:"music",name:e.songName,avater:e.cover},null,8,["name","avater"]),vue.createElementVNode("view",{class:"songname-wrapper"},[vue.createElementVNode("text",null,vue.toDisplayString(e.authorName),1),vue.createElementVNode("text",{class:"total"},"听过"+vue.toDisplayString(e.times)+"次",1)]),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_play.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_delete.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_menu.png"})])))),128))]),vue.createElementVNode("view",{class:"module-block module-block-last"},[vue.createVNode(MusicTitleComponent,{classifyItem:{classifyName:"我听过的歌曲",category:""}}),(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(s,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"singer-list",key:e.id},[vue.createVNode(MusicAvaterComponent,{type:"music",name:e.songName,avater:e.cover},null,8,["name","avater"]),vue.createElementVNode("view",{class:"songname-wrapper"},[vue.createElementVNode("text",null,vue.toDisplayString(e.songName),1),vue.createElementVNode("text",{class:"total"},vue.toDisplayString(vue.unref(formatTime)(e.createTime)),1)]),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_play.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_delete.png"}),vue.createElementVNode("image",{class:"icon-operate",src:"/static/icon_music_menu.png"})])))),128))])]))}}),MusicMyComponent=_export_sfc(_sfc_main$e,[["__scopeId","data-v-91383783"]]),_sfc_main$d=vue.defineComponent({__name:"MusicIndexPage",setup(e){const t=vue.ref(0),i=useStore(),r=vue.ref(0),s=vue.reactive([!0,!1,!1,!1]),a=e=>{r.value=e,s[e]=!0},n=()=>{t.value+=10,t.value=360===t.value?0:t.value},o=()=>{uni.navigateTo({url:"../pages/MusicPlayerPage"})};return vue.onMounted((()=>{i.audio.onTimeUpdate(n),uni.getStorage({key:MUSIC_STORAGE_KEY,success:e=>{if(""!==e.data&&null!==e.data){const t=JSON.parse(e.data);i.setMusic(t,!1)}}}),uni.getStorage({key:MUSIC_LIST_STORAGE_KEY,success:e=>{if(""!==e.data&&null!==e.data){const t=JSON.parse(e.data);i.setMusicList(t)}}}),uni.getStorage({key:LOOP_STORAGE_KEY,success:e=>{""!==e.data&&null!==e.data&&i.setLoop(e.data)}})})),vue.onActivated((()=>i.audio.onTimeUpdate(n))),vue.onDeactivated((()=>i.audio.offTimeUpdate(n))),vue.onUnmounted((()=>i.audio.offTimeUpdate(n))),(e,n)=>{var l,c;return vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createElementVNode("view",{class:"page-container"},[vue.withDirectives(vue.createVNode(MusicHomeComponent,null,null,512),[[vue.vShow,0===r.value]]),s[1]?vue.withDirectives((vue.openBlock(),vue.createBlock(MusicRecommentComponent,{key:0},null,512)),[[vue.vShow,1===r.value]]):vue.createCommentVNode("",!0),s[2]?vue.withDirectives((vue.openBlock(),vue.createBlock(MusicCircleComponent,{key:1},null,512)),[[vue.vShow,2===r.value]]):vue.createCommentVNode("",!0),s[3]?vue.withDirectives((vue.openBlock(),vue.createBlock(MusicMyComponent,{key:2},null,512)),[[vue.vShow,3===r.value]]):vue.createCommentVNode("",!0)]),vue.createElementVNode("view",{class:"tab-bar"},[vue.createElementVNode("view",{class:"tab-item",onClick:n[0]||(n[0]=e=>a(0))},[0===r.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_home_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_home.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":0===r.value}])},"首页",2)]),vue.createElementVNode("view",{class:"tab-item",onClick:n[1]||(n[1]=e=>a(1))},[1===r.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_recomment_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_recomment.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":1===r.value}])},"推荐",2)]),vue.createElementVNode("view",{class:"mini-player-empty"}),vue.createElementVNode("view",{class:"mini-player-wrapper",onClick:o,style:vue.normalizeStyle({transform:"translateX(-50%) rotate("+t.value+"deg)"})},[(null==(l=vue.unref(i).musicItem)?void 0:l.id)?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"music-img-cover",src:vue.unref(getMusicCover)(null==(c=vue.unref(i).musicItem)?void 0:c.cover)},null,8,["src"])):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"music-img-default",src:"/static/icon_music.png",alt:""}))],4),vue.createElementVNode("view",{class:"tab-item",onClick:n[2]||(n[2]=e=>a(2))},[2===r.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_music_circle_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_music_circle.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":2===r.value}])},"音乐圈",2)]),vue.createElementVNode("view",{class:"tab-item",onClick:n[3]||(n[3]=e=>a(3)),"data-index":"3"},[3===r.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"tab-icon",src:"/static/icon_user_active.png"})):(vue.openBlock(),vue.createElementBlock("image",{key:1,class:"tab-icon",src:"/static/icon_user.png"})),vue.createElementVNode("text",{class:vue.normalizeClass(["tab-text",{"tab-text-active":3===r.value}])},"我的",2)])])])}}}),_sfc_main$c={};function _sfc_render$1(e,t){return vue.openBlock(),vue.createElementBlock("scroll-view",{class:"page-wrapper"})}const MusicPagesMusicCirClePublishPage=_export_sfc(_sfc_main$c,[["render",_sfc_render$1]]),_sfc_main$b=vue.defineComponent({__name:"MusicSearchPage",setup(e){const t=useStore(),i=useRoute(),r=vue.reactive([]),s=decodeURIComponent(i.query.keyword),a=vue.reactive([]),n=vue.ref(!1),o=vue.ref(!1),l=vue.ref(""),c=vue.ref(1),u=vue.ref(20);uni.getStorage({key:MUSIC_SEARCH_STORAGE_KEY}).then((e=>{e&&r.push(...e.data.split(","))}));const d=()=>{if(l.value||(l.value=s),o.value)return;n.value=o.value=!0;const e=r.findIndex((e=>e===l.value));-1!==e&&r.splice(e,1),r.unshift(l.value),uni.setStorage({key:MUSIC_SEARCH_STORAGE_KEY,data:r.join(",")}),searchMusicService(l.value,c.value,u.value).then((e=>{a.splice(0,a.length,...e.data)})).finally((()=>{o.value=!1}))},h=()=>{o.value||(n.value=!1,l.value="")};return(e,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createElementVNode("view",{class:"module-block module-block-row"},[vue.createElementVNode("view",{class:"search-input-wrapper"},[vue.withDirectives(vue.createElementVNode("input",{class:"search-input","onUpdate:modelValue":i[0]||(i[0]=e=>l.value=e),placeholder:vue.unref(s)},null,8,["placeholder"]),[[vue.vModelText,l.value]]),l.value?(vue.openBlock(),vue.createElementBlock("image",{key:0,onClick:h,class:"icon-clear",src:"/static/icon_clear.png"})):vue.createCommentVNode("",!0)]),vue.createElementVNode("text",{class:"search-btn",onClick:d},"搜索")]),n.value?(vue.openBlock(),vue.createElementBlock(vue.Fragment,{key:0},[o.value?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("scroll-view",{key:0,class:"module-block module-block-last scroll-list","scroll-y":"","show-scrollbar":"false"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(a,(e=>(vue.openBlock(),vue.createElementBlock("view",{key:e.id,class:"scroll-view-item"},[vue.createElementVNode("image",{class:"song-cover",src:vue.unref(getMusicCover)(e.cover)},null,8,["src"]),vue.createVNode(MusicAvaterComponent,{type:"music",class:"song-cover",name:e.songName,avater:e.cover},null,8,["name","avater"]),vue.createElementVNode("view",{class:"name-wrapper"},[vue.createElementVNode("text",{class:"song-name"},vue.toDisplayString(e.songName),1),vue.createElementVNode("text",{class:"author-name"},vue.toDisplayString(e.authorName),1)]),vue.createElementVNode("image",{onClick:i=>{return r=e,(null==(s=t.musicItem)?void 0:s.id)===r.id&&t.setMusic(r),void uni.navigateTo({url:"../pages/MusicPlayerPage"});var r,s},class:"icon-play",src:vue.unref(t).isPlaying&&vue.unref(t).musicItem.id===e.id?vue.unref(playingIcon$1):vue.unref(pauseIcon$1)},null,8,["onClick","src"]),vue.createElementVNode("image",{class:"icon-play",src:e.isLike?vue.unref(isLikeActiveIcon):vue.unref(isLikeIcon)},null,8,["src"]),vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_music_menu.png"})])))),128))]))],64)):(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"module-block",style:{"padding-right":"0"}},[vue.createVNode(TitleComponent,{title:"历史记录"}),vue.createElementVNode("view",{class:"record-list"},[r.length>0?(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,{key:0},vue.renderList(r,((e,t)=>(vue.openBlock(),vue.createElementBlock("text",{onClick:t=>(e=>{l.value=e,d()})(e),class:"record-item",key:e+t},vue.toDisplayString(e),9,["onClick"])))),128)):vue.createCommentVNode("",!0),vue.createElementVNode("text",{class:"no-data"},"暂无搜索记录")])]))]))}}),MusicPagesMusicSearchPage=_export_sfc(_sfc_main$b,[["__scopeId","data-v-2c7806b0"]]);var lyricExports={},lyric={get exports(){return lyricExports},set exports(e){lyricExports=e}};!function(e,t){var i;i=function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=20)}([function(e,t,i){e.exports=!i(3)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){var i=e.exports={version:"2.4.0"};"number"==typeof __e&&(__e=i)},function(e,t){e.exports=function(e){try{return!!e()}catch(e2){return!0}}},function(e,t){var i=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=i)},function(e,t,i){var r=i(11),s=i(16),a=i(18),n=Object.defineProperty;t.f=i(0)?Object.defineProperty:function(e,t,i){if(r(e),t=a(t,!0),r(i),s)try{return n(e,t,i)}catch(e2){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t,i){t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,i){t.__esModule=!0;var r,s=i(8),a=(r=s)&&r.__esModule?r:{default:r};t.default=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),(0,a.default)(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}()},function(e,t,i){e.exports={default:i(9),__esModule:!0}},function(e,t,i){i(19);var r=i(2).Object;e.exports=function(e,t,i){return r.defineProperty(e,t,i)}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,i){var r=i(1);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,i){var r=i(10);e.exports=function(e,t,i){if(r(e),void 0===t)return e;switch(i){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,s){return e.call(t,i,r,s)}}return function(){return e.apply(t,arguments)}}},function(e,t,i){var r=i(1),s=i(4).document,a=r(s)&&r(s.createElement);e.exports=function(e){return a?s.createElement(e):{}}},function(e,t,i){var r=i(4),s=i(2),a=i(12),n=i(15),o="prototype",l=function(e,t,i){var c,u,d,h=e&l.F,m=e&l.G,f=e&l.S,g=e&l.P,p=e&l.B,v=e&l.W,y=m?s:s[t]||(s[t]={}),E=y[o],T=m?r:f?r[t]:(r[t]||{})[o];for(c in m&&(i=t),i)(u=!h&&T&&void 0!==T[c])&&c in y||(d=u?T[c]:i[c],y[c]=m&&"function"!=typeof T[c]?i[c]:p&&u?a(d,r):v&&T[c]==d?function(e){var t=function(t,i,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,i)}return new e(t,i,r)}return e.apply(this,arguments)};return t[o]=e[o],t}(d):g&&"function"==typeof d?a(Function.call,d):d,g&&((y.virtual||(y.virtual={}))[c]=d,e&l.R&&E&&!E[c]&&n(E,c,d)))};l.F=1,l.G=2,l.S=4,l.P=8,l.B=16,l.W=32,l.U=64,l.R=128,e.exports=l},function(e,t,i){var r=i(5),s=i(17);e.exports=i(0)?function(e,t,i){return r.f(e,t,s(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){e.exports=!i(0)&&!i(3)((function(){return 7!=Object.defineProperty(i(13)("div"),"a",{get:function(){return 7}}).a}))},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,i){var r=i(1);e.exports=function(e,t){if(!r(e))return e;var i,s;if(t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;if("function"==typeof(i=e.valueOf)&&!r(s=i.call(e)))return s;if(!t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},function(e,t,i){var r=i(14);r(r.S+r.F*!i(0),"Object",{defineProperty:i(5).f})},function(e,t,i){var r,s,a;s=[e,t,i(6),i(7)],r=function(e,t,i,r){Object.defineProperty(t,"__esModule",{value:!0});var s=n(i),a=n(r);function n(e){return e&&e.__esModule?e:{default:e}}var o=/\[(\d{2,}):(\d{2})(?:\.(\d{2,3}))?]/g,l=0,c=1,u={title:"ti",artist:"ar",album:"al",offset:"offset",by:"by"};function d(){}var h=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d;(0,s.default)(this,e),this.lrc=t,this.tags={},this.lines=[],this.handler=i,this.state=l,this.curLine=0,this._init()}return(0,a.default)(e,[{key:"_init",value:function(){this._initTag(),this._initLines()}},{key:"_initTag",value:function(){for(var e in u){var t=this.lrc.match(new RegExp("\\["+u[e]+":([^\\]]*)]","i"));this.tags[e]=t&&t[1]||""}}},{key:"_initLines",value:function(){for(var e=this.lrc.split("\n"),t=0;t<e.length;t++){var i=e[t],r=o.exec(i);if(r){var s=i.replace(o,"").trim();s&&this.lines.push({time:60*r[1]*1e3+1e3*r[2]+10*(r[3]||0),txt:s})}}this.lines.sort((function(e,t){return e.time-t.time}))}},{key:"_findCurNum",value:function(e){for(var t=0;t<this.lines.length;t++)if(e<=this.lines[t].time)return t;return this.lines.length-1}},{key:"_callHandler",value:function(e){e<0||this.handler({txt:this.lines[e].txt,lineNum:e})}},{key:"_playRest",value:function(){var e=this,t=this.lines[this.curNum].time-(+new Date-this.startStamp);this.timer=setTimeout((function(){e._callHandler(e.curNum++),e.curNum<e.lines.length&&e.state===c&&e._playRest()}),t)}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments[1];this.lines.length&&(this.state=c,this.curNum=this._findCurNum(e),this.startStamp=+new Date-e,t||this._callHandler(this.curNum-1),this.curNum<this.lines.length&&(clearTimeout(this.timer),this._playRest()))}},{key:"togglePlay",value:function(){var e=+new Date;this.state===c?(this.stop(),this.pauseStamp=e):(this.state=c,this.play((this.pauseStamp||e)-(this.startStamp||e),!0),this.pauseStamp=0)}},{key:"stop",value:function(){this.state=l,clearTimeout(this.timer)}},{key:"seek",value:function(e){this.play(e)}}]),e}();t.default=h,e.exports=t.default},void 0===(a="function"==typeof r?r.apply(t,s):r)||(e.exports=a)}])},e.exports=i()}(lyric);const Lyric=getDefaultExportFromCjs$1(lyricExports),defaultCover="/assets/default_cover.d3df9517.jpg",playingIcon="/assets/icon_music_playing.078c77db.png",pauseIcon="/assets/icon_music_play_white.46465068.png",likeIcon="/assets/icon_music_collect.37256d1e.png",likeActiveIcon="/assets/icon_collection_active.e58a0a87.png",favoriteIcon="/assets/icon_favorite.8f14792a.png",favoriteActiveIcon="/assets/icon_full_star.06ff4e10.png",orderImg="/assets/icon_music_order.de7f6bca.png",repeatImg="/assets/icon_music_loop.c1732e85.png",randomImg="/assets/icon_music_random.cb2d1974.png",_sfc_main$a=vue.defineComponent({__name:"FavoriteDirectoryComponent",props:{isFavorite:{type:Boolean,reqiure:!0,default:!1},musicId:{type:Number,reqiure:!0,default:-1}},emits:["useFavorite"],setup(e,{emit:t}){const{musicId:i,isFavorite:r}=e,s=vue.reactive([]),a=vue.reactive([]),n=vue.ref(!1),o=vue.ref(!1),l=vue.ref(""),c=e=>{a.length=0,a.push(...e.detail.value)},u=()=>{const e=a.map((e=>({favoriteId:e})));insertFavoriteDirectoryService(i,e).then((i=>{i.data>0&&uni.showToast({duration:2e3,position:"center",title:0==e.length?"取消收藏成功":"添加收藏成功"}),t("useFavorite",0!=e.length)}))},d=()=>{const e={name:l.value,id:-1};insertFavoriteDirectoryService(e).then((e=>{e.data?(uni.showToast({duration:2e3,position:"center",title:"创建收藏夹成功"}),s.unshift(e.data),l.value="",n.value=!1):uni.showToast({duration:2e3,position:"center",title:"收藏夹已存在"})}))};return vue.watch((()=>l.value),(e=>{o.value=Boolean(e)})),getFavoriteDirectoryService(i).then((e=>{e.data.forEach((e=>{e.checked&&a.push(e.id),s.push(e)}))})),(t,i)=>(vue.openBlock(),vue.createElementBlock("view",{class:"favorite-list-wrapper"},[n.value?(vue.openBlock(),vue.createElementBlock(vue.Fragment,{key:0},[vue.createElementVNode("view",{class:"favorite-add-row"},[vue.createElementVNode("text",{class:"require-text"},"*"),vue.createElementVNode("text",null,"名称"),vue.withDirectives(vue.createElementVNode("input",{"onUpdate:modelValue":i[0]||(i[0]=e=>l.value=e),placeholder:"请输入收藏夹名称",class:"favorite-input"},null,512),[[vue.vModelText,l.value]])]),vue.createElementVNode("view",{class:"favorite-add-row favorite-cover-row"},[vue.createElementVNode("text",{class:"require-text require-text-hidden"},"*"),vue.createElementVNode("text",null,"封面"),vue.createElementVNode("view",{class:"rectangle"},[vue.createElementVNode("image",{class:"icon-favorite-add",src:"/static/icon_add.png"})])]),vue.createElementVNode("view",{class:"favorite-btn-row"},[vue.createElementVNode("button",{class:vue.normalizeClass(["favorite-btn favorite-create",o.value?"":"favorite-btn-disable"]),onClick:d},"创建",2),vue.createElementVNode("button",{class:"favorite-btn favorite-cancle",onClick:i[1]||(i[1]=e=>n.value=!1)},"取消")])],64)):(vue.openBlock(),vue.createElementBlock(vue.Fragment,{key:1},[vue.createElementVNode("view",{class:"favorite-add",onClick:i[2]||(i[2]=e=>n.value=!0)},[vue.createElementVNode("view",{class:"rectangle"},[vue.createElementVNode("image",{class:"icon-favorite-add",src:"/static/icon_add.png"})]),vue.createElementVNode("text",null,"新建收藏夹")]),vue.createElementVNode("scroll-view",{class:"favorite-directory","scroll-y":"","show-scrollbar":"false"},[vue.createElementVNode("checkbox-group",{onChange:c},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(s,(e=>(vue.openBlock(),vue.createElementBlock("label",{class:"checkbox-item",key:e.id},[e.cover?(vue.openBlock(),vue.createElementBlock("image",{key:0,class:"rectangle",src:vue.unref(HOST)+e.cover},null,8,["src"])):(vue.openBlock(),vue.createElementBlock("view",{key:1,class:"rectangle"},[vue.createElementVNode("text",null,vue.toDisplayString(e.name.slice(0,1)),1)])),vue.createElementVNode("view",{class:"checkbox-name"},[vue.createElementVNode("text",null,vue.toDisplayString(e.name),1),vue.createElementVNode("text",{class:"favorite-total"},vue.toDisplayString(e.total)+"首",1)]),vue.createElementVNode("checkbox",{value:e.id,checked:e.checked},null,8,["value","checked"])])))),128))],32)]),vue.createElementVNode("button",{onClick:u,class:"btn-add-favorite"},vue.toDisplayString(e.isFavorite&&0==a.length?"取消收藏":"添加")+vue.toDisplayString(a.length>0?`（已选${a.length}个）`:""),1)],64))]))}}),FavoriteDirectoryComponent=_export_sfc(_sfc_main$a,[["__scopeId","data-v-5d8c8cdf"]]),_sfc_main$9=vue.defineComponent({__name:"MusicPlayerPage",setup(e){const t=vue.ref(0),i=vue.ref(0),r=vue.ref(""),s=vue.ref(null),a=vue.ref(0),n=vue.ref(!1),o=vue.ref(!1),l=vue.reactive([]),c=vue.ref(1),u=vue.ref(0),d=vue.ref(!1),h=vue.ref(!1),m=useStore();let f=null,g=!0,p=!1;const v={[LoopModeEnum.ORDER]:orderImg,[LoopModeEnum.REPEAT]:repeatImg,[LoopModeEnum.RANDOM]:randomImg},y=()=>{r.value=formatSecond(m.audio.currentTime),i.value=m.audio.currentTime/m.audio.duration*100,t.value+=5,t.value=360===t.value?0:t.value,s.value.seek(Math.floor(1e3*m.audio.currentTime))},E=()=>{n.value=!n.value},T=e=>{n.value=!1,m.setLoop(e)},S=e=>{if(e===TabEnum.NEXT){const e=Math.floor(Math.random()*m.unPlayMusicList.length);m.setMusic(m.unPlayMusicList[e])}else m.randomTabPrev();k()},_=e=>{m.loop===LoopModeEnum.ORDER||m.loop===LoopModeEnum.REPEAT?C(e):S(e)},k=()=>{var e;if(!(null==(e=m.musicItem)?void 0:e.lyrics))return s.value=null;s.value=new Lyric(m.musicItem.lyrics,(({lineNum:e=0})=>{a.value=e}))},b=e=>{m.audio.currentTime=60*m.audio.duration/100},C=e=>{let{playIndex:t,musicList:i}=m;e===TabEnum.PREV?0===t?(m.resetplayMusicList(),t=i.length-1):t--:m.playIndex===m.musicList.length-1?(m.resetplayMusicList(),t=0):t++,m.setMusicPlayIndex(t)},L=()=>{p||(p=!0,m.musicItem.isLike?deleteMusicLikeService(m.musicItem.id).then((e=>{e.data>0&&(m.musicItem.isLike=0,uni.showToast({duration:2e3,position:"center",title:"取消点赞成功"}))})).finally((()=>p=!1)):insertMusicLikeService(m.musicItem.id).then((e=>{e.data>0&&(m.musicItem.isLike=1,uni.showToast({duration:2e3,position:"center",title:"点赞成功"}))})).finally((()=>p=!1)))},A=()=>{getTopCommentListService(m.musicItem.id,CommentEnum.MUSIC,c.value,20).then((e=>{u.value=e.total,l.splice(0,l.length,...e.data),o.value=!0}))},w=()=>getCommentCountService(m.musicItem.id,CommentEnum.MUSIC).then((e=>u.value=e.data));m.audio.onEnded((()=>{switch(m.loop){case LoopModeEnum.REPEAT:m.audio.play();break;case LoopModeEnum.RANDOM:S(TabEnum.NEXT);break;default:C(TabEnum.NEXT)}}));const D=()=>{d.value=!1,formatAppLog("log","at music/pages/MusicPlayerPage.vue:314",111,m.musicItem),isMusicFavoriteService(m.musicItem.id).then((e=>d.value=e.data>0))},R=e=>{d.value=e,h.value=!1},I=()=>{uni.navigateTo({url:`../pages/MusicSharePage?musicItem=${encodeURIComponent(JSON.stringify(m.musicItem))}`})};return m.audio.onTimeUpdate(y),vue.watch((()=>m.musicItem),(e=>{g&&(f=e,k(),D())})),vue.onMounted((()=>{k(),D()})),vue.onUnmounted((()=>{m.audio.offTimeUpdate(y)})),vue.onActivated((()=>{g=!0,f!==m.musicItem&&k(),m.audio.onTimeUpdate(y)})),vue.onDeactivated((()=>{g=!1,m.audio.offTimeUpdate(y)})),(e,c)=>(vue.openBlock(),vue.createElementBlock("view",{class:"play-wrapper",onClick:c[9]||(c[9]=e=>n.value=!1)},[vue.createElementVNode("view",{class:"song-bg",style:vue.normalizeStyle(`background-image: url(${vue.unref(m).musicItem.cover?vue.unref(getMusicCover)(vue.unref(m).musicItem.cover):vue.unref(defaultCover)})`)},null,4),vue.createElementVNode("view",{class:"play-controller-wrapper"},[vue.createElementVNode("text",{class:"song-name"},vue.toDisplayString(vue.unref(m).musicItem.songName),1),vue.createElementVNode("view",{class:"circle-wrapper"},[vue.createElementVNode("view",{class:"inner-circle",style:vue.normalizeStyle({transform:`rotate(${t.value}deg)`})},[vue.createElementVNode("view",{class:"song-cover",style:vue.normalizeStyle({backgroundImage:`url(${vue.unref(m).musicItem.cover?vue.unref(getMusicCover)(vue.unref(m).musicItem.cover):vue.unref(defaultCover)})`})},null,4)],4)]),vue.createElementVNode("scroll-view",{"scroll-into-view":"lyric"+a.value,class:"lyrice-scroll-wrapper","scroll-y":"","show-scrollbar":"false"},[s.value?(vue.openBlock(),vue.createElementBlock("view",{key:0,class:"lyric-wrapper"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(s.value.lines,((e,t)=>(vue.openBlock(),vue.createElementBlock("text",{id:"lyric"+t,key:"lyric-index"+vue.unref(m).musicItem.id+t,class:vue.normalizeClass(["text",{current:a.value===t}])},vue.toDisplayString(e.txt),11,["id"])))),128))])):(vue.openBlock(),vue.createElementBlock("text",{key:1},"暂无歌词"))],8,["scroll-into-view"]),vue.createElementVNode("text",{class:"singer"},vue.toDisplayString(vue.unref(m).musicItem.authorName),1),vue.createElementVNode("view",{class:"play-operate-wrapper"},[vue.createElementVNode("image",{class:"icon-middle",onClick:vue.withModifiers(L,["stop"]),src:vue.unref(m).musicItem.isLike?vue.unref(likeActiveIcon):vue.unref(likeIcon)},null,8,["onClick","src"]),vue.createElementVNode("image",{class:"icon-middle",onClick:I,src:"/static/icon_share_music.png"}),vue.createElementVNode("image",{onClick:vue.withModifiers(A,["stop"]),class:"icon-middle",src:"/static/icon_music_comments.png"},null,8,["onClick"]),vue.createElementVNode("image",{class:"icon-middle",onClick:c[0]||(c[0]=e=>h.value=!0),src:d.value?vue.unref(favoriteActiveIcon):vue.unref(favoriteIcon)},null,8,["src"])]),vue.createElementVNode("view",{class:"play-progress-wrapper"},[vue.createElementVNode("text",{class:"play-time"},vue.toDisplayString(r.value),1),vue.createElementVNode("slider",{onChange:b,class:"slider-bar",value:i.value,"block-size":"20",activeColor:"#fff",backgroundColor:"rgba(255,255,255,0.2)"},null,40,["value"]),vue.createElementVNode("text",{class:"play-time"},vue.toDisplayString(vue.unref(formatSecond)(vue.unref(m).audio.duration)),1)]),vue.createElementVNode("view",{class:"toggle-wrapper"},[vue.createElementVNode("view",{class:"play-menu-item"},[vue.createElementVNode("image",{onClick:vue.withModifiers(E,["stop"]),class:"icon-loop",src:v[vue.unref(m).loop]},null,8,["onClick","src"]),vue.withDirectives(vue.createElementVNode("view",{class:"loop-menu"},[vue.createElementVNode("view",{class:"loop-item",onClick:c[1]||(c[1]=e=>T(vue.unref(LoopModeEnum).ORDER))},[vue.createElementVNode("image",{class:"icon-loop",src:"/static/icon_music_order.png"}),vue.createElementVNode("text",{class:"loop-name"},"顺序播放")]),vue.createElementVNode("view",{class:"loop-item",onClick:c[2]||(c[2]=e=>T(vue.unref(LoopModeEnum).REPEAT))},[vue.createElementVNode("image",{class:"icon-loop",src:"/static/icon_music_loop.png"}),vue.createElementVNode("text",{class:"loop-name"},"单曲循环")]),vue.createElementVNode("view",{class:"loop-item",onClick:c[3]||(c[3]=e=>T(vue.unref(LoopModeEnum).RANDOM))},[vue.createElementVNode("image",{class:"icon-loop",src:"/static/icon_music_random.png"}),vue.createElementVNode("text",{class:"loop-name"},"随机播放")])],512),[[vue.vShow,n.value]])]),vue.createElementVNode("image",{class:"play-menu-item",onClick:c[4]||(c[4]=vue.withModifiers((e=>_(vue.unref(TabEnum).PREV)),["stop"])),src:"/static/icon_music_prev.png"}),vue.createElementVNode("view",{onClick:c[5]||(c[5]=vue.withModifiers((e=>vue.unref(m).usePlay(!vue.unref(m).isPlaying)),["stop"])),class:"play-circle"},[vue.createElementVNode("image",{class:"play-menu-item",src:vue.unref(m).isPlaying?vue.unref(playingIcon):vue.unref(pauseIcon)},null,8,["src"])]),vue.createElementVNode("image",{class:"play-menu-item",onClick:c[6]||(c[6]=vue.withModifiers((e=>_(vue.unref(TabEnum).NEXT)),["stop"])),src:"/static/icon_music_next.png"}),vue.createElementVNode("image",{class:"play-menu-item",src:"/static/icon_music_play_menu.png"})])]),o.value?(vue.openBlock(),vue.createBlock(DialogComponent,{key:0,onOnClose:c[7]||(c[7]=e=>o.value=!1)},{header:vue.withCtx((()=>[vue.createElementVNode("text",{class:"comment-header"},vue.toDisplayString(u.value)+"条评论",1)])),content:vue.withCtx((()=>[vue.createVNode(CommentComponent,{onOnSend:w,isShowInput:!0,relationId:vue.unref(m).musicItem.id,category:vue.unref(CommentEnum).MUSIC,commentList:l},null,8,["relationId","category","commentList"])])),_:1})):vue.createCommentVNode("",!0),h.value?(vue.openBlock(),vue.createBlock(DialogComponent,{key:1,onOnClose:c[8]||(c[8]=e=>h.value=!1)},{header:vue.withCtx((()=>[vue.createElementVNode("text",{class:"comment-header"},"收藏夹")])),content:vue.withCtx((()=>[vue.createVNode(FavoriteDirectoryComponent,{onUseFavorite:R,isFavorite:d.value,musicId:vue.unref(m).musicItem.id},null,8,["isFavorite","musicId"])])),_:1})):vue.createCommentVNode("",!0)]))}}),_sfc_main$8=vue.defineComponent({__name:"MusicSharePage",setup(e){const t=vue.ref(""),i=vue.ref(1),r=vue.ref(null);useStore();const s=useRoute(),a=JSON.parse(decodeURIComponent(s.query.musicItem)),n=()=>{var e;null==(e=r.value)||e.$refs.popup.open("top")},o=e=>{i.value=e},l=()=>{uni.navigateBack()},c=()=>{const e={permission:i.value,type:CircleEnum.MUSIC,relationId:a.id,content:t.value};saveCircleService(e).then((()=>{uni.showToast({duration:2e3,position:"center",title:"发布成功"}),uni.navigateBack()}))};return(e,s)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createElementVNode("view",{class:"page-header"},[vue.createElementVNode("text",{class:"page-btn btn-cancle",onClick:l},"取消"),vue.createElementVNode("text",{class:"page-btn btn-publish",onClick:c},"发布")]),vue.createElementVNode("view",{class:"page-body"},[vue.withDirectives(vue.createElementVNode("textarea",{class:"textarea","onUpdate:modelValue":s[0]||(s[0]=e=>t.value=e),placeholder:"这一刻的想法"},null,512),[[vue.vModelText,t.value]]),vue.createElementVNode("view",{class:"module-block module-block-row"},[vue.createVNode(MusicAvaterComponent,{type:"music",name:vue.unref(a).songName,avater:vue.unref(a).cover},null,8,["name","avater"]),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(a).authorName)+" - "+vue.toDisplayString(vue.unref(a).songName),1)]),vue.createElementVNode("view",{class:"module-block module-block-row",onClick:n},[vue.createElementVNode("image",{class:"icon-permission",src:"/static/icon_permission.png"}),vue.createElementVNode("text",{class:"permission-text"},"谁可以看"),vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(PermissionMap)[i.value]),1),vue.createElementVNode("image",{class:"icon-arrow",src:"/static/icon_arrow.png"})])]),vue.createVNode(OptionsDialog,{ref_key:"permissionOptionsDialog",ref:r,onOnCheck:o,options:[{text:"公开",value:1},{text:"私密",value:0}]},null,512)]))}}),MusicPagesMusicSharePage=_export_sfc(_sfc_main$8,[["__scopeId","data-v-2ccae505"]]),_sfc_main$7=vue.defineComponent({__name:"NavigatorTitleComponent",props:{title:{type:String,reqiure:!0,default:""}},setup(e){const t=()=>{uni.navigateBack()};return(i,r)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-header"},[vue.createElementVNode("image",{class:"icon-back",onClick:t,src:"/static/icon_back.png"}),vue.createElementVNode("text",{class:"my-favorite"},vue.toDisplayString(e.title),1),vue.createElementVNode("view",{class:"icon-back"})]))}}),NavigatorTitleComponent=_export_sfc(_sfc_main$7,[["__scopeId","data-v-db3882f9"]]),_sfc_main$6=vue.defineComponent({__name:"MusicFavoriteListPage",setup(e){const t=useStore(),i=useRoute(),r=vue.ref(1),s=JSON.parse(decodeURIComponent(i.query.data)),a=vue.reactive([]),n=MUSIC_FAVORITE_NAME_STORAGE_KEY+s.name;getMusicListByFavoriteIdService(s.id,r.value,20).then((e=>{a.push(...e.data)}));const o=async(e,i)=>{t.classifyName!=n?await getMusicListByFavoriteIdService(s.id,1,MAX_FAVORITE_NUMBER).then((r=>{t.setClassifyMusic(r.data,e,i,n)})):t.setMusic(e,!0),uni.navigateTo({url:"../pages/MusicPlayerPage"})};return(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createVNode(NavigatorTitleComponent,{title:"我的收藏夹"}),vue.createElementVNode("scroll-view",{"scroll-y":"","show-scrollbar":"false",class:"page-body"},[vue.createElementVNode("view",{class:"module-block module-block-row"},[vue.createVNode(MusicAvaterComponent,{type:"author",size:"big",name:vue.unref(s).name,avater:vue.unref(s).cover},null,8,["name","avater"]),vue.createElementVNode("view",{class:"favorite-name-wrapper"},[vue.createElementVNode("text",null,vue.toDisplayString(vue.unref(s).name),1),vue.createElementVNode("text",{class:"favorite-total"},vue.toDisplayString(vue.unref(s).total)+"首",1)]),vue.createElementVNode("image",{class:"icon-middle",src:"/static/icon_edit.png"})]),vue.createVNode(MusicClassifyListComponent,{onOnPlayMusic:o,"music-list":a,"classify-name":n},null,8,["music-list"])])]))}}),MusicPagesMusicFavoriteListPage=_export_sfc(_sfc_main$6,[["__scopeId","data-v-830f9980"]]),_sfc_main$5=vue.defineComponent({__name:"MusicClassifyListPage",setup(e){const t=useStore(),i=useRoute();let r=!1;const s=vue.ref(0),a=vue.ref(1),n=JSON.parse(decodeURIComponent(i.query.data)),o=vue.reactive([]),l=()=>{getMusicListByClassifyIdService(n.id,a.value,PAGE_SIZE).then((e=>{s.value=e.total,o.push(...e.data)})).finally((()=>r=!1))},c=async(e,i)=>{t.classifyName!=n.classifyName?await getMusicListByClassifyIdService(n.id,1,MAX_FAVORITE_NUMBER).then((r=>{t.setClassifyMusic(r.data,e,i,n.classifyName)})):t.setMusic(e,!0),uni.navigateTo({url:"../pages/MusicPlayerPage"})},u=()=>{r||s.value>PAGE_SIZE*a.value&&(a.value++,l())};return l(),(e,t)=>{var i;return vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper"},[vue.createVNode(NavigatorTitleComponent,{title:null==(i=vue.unref(n))?void 0:i.classifyName},null,8,["title"]),vue.createElementVNode("scroll-view",{"scroll-y":"","show-scrollbar":"false",onScrolltolower:u,class:"page-body"},[vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(MusicClassifyListComponent,{onOnPlayMusic:c,"music-list":o,"classify-name":vue.unref(n).classifyName},null,8,["music-list","classify-name"])]),vue.createElementVNode("text",{class:"footer"},vue.toDisplayString(s.value>a.value*vue.unref(PAGE_SIZE)?"正在加载更多":"已经到底了"),1)],32)])}}}),MusicPagesMusicClassifyListPage=_export_sfc(_sfc_main$5,[["__scopeId","data-v-015f99ce"]]),_sfc_main$4=vue.defineComponent({__name:"MusicAuthorCategoryPage",setup(e){useRoute();const t=vue.ref(0),i=vue.ref(1),r=vue.reactive([]),s=vue.reactive([]),a=vue.ref({});let n=!1;getMusicAuthorCategoryService().then((e=>{r.push(...e.data),a.value=r[0],o()}));const o=()=>{n=!0,getMusicAuthorListByCategoryIdService(a.value.id,i.value,PAGE_SIZE).then((e=>{s.push(...e.data),t.value=e.total})).finally((()=>n=!1))},l=()=>{n||t.value>PAGE_SIZE*i.value&&(i.value++,o())};return(e,c)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createVNode(NavigatorTitleComponent,{title:"歌手分类"}),vue.createElementVNode("scroll-view",{"scroll-y":"","show-scrollbar":"false",onScrolltolower:l,class:"page-body"},[vue.createElementVNode("view",{class:"module-block module-block-grid"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(r,(e=>{var t;return vue.openBlock(),vue.createElementBlock("text",{onClick:t=>(e=>{n||e.id===a.value.id||(i.value=1,a.value=e,s.length=0,o())})(e),class:vue.normalizeClass([{"item-two":e.categoryName.length>2,"category-btn-active":(null==(t=a.value)?void 0:t.id)===e.id},"category-btn"]),key:"category-btn"+e.id},vue.toDisplayString(e.categoryName),11,["onClick"])})),128))]),vue.createElementVNode("view",{class:"module-block module-column"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(s,(e=>(vue.openBlock(),vue.createElementBlock("view",{class:"author-item",onClick:t=>(e=>{uni.navigateTo({url:`../pages/AuthorMusicListPage?data=${encodeURIComponent(JSON.stringify(e))}`})})(e),key:"author-item"+e.id},[vue.createVNode(MusicAvaterComponent,{type:"author",name:e.authorName,avater:e.avatar},null,8,["name","avater"]),vue.createElementVNode("text",null,vue.toDisplayString(e.authorName),1),vue.createElementVNode("text",{class:"total"},vue.toDisplayString(e.total)+"首",1),vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_music_play.png"}),vue.createElementVNode("image",{class:"icon-play",onClick:vue.withModifiers((t=>(e=>{e.isLike?deleteMyLikeMusicAuthorService(e.authorId).then((t=>{t.data>0&&(uni.showToast({duration:2e3,position:"center",title:"取消收藏成功"}),e.isLike=0)})):insertFavoriteAuthorService(e.authorId).then((t=>{t.data>0&&(uni.showToast({duration:2e3,position:"center",title:"收藏成功"}),e.isLike=1)}))})(e)),["stop"]),src:e.isLike>0?vue.unref(isLikeActiveIcon):vue.unref(isLikeIcon)},null,8,["onClick","src"]),vue.createElementVNode("image",{class:"icon-play",src:"/static/icon_music_menu.png"})],8,["onClick"])))),128))]),vue.createElementVNode("text",{class:"footer"},vue.toDisplayString(t.value>i.value*vue.unref(PAGE_SIZE)?"正在加载更多":"已经到底了"),1)],32)]))}}),MusicPagesMusicAuthorCategoryPage=_export_sfc(_sfc_main$4,[["__scopeId","data-v-4b6defbe"]]),_sfc_main$3=vue.defineComponent({__name:"AuthorMusicListPage",setup(e){const t=useStore(),i=useRoute(),r=vue.ref(0),s=vue.ref(1),a=vue.reactive([]);let n=!1;const o=JSON.parse(decodeURIComponent(i.query.data)),l=()=>{n=!0,getMusicListByAuthorIdService(o.authorId,s.value,PAGE_SIZE).then((e=>{r.value=e.total,a.push(...e.data)})).finally((()=>n=!1))},c=()=>{n||r.value>PAGE_SIZE*s.value&&(s.value++,l())},u=(e,i)=>{t.classifyName!=o.authorName?getMusicListByAuthorIdService(o.authorId,1,MAX_FAVORITE_NUMBER).then((r=>{t.setClassifyMusic(r.data,e,i,o.authorName)})):t.setMusic(e,!0),uni.navigateTo({url:"../pages/MusicPlayerPage"})};return l(),(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createVNode(NavigatorTitleComponent,{title:vue.unref(o).authorName},null,8,["title"]),vue.createElementVNode("scroll-view",{"scroll-y":"","show-scrollbar":"false",onScrolltolower:c,class:"page-body"},[vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(MusicClassifyListComponent,{"music-list":a,"classify-name":vue.unref(o).authorName,onOnPlayMusic:u},null,8,["music-list","classify-name"])]),vue.createElementVNode("text",{class:"footer"},vue.toDisplayString(r.value>s.value*vue.unref(PAGE_SIZE)?"正在加载更多":"已经到底了"),1)],32)]))}}),MusicPagesAuthorMusicListPage=_export_sfc(_sfc_main$3,[["__scopeId","data-v-5df684f9"]]),_sfc_main$2=vue.defineComponent({__name:"MusicCategoryListPage",setup(e){const t=vue.reactive([]),i=vue.reactive([]),r=vue.ref(0),s=vue.ref(1),a=vue.reactive([]),n=vue.ref({}),o=useStore(),l=vue.ref(!1);let c=!1;getMusicClassifyService().then((e=>{t.push(...e.data),n.value=t[0],i.push(...t.slice(0,9)),d()}));const u=()=>{l.value=!l.value,i.length=0,i.push(...t.slice(0,l.value?t.length:9))},d=()=>{c=!0,getMusicListByClassifyIdService(n.value.id,s.value,PAGE_SIZE).then((e=>{a.push(...e.data),r.value=e.total})).finally((()=>c=!1))},h=()=>{c||r.value>PAGE_SIZE*s.value&&(s.value++,d())},m=(e,t)=>{o.classifyName!=n.value.classifyName?getMusicListByClassifyIdService(n.value.id,1,MAX_FAVORITE_NUMBER).then((i=>{o.setClassifyMusic(i.data,e,t,n.value.classifyName)})):o.setMusic(e,!0),uni.navigateTo({url:"../pages/MusicPlayerPage"})};return(e,t)=>(vue.openBlock(),vue.createElementBlock("view",{class:"page-wrapper","scroll-y":"","show-scrollbar":"false"},[vue.createVNode(NavigatorTitleComponent,{title:"歌曲分类"}),vue.createElementVNode("scroll-view",{"scroll-y":"","show-scrollbar":"false",onScrolltolower:h,class:"page-body"},[vue.createElementVNode("view",{class:"module-block"},[vue.createElementVNode("view",{class:"category-grid"},[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(i,(e=>{var t;return vue.openBlock(),vue.createElementBlock("text",{onClick:t=>(e=>{c||e.id===n.value.id||(s.value=1,n.value=e,a.length=0,d())})(e),class:vue.normalizeClass([{"category-btn-active":(null==(t=n.value)?void 0:t.id)===e.id},"category-btn"]),key:"category-btn"+e.id},vue.toDisplayString(e.classifyName),11,["onClick"])})),128))]),vue.createElementVNode("view",{class:"expand-more",onClick:u},[vue.createElementVNode("text",{class:"expand-text"},vue.toDisplayString(l.value?"收起":"展开更多"),1),vue.createElementVNode("image",{class:vue.normalizeClass(["icon-small",l.value?"icon-expand":""]),src:"/static/icon_arrow.png"},null,2)])]),vue.createElementVNode("view",{class:"module-block"},[vue.createVNode(MusicClassifyListComponent,{class:"component-gap",onOnPlayMusic:m,musicList:a,classifyName:n.value.classifyName},null,8,["musicList","classifyName"])]),vue.createElementVNode("text",{class:"footer"},vue.toDisplayString(r.value>s.value*vue.unref(PAGE_SIZE)?"正在加载更多":"已经到底了"),1)],32)]))}}),MusicPagesMusicCategoryListPage=_export_sfc(_sfc_main$2,[["__scopeId","data-v-d276e08d"]]);__definePage("movie/pages/LaunchPage",MoviePagesLaunchPage),__definePage("movie/pages/IndexPage",MoviePagesIndexPage),__definePage("movie/pages/MovieDetailPage",MoviePagesMovieDetailPage),__definePage("movie/pages/MoviePlayPage",_sfc_main$y),__definePage("movie/pages/MovieUserPage",_sfc_main$v),__definePage("movie/pages/MovieLoginPage",MoviePagesMovieLoginPage),__definePage("movie/pages/MovieRegisterPage",MoviePagesMovieRegisterPage),__definePage("movie/pages/MovieSearchPage",MoviePagesMovieSearchPage),__definePage("music/pages/MusicIndexPage",_sfc_main$d),__definePage("music/pages/MusicCirClePublishPage",MusicPagesMusicCirClePublishPage),__definePage("music/pages/MusicSearchPage",MusicPagesMusicSearchPage),__definePage("music/pages/MusicPlayerPage",_sfc_main$9),__definePage("music/pages/MusicSharePage",MusicPagesMusicSharePage),__definePage("music/pages/MusicFavoriteListPage",MusicPagesMusicFavoriteListPage),__definePage("music/pages/MusicClassifyListPage",MusicPagesMusicClassifyListPage),__definePage("music/pages/MusicAuthorCategoryPage",MusicPagesMusicAuthorCategoryPage),__definePage("music/pages/AuthorMusicListPage",MusicPagesAuthorMusicListPage),__definePage("music/pages/MusicCategoryListPage",MusicPagesMusicCategoryListPage);const _sfc_main$1=vue.defineComponent({__name:"App",setup:e=>(onLaunch((()=>{formatAppLog("log","at App.vue:4","App Launch")})),onShow((()=>{formatAppLog("log","at App.vue:7","App Show")})),onHide((()=>{formatAppLog("log","at App.vue:10","App Hide")})),()=>{})});
/*!
   * uni-mini-router v0.1.5
   * 2023/10/23 10:32:53 weisheng
   */function a$1(e){return(a$1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e){var t=function(e,t){if("object"!==a$1(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,"string");if("object"!==a$1(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===a$1(t)?t:t+""}function u(e,t,r){return(t=i(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var c,l=Symbol("__ROUTER__"),f=Symbol("__ROUTE__"),e2;e2=c||(c={}),e2.push="navigateTo",e2.replace="redirectTo",e2.replaceAll="reLaunch",e2.pushTab="switchTab",e2.back="navigateBack";var s=["navigateTo","redirectTo","reLaunch","switchTab","navigateBack"];function p(e){var t={},i=e.split("?"),r="",s=[];i.length>1&&(r=i[1]),s=r.split("&");for(var a=0;s.length>a;a++)2===s[a].split("=").length&&(t[s[a].split("=")[0]]=s[a].split("=")[1]);return t}function v(e,t,i){return e.replace(RegExp(t,"g"),i)}function h(e){return null==e||0===Object.keys(e).length}function b(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function g(e){for(var t=1;arguments.length>t;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?b(Object(i),!0).forEach((function(t){u(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):b(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var y={navigateTo:uni.navigateTo,redirectTo:uni.redirectTo,reLaunch:uni.reLaunch,switchTab:uni.switchTab,navigateBack:uni.navigateBack};function d(e,t,i){var r=m(e,t);switch(i){case"push":y.navigateTo({url:r});break;case"replace":y.redirectTo({url:r});break;case"pushTab":y.switchTab({url:r});break;case"replaceAll":y.reLaunch({url:r});break;default:throw Error("无效的路由类型，请确保提供正确的路由类型")}}function m(e,t){var i,r="",s={};if("string"==typeof e)r=e;else{if(e.name){var a=t.routes.find((function(t){return t.name===e.name}));if(!a||!a.path)throw Error("您正在尝试访问的路由未在路由表中定义。请检查您的路由配置。");r=a.path,s=e.params}else e.path&&(i=v(i="/".concat(e.path.split("?")[0]),"//","/"),i=v(i,"https:/","https://"),r=v(i,"http:/","http://"),s=g(g({},p(e.path)),e.query||{}));s&&(r=function(e,t){for(var i in t)e.indexOf("?")>-1?e+="&".concat(i,"=").concat(t[i]):e+="?".concat(i,"=").concat(t[i]);return e}(r,s=function(e){var t={};if(e)for(var i in e){var r=e[i];void 0===r&&(r=""),t[i]=r}return t}(s)))}return r}function O(e){var t,i=(t=getCurrentPages()).length>0?t[t.length-1]:void 0;if(i&&i.route&&e.routes){var r=k("/".concat(i.route),e);return i.$page&&(r.fullPath=i.$page.fullPath?i.$page.fullPath:"",r.query=i.$page.fullPath?p(i.$page.fullPath):{},r.params=i.$page.fullPath?p(i.$page.fullPath):{}),r}}function k(e,t){e=e.split("?")[0];var i=t.routes.find((function(t){return t.path===e||t.aliasPath===e}));return JSON.parse(JSON.stringify(i))}function P(e,t,i){e.guardHooks[t]=[i]}var T={navigateTo:uni.navigateTo,redirectTo:uni.redirectTo,reLaunch:uni.reLaunch,switchTab:uni.switchTab,navigateBack:uni.navigateBack};function w(e){s.forEach((function(t){y[t]=function(i){if("navigateBack"===t)T[t](i);else if(e.guardHooks.beforeHooks&&e.guardHooks.beforeHooks[0]){var r=k(i.url,e);(s=e.guardHooks.beforeHooks[0],a=r,n=e.route.value,new Promise((function(e,t){var i=function i(r){i._called=!0,!1===r?t({}):e(void 0===r||!0===r||r)},r=s.call(void 0,a,n,i),o=Promise.resolve(r);if(3>s.length&&(o=o.then(i)),s.length>2){var l='The "next" callback was never called inside of '.concat(s.name?'"'+s.name+'"':"",":\n").concat(""+s,'\n. If you are returning a value instead of calling "next", make sure to remove the "next" parameter from your function.');if(null!==r&&"object"===a$1(r)&&"then"in r)o=o.then((function(e){return i._called?e:(console.warn(l),Promise.reject(Error("Invalid navigation guard")))}));else if(!i._called)return console.warn(l),void t(Error("Invalid navigation guard"))}o.catch((function(e){return t(e)}))}))).then((function(r){if(!0===r)T[t](i);else if("string"==typeof r){var s=m(r,e);T[t]({url:s})}else if("back"===r.navType)T.navigateBack(r);else{var a=m(r,e);T[r.navType?c[r.navType]:t]({url:a})}})).catch((function(e){throw e}))}else T[t](i);var s,a,n}}))}function E(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function S(e){for(var t=1;arguments.length>t;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?E(Object(i),!0).forEach((function(t){u(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):E(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function $(e){var t={routes:e.routes,guardHooks:{beforeHooks:null,afterHooks:null},push:function(e){return d(e,this,"push")},replace:function(e){return d(e,this,"replace")},replaceAll:function(e){return d(e,this,"replaceAll")},pushTab:function(e){return d(e,this,"pushTab")},back:function(e){return uni.navigateBack(e)},beforeEach:function(e){P(t,"beforeHooks",e)},afterEach:function(e){P(t,"afterHooks",e)},install:function(e){var t=this,i=this;e.provide(l,this),e.provide(f,this.route),w(i),e.mixin({beforeCreate:function(){if("page"===this.$mpType&&i.guardHooks.afterHooks&&i.guardHooks.afterHooks[0]){var e=i.route.value,t=O(i);i.guardHooks.afterHooks[0].call(null,t,e)}},onLoad:function(e){!h(e)&&h(i.route.value.query)&&h(i.route.value.params)&&(i.route.value=S(S({},i.route.value),{},{query:e}))},onShow:function(){var e;"page"===this.$mpType&&((e=i).route.value=O(e))}}),Object.defineProperty(e.config.globalProperties,"$Router",{get:function(){return i}}),Object.defineProperty(e.config.globalProperties,"$Route",{enumerable:!0,get:function(){return vue.unref(t.route)}})},route:vue.shallowRef({path:"/"})};return t}const pages=[{path:"movie/pages/LaunchPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"movie/pages/IndexPage",style:{navigationBarTitleText:"电影"}},{path:"movie/pages/MovieDetailPage",style:{navigationBarTitleText:"电影详情"}},{path:"movie/pages/MoviePlayPage",style:{navigationBarTitleText:"电影播放"}},{path:"movie/pages/MovieUserPage",style:{navigationBarTitleText:""}},{path:"movie/pages/MovieLoginPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"movie/pages/MovieRegisterPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"movie/pages/MovieSearchPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicIndexPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicCirClePublishPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicSearchPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicPlayerPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicSharePage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicFavoriteListPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicClassifyListPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicAuthorCategoryPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/AuthorMusicListPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}},{path:"music/pages/MusicCategoryListPage",style:{navigationBarTitleText:"",enablePullDownRefresh:!1}}],globalStyle={navigationStyle:"custom",navigationBarTextStyle:"white",navigationBarTitleText:"uni-app",navigationBarBackgroundColor:"#F8F8F8",backgroundColor:"#F8F8F8"},pagesJson={pages:pages,globalStyle:globalStyle};
/*!
   * uni-reade-pages-vite v0.0.1
   * 2023 weisheng
   */
function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);t>i;i++)r[i]=e[i];return r}function n(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,i){if(e){if("string"==typeof e)return t(e,i);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,i):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var r={includes:["meta","path","aliasPath","name"]};function e(e,t){return t&&t.includes&&(r.includes=Array.from(new Set([].concat(n(r.includes),n(t.includes))))),a(e.pages).concat((i=e.subPackages,o=[],null==i||0==i.length?[]:(i.forEach((function(e){s=a(e.pages,e.root),o=o.concat(s)})),o)));var i,s,o}function a(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=[],s=0;e.length>s;s++){for(var a=e[s],n={},o=0;r.includes.length>o;o++){var l=r.includes[o],c=a[l];"path"===l&&(c=t?"/".concat(t,"/").concat(c):"/".concat(c)),"aliasPath"===l&&0==s&&null==t?n[l]=n[l]||"/":void 0!==c&&(n[l]=c)}i.push(n)}return i}const routes=e(pagesJson),router=$({routes:[...routes]}),icons={id:"2852637",name:"uniui图标库",font_family:"uniicons",css_prefix_text:"uniui-",description:"",glyphs:[{icon_id:"25027049",name:"yanse",font_class:"color",unicode:"e6cf",unicode_decimal:59087},{icon_id:"25027048",name:"wallet",font_class:"wallet",unicode:"e6b1",unicode_decimal:59057},{icon_id:"25015720",name:"settings-filled",font_class:"settings-filled",unicode:"e6ce",unicode_decimal:59086},{icon_id:"25015434",name:"shimingrenzheng-filled",font_class:"auth-filled",unicode:"e6cc",unicode_decimal:59084},{icon_id:"24934246",name:"shop-filled",font_class:"shop-filled",unicode:"e6cd",unicode_decimal:59085},{icon_id:"24934159",name:"staff-filled-01",font_class:"staff-filled",unicode:"e6cb",unicode_decimal:59083},{icon_id:"24932461",name:"VIP-filled",font_class:"vip-filled",unicode:"e6c6",unicode_decimal:59078},{icon_id:"24932462",name:"plus_circle_fill",font_class:"plus-filled",unicode:"e6c7",unicode_decimal:59079},{icon_id:"24932463",name:"folder_add-filled",font_class:"folder-add-filled",unicode:"e6c8",unicode_decimal:59080},{icon_id:"24932464",name:"yanse-filled",font_class:"color-filled",unicode:"e6c9",unicode_decimal:59081},{icon_id:"24932465",name:"tune-filled",font_class:"tune-filled",unicode:"e6ca",unicode_decimal:59082},{icon_id:"24932455",name:"a-rilidaka-filled",font_class:"calendar-filled",unicode:"e6c0",unicode_decimal:59072},{icon_id:"24932456",name:"notification-filled",font_class:"notification-filled",unicode:"e6c1",unicode_decimal:59073},{icon_id:"24932457",name:"wallet-filled",font_class:"wallet-filled",unicode:"e6c2",unicode_decimal:59074},{icon_id:"24932458",name:"paihangbang-filled",font_class:"medal-filled",unicode:"e6c3",unicode_decimal:59075},{icon_id:"24932459",name:"gift-filled",font_class:"gift-filled",unicode:"e6c4",unicode_decimal:59076},{icon_id:"24932460",name:"fire-filled",font_class:"fire-filled",unicode:"e6c5",unicode_decimal:59077},{icon_id:"24928001",name:"refreshempty",font_class:"refreshempty",unicode:"e6bf",unicode_decimal:59071},{icon_id:"24926853",name:"location-ellipse",font_class:"location-filled",unicode:"e6af",unicode_decimal:59055},{icon_id:"24926735",name:"person-filled",font_class:"person-filled",unicode:"e69d",unicode_decimal:59037},{icon_id:"24926703",name:"personadd-filled",font_class:"personadd-filled",unicode:"e698",unicode_decimal:59032},{icon_id:"24923351",name:"back",font_class:"back",unicode:"e6b9",unicode_decimal:59065},{icon_id:"24923352",name:"forward",font_class:"forward",unicode:"e6ba",unicode_decimal:59066},{icon_id:"24923353",name:"arrowthinright",font_class:"arrow-right",unicode:"e6bb",unicode_decimal:59067},{icon_id:"24923353",name:"arrowthinright",font_class:"arrowthinright",unicode:"e6bb",unicode_decimal:59067},{icon_id:"24923354",name:"arrowthinleft",font_class:"arrow-left",unicode:"e6bc",unicode_decimal:59068},{icon_id:"24923354",name:"arrowthinleft",font_class:"arrowthinleft",unicode:"e6bc",unicode_decimal:59068},{icon_id:"24923355",name:"arrowthinup",font_class:"arrow-up",unicode:"e6bd",unicode_decimal:59069},{icon_id:"24923355",name:"arrowthinup",font_class:"arrowthinup",unicode:"e6bd",unicode_decimal:59069},{icon_id:"24923356",name:"arrowthindown",font_class:"arrow-down",unicode:"e6be",unicode_decimal:59070},{icon_id:"24923356",name:"arrowthindown",font_class:"arrowthindown",unicode:"e6be",unicode_decimal:59070},{icon_id:"24923349",name:"arrowdown",font_class:"bottom",unicode:"e6b8",unicode_decimal:59064},{icon_id:"24923349",name:"arrowdown",font_class:"arrowdown",unicode:"e6b8",unicode_decimal:59064},{icon_id:"24923346",name:"arrowright",font_class:"right",unicode:"e6b5",unicode_decimal:59061},{icon_id:"24923346",name:"arrowright",font_class:"arrowright",unicode:"e6b5",unicode_decimal:59061},{icon_id:"24923347",name:"arrowup",font_class:"top",unicode:"e6b6",unicode_decimal:59062},{icon_id:"24923347",name:"arrowup",font_class:"arrowup",unicode:"e6b6",unicode_decimal:59062},{icon_id:"24923348",name:"arrowleft",font_class:"left",unicode:"e6b7",unicode_decimal:59063},{icon_id:"24923348",name:"arrowleft",font_class:"arrowleft",unicode:"e6b7",unicode_decimal:59063},{icon_id:"24923334",name:"eye",font_class:"eye",unicode:"e651",unicode_decimal:58961},{icon_id:"24923335",name:"eye-filled",font_class:"eye-filled",unicode:"e66a",unicode_decimal:58986},{icon_id:"24923336",name:"eye-slash",font_class:"eye-slash",unicode:"e6b3",unicode_decimal:59059},{icon_id:"24923337",name:"eye-slash-filled",font_class:"eye-slash-filled",unicode:"e6b4",unicode_decimal:59060},{icon_id:"24923305",name:"info-filled",font_class:"info-filled",unicode:"e649",unicode_decimal:58953},{icon_id:"24923299",name:"reload-01",font_class:"reload",unicode:"e6b2",unicode_decimal:59058},{icon_id:"24923195",name:"mic_slash_fill",font_class:"micoff-filled",unicode:"e6b0",unicode_decimal:59056},{icon_id:"24923165",name:"map-pin-ellipse",font_class:"map-pin-ellipse",unicode:"e6ac",unicode_decimal:59052},{icon_id:"24923166",name:"map-pin",font_class:"map-pin",unicode:"e6ad",unicode_decimal:59053},{icon_id:"24923167",name:"location",font_class:"location",unicode:"e6ae",unicode_decimal:59054},{icon_id:"24923064",name:"starhalf",font_class:"starhalf",unicode:"e683",unicode_decimal:59011},{icon_id:"24923065",name:"star",font_class:"star",unicode:"e688",unicode_decimal:59016},{icon_id:"24923066",name:"star-filled",font_class:"star-filled",unicode:"e68f",unicode_decimal:59023},{icon_id:"24899646",name:"a-rilidaka",font_class:"calendar",unicode:"e6a0",unicode_decimal:59040},{icon_id:"24899647",name:"fire",font_class:"fire",unicode:"e6a1",unicode_decimal:59041},{icon_id:"24899648",name:"paihangbang",font_class:"medal",unicode:"e6a2",unicode_decimal:59042},{icon_id:"24899649",name:"font",font_class:"font",unicode:"e6a3",unicode_decimal:59043},{icon_id:"24899650",name:"gift",font_class:"gift",unicode:"e6a4",unicode_decimal:59044},{icon_id:"24899651",name:"link",font_class:"link",unicode:"e6a5",unicode_decimal:59045},{icon_id:"24899652",name:"notification",font_class:"notification",unicode:"e6a6",unicode_decimal:59046},{icon_id:"24899653",name:"staff",font_class:"staff",unicode:"e6a7",unicode_decimal:59047},{icon_id:"24899654",name:"VIP",font_class:"vip",unicode:"e6a8",unicode_decimal:59048},{icon_id:"24899655",name:"folder_add",font_class:"folder-add",unicode:"e6a9",unicode_decimal:59049},{icon_id:"24899656",name:"tune",font_class:"tune",unicode:"e6aa",unicode_decimal:59050},{icon_id:"24899657",name:"shimingrenzheng",font_class:"auth",unicode:"e6ab",unicode_decimal:59051},{icon_id:"24899565",name:"person",font_class:"person",unicode:"e699",unicode_decimal:59033},{icon_id:"24899566",name:"email-filled",font_class:"email-filled",unicode:"e69a",unicode_decimal:59034},{icon_id:"24899567",name:"phone-filled",font_class:"phone-filled",unicode:"e69b",unicode_decimal:59035},{icon_id:"24899568",name:"phone",font_class:"phone",unicode:"e69c",unicode_decimal:59036},{icon_id:"24899570",name:"email",font_class:"email",unicode:"e69e",unicode_decimal:59038},{icon_id:"24899571",name:"personadd",font_class:"personadd",unicode:"e69f",unicode_decimal:59039},{icon_id:"24899558",name:"chatboxes-filled",font_class:"chatboxes-filled",unicode:"e692",unicode_decimal:59026},{icon_id:"24899559",name:"contact",font_class:"contact",unicode:"e693",unicode_decimal:59027},{icon_id:"24899560",name:"chatbubble-filled",font_class:"chatbubble-filled",unicode:"e694",unicode_decimal:59028},{icon_id:"24899561",name:"contact-filled",font_class:"contact-filled",unicode:"e695",unicode_decimal:59029},{icon_id:"24899562",name:"chatboxes",font_class:"chatboxes",unicode:"e696",unicode_decimal:59030},{icon_id:"24899563",name:"chatbubble",font_class:"chatbubble",unicode:"e697",unicode_decimal:59031},{icon_id:"24881290",name:"upload-filled",font_class:"upload-filled",unicode:"e68e",unicode_decimal:59022},{icon_id:"24881292",name:"upload",font_class:"upload",unicode:"e690",unicode_decimal:59024},{icon_id:"24881293",name:"weixin",font_class:"weixin",unicode:"e691",unicode_decimal:59025},{icon_id:"24881274",name:"compose",font_class:"compose",unicode:"e67f",unicode_decimal:59007},{icon_id:"24881275",name:"qq",font_class:"qq",unicode:"e680",unicode_decimal:59008},{icon_id:"24881276",name:"download-filled",font_class:"download-filled",unicode:"e681",unicode_decimal:59009},{icon_id:"24881277",name:"pengyouquan",font_class:"pyq",unicode:"e682",unicode_decimal:59010},{icon_id:"24881279",name:"sound",font_class:"sound",unicode:"e684",unicode_decimal:59012},{icon_id:"24881280",name:"trash-filled",font_class:"trash-filled",unicode:"e685",unicode_decimal:59013},{icon_id:"24881281",name:"sound-filled",font_class:"sound-filled",unicode:"e686",unicode_decimal:59014},{icon_id:"24881282",name:"trash",font_class:"trash",unicode:"e687",unicode_decimal:59015},{icon_id:"24881284",name:"videocam-filled",font_class:"videocam-filled",unicode:"e689",unicode_decimal:59017},{icon_id:"24881285",name:"spinner-cycle",font_class:"spinner-cycle",unicode:"e68a",unicode_decimal:59018},{icon_id:"24881286",name:"weibo",font_class:"weibo",unicode:"e68b",unicode_decimal:59019},{icon_id:"24881288",name:"videocam",font_class:"videocam",unicode:"e68c",unicode_decimal:59020},{icon_id:"24881289",name:"download",font_class:"download",unicode:"e68d",unicode_decimal:59021},{icon_id:"24879601",name:"help",font_class:"help",unicode:"e679",unicode_decimal:59001},{icon_id:"24879602",name:"navigate-filled",font_class:"navigate-filled",unicode:"e67a",unicode_decimal:59002},{icon_id:"24879603",name:"plusempty",font_class:"plusempty",unicode:"e67b",unicode_decimal:59003},{icon_id:"24879604",name:"smallcircle",font_class:"smallcircle",unicode:"e67c",unicode_decimal:59004},{icon_id:"24879605",name:"minus-filled",font_class:"minus-filled",unicode:"e67d",unicode_decimal:59005},{icon_id:"24879606",name:"micoff",font_class:"micoff",unicode:"e67e",unicode_decimal:59006},{icon_id:"24879588",name:"closeempty",font_class:"closeempty",unicode:"e66c",unicode_decimal:58988},{icon_id:"24879589",name:"clear",font_class:"clear",unicode:"e66d",unicode_decimal:58989},{icon_id:"24879590",name:"navigate",font_class:"navigate",unicode:"e66e",unicode_decimal:58990},{icon_id:"24879591",name:"minus",font_class:"minus",unicode:"e66f",unicode_decimal:58991},{icon_id:"24879592",name:"image",font_class:"image",unicode:"e670",unicode_decimal:58992},{icon_id:"24879593",name:"mic",font_class:"mic",unicode:"e671",unicode_decimal:58993},{icon_id:"24879594",name:"paperplane",font_class:"paperplane",unicode:"e672",unicode_decimal:58994},{icon_id:"24879595",name:"close",font_class:"close",unicode:"e673",unicode_decimal:58995},{icon_id:"24879596",name:"help-filled",font_class:"help-filled",unicode:"e674",unicode_decimal:58996},{icon_id:"24879597",name:"plus-filled",font_class:"paperplane-filled",unicode:"e675",unicode_decimal:58997},{icon_id:"24879598",name:"plus",font_class:"plus",unicode:"e676",unicode_decimal:58998},{icon_id:"24879599",name:"mic-filled",font_class:"mic-filled",unicode:"e677",unicode_decimal:58999},{icon_id:"24879600",name:"image-filled",font_class:"image-filled",unicode:"e678",unicode_decimal:59e3},{icon_id:"24855900",name:"locked-filled",font_class:"locked-filled",unicode:"e668",unicode_decimal:58984},{icon_id:"24855901",name:"info",font_class:"info",unicode:"e669",unicode_decimal:58985},{icon_id:"24855903",name:"locked",font_class:"locked",unicode:"e66b",unicode_decimal:58987},{icon_id:"24855884",name:"camera-filled",font_class:"camera-filled",unicode:"e658",unicode_decimal:58968},{icon_id:"24855885",name:"chat-filled",font_class:"chat-filled",unicode:"e659",unicode_decimal:58969},{icon_id:"24855886",name:"camera",font_class:"camera",unicode:"e65a",unicode_decimal:58970},{icon_id:"24855887",name:"circle",font_class:"circle",unicode:"e65b",unicode_decimal:58971},{icon_id:"24855888",name:"checkmarkempty",font_class:"checkmarkempty",unicode:"e65c",unicode_decimal:58972},{icon_id:"24855889",name:"chat",font_class:"chat",unicode:"e65d",unicode_decimal:58973},{icon_id:"24855890",name:"circle-filled",font_class:"circle-filled",unicode:"e65e",unicode_decimal:58974},{icon_id:"24855891",name:"flag",font_class:"flag",unicode:"e65f",unicode_decimal:58975},{icon_id:"24855892",name:"flag-filled",font_class:"flag-filled",unicode:"e660",unicode_decimal:58976},{icon_id:"24855893",name:"gear-filled",font_class:"gear-filled",unicode:"e661",unicode_decimal:58977},{icon_id:"24855894",name:"home",font_class:"home",unicode:"e662",unicode_decimal:58978},{icon_id:"24855895",name:"home-filled",font_class:"home-filled",unicode:"e663",unicode_decimal:58979},{icon_id:"24855896",name:"gear",font_class:"gear",unicode:"e664",unicode_decimal:58980},{icon_id:"24855897",name:"smallcircle-filled",font_class:"smallcircle-filled",unicode:"e665",unicode_decimal:58981},{icon_id:"24855898",name:"map-filled",font_class:"map-filled",unicode:"e666",unicode_decimal:58982},{icon_id:"24855899",name:"map",font_class:"map",unicode:"e667",unicode_decimal:58983},{icon_id:"24855825",name:"refresh-filled",font_class:"refresh-filled",unicode:"e656",unicode_decimal:58966},{icon_id:"24855826",name:"refresh",font_class:"refresh",unicode:"e657",unicode_decimal:58967},{icon_id:"24855808",name:"cloud-upload",font_class:"cloud-upload",unicode:"e645",unicode_decimal:58949},{icon_id:"24855809",name:"cloud-download-filled",font_class:"cloud-download-filled",unicode:"e646",unicode_decimal:58950},{icon_id:"24855810",name:"cloud-download",font_class:"cloud-download",unicode:"e647",unicode_decimal:58951},{icon_id:"24855811",name:"cloud-upload-filled",font_class:"cloud-upload-filled",unicode:"e648",unicode_decimal:58952},{icon_id:"24855813",name:"redo",font_class:"redo",unicode:"e64a",unicode_decimal:58954},{icon_id:"24855814",name:"images-filled",font_class:"images-filled",unicode:"e64b",unicode_decimal:58955},{icon_id:"24855815",name:"undo-filled",font_class:"undo-filled",unicode:"e64c",unicode_decimal:58956},{icon_id:"24855816",name:"more",font_class:"more",unicode:"e64d",unicode_decimal:58957},{icon_id:"24855817",name:"more-filled",font_class:"more-filled",unicode:"e64e",unicode_decimal:58958},{icon_id:"24855818",name:"undo",font_class:"undo",unicode:"e64f",unicode_decimal:58959},{icon_id:"24855819",name:"images",font_class:"images",unicode:"e650",unicode_decimal:58960},{icon_id:"24855821",name:"paperclip",font_class:"paperclip",unicode:"e652",unicode_decimal:58962},{icon_id:"24855822",name:"settings",font_class:"settings",unicode:"e653",unicode_decimal:58963},{icon_id:"24855823",name:"search",font_class:"search",unicode:"e654",unicode_decimal:58964},{icon_id:"24855824",name:"redo-filled",font_class:"redo-filled",unicode:"e655",unicode_decimal:58965},{icon_id:"24841702",name:"list",font_class:"list",unicode:"e644",unicode_decimal:58948},{icon_id:"24841489",name:"mail-open-filled",font_class:"mail-open-filled",unicode:"e63a",unicode_decimal:58938},{icon_id:"24841491",name:"hand-thumbsdown-filled",font_class:"hand-down-filled",unicode:"e63c",unicode_decimal:58940},{icon_id:"24841492",name:"hand-thumbsdown",font_class:"hand-down",unicode:"e63d",unicode_decimal:58941},{icon_id:"24841493",name:"hand-thumbsup-filled",font_class:"hand-up-filled",unicode:"e63e",unicode_decimal:58942},{icon_id:"24841494",name:"hand-thumbsup",font_class:"hand-up",unicode:"e63f",unicode_decimal:58943},{icon_id:"24841496",name:"heart-filled",font_class:"heart-filled",unicode:"e641",unicode_decimal:58945},{icon_id:"24841498",name:"mail-open",font_class:"mail-open",unicode:"e643",unicode_decimal:58947},{icon_id:"24841488",name:"heart",font_class:"heart",unicode:"e639",unicode_decimal:58937},{icon_id:"24839963",name:"loop",font_class:"loop",unicode:"e633",unicode_decimal:58931},{icon_id:"24839866",name:"pulldown",font_class:"pulldown",unicode:"e632",unicode_decimal:58930},{icon_id:"24813798",name:"scan",font_class:"scan",unicode:"e62a",unicode_decimal:58922},{icon_id:"24813786",name:"bars",font_class:"bars",unicode:"e627",unicode_decimal:58919},{icon_id:"24813788",name:"cart-filled",font_class:"cart-filled",unicode:"e629",unicode_decimal:58921},{icon_id:"24813790",name:"checkbox",font_class:"checkbox",unicode:"e62b",unicode_decimal:58923},{icon_id:"24813791",name:"checkbox-filled",font_class:"checkbox-filled",unicode:"e62c",unicode_decimal:58924},{icon_id:"24813794",name:"shop",font_class:"shop",unicode:"e62f",unicode_decimal:58927},{icon_id:"24813795",name:"headphones",font_class:"headphones",unicode:"e630",unicode_decimal:58928},{icon_id:"24813796",name:"cart",font_class:"cart",unicode:"e631",unicode_decimal:58929}]},getVal=e=>"number"==typeof e||/^[0-9]*$/g.test(e)?e+"px":e,_sfc_main={name:"UniIcons",emits:["click"],props:{type:{type:String,default:""},color:{type:String,default:"#333333"},size:{type:[Number,String],default:16},customPrefix:{type:String,default:""}},data:()=>({icons:icons.glyphs}),computed:{unicode(){let e=this.icons.find((e=>e.font_class===this.type));return e?unescape(`%u${e.unicode}`):""},iconSize(){return getVal(this.size)}},methods:{_onClick(){this.$emit("click")}}};function _sfc_render(e,t,i,r,s,a){return vue.openBlock(),vue.createElementBlock("text",{style:vue.normalizeStyle({color:i.color,"font-size":a.iconSize}),class:vue.normalizeClass(["uni-icons",["uniui-"+i.type,i.customPrefix,i.customPrefix?i.type:""]]),onClick:t[0]||(t[0]=(...e)=>a._onClick&&a._onClick(...e))},null,6)}const uniIcons=_export_sfc(_sfc_main,[["render",_sfc_render],["__scopeId","data-v-4b2c0a25"]]);function createApp(){const e=vue.createVueApp(_sfc_main$1),t=createPinia();return e.component("uni-icons",uniIcons),e.use(t),e.use(router),{app:e,pinia:t}}const{app:__app__,Vuex:__Vuex__,Pinia:__Pinia__}=createApp();uni.Vuex=__Vuex__,uni.Pinia=__Pinia__,__app__.provide("__globalStyles",__uniConfig.styles),__app__._component.mpType="app",__app__._component.render=()=>{},__app__.mount("#app")}(Vue);
